'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var constants = require('./constants'),
    arrayUtilities = require('./utilities/array'),
    verticesUtilities = require('./utilities/vertices'),
    rotationUtilities = require('./utilities/rotation'),
    EdgeInXYPlane = require('./facet/edgeInXYPlane'),
    VerticalLineInXYPlane = require('./facet/verticalLineInXYPlane');

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    push = arrayUtilities.push,
    separate = arrayUtilities.separate,
    rotateVertices = verticesUtilities.rotateVertices,
    calculateRotationQuaternion = rotationUtilities.calculateRotationQuaternion,
    calculateForwardsRotationQuaternion = rotationUtilities.calculateForwardsRotationQuaternion,
    calculateBackwardsRotationQuaternion = rotationUtilities.calculateBackwardsRotationQuaternion;

var MaskingFacet = function () {
  function MaskingFacet(edgesInXYPlane, verticalLinesInXYPlane, forwardsRotationQuaternion, backwardsRotationQuaternion) {
    _classCallCheck(this, MaskingFacet);

    this.edgesInXYPlane = edgesInXYPlane;
    this.verticalLinesInXYPlane = verticalLinesInXYPlane;
    this.forwardsRotationQuaternion = forwardsRotationQuaternion;
    this.backwardsRotationQuaternion = backwardsRotationQuaternion;
  }

  _createClass(MaskingFacet, [{
    key: 'getEdgesInXYPlane',
    value: function getEdgesInXYPlane() {
      return this.edgesInXYPlane;
    }
  }, {
    key: 'getVerticalLinesInXYPlane',
    value: function getVerticalLinesInXYPlane() {
      return this.verticalLinesInXYPlane;
    }
  }, {
    key: 'getForwardsRotationQuaternion',
    value: function getForwardsRotationQuaternion() {
      return this.forwardsRotationQuaternion;
    }
  }, {
    key: 'getBackwardsRotationQuaternion',
    value: function getBackwardsRotationQuaternion() {
      return this.backwardsRotationQuaternion;
    }
  }, {
    key: 'maskFacet',
    value: function maskFacet(facet, unmaskedFacets) {
      var unmaskedFacet = facet.clone();

      facet.rotate(this.forwardsRotationQuaternion);

      var maskingFacet = this,
          ///
      smallerFacets = this.splitFacet(facet),
          maskedSmallerFacets = [],
          unmaskedSmallerFacets = [];

      separate(smallerFacets, maskedSmallerFacets, unmaskedSmallerFacets, function (smallerFacet) {
        var smallerFacetMasked = smallerFacet.isMasked(maskingFacet);

        return smallerFacetMasked;
      });

      var maskedSmallerFacetsLength = maskedSmallerFacets.length;

      if (maskedSmallerFacetsLength === 0) {
        unmaskedFacets.push(unmaskedFacet);
      } else {
        unmaskedSmallerFacets.forEach(function (unmaskedSmallerFacet) {
          unmaskedSmallerFacet.rotate(this.backwardsRotationQuaternion);
        }.bind(this));

        push(unmaskedFacets, unmaskedSmallerFacets);
      }
    }
  }, {
    key: 'splitFacet',
    value: function splitFacet(facet) {
      var facets = [facet],
          smallerFacets = facets; ///

      this.verticalLinesInXYPlane.forEach(function (verticalLineInXYPlane) {
        smallerFacets = verticalLineInXYPlane.splitFacets(facets);

        facets = smallerFacets; ///
      });

      return smallerFacets;
    }
  }], [{
    key: 'fromFacet',
    value: function fromFacet(facet) {
      var facetNormal = facet.getNormal(),
          facetVertices = facet.getVertices(),
          rotationQuaternion = calculateRotationQuaternion(facetNormal),
          verticesInXYPlane = rotateVertices(facetVertices, rotationQuaternion),
          edgesInXYPlane = calculateEdgesInXYPlane(verticesInXYPlane),
          verticalLinesInXYPlane = edgesInXYPlane.map(function (edgeInXYPlane) {
        var verticalLineInXYPlane = VerticalLineInXYPlane.fromEdgeInXYPlane(edgeInXYPlane);

        return verticalLineInXYPlane;
      }),
          forwardsRotationQuaternion = calculateForwardsRotationQuaternion(rotationQuaternion),
          backwardsRotationQuaternion = calculateBackwardsRotationQuaternion(rotationQuaternion),
          maskingFacet = new MaskingFacet(edgesInXYPlane, verticalLinesInXYPlane, forwardsRotationQuaternion, backwardsRotationQuaternion);

      return maskingFacet;
    }
  }]);

  return MaskingFacet;
}();

module.exports = MaskingFacet;

function calculateEdgesInXYPlane(verticesInXYPlane) {
  var edgesInXYPlane = verticesInXYPlane.map(function (vertex, index) {
    var startIndex = index,
        endIndex = (startIndex + 1) % VERTICES_LENGTH,
        startVertexInXYPlane = verticesInXYPlane[startIndex],
        endVertexInXYPlane = verticesInXYPlane[endIndex],
        edgeInXYPlane = EdgeInXYPlane.fromStartVertexInXYPlaneAndEndVertexInXYPlane(startVertexInXYPlane, endVertexInXYPlane);

    return edgeInXYPlane;
  }.bind(this));

  return edgesInXYPlane;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9tYXNraW5nRmFjZXQuanMiXSwibmFtZXMiOlsiY29uc3RhbnRzIiwicmVxdWlyZSIsImFycmF5VXRpbGl0aWVzIiwidmVydGljZXNVdGlsaXRpZXMiLCJyb3RhdGlvblV0aWxpdGllcyIsIkVkZ2VJblhZUGxhbmUiLCJWZXJ0aWNhbExpbmVJblhZUGxhbmUiLCJWRVJUSUNFU19MRU5HVEgiLCJwdXNoIiwic2VwYXJhdGUiLCJyb3RhdGVWZXJ0aWNlcyIsImNhbGN1bGF0ZVJvdGF0aW9uUXVhdGVybmlvbiIsImNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiTWFza2luZ0ZhY2V0IiwiZWRnZXNJblhZUGxhbmUiLCJ2ZXJ0aWNhbExpbmVzSW5YWVBsYW5lIiwiZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJmYWNldCIsInVubWFza2VkRmFjZXRzIiwidW5tYXNrZWRGYWNldCIsImNsb25lIiwicm90YXRlIiwibWFza2luZ0ZhY2V0Iiwic21hbGxlckZhY2V0cyIsInNwbGl0RmFjZXQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzIiwidW5tYXNrZWRTbWFsbGVyRmFjZXRzIiwic21hbGxlckZhY2V0Iiwic21hbGxlckZhY2V0TWFza2VkIiwiaXNNYXNrZWQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzTGVuZ3RoIiwibGVuZ3RoIiwiZm9yRWFjaCIsInVubWFza2VkU21hbGxlckZhY2V0IiwiYmluZCIsImZhY2V0cyIsInZlcnRpY2FsTGluZUluWFlQbGFuZSIsInNwbGl0RmFjZXRzIiwiZmFjZXROb3JtYWwiLCJnZXROb3JtYWwiLCJmYWNldFZlcnRpY2VzIiwiZ2V0VmVydGljZXMiLCJyb3RhdGlvblF1YXRlcm5pb24iLCJ2ZXJ0aWNlc0luWFlQbGFuZSIsImNhbGN1bGF0ZUVkZ2VzSW5YWVBsYW5lIiwibWFwIiwiZWRnZUluWFlQbGFuZSIsImZyb21FZGdlSW5YWVBsYW5lIiwibW9kdWxlIiwiZXhwb3J0cyIsInZlcnRleCIsImluZGV4Iiwic3RhcnRJbmRleCIsImVuZEluZGV4Iiwic3RhcnRWZXJ0ZXhJblhZUGxhbmUiLCJlbmRWZXJ0ZXhJblhZUGxhbmUiLCJmcm9tU3RhcnRWZXJ0ZXhJblhZUGxhbmVBbmRFbmRWZXJ0ZXhJblhZUGxhbmUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLGFBQVIsQ0FBbEI7QUFBQSxJQUNNQyxpQkFBaUJELFFBQVEsbUJBQVIsQ0FEdkI7QUFBQSxJQUVNRSxvQkFBb0JGLFFBQVEsc0JBQVIsQ0FGMUI7QUFBQSxJQUdNRyxvQkFBb0JILFFBQVEsc0JBQVIsQ0FIMUI7QUFBQSxJQUlNSSxnQkFBZ0JKLFFBQVEsdUJBQVIsQ0FKdEI7QUFBQSxJQUtNSyx3QkFBd0JMLFFBQVEsK0JBQVIsQ0FMOUI7O0FBT00sSUFBRU0sZUFBRixHQUFzQlAsU0FBdEIsQ0FBRU8sZUFBRjtBQUFBLElBQ0VDLElBREYsR0FDcUJOLGNBRHJCLENBQ0VNLElBREY7QUFBQSxJQUNRQyxRQURSLEdBQ3FCUCxjQURyQixDQUNRTyxRQURSO0FBQUEsSUFFRUMsY0FGRixHQUVxQlAsaUJBRnJCLENBRUVPLGNBRkY7QUFBQSxJQUdFQywyQkFIRixHQUc2R1AsaUJBSDdHLENBR0VPLDJCQUhGO0FBQUEsSUFHK0JDLG1DQUgvQixHQUc2R1IsaUJBSDdHLENBRytCUSxtQ0FIL0I7QUFBQSxJQUdvRUMsb0NBSHBFLEdBRzZHVCxpQkFIN0csQ0FHb0VTLG9DQUhwRTs7SUFLQUMsWTtBQUNKLHdCQUFZQyxjQUFaLEVBQTRCQyxzQkFBNUIsRUFBb0RDLDBCQUFwRCxFQUFnRkMsMkJBQWhGLEVBQTZHO0FBQUE7O0FBQzNHLFNBQUtILGNBQUwsR0FBc0JBLGNBQXRCO0FBQ0EsU0FBS0Msc0JBQUwsR0FBOEJBLHNCQUE5QjtBQUNBLFNBQUtDLDBCQUFMLEdBQWtDQSwwQkFBbEM7QUFD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QWpCLEVBQXdCO0FBQzdELFFBQU1DLGFBQWFELEtBQW5CO0FBQUEsUUFDTUUsV0FBVyxDQUFDRCxhQUFhLENBQWQsSUFBbUIvQyxlQURwQztBQUFBLFFBRU1pRCx1QkFBdUJYLGtCQUFrQlMsVUFBbEIsQ0FGN0I7QUFBQSxRQUdNRyxxQkFBcUJaLGtCQUFrQlUsUUFBbEIsQ0FIM0I7QUFBQSxRQUlNUCxnQkFBZ0IzQyxjQUFjcUQsNkNBQWQsQ0FBNERGLG9CQUE1RCxFQUFrRkMsa0JBQWxGLENBSnRCOztBQU1BLFdBQU9ULGFBQVA7QUFDRCxHQVJzQyxDQVFyQ1osSUFScUMsQ0FRaEMsSUFSZ0MsQ0FBdEIsQ0FBdkI7O0FBVUEsU0FBT3JCLGNBQVA7QUFDRCIsImZpbGUiOiJtYXNraW5nRmFjZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICB2ZXJ0aWNlc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3ZlcnRpY2VzJyksXG4gICAgICByb3RhdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JvdGF0aW9uJyksXG4gICAgICBFZGdlSW5YWVBsYW5lID0gcmVxdWlyZSgnLi9mYWNldC9lZGdlSW5YWVBsYW5lJyksXG4gICAgICBWZXJ0aWNhbExpbmVJblhZUGxhbmUgPSByZXF1aXJlKCcuL2ZhY2V0L3ZlcnRpY2FsTGluZUluWFlQbGFuZScpO1xuXG5jb25zdCB7IFZFUlRJQ0VTX0xFTkdUSCB9ID0gY29uc3RhbnRzLFxuICAgICAgeyBwdXNoLCBzZXBhcmF0ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJvdGF0ZVZlcnRpY2VzIH0gPSB2ZXJ0aWNlc1V0aWxpdGllcyxcbiAgICAgIHsgY2FsY3VsYXRlUm90YXRpb25RdWF0ZXJuaW9uLCBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIH0gPSByb3RhdGlvblV0aWxpdGllcztcblxuY2xhc3MgTWFza2luZ0ZhY2V0IHtcbiAgY29uc3RydWN0b3IoZWRnZXNJblhZUGxhbmUsIHZlcnRpY2FsTGluZXNJblhZUGxhbmUsIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uLCBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgICB0aGlzLmVkZ2VzSW5YWVBsYW5lID0gZWRnZXNJblhZUGxhbmU7XG4gICAgdGhpcy52ZXJ0aWNhbExpbmVzSW5YWVBsYW5lID0gdmVydGljYWxMaW5lc0luWFlQbGFuZTtcbiAgICB0aGlzLmZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gICAgdGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gIH1cblxuICBnZXRFZGdlc0luWFlQbGFuZSgpIHtcbiAgICByZXR1cm4gdGhpcy5lZGdlc0luWFlQbGFuZTtcbiAgfVxuXG4gIGdldFZlcnRpY2FsTGluZXNJblhZUGxhbmUoKSB7XG4gICAgcmV0dXJuIHRoaXMudmVydGljYWxMaW5lc0luWFlQbGFuZTtcbiAgfVxuXG4gIGdldEZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uKCkge1xuICAgIHJldHVybiB0aGlzLmZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xuICB9XG5cbiAgZ2V0QmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKCkge1xuICAgIHJldHVybiB0aGlzLmJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIG1hc2tGYWNldChmYWNldCwgdW5tYXNrZWRGYWNldHMpIHtcbiAgICBjb25zdCB1bm1hc2tlZEZhY2V0ID0gZmFjZXQuY2xvbmUoKTtcblxuICAgIGZhY2V0LnJvdGF0ZSh0aGlzLmZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICAgIGNvbnN0IG1hc2tpbmdGYWNldCA9IHRoaXMsICAvLy9cbiAgICAgICAgICBzbWFsbGVyRmFjZXRzID0gdGhpcy5zcGxpdEZhY2V0KGZhY2V0KSxcbiAgICAgICAgICBtYXNrZWRTbWFsbGVyRmFjZXRzID0gW10sXG4gICAgICAgICAgdW5tYXNrZWRTbWFsbGVyRmFjZXRzID0gW107XG5cbiAgICBzZXBhcmF0ZShzbWFsbGVyRmFjZXRzLCBtYXNrZWRTbWFsbGVyRmFjZXRzLCB1bm1hc2tlZFNtYWxsZXJGYWNldHMsIGZ1bmN0aW9uKHNtYWxsZXJGYWNldCkge1xuICAgICAgY29uc3Qgc21hbGxlckZhY2V0TWFza2VkID0gc21hbGxlckZhY2V0LmlzTWFza2VkKG1hc2tpbmdGYWNldCk7XG5cbiAgICAgIHJldHVybiBzbWFsbGVyRmFjZXRNYXNrZWQ7XG4gICAgfSk7XG5cbiAgICBjb25zdCBtYXNrZWRTbWFsbGVyRmFjZXRzTGVuZ3RoID0gbWFza2VkU21hbGxlckZhY2V0cy5sZW5ndGg7XG5cbiAgICBpZiAobWFza2VkU21hbGxlckZhY2V0c0xlbmd0aCA9PT0gMCkge1xuICAgICAgdW5tYXNrZWRGYWNldHMucHVzaCh1bm1hc2tlZEZhY2V0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdW5tYXNrZWRTbWFsbGVyRmFjZXRzLmZvckVhY2goZnVuY3Rpb24odW5tYXNrZWRTbWFsbGVyRmFjZXQpIHtcbiAgICAgICAgdW5tYXNrZWRTbWFsbGVyRmFjZXQucm90YXRlKHRoaXMuYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICAgIHB1c2godW5tYXNrZWRGYWNldHMsIHVubWFza2VkU21hbGxlckZhY2V0cyk7XG4gICAgfVxuICB9XG4gIFxuICBzcGxpdEZhY2V0KGZhY2V0KSB7XG4gICAgbGV0IGZhY2V0cyA9IFtcbiAgICAgICAgICBmYWNldFxuICAgICAgICBdLFxuICAgICAgICBzbWFsbGVyRmFjZXRzID0gZmFjZXRzOyAvLy9cblxuICAgIHRoaXMudmVydGljYWxMaW5lc0luWFlQbGFuZS5mb3JFYWNoKGZ1bmN0aW9uKHZlcnRpY2FsTGluZUluWFlQbGFuZSkge1xuICAgICAgc21hbGxlckZhY2V0cyA9IHZlcnRpY2FsTGluZUluWFlQbGFuZS5zcGxpdEZhY2V0cyhmYWNldHMpO1xuXG4gICAgICBmYWNldHMgPSBzbWFsbGVyRmFjZXRzOyAvLy9cbiAgICB9KTtcblxuICAgIHJldHVybiBzbWFsbGVyRmFjZXRzO1xuICB9XG5cbiAgc3RhdGljIGZyb21GYWNldChmYWNldCkge1xuICAgIGNvbnN0IGZhY2V0Tm9ybWFsID0gZmFjZXQuZ2V0Tm9ybWFsKCksXG4gICAgICAgICAgZmFjZXRWZXJ0aWNlcyA9IGZhY2V0LmdldFZlcnRpY2VzKCksXG4gICAgICAgICAgcm90YXRpb25RdWF0ZXJuaW9uID0gY2FsY3VsYXRlUm90YXRpb25RdWF0ZXJuaW9uKGZhY2V0Tm9ybWFsKSxcbiAgICAgICAgICB2ZXJ0aWNlc0luWFlQbGFuZSA9IHJvdGF0ZVZlcnRpY2VzKGZhY2V0VmVydGljZXMsIHJvdGF0aW9uUXVhdGVybmlvbiksXG4gICAgICAgICAgZWRnZXNJblhZUGxhbmUgPSBjYWxjdWxhdGVFZGdlc0luWFlQbGFuZSh2ZXJ0aWNlc0luWFlQbGFuZSksXG4gICAgICAgICAgdmVydGljYWxMaW5lc0luWFlQbGFuZSA9IGVkZ2VzSW5YWVBsYW5lLm1hcChmdW5jdGlvbihlZGdlSW5YWVBsYW5lKSB7XG4gICAgICAgICAgICBjb25zdCB2ZXJ0aWNhbExpbmVJblhZUGxhbmUgPSBWZXJ0aWNhbExpbmVJblhZUGxhbmUuZnJvbUVkZ2VJblhZUGxhbmUoZWRnZUluWFlQbGFuZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB2ZXJ0aWNhbExpbmVJblhZUGxhbmU7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIG1hc2tpbmdGYWNldCA9IG5ldyBNYXNraW5nRmFjZXQoZWRnZXNJblhZUGxhbmUsIHZlcnRpY2FsTGluZXNJblhZUGxhbmUsIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uLCBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pO1xuXG4gICAgcmV0dXJuIG1hc2tpbmdGYWNldDtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IE1hc2tpbmdGYWNldDtcblxuZnVuY3Rpb24gY2FsY3VsYXRlRWRnZXNJblhZUGxhbmUodmVydGljZXNJblhZUGxhbmUpIHtcbiAgY29uc3QgZWRnZXNJblhZUGxhbmUgPSB2ZXJ0aWNlc0luWFlQbGFuZS5tYXAoZnVuY3Rpb24odmVydGV4LCBpbmRleCkge1xuICAgICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBpbmRleCxcbiAgICAgICAgICAgICAgICBlbmRJbmRleCA9IChzdGFydEluZGV4ICsgMSkgJSBWRVJUSUNFU19MRU5HVEgsXG4gICAgICAgICAgICAgICAgc3RhcnRWZXJ0ZXhJblhZUGxhbmUgPSB2ZXJ0aWNlc0luWFlQbGFuZVtzdGFydEluZGV4XSxcbiAgICAgICAgICAgICAgICBlbmRWZXJ0ZXhJblhZUGxhbmUgPSB2ZXJ0aWNlc0luWFlQbGFuZVtlbmRJbmRleF0sXG4gICAgICAgICAgICAgICAgZWRnZUluWFlQbGFuZSA9IEVkZ2VJblhZUGxhbmUuZnJvbVN0YXJ0VmVydGV4SW5YWVBsYW5lQW5kRW5kVmVydGV4SW5YWVBsYW5lKHN0YXJ0VmVydGV4SW5YWVBsYW5lLCBlbmRWZXJ0ZXhJblhZUGxhbmUpO1xuXG4gICAgICAgICAgcmV0dXJuIGVkZ2VJblhZUGxhbmU7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgcmV0dXJuIGVkZ2VzSW5YWVBsYW5lO1xufVxuIl19