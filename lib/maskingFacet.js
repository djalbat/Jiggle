'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var constants = require('./constants'),
    MaskingEdge = require('./edge/masking'),
    VerticalLine = require('./verticalLine'),
    arrayUtilities = require('./utilities/array'),
    verticesUtilities = require('./utilities/vertices'),
    quaternionUtilities = require('./utilities/quaternion');

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    push = arrayUtilities.push,
    separate = arrayUtilities.separate,
    rotateVertices = verticesUtilities.rotateVertices,
    calculateArbitraryRotationQuaternion = quaternionUtilities.calculateArbitraryRotationQuaternion,
    calculateForwardsRotationQuaternion = quaternionUtilities.calculateForwardsRotationQuaternion,
    calculateBackwardsRotationQuaternion = quaternionUtilities.calculateBackwardsRotationQuaternion;

var MaskingFacet = function () {
  function MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion) {
    _classCallCheck(this, MaskingFacet);

    this.maskingEdges = maskingEdges;
    this.verticalLines = verticalLines;
    this.forwardsRotationQuaternion = forwardsRotationQuaternion;
    this.backwardsRotationQuaternion = backwardsRotationQuaternion;
  }

  _createClass(MaskingFacet, [{
    key: 'getMaskingEdges',
    value: function getMaskingEdges() {
      return this.maskingEdges;
    }
  }, {
    key: 'getVerticalLines',
    value: function getVerticalLines() {
      return this.verticalLines;
    }
  }, {
    key: 'getForwardsRotationQuaternion',
    value: function getForwardsRotationQuaternion() {
      return this.forwardsRotationQuaternion;
    }
  }, {
    key: 'getBackwardsRotationQuaternion',
    value: function getBackwardsRotationQuaternion() {
      return this.backwardsRotationQuaternion;
    }
  }, {
    key: 'maskFacet',
    value: function maskFacet(facet, unmaskedFacets) {
      var _this = this;

      var unmaskedFacet = facet.clone(); ///

      facet.rotate(this.forwardsRotationQuaternion);

      var maskingFacet = this,
          ///
      smallerFacets = this.splitFacet(facet),
          maskedSmallerFacets = [],
          unmaskedSmallerFacets = [];

      separate(smallerFacets, maskedSmallerFacets, unmaskedSmallerFacets, function (smallerFacet) {
        var smallerFacetMasked = smallerFacet.isMasked(maskingFacet);

        return smallerFacetMasked;
      });

      var maskedSmallerFacetsLength = maskedSmallerFacets.length;

      if (maskedSmallerFacetsLength === 0) {
        unmaskedFacets.push(unmaskedFacet);
      } else {
        unmaskedSmallerFacets.forEach(function (unmaskedSmallerFacet) {
          unmaskedSmallerFacet.rotate(_this.backwardsRotationQuaternion);
        });

        push(unmaskedFacets, unmaskedSmallerFacets);
      }
    }
  }, {
    key: 'splitFacet',
    value: function splitFacet(facet) {
      var facets = [facet],
          smallerFacets = facets; ///

      this.verticalLines.forEach(function (verticalLine) {
        smallerFacets = verticalLine.splitFacets(facets);

        facets = smallerFacets; ///
      });

      return smallerFacets;
    }
  }], [{
    key: 'fromFacet',
    value: function fromFacet(facet) {
      var facetNormal = facet.getNormal(),
          facetVertices = facet.getVertices(),
          normal = facetNormal,
          ///
      arbitraryRotationQuaternion = calculateArbitraryRotationQuaternion(normal),
          rotationQuaternion = arbitraryRotationQuaternion,
          ///
      vertices = rotateVertices(facetVertices, rotationQuaternion),
          maskingEdges = calculateMaskingEdges(vertices),
          verticalLines = maskingEdges.map(function (maskingEdge) {
        var verticalLine = VerticalLine.fromMaskingEdge(maskingEdge);

        return verticalLine;
      }),
          forwardsRotationQuaternion = calculateForwardsRotationQuaternion(rotationQuaternion),
          backwardsRotationQuaternion = calculateBackwardsRotationQuaternion(rotationQuaternion),
          maskingFacet = new MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion);

      return maskingFacet;
    }
  }]);

  return MaskingFacet;
}();

module.exports = MaskingFacet;

function calculateMaskingEdges(vertices) {
  var maskingEdges = vertices.map(function (vertex, index) {
    var startIndex = index,
        endIndex = (startIndex + 1) % VERTICES_LENGTH,
        startVertex = vertices[startIndex],
        endVertex = vertices[endIndex],
        maskingEdge = MaskingEdge.fromStartVertexAndEndVertex(startVertex, endVertex);

    return maskingEdge;
  });

  return maskingEdges;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9tYXNraW5nRmFjZXQuanMiXSwibmFtZXMiOlsiY29uc3RhbnRzIiwicmVxdWlyZSIsIk1hc2tpbmdFZGdlIiwiVmVydGljYWxMaW5lIiwiYXJyYXlVdGlsaXRpZXMiLCJ2ZXJ0aWNlc1V0aWxpdGllcyIsInF1YXRlcm5pb25VdGlsaXRpZXMiLCJWRVJUSUNFU19MRU5HVEgiLCJwdXNoIiwic2VwYXJhdGUiLCJyb3RhdGVWZXJ0aWNlcyIsImNhbGN1bGF0ZUFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbiIsImNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiTWFza2luZ0ZhY2V0IiwibWFza2luZ0VkZ2VzIiwidmVydGljYWxMaW5lcyIsImZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiZmFjZXQiLCJ1bm1hc2tlZEZhY2V0cyIsInVubWFza2VkRmFjZXQiLCJjbG9uZSIsInJvdGF0ZSIsIm1hc2tpbmdGYWNldCIsInNtYWxsZXJGYWNldHMiLCJzcGxpdEZhY2V0IiwibWFza2VkU21hbGxlckZhY2V0cyIsInVubWFza2VkU21hbGxlckZhY2V0cyIsInNtYWxsZXJGYWNldCIsInNtYWxsZXJGYWNldE1hc2tlZCIsImlzTWFza2VkIiwibWFza2VkU21hbGxlckZhY2V0c0xlbmd0aCIsImxlbmd0aCIsImZvckVhY2giLCJ1bm1hc2tlZFNtYWxsZXJGYWNldCIsImZhY2V0cyIsInZlcnRpY2FsTGluZSIsInNwbGl0RmFjZXRzIiwiZmFjZXROb3JtYWwiLCJnZXROb3JtYWwiLCJmYWNldFZlcnRpY2VzIiwiZ2V0VmVydGljZXMiLCJub3JtYWwiLCJhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24iLCJyb3RhdGlvblF1YXRlcm5pb24iLCJ2ZXJ0aWNlcyIsImNhbGN1bGF0ZU1hc2tpbmdFZGdlcyIsIm1hcCIsIm1hc2tpbmdFZGdlIiwiZnJvbU1hc2tpbmdFZGdlIiwibW9kdWxlIiwiZXhwb3J0cyIsInZlcnRleCIsImluZGV4Iiwic3RhcnRJbmRleCIsImVuZEluZGV4Iiwic3RhcnRWZXJ0ZXgiLCJlbmRWZXJ0ZXgiLCJmcm9tU3RhcnRWZXJ0ZXhBbmRFbmRWZXJ0ZXgiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLGFBQVIsQ0FBbEI7QUFBQSxJQUNNQyxjQUFjRCxRQUFRLGdCQUFSLENBRHBCO0FBQUEsSUFFTUUsZUFBZUYsUUFBUSxnQkFBUixDQUZyQjtBQUFBLElBR01HLGlCQUFpQkgsUUFBUSxtQkFBUixDQUh2QjtBQUFBLElBSU1JLG9CQUFvQkosUUFBUSxzQkFBUixDQUoxQjtBQUFBLElBS01LLHNCQUFzQkwsUUFBUSx3QkFBUixDQUw1Qjs7QUFPTSxJQUFFTSxlQUFGLEdBQXNCUCxTQUF0QixDQUFFTyxlQUFGO0FBQUEsSUFDRUMsSUFERixHQUNxQkosY0FEckIsQ0FDRUksSUFERjtBQUFBLElBQ1FDLFFBRFIsR0FDcUJMLGNBRHJCLENBQ1FLLFFBRFI7QUFBQSxJQUVFQyxjQUZGLEdBRXFCTCxpQkFGckIsQ0FFRUssY0FGRjtBQUFBLElBR0VDLG9DQUhGLEdBR3NITCxtQkFIdEgsQ0FHRUssb0NBSEY7QUFBQSxJQUd3Q0MsbUNBSHhDLEdBR3NITixtQkFIdEgsQ0FHd0NNLG1DQUh4QztBQUFBLElBRzZFQyxvQ0FIN0UsR0FHc0hQLG1CQUh0SCxDQUc2RU8sb0NBSDdFOztJQUtBQyxZO0FBQ0osd0JBQVlDLFlBQVosRUFBMEJDLGFBQTFCLEVBQXlDQywwQkFBekMsRUFBcUVDLDJCQUFyRSxFQUFrRztBQUFBOztBQUNoRyxTQUFLSCxZQUFMLEdBQW9CQSxZQUFwQjtBQUNBLFNBQUtDLGFBQUwsR0FBcUJBLGFBQXJCO0FBQ0EsU0FBS0MsMEJBQUwsR0FBa0NBLDBCQUFsQztBQUNBLFNBQUtDLDJCQUFMLEdBQW1DQSwyQkFBbkM7QUFDRDs7OztzQ0FFaUI7QUFD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LEtBQW5CO0FBQUEsUUFDTUUsV0FBVyxDQUFDRCxhQUFhLENBQWQsSUFBbUJoRCxlQURwQztBQUFBLFFBRU1rRCxjQUFjWCxTQUFTUyxVQUFULENBRnBCO0FBQUEsUUFHTUcsWUFBWVosU0FBU1UsUUFBVCxDQUhsQjtBQUFBLFFBSU1QLGNBQWMvQyxZQUFZeUQsMkJBQVosQ0FBd0NGLFdBQXhDLEVBQXFEQyxTQUFyRCxDQUpwQjs7QUFNQSxXQUFPVCxXQUFQO0FBQ0QsR0FSYyxDQUFyQjs7QUFVQSxTQUFPbEMsWUFBUDtBQUNEIiwiZmlsZSI6Im1hc2tpbmdGYWNldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKSxcbiAgICAgIE1hc2tpbmdFZGdlID0gcmVxdWlyZSgnLi9lZGdlL21hc2tpbmcnKSxcbiAgICAgIFZlcnRpY2FsTGluZSA9IHJlcXVpcmUoJy4vdmVydGljYWxMaW5lJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICB2ZXJ0aWNlc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3ZlcnRpY2VzJyksXG4gICAgICBxdWF0ZXJuaW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcXVhdGVybmlvbicpO1xuXG5jb25zdCB7IFZFUlRJQ0VTX0xFTkdUSCB9ID0gY29uc3RhbnRzLFxuICAgICAgeyBwdXNoLCBzZXBhcmF0ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJvdGF0ZVZlcnRpY2VzIH0gPSB2ZXJ0aWNlc1V0aWxpdGllcyxcbiAgICAgIHsgY2FsY3VsYXRlQXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uLCBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIH0gPSBxdWF0ZXJuaW9uVXRpbGl0aWVzO1xuXG5jbGFzcyBNYXNraW5nRmFjZXQge1xuICBjb25zdHJ1Y3RvcihtYXNraW5nRWRnZXMsIHZlcnRpY2FsTGluZXMsIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uLCBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgICB0aGlzLm1hc2tpbmdFZGdlcyA9IG1hc2tpbmdFZGdlcztcbiAgICB0aGlzLnZlcnRpY2FsTGluZXMgPSB2ZXJ0aWNhbExpbmVzO1xuICAgIHRoaXMuZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgICB0aGlzLmJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIGdldE1hc2tpbmdFZGdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5tYXNraW5nRWRnZXM7XG4gIH1cblxuICBnZXRWZXJ0aWNhbExpbmVzKCkge1xuICAgIHJldHVybiB0aGlzLnZlcnRpY2FsTGluZXM7XG4gIH1cblxuICBnZXRGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5mb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIGdldEJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gIH1cblxuICBtYXNrRmFjZXQoZmFjZXQsIHVubWFza2VkRmFjZXRzKSB7XG4gICAgY29uc3QgdW5tYXNrZWRGYWNldCA9IGZhY2V0LmNsb25lKCk7ICAvLy9cblxuICAgIGZhY2V0LnJvdGF0ZSh0aGlzLmZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICAgIGNvbnN0IG1hc2tpbmdGYWNldCA9IHRoaXMsICAvLy9cbiAgICAgICAgICBzbWFsbGVyRmFjZXRzID0gdGhpcy5zcGxpdEZhY2V0KGZhY2V0KSxcbiAgICAgICAgICBtYXNrZWRTbWFsbGVyRmFjZXRzID0gW10sXG4gICAgICAgICAgdW5tYXNrZWRTbWFsbGVyRmFjZXRzID0gW107XG5cbiAgICBzZXBhcmF0ZShzbWFsbGVyRmFjZXRzLCBtYXNrZWRTbWFsbGVyRmFjZXRzLCB1bm1hc2tlZFNtYWxsZXJGYWNldHMsIChzbWFsbGVyRmFjZXQpID0+IHtcbiAgICAgIGNvbnN0IHNtYWxsZXJGYWNldE1hc2tlZCA9IHNtYWxsZXJGYWNldC5pc01hc2tlZChtYXNraW5nRmFjZXQpO1xuXG4gICAgICByZXR1cm4gc21hbGxlckZhY2V0TWFza2VkO1xuICAgIH0pO1xuXG4gICAgY29uc3QgbWFza2VkU21hbGxlckZhY2V0c0xlbmd0aCA9IG1hc2tlZFNtYWxsZXJGYWNldHMubGVuZ3RoO1xuXG4gICAgaWYgKG1hc2tlZFNtYWxsZXJGYWNldHNMZW5ndGggPT09IDApIHtcbiAgICAgIHVubWFza2VkRmFjZXRzLnB1c2godW5tYXNrZWRGYWNldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVubWFza2VkU21hbGxlckZhY2V0cy5mb3JFYWNoKCh1bm1hc2tlZFNtYWxsZXJGYWNldCkgPT4ge1xuICAgICAgICB1bm1hc2tlZFNtYWxsZXJGYWNldC5yb3RhdGUodGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pO1xuICAgICAgfSk7XG5cbiAgICAgIHB1c2godW5tYXNrZWRGYWNldHMsIHVubWFza2VkU21hbGxlckZhY2V0cyk7XG4gICAgfVxuICB9XG4gIFxuICBzcGxpdEZhY2V0KGZhY2V0KSB7XG4gICAgbGV0IGZhY2V0cyA9IFtcbiAgICAgICAgICBmYWNldFxuICAgICAgICBdLFxuICAgICAgICBzbWFsbGVyRmFjZXRzID0gZmFjZXRzOyAvLy9cblxuICAgIHRoaXMudmVydGljYWxMaW5lcy5mb3JFYWNoKCh2ZXJ0aWNhbExpbmUpID0+IHtcbiAgICAgIHNtYWxsZXJGYWNldHMgPSB2ZXJ0aWNhbExpbmUuc3BsaXRGYWNldHMoZmFjZXRzKTtcblxuICAgICAgZmFjZXRzID0gc21hbGxlckZhY2V0czsgLy8vXG4gICAgfSk7XG5cbiAgICByZXR1cm4gc21hbGxlckZhY2V0cztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tRmFjZXQoZmFjZXQpIHtcbiAgICBjb25zdCBmYWNldE5vcm1hbCA9IGZhY2V0LmdldE5vcm1hbCgpLFxuICAgICAgICAgIGZhY2V0VmVydGljZXMgPSBmYWNldC5nZXRWZXJ0aWNlcygpLFxuICAgICAgICAgIG5vcm1hbCA9IGZhY2V0Tm9ybWFsLCAvLy9cbiAgICAgICAgICBhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVBcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24obm9ybWFsKSxcbiAgICAgICAgICByb3RhdGlvblF1YXRlcm5pb24gPSBhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24sIC8vL1xuICAgICAgICAgIHZlcnRpY2VzID0gcm90YXRlVmVydGljZXMoZmFjZXRWZXJ0aWNlcywgcm90YXRpb25RdWF0ZXJuaW9uKSxcbiAgICAgICAgICBtYXNraW5nRWRnZXMgPSBjYWxjdWxhdGVNYXNraW5nRWRnZXModmVydGljZXMpLFxuICAgICAgICAgIHZlcnRpY2FsTGluZXMgPSBtYXNraW5nRWRnZXMubWFwKChtYXNraW5nRWRnZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmVydGljYWxMaW5lID0gVmVydGljYWxMaW5lLmZyb21NYXNraW5nRWRnZShtYXNraW5nRWRnZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB2ZXJ0aWNhbExpbmU7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIG1hc2tpbmdGYWNldCA9IG5ldyBNYXNraW5nRmFjZXQobWFza2luZ0VkZ2VzLCB2ZXJ0aWNhbExpbmVzLCBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICAgIHJldHVybiBtYXNraW5nRmFjZXQ7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNYXNraW5nRmFjZXQ7XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU1hc2tpbmdFZGdlcyh2ZXJ0aWNlcykge1xuICBjb25zdCBtYXNraW5nRWRnZXMgPSB2ZXJ0aWNlcy5tYXAoKHZlcnRleCwgaW5kZXgpID0+IHtcbiAgICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXgsXG4gICAgICAgICAgICAgICAgZW5kSW5kZXggPSAoc3RhcnRJbmRleCArIDEpICUgVkVSVElDRVNfTEVOR1RILFxuICAgICAgICAgICAgICAgIHN0YXJ0VmVydGV4ID0gdmVydGljZXNbc3RhcnRJbmRleF0sXG4gICAgICAgICAgICAgICAgZW5kVmVydGV4ID0gdmVydGljZXNbZW5kSW5kZXhdLFxuICAgICAgICAgICAgICAgIG1hc2tpbmdFZGdlID0gTWFza2luZ0VkZ2UuZnJvbVN0YXJ0VmVydGV4QW5kRW5kVmVydGV4KHN0YXJ0VmVydGV4LCBlbmRWZXJ0ZXgpO1xuXG4gICAgICAgICAgcmV0dXJuIG1hc2tpbmdFZGdlO1xuICAgICAgICB9KTtcblxuICByZXR1cm4gbWFza2luZ0VkZ2VzO1xufVxuIl19