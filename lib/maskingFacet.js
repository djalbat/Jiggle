'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var constants = require('./constants'),
    MaskingEdge = require('./edge/masking'),
    VerticalLine = require('./verticalLine'),
    arrayUtilities = require('./utilities/array'),
    rotationUtilities = require('./utilities/rotation'),
    quaternionUtilities = require('./utilities/quaternion');

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    push = arrayUtilities.push,
    separate = arrayUtilities.separate,
    rotateVertices = rotationUtilities.rotateVertices,
    calculateRotationQuaternion = quaternionUtilities.calculateRotationQuaternion,
    calculateForwardsRotationQuaternion = quaternionUtilities.calculateForwardsRotationQuaternion,
    calculateBackwardsRotationQuaternion = quaternionUtilities.calculateBackwardsRotationQuaternion;

var MaskingFacet = function () {
  function MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion) {
    _classCallCheck(this, MaskingFacet);

    this.maskingEdges = maskingEdges;
    this.verticalLines = verticalLines;
    this.forwardsRotationQuaternion = forwardsRotationQuaternion;
    this.backwardsRotationQuaternion = backwardsRotationQuaternion;
  }

  _createClass(MaskingFacet, [{
    key: 'getMaskingEdges',
    value: function getMaskingEdges() {
      return this.maskingEdges;
    }
  }, {
    key: 'getVerticalLines',
    value: function getVerticalLines() {
      return this.verticalLines;
    }
  }, {
    key: 'getForwardsRotationQuaternion',
    value: function getForwardsRotationQuaternion() {
      return this.forwardsRotationQuaternion;
    }
  }, {
    key: 'getBackwardsRotationQuaternion',
    value: function getBackwardsRotationQuaternion() {
      return this.backwardsRotationQuaternion;
    }
  }, {
    key: 'maskFacet',
    value: function maskFacet(facet, unmaskedFacets) {
      var unmaskedFacet = facet.clone();

      facet.rotate(this.forwardsRotationQuaternion);

      var maskingFacet = this,
          ///
      smallerFacets = this.splitFacet(facet),
          maskedSmallerFacets = [],
          unmaskedSmallerFacets = [];

      separate(smallerFacets, maskedSmallerFacets, unmaskedSmallerFacets, function (smallerFacet) {
        var smallerFacetMasked = smallerFacet.isMasked(maskingFacet);

        return smallerFacetMasked;
      });

      var maskedSmallerFacetsLength = maskedSmallerFacets.length;

      if (maskedSmallerFacetsLength === 0) {
        unmaskedFacets.push(unmaskedFacet);
      } else {
        unmaskedSmallerFacets.forEach(function (unmaskedSmallerFacet) {
          unmaskedSmallerFacet.rotate(this.backwardsRotationQuaternion);
        }.bind(this));

        push(unmaskedFacets, unmaskedSmallerFacets);
      }
    }
  }, {
    key: 'splitFacet',
    value: function splitFacet(facet) {
      var facets = [facet],
          smallerFacets = facets; ///

      this.verticalLines.forEach(function (verticalLine) {
        smallerFacets = verticalLine.splitFacets(facets);

        facets = smallerFacets; ///
      });

      return smallerFacets;
    }
  }], [{
    key: 'fromFacet',
    value: function fromFacet(facet) {
      var facetNormal = facet.getNormal(),
          facetVertices = facet.getVertices(),
          normal = facetNormal,
          ///
      rotationQuaternion = calculateRotationQuaternion(normal),
          vertices = rotateVertices(facetVertices, rotationQuaternion),
          maskingEdges = calculateMaskingEdges(vertices),
          verticalLines = maskingEdges.map(function (maskingEdge) {
        var verticalLine = VerticalLine.fromMaskingEdge(maskingEdge);

        return verticalLine;
      }),
          forwardsRotationQuaternion = calculateForwardsRotationQuaternion(rotationQuaternion),
          backwardsRotationQuaternion = calculateBackwardsRotationQuaternion(rotationQuaternion),
          maskingFacet = new MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion);

      return maskingFacet;
    }
  }]);

  return MaskingFacet;
}();

module.exports = MaskingFacet;

function calculateMaskingEdges(vertices) {
  var maskingEdges = vertices.map(function (vertex, index) {
    var startIndex = index,
        endIndex = (startIndex + 1) % VERTICES_LENGTH,
        startVertex = vertices[startIndex],
        endVertex = vertices[endIndex],
        maskingEdge = MaskingEdge.fromStartVertexAndEndVertex(startVertex, endVertex);

    return maskingEdge;
  }.bind(this));

  return maskingEdges;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9tYXNraW5nRmFjZXQuanMiXSwibmFtZXMiOlsiY29uc3RhbnRzIiwicmVxdWlyZSIsIk1hc2tpbmdFZGdlIiwiVmVydGljYWxMaW5lIiwiYXJyYXlVdGlsaXRpZXMiLCJyb3RhdGlvblV0aWxpdGllcyIsInF1YXRlcm5pb25VdGlsaXRpZXMiLCJWRVJUSUNFU19MRU5HVEgiLCJwdXNoIiwic2VwYXJhdGUiLCJyb3RhdGVWZXJ0aWNlcyIsImNhbGN1bGF0ZVJvdGF0aW9uUXVhdGVybmlvbiIsImNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiTWFza2luZ0ZhY2V0IiwibWFza2luZ0VkZ2VzIiwidmVydGljYWxMaW5lcyIsImZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiZmFjZXQiLCJ1bm1hc2tlZEZhY2V0cyIsInVubWFza2VkRmFjZXQiLCJjbG9uZSIsInJvdGF0ZSIsIm1hc2tpbmdGYWNldCIsInNtYWxsZXJGYWNldHMiLCJzcGxpdEZhY2V0IiwibWFza2VkU21hbGxlckZhY2V0cyIsInVubWFza2VkU21hbGxlckZhY2V0cyIsInNtYWxsZXJGYWNldCIsInNtYWxsZXJGYWNldE1hc2tlZCIsImlzTWFza2VkIiwibWFza2VkU21hbGxlckZhY2V0c0xlbmd0aCIsImxlbmd0aCIsImZvckVhY2giLCJ1bm1hc2tlZFNtYWxsZXJGYWNldCIsImJpbmQiLCJmYWNldHMiLCJ2ZXJ0aWNhbExpbmUiLCJzcGxpdEZhY2V0cyIsImZhY2V0Tm9ybWFsIiwiZ2V0Tm9ybWFsIiwiZmFjZXRWZXJ0aWNlcyIsImdldFZlcnRpY2VzIiwibm9ybWFsIiwicm90YXRpb25RdWF0ZXJuaW9uIiwidmVydGljZXMiLCJjYWxjdWxhdGVNYXNraW5nRWRnZXMiLCJtYXAiLCJtYXNraW5nRWRnZSIsImZyb21NYXNraW5nRWRnZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJ2ZXJ0ZXgiLCJpbmRleCIsInN0YXJ0SW5kZXgiLCJlbmRJbmRleCIsInN0YXJ0VmVydGV4IiwiZW5kVmVydGV4IiwiZnJvbVN0YXJ0VmVydGV4QW5kRW5kVmVydGV4Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsWUFBWUMsUUFBUSxhQUFSLENBQWxCO0FBQUEsSUFDTUMsY0FBY0QsUUFBUSxnQkFBUixDQURwQjtBQUFBLElBRU1FLGVBQWVGLFFBQVEsZ0JBQVIsQ0FGckI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7QUFBQSxJQUlNSSxvQkFBb0JKLFFBQVEsc0JBQVIsQ0FKMUI7QUFBQSxJQUtNSyxzQkFBc0JMLFFBQVEsd0JBQVIsQ0FMNUI7O0FBT00sSUFBRU0sZUFBRixHQUFzQlAsU0FBdEIsQ0FBRU8sZUFBRjtBQUFBLElBQ0VDLElBREYsR0FDcUJKLGNBRHJCLENBQ0VJLElBREY7QUFBQSxJQUNRQyxRQURSLEdBQ3FCTCxjQURyQixDQUNRSyxRQURSO0FBQUEsSUFFRUMsY0FGRixHQUVxQkwsaUJBRnJCLENBRUVLLGNBRkY7QUFBQSxJQUdFQywyQkFIRixHQUc2R0wsbUJBSDdHLENBR0VLLDJCQUhGO0FBQUEsSUFHK0JDLG1DQUgvQixHQUc2R04sbUJBSDdHLENBRytCTSxtQ0FIL0I7QUFBQSxJQUdvRUMsb0NBSHBFLEdBRzZHUCxtQkFIN0csQ0FHb0VPLG9DQUhwRTs7SUFLQUMsWTtBQUNKLHdCQUFZQyxZQUFaLEVBQTBCQyxhQUExQixFQUF5Q0MsMEJBQXpDLEVBQXFFQywyQkFBckUsRUFBa0c7QUFBQTs7QUFDaEcsU0FBS0gsWUFBTCxHQUFvQkEsWUFBcEI7QUFDQSxTQUFLQyxhQUFMLEdBQXFCQSxhQUFyQjtBQUNBLFNBQUtDLDBCQUFMLEdBQWtDQSwwQkFBbEM7QUFDQSxTQUFLQywyQkFBTCxHQUFtQ0EsMkJBQW5DO0FBQ0Q7Ozs7c0NBRWlCO0FBQ2hCLGFBQU8sS0FBS0gsWUFBWjtBQUNEOzs7dUNBRWtC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RHBDO0FBQUEsUUFFTWtELGNBQWNYLFNBQVNTLFVBQVQsQ0FGcEI7QUFBQSxRQUdNRyxZQUFZWixTQUFTVSxRQUFULENBSGxCO0FBQUEsUUFJTVAsY0FBYy9DLFlBQVl5RCwyQkFBWixDQUF3Q0YsV0FBeEMsRUFBcURDLFNBQXJELENBSnBCOztBQU1BLFdBQU9ULFdBQVA7QUFDRCxHQVIyQixDQVExQmIsSUFSMEIsQ0FRckIsSUFScUIsQ0FBYixDQUFyQjs7QUFVQSxTQUFPckIsWUFBUDtBQUNEIiwiZmlsZSI6Im1hc2tpbmdGYWNldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKSxcbiAgICAgIE1hc2tpbmdFZGdlID0gcmVxdWlyZSgnLi9lZGdlL21hc2tpbmcnKSxcbiAgICAgIFZlcnRpY2FsTGluZSA9IHJlcXVpcmUoJy4vdmVydGljYWxMaW5lJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICByb3RhdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JvdGF0aW9uJyksXG4gICAgICBxdWF0ZXJuaW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvcXVhdGVybmlvbicpO1xuXG5jb25zdCB7IFZFUlRJQ0VTX0xFTkdUSCB9ID0gY29uc3RhbnRzLFxuICAgICAgeyBwdXNoLCBzZXBhcmF0ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJvdGF0ZVZlcnRpY2VzIH0gPSByb3RhdGlvblV0aWxpdGllcyxcbiAgICAgIHsgY2FsY3VsYXRlUm90YXRpb25RdWF0ZXJuaW9uLCBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIH0gPSBxdWF0ZXJuaW9uVXRpbGl0aWVzO1xuXG5jbGFzcyBNYXNraW5nRmFjZXQge1xuICBjb25zdHJ1Y3RvcihtYXNraW5nRWRnZXMsIHZlcnRpY2FsTGluZXMsIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uLCBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgICB0aGlzLm1hc2tpbmdFZGdlcyA9IG1hc2tpbmdFZGdlcztcbiAgICB0aGlzLnZlcnRpY2FsTGluZXMgPSB2ZXJ0aWNhbExpbmVzO1xuICAgIHRoaXMuZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgICB0aGlzLmJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIGdldE1hc2tpbmdFZGdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5tYXNraW5nRWRnZXM7XG4gIH1cblxuICBnZXRWZXJ0aWNhbExpbmVzKCkge1xuICAgIHJldHVybiB0aGlzLnZlcnRpY2FsTGluZXM7XG4gIH1cblxuICBnZXRGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5mb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIGdldEJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gIH1cblxuICBtYXNrRmFjZXQoZmFjZXQsIHVubWFza2VkRmFjZXRzKSB7XG4gICAgY29uc3QgdW5tYXNrZWRGYWNldCA9IGZhY2V0LmNsb25lKCk7XG5cbiAgICBmYWNldC5yb3RhdGUodGhpcy5mb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbik7XG5cbiAgICBjb25zdCBtYXNraW5nRmFjZXQgPSB0aGlzLCAgLy8vXG4gICAgICAgICAgc21hbGxlckZhY2V0cyA9IHRoaXMuc3BsaXRGYWNldChmYWNldCksXG4gICAgICAgICAgbWFza2VkU21hbGxlckZhY2V0cyA9IFtdLFxuICAgICAgICAgIHVubWFza2VkU21hbGxlckZhY2V0cyA9IFtdO1xuXG4gICAgc2VwYXJhdGUoc21hbGxlckZhY2V0cywgbWFza2VkU21hbGxlckZhY2V0cywgdW5tYXNrZWRTbWFsbGVyRmFjZXRzLCBmdW5jdGlvbihzbWFsbGVyRmFjZXQpIHtcbiAgICAgIGNvbnN0IHNtYWxsZXJGYWNldE1hc2tlZCA9IHNtYWxsZXJGYWNldC5pc01hc2tlZChtYXNraW5nRmFjZXQpO1xuXG4gICAgICByZXR1cm4gc21hbGxlckZhY2V0TWFza2VkO1xuICAgIH0pO1xuXG4gICAgY29uc3QgbWFza2VkU21hbGxlckZhY2V0c0xlbmd0aCA9IG1hc2tlZFNtYWxsZXJGYWNldHMubGVuZ3RoO1xuXG4gICAgaWYgKG1hc2tlZFNtYWxsZXJGYWNldHNMZW5ndGggPT09IDApIHtcbiAgICAgIHVubWFza2VkRmFjZXRzLnB1c2godW5tYXNrZWRGYWNldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVubWFza2VkU21hbGxlckZhY2V0cy5mb3JFYWNoKGZ1bmN0aW9uKHVubWFza2VkU21hbGxlckZhY2V0KSB7XG4gICAgICAgIHVubWFza2VkU21hbGxlckZhY2V0LnJvdGF0ZSh0aGlzLmJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbik7XG4gICAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgICBwdXNoKHVubWFza2VkRmFjZXRzLCB1bm1hc2tlZFNtYWxsZXJGYWNldHMpO1xuICAgIH1cbiAgfVxuICBcbiAgc3BsaXRGYWNldChmYWNldCkge1xuICAgIGxldCBmYWNldHMgPSBbXG4gICAgICAgICAgZmFjZXRcbiAgICAgICAgXSxcbiAgICAgICAgc21hbGxlckZhY2V0cyA9IGZhY2V0czsgLy8vXG5cbiAgICB0aGlzLnZlcnRpY2FsTGluZXMuZm9yRWFjaChmdW5jdGlvbih2ZXJ0aWNhbExpbmUpIHtcbiAgICAgIHNtYWxsZXJGYWNldHMgPSB2ZXJ0aWNhbExpbmUuc3BsaXRGYWNldHMoZmFjZXRzKTtcblxuICAgICAgZmFjZXRzID0gc21hbGxlckZhY2V0czsgLy8vXG4gICAgfSk7XG5cbiAgICByZXR1cm4gc21hbGxlckZhY2V0cztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tRmFjZXQoZmFjZXQpIHtcbiAgICBjb25zdCBmYWNldE5vcm1hbCA9IGZhY2V0LmdldE5vcm1hbCgpLFxuICAgICAgICAgIGZhY2V0VmVydGljZXMgPSBmYWNldC5nZXRWZXJ0aWNlcygpLFxuICAgICAgICAgIG5vcm1hbCA9IGZhY2V0Tm9ybWFsLCAvLy9cbiAgICAgICAgICByb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVSb3RhdGlvblF1YXRlcm5pb24obm9ybWFsKSxcbiAgICAgICAgICB2ZXJ0aWNlcyA9IHJvdGF0ZVZlcnRpY2VzKGZhY2V0VmVydGljZXMsIHJvdGF0aW9uUXVhdGVybmlvbiksXG4gICAgICAgICAgbWFza2luZ0VkZ2VzID0gY2FsY3VsYXRlTWFza2luZ0VkZ2VzKHZlcnRpY2VzKSxcbiAgICAgICAgICB2ZXJ0aWNhbExpbmVzID0gbWFza2luZ0VkZ2VzLm1hcChmdW5jdGlvbihtYXNraW5nRWRnZSkge1xuICAgICAgICAgICAgY29uc3QgdmVydGljYWxMaW5lID0gVmVydGljYWxMaW5lLmZyb21NYXNraW5nRWRnZShtYXNraW5nRWRnZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB2ZXJ0aWNhbExpbmU7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIG1hc2tpbmdGYWNldCA9IG5ldyBNYXNraW5nRmFjZXQobWFza2luZ0VkZ2VzLCB2ZXJ0aWNhbExpbmVzLCBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICAgIHJldHVybiBtYXNraW5nRmFjZXQ7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNYXNraW5nRmFjZXQ7XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU1hc2tpbmdFZGdlcyh2ZXJ0aWNlcykge1xuICBjb25zdCBtYXNraW5nRWRnZXMgPSB2ZXJ0aWNlcy5tYXAoZnVuY3Rpb24odmVydGV4LCBpbmRleCkge1xuICAgICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSBpbmRleCxcbiAgICAgICAgICAgICAgICBlbmRJbmRleCA9IChzdGFydEluZGV4ICsgMSkgJSBWRVJUSUNFU19MRU5HVEgsXG4gICAgICAgICAgICAgICAgc3RhcnRWZXJ0ZXggPSB2ZXJ0aWNlc1tzdGFydEluZGV4XSxcbiAgICAgICAgICAgICAgICBlbmRWZXJ0ZXggPSB2ZXJ0aWNlc1tlbmRJbmRleF0sXG4gICAgICAgICAgICAgICAgbWFza2luZ0VkZ2UgPSBNYXNraW5nRWRnZS5mcm9tU3RhcnRWZXJ0ZXhBbmRFbmRWZXJ0ZXgoc3RhcnRWZXJ0ZXgsIGVuZFZlcnRleCk7XG5cbiAgICAgICAgICByZXR1cm4gbWFza2luZ0VkZ2U7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgcmV0dXJuIG1hc2tpbmdFZGdlcztcbn1cbiJdfQ==