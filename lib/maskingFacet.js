'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var constants = require('./constants'),
    EdgeInXYPlane = require('./edgeInXYPlane'),
    VerticalLineInXYPlane = require('./verticalLineInXYPlane'),
    arrayUtilities = require('./utilities/array'),
    facetUtilities = require('./utilities/facet'),
    rotationUtilities = require('./utilities/rotation');

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    push = arrayUtilities.push,
    separate = arrayUtilities.separate,
    rotateVertices = facetUtilities.rotateVertices,
    calculateRotationQuaternion = rotationUtilities.calculateRotationQuaternion,
    calculateForwardsRotationQuaternion = rotationUtilities.calculateForwardsRotationQuaternion,
    calculateBackwardsRotationQuaternion = rotationUtilities.calculateBackwardsRotationQuaternion;

var MaskingFacet = function () {
  function MaskingFacet(edgesInXYPlane, verticalLinesInXYPlane, forwardsRotationQuaternion, backwardsRotationQuaternion) {
    _classCallCheck(this, MaskingFacet);

    this.edgesInXYPlane = edgesInXYPlane;
    this.verticalLinesInXYPlane = verticalLinesInXYPlane;
    this.forwardsRotationQuaternion = forwardsRotationQuaternion;
    this.backwardsRotationQuaternion = backwardsRotationQuaternion;
  }

  _createClass(MaskingFacet, [{
    key: 'getEdgesInXYPlane',
    value: function getEdgesInXYPlane() {
      return this.edgesInXYPlane;
    }
  }, {
    key: 'getVerticalLinesInXYPlane',
    value: function getVerticalLinesInXYPlane() {
      return this.verticalLinesInXYPlane;
    }
  }, {
    key: 'getForwardsRotationQuaternion',
    value: function getForwardsRotationQuaternion() {
      return this.forwardsRotationQuaternion;
    }
  }, {
    key: 'getBackwardsRotationQuaternion',
    value: function getBackwardsRotationQuaternion() {
      return this.backwardsRotationQuaternion;
    }
  }, {
    key: 'maskFacet',
    value: function maskFacet(facet, unmaskedFacets) {
      var unmaskedFacet = facet.clone();

      facet.rotate(this.forwardsRotationQuaternion);

      var maskingFacet = this,
          ///
      smallerFacets = this.splitFacet(facet),
          maskedSmallerFacets = [],
          unmaskedSmallerFacets = [];

      separate(smallerFacets, maskedSmallerFacets, unmaskedSmallerFacets, function (smallerFacet) {
        var smallerFacetMasked = smallerFacet.isMasked(maskingFacet);

        return smallerFacetMasked;
      });

      var maskedSmallerFacetsLength = maskedSmallerFacets.length;

      if (maskedSmallerFacetsLength === 0) {
        unmaskedFacets.push(unmaskedFacet);
      } else {
        unmaskedSmallerFacets.forEach(function (unmaskedSmallerFacet) {
          unmaskedSmallerFacet.rotate(this.backwardsRotationQuaternion);
        }.bind(this));

        push(unmaskedFacets, unmaskedSmallerFacets);
      }
    }
  }, {
    key: 'splitFacet',
    value: function splitFacet(facet) {
      var facets = [facet],
          smallerFacets = facets; ///

      this.verticalLinesInXYPlane.forEach(function (verticalLineInXYPlane) {
        smallerFacets = verticalLineInXYPlane.splitFacets(facets);

        facets = smallerFacets; ///
      });

      return smallerFacets;
    }
  }], [{
    key: 'fromFacet',
    value: function fromFacet(facet) {
      var facetNormal = facet.getNormal(),
          facetVertices = facet.getVertices(),
          rotationQuaternion = calculateRotationQuaternion(facetNormal),
          verticesInXYPlane = rotateVertices(facetVertices, rotationQuaternion),
          edgesInXYPlane = calculateEdgesInXYPlane(verticesInXYPlane),
          verticalLinesInXYPlane = edgesInXYPlane.map(function (edgeInXYPlane) {
        var verticalLineInXYPlane = VerticalLineInXYPlane.fromEdgeInXYPlane(edgeInXYPlane);

        return verticalLineInXYPlane;
      }),
          forwardsRotationQuaternion = calculateForwardsRotationQuaternion(rotationQuaternion),
          backwardsRotationQuaternion = calculateBackwardsRotationQuaternion(rotationQuaternion),
          maskingFacet = new MaskingFacet(edgesInXYPlane, verticalLinesInXYPlane, forwardsRotationQuaternion, backwardsRotationQuaternion);

      return maskingFacet;
    }
  }]);

  return MaskingFacet;
}();

module.exports = MaskingFacet;

function calculateEdgesInXYPlane(verticesInXYPlane) {
  var edgesInXYPlane = verticesInXYPlane.map(function (vertex, index) {
    var startIndex = index,
        endIndex = (startIndex + 1) % VERTICES_LENGTH,
        startVertexInXYPlane = verticesInXYPlane[startIndex],
        endVertexInXYPlane = verticesInXYPlane[endIndex],
        edgeInXYPlane = EdgeInXYPlane.fromStartVertexInXYPlaneAndEndVertexInXYPlane(startVertexInXYPlane, endVertexInXYPlane);

    return edgeInXYPlane;
  }.bind(this));

  return edgesInXYPlane;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9tYXNraW5nRmFjZXQuanMiXSwibmFtZXMiOlsiY29uc3RhbnRzIiwicmVxdWlyZSIsIkVkZ2VJblhZUGxhbmUiLCJWZXJ0aWNhbExpbmVJblhZUGxhbmUiLCJhcnJheVV0aWxpdGllcyIsImZhY2V0VXRpbGl0aWVzIiwicm90YXRpb25VdGlsaXRpZXMiLCJWRVJUSUNFU19MRU5HVEgiLCJwdXNoIiwic2VwYXJhdGUiLCJyb3RhdGVWZXJ0aWNlcyIsImNhbGN1bGF0ZVJvdGF0aW9uUXVhdGVybmlvbiIsImNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiTWFza2luZ0ZhY2V0IiwiZWRnZXNJblhZUGxhbmUiLCJ2ZXJ0aWNhbExpbmVzSW5YWVBsYW5lIiwiZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJmYWNldCIsInVubWFza2VkRmFjZXRzIiwidW5tYXNrZWRGYWNldCIsImNsb25lIiwicm90YXRlIiwibWFza2luZ0ZhY2V0Iiwic21hbGxlckZhY2V0cyIsInNwbGl0RmFjZXQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzIiwidW5tYXNrZWRTbWFsbGVyRmFjZXRzIiwic21hbGxlckZhY2V0Iiwic21hbGxlckZhY2V0TWFza2VkIiwiaXNNYXNrZWQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzTGVuZ3RoIiwibGVuZ3RoIiwiZm9yRWFjaCIsInVubWFza2VkU21hbGxlckZhY2V0IiwiYmluZCIsImZhY2V0cyIsInZlcnRpY2FsTGluZUluWFlQbGFuZSIsInNwbGl0RmFjZXRzIiwiZmFjZXROb3JtYWwiLCJnZXROb3JtYWwiLCJmYWNldFZlcnRpY2VzIiwiZ2V0VmVydGljZXMiLCJyb3RhdGlvblF1YXRlcm5pb24iLCJ2ZXJ0aWNlc0luWFlQbGFuZSIsImNhbGN1bGF0ZUVkZ2VzSW5YWVBsYW5lIiwibWFwIiwiZWRnZUluWFlQbGFuZSIsImZyb21FZGdlSW5YWVBsYW5lIiwibW9kdWxlIiwiZXhwb3J0cyIsInZlcnRleCIsImluZGV4Iiwic3RhcnRJbmRleCIsImVuZEluZGV4Iiwic3RhcnRWZXJ0ZXhJblhZUGxhbmUiLCJlbmRWZXJ0ZXhJblhZUGxhbmUiLCJmcm9tU3RhcnRWZXJ0ZXhJblhZUGxhbmVBbmRFbmRWZXJ0ZXhJblhZUGxhbmUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLGFBQVIsQ0FBbEI7QUFBQSxJQUNNQyxnQkFBZ0JELFFBQVEsaUJBQVIsQ0FEdEI7QUFBQSxJQUVNRSx3QkFBd0JGLFFBQVEseUJBQVIsQ0FGOUI7QUFBQSxJQUdNRyxpQkFBaUJILFFBQVEsbUJBQVIsQ0FIdkI7QUFBQSxJQUlNSSxpQkFBaUJKLFFBQVEsbUJBQVIsQ0FKdkI7QUFBQSxJQUtNSyxvQkFBb0JMLFFBQVEsc0JBQVIsQ0FMMUI7O0FBT00sSUFBRU0sZUFBRixHQUFzQlAsU0FBdEIsQ0FBRU8sZUFBRjtBQUFBLElBQ0VDLElBREYsR0FDcUJKLGNBRHJCLENBQ0VJLElBREY7QUFBQSxJQUNRQyxRQURSLEdBQ3FCTCxjQURyQixDQUNRSyxRQURSO0FBQUEsSUFFRUMsY0FGRixHQUVxQkwsY0FGckIsQ0FFRUssY0FGRjtBQUFBLElBR0VDLDJCQUhGLEdBRzZHTCxpQkFIN0csQ0FHRUssMkJBSEY7QUFBQSxJQUcrQkMsbUNBSC9CLEdBRzZHTixpQkFIN0csQ0FHK0JNLG1DQUgvQjtBQUFBLElBR29FQyxvQ0FIcEUsR0FHNkdQLGlCQUg3RyxDQUdvRU8sb0NBSHBFOztJQUtBQyxZO0FBQ0osd0JBQVlDLGNBQVosRUFBNEJDLHNCQUE1QixFQUFvREMsMEJBQXBELEVBQWdGQywyQkFBaEYsRUFBNkc7QUFBQTs7QUFDM0csU0FBS0gsY0FBTCxHQUFzQkEsY0FBdEI7QUFDQSxTQUFLQyxzQkFBTCxHQUE4QkEsc0JBQTlCO0FBQ0EsU0FBS0MsMEJBQUwsR0FBa0NBLDBCQUFsQztBQUNBLFNB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RUFBd0I7QUFDN0QsUUFBTUMsYUFBYUQsS0FBbkI7QUFBQSxRQUNNRSxXQUFXLENBQUNELGFBQWEsQ0FBZCxJQUFtQi9DLGVBRHBDO0FBQUEsUUFFTWlELHVCQUF1Qlgsa0JBQWtCUyxVQUFsQixDQUY3QjtBQUFBLFFBR01HLHFCQUFxQlosa0JBQWtCVSxRQUFsQixDQUgzQjtBQUFBLFFBSU1QLGdCQUFnQjlDLGNBQWN3RCw2Q0FBZCxDQUE0REYsb0JBQTVELEVBQWtGQyxrQkFBbEYsQ0FKdEI7O0FBTUEsV0FBT1QsYUFBUDtBQUNELEdBUnNDLENBUXJDWixJQVJxQyxDQVFoQyxJQVJnQyxDQUF0QixDQUF2Qjs7QUFVQSxTQUFPckIsY0FBUDtBQUNEIiwiZmlsZSI6Im1hc2tpbmdGYWNldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi9jb25zdGFudHMnKSxcbiAgICAgIEVkZ2VJblhZUGxhbmUgPSByZXF1aXJlKCcuL2VkZ2VJblhZUGxhbmUnKSxcbiAgICAgIFZlcnRpY2FsTGluZUluWFlQbGFuZSA9IHJlcXVpcmUoJy4vdmVydGljYWxMaW5lSW5YWVBsYW5lJyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICBmYWNldFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2ZhY2V0JyksXG4gICAgICByb3RhdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JvdGF0aW9uJyk7XG5cbmNvbnN0IHsgVkVSVElDRVNfTEVOR1RIIH0gPSBjb25zdGFudHMsXG4gICAgICB7IHB1c2gsIHNlcGFyYXRlIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgcm90YXRlVmVydGljZXMgfSA9IGZhY2V0VXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVSb3RhdGlvblF1YXRlcm5pb24sIGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uLCBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gfSA9IHJvdGF0aW9uVXRpbGl0aWVzO1xuXG5jbGFzcyBNYXNraW5nRmFjZXQge1xuICBjb25zdHJ1Y3RvcihlZGdlc0luWFlQbGFuZSwgdmVydGljYWxMaW5lc0luWFlQbGFuZSwgZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24sIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbikge1xuICAgIHRoaXMuZWRnZXNJblhZUGxhbmUgPSBlZGdlc0luWFlQbGFuZTtcbiAgICB0aGlzLnZlcnRpY2FsTGluZXNJblhZUGxhbmUgPSB2ZXJ0aWNhbExpbmVzSW5YWVBsYW5lO1xuICAgIHRoaXMuZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgICB0aGlzLmJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIGdldEVkZ2VzSW5YWVBsYW5lKCkge1xuICAgIHJldHVybiB0aGlzLmVkZ2VzSW5YWVBsYW5lO1xuICB9XG5cbiAgZ2V0VmVydGljYWxMaW5lc0luWFlQbGFuZSgpIHtcbiAgICByZXR1cm4gdGhpcy52ZXJ0aWNhbExpbmVzSW5YWVBsYW5lO1xuICB9XG5cbiAgZ2V0Rm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gIH1cblxuICBnZXRCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xuICB9XG5cbiAgbWFza0ZhY2V0KGZhY2V0LCB1bm1hc2tlZEZhY2V0cykge1xuICAgIGNvbnN0IHVubWFza2VkRmFjZXQgPSBmYWNldC5jbG9uZSgpO1xuXG4gICAgZmFjZXQucm90YXRlKHRoaXMuZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pO1xuXG4gICAgY29uc3QgbWFza2luZ0ZhY2V0ID0gdGhpcywgIC8vL1xuICAgICAgICAgIHNtYWxsZXJGYWNldHMgPSB0aGlzLnNwbGl0RmFjZXQoZmFjZXQpLFxuICAgICAgICAgIG1hc2tlZFNtYWxsZXJGYWNldHMgPSBbXSxcbiAgICAgICAgICB1bm1hc2tlZFNtYWxsZXJGYWNldHMgPSBbXTtcblxuICAgIHNlcGFyYXRlKHNtYWxsZXJGYWNldHMsIG1hc2tlZFNtYWxsZXJGYWNldHMsIHVubWFza2VkU21hbGxlckZhY2V0cywgZnVuY3Rpb24oc21hbGxlckZhY2V0KSB7XG4gICAgICBjb25zdCBzbWFsbGVyRmFjZXRNYXNrZWQgPSBzbWFsbGVyRmFjZXQuaXNNYXNrZWQobWFza2luZ0ZhY2V0KTtcblxuICAgICAgcmV0dXJuIHNtYWxsZXJGYWNldE1hc2tlZDtcbiAgICB9KTtcblxuICAgIGNvbnN0IG1hc2tlZFNtYWxsZXJGYWNldHNMZW5ndGggPSBtYXNrZWRTbWFsbGVyRmFjZXRzLmxlbmd0aDtcblxuICAgIGlmIChtYXNrZWRTbWFsbGVyRmFjZXRzTGVuZ3RoID09PSAwKSB7XG4gICAgICB1bm1hc2tlZEZhY2V0cy5wdXNoKHVubWFza2VkRmFjZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB1bm1hc2tlZFNtYWxsZXJGYWNldHMuZm9yRWFjaChmdW5jdGlvbih1bm1hc2tlZFNtYWxsZXJGYWNldCkge1xuICAgICAgICB1bm1hc2tlZFNtYWxsZXJGYWNldC5yb3RhdGUodGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pO1xuICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICAgICAgcHVzaCh1bm1hc2tlZEZhY2V0cywgdW5tYXNrZWRTbWFsbGVyRmFjZXRzKTtcbiAgICB9XG4gIH1cbiAgXG4gIHNwbGl0RmFjZXQoZmFjZXQpIHtcbiAgICBsZXQgZmFjZXRzID0gW1xuICAgICAgICAgIGZhY2V0XG4gICAgICAgIF0sXG4gICAgICAgIHNtYWxsZXJGYWNldHMgPSBmYWNldHM7IC8vL1xuXG4gICAgdGhpcy52ZXJ0aWNhbExpbmVzSW5YWVBsYW5lLmZvckVhY2goZnVuY3Rpb24odmVydGljYWxMaW5lSW5YWVBsYW5lKSB7XG4gICAgICBzbWFsbGVyRmFjZXRzID0gdmVydGljYWxMaW5lSW5YWVBsYW5lLnNwbGl0RmFjZXRzKGZhY2V0cyk7XG5cbiAgICAgIGZhY2V0cyA9IHNtYWxsZXJGYWNldHM7IC8vL1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNtYWxsZXJGYWNldHM7XG4gIH1cblxuICBzdGF0aWMgZnJvbUZhY2V0KGZhY2V0KSB7XG4gICAgY29uc3QgZmFjZXROb3JtYWwgPSBmYWNldC5nZXROb3JtYWwoKSxcbiAgICAgICAgICBmYWNldFZlcnRpY2VzID0gZmFjZXQuZ2V0VmVydGljZXMoKSxcbiAgICAgICAgICByb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVSb3RhdGlvblF1YXRlcm5pb24oZmFjZXROb3JtYWwpLFxuICAgICAgICAgIHZlcnRpY2VzSW5YWVBsYW5lID0gcm90YXRlVmVydGljZXMoZmFjZXRWZXJ0aWNlcywgcm90YXRpb25RdWF0ZXJuaW9uKSxcbiAgICAgICAgICBlZGdlc0luWFlQbGFuZSA9IGNhbGN1bGF0ZUVkZ2VzSW5YWVBsYW5lKHZlcnRpY2VzSW5YWVBsYW5lKSxcbiAgICAgICAgICB2ZXJ0aWNhbExpbmVzSW5YWVBsYW5lID0gZWRnZXNJblhZUGxhbmUubWFwKGZ1bmN0aW9uKGVkZ2VJblhZUGxhbmUpIHtcbiAgICAgICAgICAgIGNvbnN0IHZlcnRpY2FsTGluZUluWFlQbGFuZSA9IFZlcnRpY2FsTGluZUluWFlQbGFuZS5mcm9tRWRnZUluWFlQbGFuZShlZGdlSW5YWVBsYW5lKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHZlcnRpY2FsTGluZUluWFlQbGFuZTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbiksXG4gICAgICAgICAgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbiksXG4gICAgICAgICAgbWFza2luZ0ZhY2V0ID0gbmV3IE1hc2tpbmdGYWNldChlZGdlc0luWFlQbGFuZSwgdmVydGljYWxMaW5lc0luWFlQbGFuZSwgZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24sIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbik7XG5cbiAgICByZXR1cm4gbWFza2luZ0ZhY2V0O1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTWFza2luZ0ZhY2V0O1xuXG5mdW5jdGlvbiBjYWxjdWxhdGVFZGdlc0luWFlQbGFuZSh2ZXJ0aWNlc0luWFlQbGFuZSkge1xuICBjb25zdCBlZGdlc0luWFlQbGFuZSA9IHZlcnRpY2VzSW5YWVBsYW5lLm1hcChmdW5jdGlvbih2ZXJ0ZXgsIGluZGV4KSB7XG4gICAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4LFxuICAgICAgICAgICAgICAgIGVuZEluZGV4ID0gKHN0YXJ0SW5kZXggKyAxKSAlIFZFUlRJQ0VTX0xFTkdUSCxcbiAgICAgICAgICAgICAgICBzdGFydFZlcnRleEluWFlQbGFuZSA9IHZlcnRpY2VzSW5YWVBsYW5lW3N0YXJ0SW5kZXhdLFxuICAgICAgICAgICAgICAgIGVuZFZlcnRleEluWFlQbGFuZSA9IHZlcnRpY2VzSW5YWVBsYW5lW2VuZEluZGV4XSxcbiAgICAgICAgICAgICAgICBlZGdlSW5YWVBsYW5lID0gRWRnZUluWFlQbGFuZS5mcm9tU3RhcnRWZXJ0ZXhJblhZUGxhbmVBbmRFbmRWZXJ0ZXhJblhZUGxhbmUoc3RhcnRWZXJ0ZXhJblhZUGxhbmUsIGVuZFZlcnRleEluWFlQbGFuZSk7XG5cbiAgICAgICAgICByZXR1cm4gZWRnZUluWFlQbGFuZTtcbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICByZXR1cm4gZWRnZXNJblhZUGxhbmU7XG59XG4iXX0=