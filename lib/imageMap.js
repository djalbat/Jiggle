'use strict';

var sharp = require('sharp'),
    necessary = require('necessary');

var fileSystemUtilities = necessary.fileSystemUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    miscellaneousUtilities = necessary.miscellaneousUtilities,
    rc = miscellaneousUtilities.rc,
    whilst = asynchronousUtilities.whilst,
    readDirectory = fileSystemUtilities.readDirectory;


function png(imageDirectoryPath, overlayImageSize, response) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names);

  createImageMap(dimension, overlayImageSize, function (buffer) {
    var context = {
      buffer: buffer,
      names: names,
      dimension: dimension,
      overlayImageSize: overlayImageSize,
      imageDirectoryPath: imageDirectoryPath
    };

    whilst(overlayCallback, function () {
      response.writeHead(200, { 'Content-Type': 'image/png; charset=utf-8' });

      var buffer = context.buffer;


      sharp(buffer).pipe(response);
    }, context);
  });
}

function json(imageDirectoryPath) {
  var names = readDirectory(imageDirectoryPath),
      dimension = dimensionFromNames(names),
      json = names.reduce(function (json, name, index) {
    var left = index % dimension / dimension,
        bottom = Math.floor(index / dimension) / dimension,
        width = 1 / dimension,
        height = 1 / dimension;

    json[name] = {
      left: left,
      bottom: bottom,
      width: width,
      height: height
    };

    return json;
  }, {});

  return json;
}

module.exports = {
  respond: respond,
  json: json
};

function createImageMap(dimension, overlayImageSize, callback) {
  var width = dimension * overlayImageSize,
      height = dimension * overlayImageSize,
      channels = 4,
      background = { r: 0, g: 0, b: 0, alpha: 0 },
      options = {
    width: width,
    height: height,
    channels: channels,
    background: background
  },
      imageMap = sharp({
    create: options ///
  });

  imageMap.png().toBuffer().then(function (buffer) {
    callback(buffer);
  });
}

function overlayCallback(next, done, context, index) {
  var names = context.names,
      buffer = context.buffer,
      dimension = context.dimension,
      overlayImageSize = context.overlayImageSize,
      imageDirectoryPath = context.imageDirectoryPath,
      namesLength = names.length,
      lastIndex = namesLength - 1;


  if (index > lastIndex) {
    done();

    return;
  }

  var name = names[index],
      path = imageDirectoryPath + '/' + name;

  resizeImage(path, overlayImageSize, function (resizedImageBuffer) {
    var top = (dimension - 1 - Math.floor(index / dimension)) * overlayImageSize,
        left = index % dimension * overlayImageSize,
        options = {
      top: top,
      left: left
    };

    sharp(buffer).overlayWith(resizedImageBuffer, options).toBuffer().then(function (buffer) {
      Object.assign(context, {
        buffer: buffer
      });

      next();
    });
  });
}

function resizeImage(path, overlayImageSize, callback) {
  var width = overlayImageSize,
      ///
  height = overlayImageSize; ///

  sharp(path).resize(width, height).toBuffer().then(function (buffer) {
    var resizedImageBuffer = buffer; ///

    callback(resizedImageBuffer);
  });
}

function dimensionFromNames(names) {
  var namesLength = names.length,
      dimension = Math.ceil(Math.sqrt(namesLength)); ///

  return dimension;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9pbWFnZU1hcC5qcyJdLCJuYW1lcyI6WyJzaGFycCIsInJlcXVpcmUiLCJuZWNlc3NhcnkiLCJmaWxlU3lzdGVtVXRpbGl0aWVzIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwibWlzY2VsbGFuZW91c1V0aWxpdGllcyIsInJjIiwid2hpbHN0IiwicmVhZERpcmVjdG9yeSIsInBuZyIsImltYWdlRGlyZWN0b3J5UGF0aCIsIm92ZXJsYXlJbWFnZVNpemUiLCJyZXNwb25zZSIsIm5hbWVzIiwiZGltZW5zaW9uIiwiZGltZW5zaW9uRnJvbU5hbWVzIiwiY3JlYXRlSW1hZ2VNYXAiLCJidWZmZXIiLCJjb250ZXh0Iiwib3ZlcmxheUNhbGxiYWNrIiwid3JpdGVIZWFkIiwicGlwZSIsImpzb24iLCJyZWR1Y2UiLCJuYW1lIiwiaW5kZXgiLCJsZWZ0IiwiYm90dG9tIiwiTWF0aCIsImZsb29yIiwid2lkdGgiLCJoZWlnaHQiLCJtb2R1bGUiLCJleHBvcnRzIiwicmVzcG9uZCIsImNhbGxiYWNrIiwiY2hhbm5lbHMiLCJiYWNrZ3JvdW5kIiwiciIsImciLCJiIiwiYWxwaGEiLCJvcHRpb25zIiwiaW1hZ2VNYXAiLCJjcmVhdGUiLCJ0b0J1ZmZlciIsInRoZW4iLCJuZXh0IiwiZG9uZSIsIm5hbWVzTGVuZ3RoIiwibGVuZ3RoIiwibGFzdEluZGV4IiwicGF0aCIsInJlc2l6ZUltYWdlIiwicmVzaXplZEltYWdlQnVmZmVyIiwidG9wIiwib3ZlcmxheVdpdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJyZXNpemUiLCJjZWlsIiwic3FydCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsUUFBUUMsUUFBUSxPQUFSLENBQWQ7QUFBQSxJQUNNQyxZQUFZRCxRQUFRLFdBQVIsQ0FEbEI7O0lBR1FFLG1CLEdBQXVFRCxTLENBQXZFQyxtQjtJQUFxQkMscUIsR0FBa0RGLFMsQ0FBbERFLHFCO0lBQXVCQyxzQixHQUEyQkgsUyxDQUEzQkcsc0I7SUFDNUNDLEUs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QzFCb0IsV0FBU3BCLGdCQURmLENBRHFELENBRW5COztBQUVsQ1gsUUFBTW9ELElBQU4sRUFDR08sTUFESCxDQUNVN0IsS0FEVixFQUNpQkMsTUFEakIsRUFFR2MsUUFGSCxHQUdHQyxJQUhILENBR1EsVUFBUzdCLE1BQVQsRUFBaUI7QUFDckIsUUFBTXFDLHFCQUFxQnJDLE1BQTNCLENBRHFCLENBQ2M7O0FBRW5Da0IsYUFBU21CLGtCQUFUO0FBQ0QsR0FQSDtBQVFEOztBQUVELFNBQVN2QyxrQkFBVCxDQUE0QkYsS0FBNUIsRUFBbUM7QUFDakMsTUFBTW9DLGNBQWNwQyxNQUFNcUMsTUFBMUI7QUFBQSxNQUNNcEMsWUFBWWMsS0FBS2dDLElBQUwsQ0FBVWhDLEtBQUtpQyxJQUFMLENBQVVaLFdBQVYsQ0FBVixDQURsQixDQURpQyxDQUVvQjs7QUFFckQsU0FBT25DLFNBQVA7QUFDRCIsImZpbGUiOiJpbWFnZU1hcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3Qgc2hhcnAgPSByZXF1aXJlKCdzaGFycCcpLFxuICAgICAgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IHsgZmlsZVN5c3RlbVV0aWxpdGllcywgYXN5bmNocm9ub3VzVXRpbGl0aWVzLCBtaXNjZWxsYW5lb3VzVXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IHJjIH0gPSBtaXNjZWxsYW5lb3VzVXRpbGl0aWVzLFxuICAgICAgeyB3aGlsc3QgfSA9IGFzeW5jaHJvbm91c1V0aWxpdGllcyxcbiAgICAgIHsgcmVhZERpcmVjdG9yeSB9ID0gZmlsZVN5c3RlbVV0aWxpdGllcztcblxuZnVuY3Rpb24gcG5nKGltYWdlRGlyZWN0b3J5UGF0aCwgb3ZlcmxheUltYWdlU2l6ZSwgcmVzcG9uc2UpIHtcbiAgY29uc3QgbmFtZXMgPSByZWFkRGlyZWN0b3J5KGltYWdlRGlyZWN0b3J5UGF0aCksXG4gICAgICAgIGRpbWVuc2lvbiA9IGRpbWVuc2lvbkZyb21OYW1lcyhuYW1lcyk7XG5cbiAgY3JlYXRlSW1hZ2VNYXAoZGltZW5zaW9uLCBvdmVybGF5SW1hZ2VTaXplLCBmdW5jdGlvbihidWZmZXIpIHtcbiAgICBjb25zdCBjb250ZXh0ID0ge1xuICAgICAgYnVmZmVyOiBidWZmZXIsXG4gICAgICBuYW1lczogbmFtZXMsXG4gICAgICBkaW1lbnNpb246IGRpbWVuc2lvbixcbiAgICAgIG92ZXJsYXlJbWFnZVNpemU6IG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICBpbWFnZURpcmVjdG9yeVBhdGg6IGltYWdlRGlyZWN0b3J5UGF0aFxuICAgIH07XG4gICAgXG4gICAgd2hpbHN0KG92ZXJsYXlDYWxsYmFjaywgZnVuY3Rpb24oKSB7XG4gICAgICByZXNwb25zZS53cml0ZUhlYWQoMjAwLCB7J0NvbnRlbnQtVHlwZSc6ICdpbWFnZS9wbmc7IGNoYXJzZXQ9dXRmLTgnfSk7XG5cbiAgICAgIGNvbnN0IHsgYnVmZmVyIH0gPSBjb250ZXh0O1xuXG4gICAgICBzaGFycChidWZmZXIpLnBpcGUocmVzcG9uc2UpO1xuICAgIH0sIGNvbnRleHQpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24ganNvbihpbWFnZURpcmVjdG9yeVBhdGgpIHtcbiAgY29uc3QgbmFtZXMgPSByZWFkRGlyZWN0b3J5KGltYWdlRGlyZWN0b3J5UGF0aCksXG4gICAgICAgIGRpbWVuc2lvbiA9IGRpbWVuc2lvbkZyb21OYW1lcyhuYW1lcyksXG4gICAgICAgIGpzb24gPSBuYW1lcy5yZWR1Y2UoZnVuY3Rpb24oanNvbiwgbmFtZSwgaW5kZXgpIHtcbiAgICAgICAgICBjb25zdCBsZWZ0ID0gKGluZGV4ICUgZGltZW5zaW9uKSAvIGRpbWVuc2lvbixcbiAgICAgICAgICAgICAgICBib3R0b20gPSBNYXRoLmZsb29yKGluZGV4IC8gZGltZW5zaW9uKSAvIGRpbWVuc2lvbixcbiAgICAgICAgICAgICAgICB3aWR0aCA9IDEgLyBkaW1lbnNpb24sXG4gICAgICAgICAgICAgICAgaGVpZ2h0ID0gMSAvIGRpbWVuc2lvbjtcblxuICAgICAgICAgIGpzb25bbmFtZV0gPSB7XG4gICAgICAgICAgICBsZWZ0OiBsZWZ0LFxuICAgICAgICAgICAgYm90dG9tOiBib3R0b20sXG4gICAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgICBoZWlnaHQ6IGhlaWdodFxuICAgICAgICAgIH07XG5cbiAgICAgICAgICByZXR1cm4ganNvbjtcbiAgICAgICAgfSwge30pO1xuICAgICAgICBcbiAgcmV0dXJuIGpzb247XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICByZXNwb25kOiByZXNwb25kLFxuICBqc29uOiBqc29uXG59O1xuXG5mdW5jdGlvbiBjcmVhdGVJbWFnZU1hcChkaW1lbnNpb24sIG92ZXJsYXlJbWFnZVNpemUsICBjYWxsYmFjaykge1xuICBjb25zdCB3aWR0aCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGhlaWdodCA9IGRpbWVuc2lvbiAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgIGNoYW5uZWxzID0gNCxcbiAgICAgICAgYmFja2dyb3VuZCA9IHsgcjogMCwgZzogMCwgYjogMCwgYWxwaGE6IDAgfSxcbiAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICB3aWR0aDogd2lkdGgsXG4gICAgICAgICAgaGVpZ2h0OiBoZWlnaHQsXG4gICAgICAgICAgY2hhbm5lbHM6IGNoYW5uZWxzLFxuICAgICAgICAgIGJhY2tncm91bmQ6IGJhY2tncm91bmRcbiAgICAgICAgfSxcbiAgICAgICAgaW1hZ2VNYXAgPSBzaGFycCh7XG4gICAgICAgICAgY3JlYXRlOiBvcHRpb25zIC8vL1xuICAgICAgICB9KTtcblxuICBpbWFnZU1hcFxuICAgIC5wbmcoKVxuICAgIC50b0J1ZmZlcigpXG4gICAgLnRoZW4oZnVuY3Rpb24oYnVmZmVyKSB7XG4gICAgICBjYWxsYmFjayhidWZmZXIpXG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIG92ZXJsYXlDYWxsYmFjayhuZXh0LCBkb25lLCBjb250ZXh0LCBpbmRleCkge1xuICBjb25zdCB7IG5hbWVzLCBidWZmZXIsIGRpbWVuc2lvbiwgb3ZlcmxheUltYWdlU2l6ZSwgaW1hZ2VEaXJlY3RvcnlQYXRoIH0gPSBjb250ZXh0LFxuICAgICAgICBuYW1lc0xlbmd0aCA9IG5hbWVzLmxlbmd0aCxcbiAgICAgICAgbGFzdEluZGV4ID0gbmFtZXNMZW5ndGggLSAxO1xuXG4gIGlmIChpbmRleCA+IGxhc3RJbmRleCkge1xuICAgIGRvbmUoKTtcbiAgICBcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIGNvbnN0IG5hbWUgPSBuYW1lc1tpbmRleF0sXG4gICAgICAgIHBhdGggPSBgJHtpbWFnZURpcmVjdG9yeVBhdGh9LyR7bmFtZX1gO1xuXG4gIHJlc2l6ZUltYWdlKHBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIGZ1bmN0aW9uKHJlc2l6ZWRJbWFnZUJ1ZmZlcikge1xuICAgIGNvbnN0IHRvcCA9ICgoZGltZW5zaW9uIC0gMSkgLSBNYXRoLmZsb29yKGluZGV4IC8gZGltZW5zaW9uKSApICogb3ZlcmxheUltYWdlU2l6ZSxcbiAgICAgICAgICBsZWZ0ID0gKGluZGV4ICUgZGltZW5zaW9uKSAqIG92ZXJsYXlJbWFnZVNpemUsXG4gICAgICAgICAgb3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHRvcDogdG9wLFxuICAgICAgICAgICAgbGVmdDogbGVmdFxuICAgICAgICAgIH07XG5cbiAgICBzaGFycChidWZmZXIpXG4gICAgICAub3ZlcmxheVdpdGgocmVzaXplZEltYWdlQnVmZmVyLCBvcHRpb25zKVxuICAgICAgLnRvQnVmZmVyKClcbiAgICAgIC50aGVuKGZ1bmN0aW9uKGJ1ZmZlcikge1xuICAgICAgICBPYmplY3QuYXNzaWduKGNvbnRleHQsIHtcbiAgICAgICAgICBidWZmZXI6IGJ1ZmZlclxuICAgICAgICB9KTtcblxuICAgICAgICBuZXh0KCk7XG4gICAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlc2l6ZUltYWdlKHBhdGgsIG92ZXJsYXlJbWFnZVNpemUsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHdpZHRoID0gb3ZlcmxheUltYWdlU2l6ZSwgLy8vXG4gICAgICAgIGhlaWdodCA9IG92ZXJsYXlJbWFnZVNpemU7ICAvLy9cbiAgXG4gIHNoYXJwKHBhdGgpXG4gICAgLnJlc2l6ZSh3aWR0aCwgaGVpZ2h0KVxuICAgIC50b0J1ZmZlcigpXG4gICAgLnRoZW4oZnVuY3Rpb24oYnVmZmVyKSB7XG4gICAgICBjb25zdCByZXNpemVkSW1hZ2VCdWZmZXIgPSBidWZmZXI7IC8vL1xuICAgICAgXG4gICAgICBjYWxsYmFjayhyZXNpemVkSW1hZ2VCdWZmZXIpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBkaW1lbnNpb25Gcm9tTmFtZXMobmFtZXMpIHtcbiAgY29uc3QgbmFtZXNMZW5ndGggPSBuYW1lcy5sZW5ndGgsXG4gICAgICAgIGRpbWVuc2lvbiA9IE1hdGguY2VpbChNYXRoLnNxcnQobmFtZXNMZW5ndGgpKTsgLy8vXG5cbiAgcmV0dXJuIGRpbWVuc2lvbjtcbn1cbiJdfQ==