"use strict";

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var constants = require("../constants"),
    MaskingEdge = require("./edge/masking"),
    VerticalLine = require("./verticalLine"),
    arrayUtilities = require("../utilities/array"),
    verticesUtilities = require("../utilities/vertices"),
    quaternionUtilities = require("../utilities/quaternion");

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    push = arrayUtilities.push,
    separate = arrayUtilities.separate,
    rotateVertices = verticesUtilities.rotateVertices,
    calculateArbitraryRotationQuaternion = quaternionUtilities.calculateArbitraryRotationQuaternion,
    calculateForwardsRotationQuaternion = quaternionUtilities.calculateForwardsRotationQuaternion,
    calculateBackwardsRotationQuaternion = quaternionUtilities.calculateBackwardsRotationQuaternion;

var MaskingFacet = /*#__PURE__*/function () {
  function MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion) {
    _classCallCheck(this, MaskingFacet);

    this.maskingEdges = maskingEdges;
    this.verticalLines = verticalLines;
    this.forwardsRotationQuaternion = forwardsRotationQuaternion;
    this.backwardsRotationQuaternion = backwardsRotationQuaternion;
  }

  _createClass(MaskingFacet, [{
    key: "getMaskingEdges",
    value: function getMaskingEdges() {
      return this.maskingEdges;
    }
  }, {
    key: "getVerticalLines",
    value: function getVerticalLines() {
      return this.verticalLines;
    }
  }, {
    key: "getForwardsRotationQuaternion",
    value: function getForwardsRotationQuaternion() {
      return this.forwardsRotationQuaternion;
    }
  }, {
    key: "getBackwardsRotationQuaternion",
    value: function getBackwardsRotationQuaternion() {
      return this.backwardsRotationQuaternion;
    }
  }, {
    key: "maskFacet",
    value: function maskFacet(facet, unmaskedFacets) {
      var _this = this;

      var unmaskedFacet = facet.clone(); ///

      facet.rotate(this.forwardsRotationQuaternion);
      var maskingFacet = this,
          ///
      smallerFacets = this.splitFacet(facet),
          maskedSmallerFacets = [],
          unmaskedSmallerFacets = [];
      separate(smallerFacets, maskedSmallerFacets, unmaskedSmallerFacets, function (smallerFacet) {
        var smallerFacetMasked = smallerFacet.isMasked(maskingFacet);
        return smallerFacetMasked;
      });
      var maskedSmallerFacetsLength = maskedSmallerFacets.length;

      if (maskedSmallerFacetsLength === 0) {
        unmaskedFacets.push(unmaskedFacet);
      } else {
        unmaskedSmallerFacets.forEach(function (unmaskedSmallerFacet) {
          unmaskedSmallerFacet.rotate(_this.backwardsRotationQuaternion);
        });
        push(unmaskedFacets, unmaskedSmallerFacets);
      }
    }
  }, {
    key: "splitFacet",
    value: function splitFacet(facet) {
      var facets = [facet],
          smallerFacets = facets; ///

      this.verticalLines.forEach(function (verticalLine) {
        smallerFacets = verticalLine.splitFacets(facets);
        facets = smallerFacets; ///
      });
      return smallerFacets;
    }
  }], [{
    key: "fromFacet",
    value: function fromFacet(facet) {
      var facetNormal = facet.getNormal(),
          facetVertices = facet.getVertices(),
          normal = facetNormal,
          ///
      arbitraryRotationQuaternion = calculateArbitraryRotationQuaternion(normal),
          rotationQuaternion = arbitraryRotationQuaternion,
          ///
      vertices = rotateVertices(facetVertices, rotationQuaternion),
          maskingEdges = calculateMaskingEdges(vertices),
          verticalLines = maskingEdges.map(function (maskingEdge) {
        var verticalLine = VerticalLine.fromMaskingEdge(maskingEdge);
        return verticalLine;
      }),
          forwardsRotationQuaternion = calculateForwardsRotationQuaternion(rotationQuaternion),
          backwardsRotationQuaternion = calculateBackwardsRotationQuaternion(rotationQuaternion),
          maskingFacet = new MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion);
      return maskingFacet;
    }
  }]);

  return MaskingFacet;
}();

module.exports = MaskingFacet;

function calculateMaskingEdges(vertices) {
  var maskingEdges = vertices.map(function (vertex, index) {
    var startIndex = index,
        endIndex = (startIndex + 1) % VERTICES_LENGTH,
        startVertex = vertices[startIndex],
        endVertex = vertices[endIndex],
        maskingEdge = MaskingEdge.fromStartVertexAndEndVertex(startVertex, endVertex);
    return maskingEdge;
  });
  return maskingEdges;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hc2tpbmdGYWNldC5qcyJdLCJuYW1lcyI6WyJjb25zdGFudHMiLCJyZXF1aXJlIiwiTWFza2luZ0VkZ2UiLCJWZXJ0aWNhbExpbmUiLCJhcnJheVV0aWxpdGllcyIsInZlcnRpY2VzVXRpbGl0aWVzIiwicXVhdGVybmlvblV0aWxpdGllcyIsIlZFUlRJQ0VTX0xFTkdUSCIsInB1c2giLCJzZXBhcmF0ZSIsInJvdGF0ZVZlcnRpY2VzIiwiY2FsY3VsYXRlQXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJNYXNraW5nRmFjZXQiLCJtYXNraW5nRWRnZXMiLCJ2ZXJ0aWNhbExpbmVzIiwiZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJmYWNldCIsInVubWFza2VkRmFjZXRzIiwidW5tYXNrZWRGYWNldCIsImNsb25lIiwicm90YXRlIiwibWFza2luZ0ZhY2V0Iiwic21hbGxlckZhY2V0cyIsInNwbGl0RmFjZXQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzIiwidW5tYXNrZWRTbWFsbGVyRmFjZXRzIiwic21hbGxlckZhY2V0Iiwic21hbGxlckZhY2V0TWFza2VkIiwiaXNNYXNrZWQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzTGVuZ3RoIiwibGVuZ3RoIiwiZm9yRWFjaCIsInVubWFza2VkU21hbGxlckZhY2V0IiwiZmFjZXRzIiwidmVydGljYWxMaW5lIiwic3BsaXRGYWNldHMiLCJmYWNldE5vcm1hbCIsImdldE5vcm1hbCIsImZhY2V0VmVydGljZXMiLCJnZXRWZXJ0aWNlcyIsIm5vcm1hbCIsImFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbiIsInJvdGF0aW9uUXVhdGVybmlvbiIsInZlcnRpY2VzIiwiY2FsY3VsYXRlTWFza2luZ0VkZ2VzIiwibWFwIiwibWFza2luZ0VkZ2UiLCJmcm9tTWFza2luZ0VkZ2UiLCJtb2R1bGUiLCJleHBvcnRzIiwidmVydGV4IiwiaW5kZXgiLCJzdGFydEluZGV4IiwiZW5kSW5kZXgiLCJzdGFydFZlcnRleCIsImVuZFZlcnRleCIsImZyb21TdGFydFZlcnRleEFuZEVuZFZlcnRleCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0FBRUEsSUFBTUEsU0FBUyxHQUFHQyxPQUFPLENBQUMsY0FBRCxDQUF6QjtBQUFBLElBQ01DLFdBQVcsR0FBR0QsT0FBTyxDQUFDLGdCQUFELENBRDNCO0FBQUEsSUFFTUUsWUFBWSxHQUFHRixPQUFPLENBQUMsZ0JBQUQsQ0FGNUI7QUFBQSxJQUdNRyxjQUFjLEdBQUdILE9BQU8sQ0FBQyxvQkFBRCxDQUg5QjtBQUFBLElBSU1JLGlCQUFpQixHQUFHSixPQUFPLENBQUMsdUJBQUQsQ0FKakM7QUFBQSxJQUtNSyxtQkFBbUIsR0FBR0wsT0FBTyxDQUFDLHlCQUFELENBTG5DOztBQU9NLElBQUVNLGVBQUYsR0FBc0JQLFNBQXRCLENBQUVPLGVBQUY7QUFBQSxJQUNFQyxJQURGLEdBQ3FCSixjQURyQixDQUNFSSxJQURGO0FBQUEsSUFDUUMsUUFEUixHQUNxQkwsY0FEckIsQ0FDUUssUUFEUjtBQUFBLElBRUVDLGNBRkYsR0FFcUJMLGlCQUZyQixDQUVFSyxjQUZGO0FBQUEsSUFHRUMsb0NBSEYsR0FHc0hMLG1CQUh0SCxDQUdFSyxvQ0FIRjtBQUFBLElBR3dDQyxtQ0FIeEMsR0FHc0hOLG1CQUh0SCxDQUd3Q00sbUNBSHhDO0FBQUEsSUFHNkVDLG9DQUg3RSxHQUdzSFAsbUJBSHRILENBRzZFTyxvQ0FIN0U7O0lBS0FDLFk7QUFDSix3QkFBWUMsWUFBWixFQUEwQkMsYUFBMUIsRUFBeUNDLDBCQUF6QyxFQUFxRUMsMkJBQXJFLEVBQWtHO0FBQUE7O0FBQ2hHLFNBQUtILFlBQUwsR0FBb0JBLFlBQXBCO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQkEsYUFBckI7QUFDQSxTQUFLQywwQkFBTCxHQUFrQ0EsMEJBQWxDO0FBQ0EsU0FBS0MsMkJBQUwsR0FBbUNBLDJCQUFuQztBQUNEOzs7O3NDQUVpQjtBQUNoQixhQUFPLEtBQUtILFlBQVo7QUFDRDs7O3VDQUVrQjtBQUNqQixhQUFPLEtBQUtDLGFBQVo7QUFDRDs7O29EQUUrQjtBQUM5QixhQUFPLEtBQUtDLDBCQUFaO0FBQ0Q7OztxREFFZ0M7QUFDL0IsYUFBTyxLQUFLQywyQkFBWjtBQUNEOzs7OEJBRVNDLEssRUFBT0MsYyxFQUFnQjtBQUFBOztBQUMvQixVQUFNQyxhQUFhLEdBQUdGLEtBQUssQ0FBQ0csS0FBTixFQUF0QixDQUQrQixDQUNPOztBQUV0Q0gsTUFBQUEsS0FBSyxDQUFDSSxNQUFOLENBQWEsS0FBS04sMEJBQWxCO0FBRUEsVUFBTU8sWUFBWSxHQUFHLElBQXJCO0FBQUEsVUFBNEI7QUFDdEJDLE1BQUFBLGFBQWEsR0FBRyxLQUFLQyxVQUFMLENBQWdCUCxLQUFoQixDQUR0QjtBQUFBLFVBRU1RLG1CQUFtQixHQUFHLEVBRjVCO0FBQUEsVUFHTUMscUJBQXFCLEdBQUcsRUFIOUI7QUFLQW5CLE1BQUFBLFFBQVEsQ0FBQ2dCLGFBQUQsRUFBZ0JFLG1CQUFoQixFQUFxQ0MscUJBQXJDLEVBQTRELFVBQUNDLFlBQUQsRUFBa0I7QUFDcEYsWUFBTUMsa0JBQWtCLEdBQUdELFlBQVksQ0FBQ0UsUUFBYixDQUFzQlAsWUFBdEIsQ0FBM0I7QUFFQSxlQUFPTSxrQkFBUDtBQUNELE9BSk8sQ0FBUjtBQU1BLFVBQU1FLHlCQUF5QixHQUFHTCxtQkFBbUIsQ0FBQ00sTUFBdEQ7O0FBRUEsVUFBSUQseUJBQXlCLEtBQUssQ0FBbEMsRUFBcUM7QUFDbkNaLFFBQUFBLGNBQWMsQ0FBQ1osSUFBZixDQUFvQmEsYUFBcEI7QUFDRCxPQUZELE1BRU87QUFDTE8sUUFBQUEscUJBQXFCLENBQUNNLE9BQXRCLENBQThCLFVBQUNDLG9CQUFELEVBQTBCO0FBQ3REQSxVQUFBQSxvQkFBb0IsQ0FBQ1osTUFBckIsQ0FBNEIsS0FBSSxDQUFDTCwyQkFBakM7QUFDRCxTQUZEO0FBSUFWLFFBQUFBLElBQUksQ0FBQ1ksY0FBRCxFQUFpQlEscUJBQWpCLENBQUo7QUFDRDtBQUNGOzs7K0JBRVVULEssRUFBTztBQUNoQixVQUFJaUIsTUFBTSxHQUFHLENBQ1BqQixLQURPLENBQWI7QUFBQSxVQUdJTSxhQUFhLEdBQUdXLE1BSHBCLENBRGdCLENBSVk7O0FBRTVCLFdBQUtwQixhQUFMLENBQW1Ca0IsT0FBbkIsQ0FBMkIsVUFBQ0csWUFBRCxFQUFrQjtBQUMzQ1osUUFBQUEsYUFBYSxHQUFHWSxZQUFZLENBQUNDLFdBQWIsQ0FBeUJGLE1BQXpCLENBQWhCO0FBRUFBLFFBQUFBLE1BQU0sR0FBR1gsYUFBVCxDQUgyQyxDQUduQjtBQUN6QixPQUpEO0FBTUEsYUFBT0EsYUFBUDtBQUNEOzs7OEJBRWdCTixLLEVBQU87QUFDdEIsVUFBTW9CLFdBQVcsR0FBR3BCLEtBQUssQ0FBQ3FCLFNBQU4sRUFBcEI7QUFBQSxVQUNNQyxhQUFhLEdBQUd0QixLQUFLLENBQUN1QixXQUFOLEVBRHRCO0FBQUEsVUFFTUMsTUFBTSxHQUFHSixXQUZmO0FBQUEsVUFFNEI7QUFDdEJLLE1BQUFBLDJCQUEyQixHQUFHakMsb0NBQW9DLENBQUNnQyxNQUFELENBSHhFO0FBQUEsVUFJTUUsa0JBQWtCLEdBQUdELDJCQUozQjtBQUFBLFVBSXdEO0FBQ2xERSxNQUFBQSxRQUFRLEdBQUdwQyxjQUFjLENBQUMrQixhQUFELEVBQWdCSSxrQkFBaEIsQ0FML0I7QUFBQSxVQU1NOUIsWUFBWSxHQUFHZ0MscUJBQXFCLENBQUNELFFBQUQsQ0FOMUM7QUFBQSxVQU9NOUIsYUFBYSxHQUFHRCxZQUFZLENBQUNpQyxHQUFiLENBQWlCLFVBQUNDLFdBQUQsRUFBaUI7QUFDaEQsWUFBTVosWUFBWSxHQUFHbEMsWUFBWSxDQUFDK0MsZUFBYixDQUE2QkQsV0FBN0IsQ0FBckI7QUFFQSxlQUFPWixZQUFQO0FBQ0QsT0FKZSxDQVB0QjtBQUFBLFVBWU1wQiwwQkFBMEIsR0FBR0wsbUNBQW1DLENBQUNpQyxrQkFBRCxDQVp0RTtBQUFBLFVBYU0zQiwyQkFBMkIsR0FBR0wsb0NBQW9DLENBQUNnQyxrQkFBRCxDQWJ4RTtBQUFBLFVBY01yQixZQUFZLEdBQUcsSUFBSVYsWUFBSixDQUFpQkMsWUFBakIsRUFBK0JDLGFBQS9CLEVBQThDQywwQkFBOUMsRUFBMEVDLDJCQUExRSxDQWRyQjtBQWdCQSxhQUFPTSxZQUFQO0FBQ0Q7Ozs7OztBQUdIMkIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEMsWUFBakI7O0FBRUEsU0FBU2lDLHFCQUFULENBQStCRCxRQUEvQixFQUF5QztBQUN2QyxNQUFNL0IsWUFBWSxHQUFHK0IsUUFBUSxDQUFDRSxHQUFULENBQWEsVUFBQ0ssTUFBRCxFQUFTQyxLQUFULEVBQW1CO0FBQzdDLFFBQU1DLFVBQVUsR0FBR0QsS0FBbkI7QUFBQSxRQUNNRSxRQUFRLEdBQUcsQ0FBQ0QsVUFBVSxHQUFHLENBQWQsSUFBbUJoRCxlQURwQztBQUFBLFFBRU1rRCxXQUFXLEdBQUdYLFFBQVEsQ0FBQ1MsVUFBRCxDQUY1QjtBQUFBLFFBR01HLFNBQVMsR0FBR1osUUFBUSxDQUFDVSxRQUFELENBSDFCO0FBQUEsUUFJTVAsV0FBVyxHQUFHL0MsV0FBVyxDQUFDeUQsMkJBQVosQ0FBd0NGLFdBQXhDLEVBQXFEQyxTQUFyRCxDQUpwQjtBQU1BLFdBQU9ULFdBQVA7QUFDRCxHQVJjLENBQXJCO0FBVUEsU0FBT2xDLFlBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCBjb25zdGFudHMgPSByZXF1aXJlKFwiLi4vY29uc3RhbnRzXCIpLFxuICAgICAgTWFza2luZ0VkZ2UgPSByZXF1aXJlKFwiLi9lZGdlL21hc2tpbmdcIiksXG4gICAgICBWZXJ0aWNhbExpbmUgPSByZXF1aXJlKFwiLi92ZXJ0aWNhbExpbmVcIiksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoXCIuLi91dGlsaXRpZXMvYXJyYXlcIiksXG4gICAgICB2ZXJ0aWNlc1V0aWxpdGllcyA9IHJlcXVpcmUoXCIuLi91dGlsaXRpZXMvdmVydGljZXNcIiksXG4gICAgICBxdWF0ZXJuaW9uVXRpbGl0aWVzID0gcmVxdWlyZShcIi4uL3V0aWxpdGllcy9xdWF0ZXJuaW9uXCIpO1xuXG5jb25zdCB7IFZFUlRJQ0VTX0xFTkdUSCB9ID0gY29uc3RhbnRzLFxuICAgICAgeyBwdXNoLCBzZXBhcmF0ZSB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJvdGF0ZVZlcnRpY2VzIH0gPSB2ZXJ0aWNlc1V0aWxpdGllcyxcbiAgICAgIHsgY2FsY3VsYXRlQXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uLCBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIH0gPSBxdWF0ZXJuaW9uVXRpbGl0aWVzO1xuXG5jbGFzcyBNYXNraW5nRmFjZXQge1xuICBjb25zdHJ1Y3RvcihtYXNraW5nRWRnZXMsIHZlcnRpY2FsTGluZXMsIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uLCBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgICB0aGlzLm1hc2tpbmdFZGdlcyA9IG1hc2tpbmdFZGdlcztcbiAgICB0aGlzLnZlcnRpY2FsTGluZXMgPSB2ZXJ0aWNhbExpbmVzO1xuICAgIHRoaXMuZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgICB0aGlzLmJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIGdldE1hc2tpbmdFZGdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5tYXNraW5nRWRnZXM7XG4gIH1cblxuICBnZXRWZXJ0aWNhbExpbmVzKCkge1xuICAgIHJldHVybiB0aGlzLnZlcnRpY2FsTGluZXM7XG4gIH1cblxuICBnZXRGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5mb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbiAgfVxuXG4gIGdldEJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gIH1cblxuICBtYXNrRmFjZXQoZmFjZXQsIHVubWFza2VkRmFjZXRzKSB7XG4gICAgY29uc3QgdW5tYXNrZWRGYWNldCA9IGZhY2V0LmNsb25lKCk7ICAvLy9cblxuICAgIGZhY2V0LnJvdGF0ZSh0aGlzLmZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICAgIGNvbnN0IG1hc2tpbmdGYWNldCA9IHRoaXMsICAvLy9cbiAgICAgICAgICBzbWFsbGVyRmFjZXRzID0gdGhpcy5zcGxpdEZhY2V0KGZhY2V0KSxcbiAgICAgICAgICBtYXNrZWRTbWFsbGVyRmFjZXRzID0gW10sXG4gICAgICAgICAgdW5tYXNrZWRTbWFsbGVyRmFjZXRzID0gW107XG5cbiAgICBzZXBhcmF0ZShzbWFsbGVyRmFjZXRzLCBtYXNrZWRTbWFsbGVyRmFjZXRzLCB1bm1hc2tlZFNtYWxsZXJGYWNldHMsIChzbWFsbGVyRmFjZXQpID0+IHtcbiAgICAgIGNvbnN0IHNtYWxsZXJGYWNldE1hc2tlZCA9IHNtYWxsZXJGYWNldC5pc01hc2tlZChtYXNraW5nRmFjZXQpO1xuXG4gICAgICByZXR1cm4gc21hbGxlckZhY2V0TWFza2VkO1xuICAgIH0pO1xuXG4gICAgY29uc3QgbWFza2VkU21hbGxlckZhY2V0c0xlbmd0aCA9IG1hc2tlZFNtYWxsZXJGYWNldHMubGVuZ3RoO1xuXG4gICAgaWYgKG1hc2tlZFNtYWxsZXJGYWNldHNMZW5ndGggPT09IDApIHtcbiAgICAgIHVubWFza2VkRmFjZXRzLnB1c2godW5tYXNrZWRGYWNldCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHVubWFza2VkU21hbGxlckZhY2V0cy5mb3JFYWNoKCh1bm1hc2tlZFNtYWxsZXJGYWNldCkgPT4ge1xuICAgICAgICB1bm1hc2tlZFNtYWxsZXJGYWNldC5yb3RhdGUodGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24pO1xuICAgICAgfSk7XG5cbiAgICAgIHB1c2godW5tYXNrZWRGYWNldHMsIHVubWFza2VkU21hbGxlckZhY2V0cyk7XG4gICAgfVxuICB9XG4gIFxuICBzcGxpdEZhY2V0KGZhY2V0KSB7XG4gICAgbGV0IGZhY2V0cyA9IFtcbiAgICAgICAgICBmYWNldFxuICAgICAgICBdLFxuICAgICAgICBzbWFsbGVyRmFjZXRzID0gZmFjZXRzOyAvLy9cblxuICAgIHRoaXMudmVydGljYWxMaW5lcy5mb3JFYWNoKCh2ZXJ0aWNhbExpbmUpID0+IHtcbiAgICAgIHNtYWxsZXJGYWNldHMgPSB2ZXJ0aWNhbExpbmUuc3BsaXRGYWNldHMoZmFjZXRzKTtcblxuICAgICAgZmFjZXRzID0gc21hbGxlckZhY2V0czsgLy8vXG4gICAgfSk7XG5cbiAgICByZXR1cm4gc21hbGxlckZhY2V0cztcbiAgfVxuXG4gIHN0YXRpYyBmcm9tRmFjZXQoZmFjZXQpIHtcbiAgICBjb25zdCBmYWNldE5vcm1hbCA9IGZhY2V0LmdldE5vcm1hbCgpLFxuICAgICAgICAgIGZhY2V0VmVydGljZXMgPSBmYWNldC5nZXRWZXJ0aWNlcygpLFxuICAgICAgICAgIG5vcm1hbCA9IGZhY2V0Tm9ybWFsLCAvLy9cbiAgICAgICAgICBhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVBcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24obm9ybWFsKSxcbiAgICAgICAgICByb3RhdGlvblF1YXRlcm5pb24gPSBhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24sIC8vL1xuICAgICAgICAgIHZlcnRpY2VzID0gcm90YXRlVmVydGljZXMoZmFjZXRWZXJ0aWNlcywgcm90YXRpb25RdWF0ZXJuaW9uKSxcbiAgICAgICAgICBtYXNraW5nRWRnZXMgPSBjYWxjdWxhdGVNYXNraW5nRWRnZXModmVydGljZXMpLFxuICAgICAgICAgIHZlcnRpY2FsTGluZXMgPSBtYXNraW5nRWRnZXMubWFwKChtYXNraW5nRWRnZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmVydGljYWxMaW5lID0gVmVydGljYWxMaW5lLmZyb21NYXNraW5nRWRnZShtYXNraW5nRWRnZSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiB2ZXJ0aWNhbExpbmU7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICAgIG1hc2tpbmdGYWNldCA9IG5ldyBNYXNraW5nRmFjZXQobWFza2luZ0VkZ2VzLCB2ZXJ0aWNhbExpbmVzLCBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICAgIHJldHVybiBtYXNraW5nRmFjZXQ7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBNYXNraW5nRmFjZXQ7XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU1hc2tpbmdFZGdlcyh2ZXJ0aWNlcykge1xuICBjb25zdCBtYXNraW5nRWRnZXMgPSB2ZXJ0aWNlcy5tYXAoKHZlcnRleCwgaW5kZXgpID0+IHtcbiAgICAgICAgICBjb25zdCBzdGFydEluZGV4ID0gaW5kZXgsXG4gICAgICAgICAgICAgICAgZW5kSW5kZXggPSAoc3RhcnRJbmRleCArIDEpICUgVkVSVElDRVNfTEVOR1RILFxuICAgICAgICAgICAgICAgIHN0YXJ0VmVydGV4ID0gdmVydGljZXNbc3RhcnRJbmRleF0sXG4gICAgICAgICAgICAgICAgZW5kVmVydGV4ID0gdmVydGljZXNbZW5kSW5kZXhdLFxuICAgICAgICAgICAgICAgIG1hc2tpbmdFZGdlID0gTWFza2luZ0VkZ2UuZnJvbVN0YXJ0VmVydGV4QW5kRW5kVmVydGV4KHN0YXJ0VmVydGV4LCBlbmRWZXJ0ZXgpO1xuXG4gICAgICAgICAgcmV0dXJuIG1hc2tpbmdFZGdlO1xuICAgICAgICB9KTtcblxuICByZXR1cm4gbWFza2luZ0VkZ2VzO1xufVxuIl19