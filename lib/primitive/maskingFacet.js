'use strict';

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var constants = require('../constants'),
    MaskingEdge = require('./edge/masking'),
    VerticalLine = require('./verticalLine'),
    arrayUtilities = require('../utilities/array'),
    verticesUtilities = require('../utilities/vertices'),
    quaternionUtilities = require('../utilities/quaternion');

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    push = arrayUtilities.push,
    separate = arrayUtilities.separate,
    rotateVertices = verticesUtilities.rotateVertices,
    calculateArbitraryRotationQuaternion = quaternionUtilities.calculateArbitraryRotationQuaternion,
    calculateForwardsRotationQuaternion = quaternionUtilities.calculateForwardsRotationQuaternion,
    calculateBackwardsRotationQuaternion = quaternionUtilities.calculateBackwardsRotationQuaternion;

var MaskingFacet = /*#__PURE__*/function () {
  function MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion) {
    _classCallCheck(this, MaskingFacet);

    this.maskingEdges = maskingEdges;
    this.verticalLines = verticalLines;
    this.forwardsRotationQuaternion = forwardsRotationQuaternion;
    this.backwardsRotationQuaternion = backwardsRotationQuaternion;
  }

  _createClass(MaskingFacet, [{
    key: "getMaskingEdges",
    value: function getMaskingEdges() {
      return this.maskingEdges;
    }
  }, {
    key: "getVerticalLines",
    value: function getVerticalLines() {
      return this.verticalLines;
    }
  }, {
    key: "getForwardsRotationQuaternion",
    value: function getForwardsRotationQuaternion() {
      return this.forwardsRotationQuaternion;
    }
  }, {
    key: "getBackwardsRotationQuaternion",
    value: function getBackwardsRotationQuaternion() {
      return this.backwardsRotationQuaternion;
    }
  }, {
    key: "maskFacet",
    value: function maskFacet(facet, unmaskedFacets) {
      var _this = this;

      var unmaskedFacet = facet.clone(); ///

      facet.rotate(this.forwardsRotationQuaternion);
      var maskingFacet = this,
          ///
      smallerFacets = this.splitFacet(facet),
          maskedSmallerFacets = [],
          unmaskedSmallerFacets = [];
      separate(smallerFacets, maskedSmallerFacets, unmaskedSmallerFacets, function (smallerFacet) {
        var smallerFacetMasked = smallerFacet.isMasked(maskingFacet);
        return smallerFacetMasked;
      });
      var maskedSmallerFacetsLength = maskedSmallerFacets.length;

      if (maskedSmallerFacetsLength === 0) {
        unmaskedFacets.push(unmaskedFacet);
      } else {
        unmaskedSmallerFacets.forEach(function (unmaskedSmallerFacet) {
          unmaskedSmallerFacet.rotate(_this.backwardsRotationQuaternion);
        });
        push(unmaskedFacets, unmaskedSmallerFacets);
      }
    }
  }, {
    key: "splitFacet",
    value: function splitFacet(facet) {
      var facets = [facet],
          smallerFacets = facets; ///

      this.verticalLines.forEach(function (verticalLine) {
        smallerFacets = verticalLine.splitFacets(facets);
        facets = smallerFacets; ///
      });
      return smallerFacets;
    }
  }], [{
    key: "fromFacet",
    value: function fromFacet(facet) {
      var facetNormal = facet.getNormal(),
          facetVertices = facet.getVertices(),
          normal = facetNormal,
          ///
      arbitraryRotationQuaternion = calculateArbitraryRotationQuaternion(normal),
          rotationQuaternion = arbitraryRotationQuaternion,
          ///
      vertices = rotateVertices(facetVertices, rotationQuaternion),
          maskingEdges = calculateMaskingEdges(vertices),
          verticalLines = maskingEdges.map(function (maskingEdge) {
        var verticalLine = VerticalLine.fromMaskingEdge(maskingEdge);
        return verticalLine;
      }),
          forwardsRotationQuaternion = calculateForwardsRotationQuaternion(rotationQuaternion),
          backwardsRotationQuaternion = calculateBackwardsRotationQuaternion(rotationQuaternion),
          maskingFacet = new MaskingFacet(maskingEdges, verticalLines, forwardsRotationQuaternion, backwardsRotationQuaternion);
      return maskingFacet;
    }
  }]);

  return MaskingFacet;
}();

module.exports = MaskingFacet;

function calculateMaskingEdges(vertices) {
  var maskingEdges = vertices.map(function (vertex, index) {
    var startIndex = index,
        endIndex = (startIndex + 1) % VERTICES_LENGTH,
        startVertex = vertices[startIndex],
        endVertex = vertices[endIndex],
        maskingEdge = MaskingEdge.fromStartVertexAndEndVertex(startVertex, endVertex);
    return maskingEdge;
  });
  return maskingEdges;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1hc2tpbmdGYWNldC5qcyJdLCJuYW1lcyI6WyJjb25zdGFudHMiLCJyZXF1aXJlIiwiTWFza2luZ0VkZ2UiLCJWZXJ0aWNhbExpbmUiLCJhcnJheVV0aWxpdGllcyIsInZlcnRpY2VzVXRpbGl0aWVzIiwicXVhdGVybmlvblV0aWxpdGllcyIsIlZFUlRJQ0VTX0xFTkdUSCIsInB1c2giLCJzZXBhcmF0ZSIsInJvdGF0ZVZlcnRpY2VzIiwiY2FsY3VsYXRlQXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJNYXNraW5nRmFjZXQiLCJtYXNraW5nRWRnZXMiLCJ2ZXJ0aWNhbExpbmVzIiwiZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJmYWNldCIsInVubWFza2VkRmFjZXRzIiwidW5tYXNrZWRGYWNldCIsImNsb25lIiwicm90YXRlIiwibWFza2luZ0ZhY2V0Iiwic21hbGxlckZhY2V0cyIsInNwbGl0RmFjZXQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzIiwidW5tYXNrZWRTbWFsbGVyRmFjZXRzIiwic21hbGxlckZhY2V0Iiwic21hbGxlckZhY2V0TWFza2VkIiwiaXNNYXNrZWQiLCJtYXNrZWRTbWFsbGVyRmFjZXRzTGVuZ3RoIiwibGVuZ3RoIiwiZm9yRWFjaCIsInVubWFza2VkU21hbGxlckZhY2V0IiwiZmFjZXRzIiwidmVydGljYWxMaW5lIiwic3BsaXRGYWNldHMiLCJmYWNldE5vcm1hbCIsImdldE5vcm1hbCIsImZhY2V0VmVydGljZXMiLCJnZXRWZXJ0aWNlcyIsIm5vcm1hbCIsImFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbiIsInJvdGF0aW9uUXVhdGVybmlvbiIsInZlcnRpY2VzIiwiY2FsY3VsYXRlTWFza2luZ0VkZ2VzIiwibWFwIiwibWFza2luZ0VkZ2UiLCJmcm9tTWFza2luZ0VkZ2UiLCJtb2R1bGUiLCJleHBvcnRzIiwidmVydGV4IiwiaW5kZXgiLCJzdGFydEluZGV4IiwiZW5kSW5kZXgiLCJzdGFydFZlcnRleCIsImVuZFZlcnRleCIsImZyb21TdGFydFZlcnRleEFuZEVuZFZlcnRleCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0FBRUEsSUFBTUEsU0FBUyxHQUFHQyxPQUFPLENBQUMsY0FBRCxDQUF6QjtBQUFBLElBQ01DLFdBQVcsR0FBR0QsT0FBTyxDQUFDLGdCQUFELENBRDNCO0FBQUEsSUFFTUUsWUFBWSxHQUFHRixPQUFPLENBQUMsZ0JBQUQsQ0FGNUI7QUFBQSxJQUdNRyxjQUFjLEdBQUdILE9BQU8sQ0FBQyxvQkFBRCxDQUg5QjtBQUFBLElBSU1JLGlCQUFpQixHQUFHSixPQUFPLENBQUMsdUJBQUQsQ0FKakM7QUFBQSxJQUtNSyxtQkFBbUIsR0FBR0wsT0FBTyxDQUFDLHlCQUFELENBTG5DOztBQU9NLElBQUVNLGVBQUYsR0FBc0JQLFNBQXRCLENBQUVPLGVBQUY7QUFBQSxJQUNFQyxJQURGLEdBQ3FCSixjQURyQixDQUNFSSxJQURGO0FBQUEsSUFDUUMsUUFEUixHQUNxQkwsY0FEckIsQ0FDUUssUUFEUjtBQUFBLElBRUVDLGNBRkYsR0FFcUJMLGlCQUZyQixDQUVFSyxjQUZGO0FBQUEsSUFHRUMsb0NBSEYsR0FHc0hMLG1CQUh0SCxDQUdFSyxvQ0FIRjtBQUFBLElBR3dDQyxtQ0FIeEMsR0FHc0hOLG1CQUh0SCxDQUd3Q00sbUNBSHhDO0FBQUEsSUFHNkVDLG9DQUg3RSxHQUdzSFAsbUJBSHRILENBRzZFTyxvQ0FIN0U7O0lBS0FDLFk7QUFDSix3QkFBWUMsWUFBWixFQUEwQkMsYUFBMUIsRUFBeUNDLDBCQUF6QyxFQUFxRUMsMkJBQXJFLEVBQWtHO0FBQUE7O0FBQ2hHLFNBQUtILFlBQUwsR0FBb0JBLFlBQXBCO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQkEsYUFBckI7QUFDQSxTQUFLQywwQkFBTCxHQUFrQ0EsMEJB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QUFBLFVBYU0zQiwyQkFBMkIsR0FBR0wsb0NBQW9DLENBQUNnQyxrQkFBRCxDQWJ4RTtBQUFBLFVBY01yQixZQUFZLEdBQUcsSUFBSVYsWUFBSixDQUFpQkMsWUFBakIsRUFBK0JDLGFBQS9CLEVBQThDQywwQkFBOUMsRUFBMEVDLDJCQUExRSxDQWRyQjtBQWdCQSxhQUFPTSxZQUFQO0FBQ0Q7Ozs7OztBQUdIMkIsTUFBTSxDQUFDQyxPQUFQLEdBQWlCdEMsWUFBakI7O0FBRUEsU0FBU2lDLHFCQUFULENBQStCRCxRQUEvQixFQUF5QztBQUN2QyxNQUFNL0IsWUFBWSxHQUFHK0IsUUFBUSxDQUFDRSxHQUFULENBQWEsVUFBQ0ssTUFBRCxFQUFTQyxLQUFULEVBQW1CO0FBQzdDLFFBQU1DLFVBQVUsR0FBR0QsS0FBbkI7QUFBQSxRQUNNRSxRQUFRLEdBQUcsQ0FBQ0QsVUFBVSxHQUFHLENBQWQsSUFBbUJoRCxlQURwQztBQUFBLFFBRU1rRCxXQUFXLEdBQUdYLFFBQVEsQ0FBQ1MsVUFBRCxDQUY1QjtBQUFBLFFBR01HLFNBQVMsR0FBR1osUUFBUSxDQUFDVSxRQUFELENBSDFCO0FBQUEsUUFJTVAsV0FBVyxHQUFHL0MsV0FBVyxDQUFDeUQsMkJBQVosQ0FBd0NGLFdBQXhDLEVBQXFEQyxTQUFyRCxDQUpwQjtBQU1BLFdBQU9ULFdBQVA7QUFDRCxHQVJjLENBQXJCO0FBVUEsU0FBT2xDLFlBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgY29uc3RhbnRzID0gcmVxdWlyZSgnLi4vY29uc3RhbnRzJyksXG4gICAgICBNYXNraW5nRWRnZSA9IHJlcXVpcmUoJy4vZWRnZS9tYXNraW5nJyksXG4gICAgICBWZXJ0aWNhbExpbmUgPSByZXF1aXJlKCcuL3ZlcnRpY2FsTGluZScpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIHZlcnRpY2VzVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL3ZlcnRpY2VzJyksXG4gICAgICBxdWF0ZXJuaW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL3F1YXRlcm5pb24nKTtcblxuY29uc3QgeyBWRVJUSUNFU19MRU5HVEggfSA9IGNvbnN0YW50cyxcbiAgICAgIHsgcHVzaCwgc2VwYXJhdGUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyByb3RhdGVWZXJ0aWNlcyB9ID0gdmVydGljZXNVdGlsaXRpZXMsXG4gICAgICB7IGNhbGN1bGF0ZUFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbiwgY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24sIGNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiB9ID0gcXVhdGVybmlvblV0aWxpdGllcztcblxuY2xhc3MgTWFza2luZ0ZhY2V0IHtcbiAgY29uc3RydWN0b3IobWFza2luZ0VkZ2VzLCB2ZXJ0aWNhbExpbmVzLCBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiwgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKSB7XG4gICAgdGhpcy5tYXNraW5nRWRnZXMgPSBtYXNraW5nRWRnZXM7XG4gICAgdGhpcy52ZXJ0aWNhbExpbmVzID0gdmVydGljYWxMaW5lcztcbiAgICB0aGlzLmZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gICAgdGhpcy5iYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gIH1cblxuICBnZXRNYXNraW5nRWRnZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMubWFza2luZ0VkZ2VzO1xuICB9XG5cbiAgZ2V0VmVydGljYWxMaW5lcygpIHtcbiAgICByZXR1cm4gdGhpcy52ZXJ0aWNhbExpbmVzO1xuICB9XG5cbiAgZ2V0Rm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb247XG4gIH1cblxuICBnZXRCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24oKSB7XG4gICAgcmV0dXJuIHRoaXMuYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xuICB9XG5cbiAgbWFza0ZhY2V0KGZhY2V0LCB1bm1hc2tlZEZhY2V0cykge1xuICAgIGNvbnN0IHVubWFza2VkRmFjZXQgPSBmYWNldC5jbG9uZSgpOyAgLy8vXG5cbiAgICBmYWNldC5yb3RhdGUodGhpcy5mb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbik7XG5cbiAgICBjb25zdCBtYXNraW5nRmFjZXQgPSB0aGlzLCAgLy8vXG4gICAgICAgICAgc21hbGxlckZhY2V0cyA9IHRoaXMuc3BsaXRGYWNldChmYWNldCksXG4gICAgICAgICAgbWFza2VkU21hbGxlckZhY2V0cyA9IFtdLFxuICAgICAgICAgIHVubWFza2VkU21hbGxlckZhY2V0cyA9IFtdO1xuXG4gICAgc2VwYXJhdGUoc21hbGxlckZhY2V0cywgbWFza2VkU21hbGxlckZhY2V0cywgdW5tYXNrZWRTbWFsbGVyRmFjZXRzLCAoc21hbGxlckZhY2V0KSA9PiB7XG4gICAgICBjb25zdCBzbWFsbGVyRmFjZXRNYXNrZWQgPSBzbWFsbGVyRmFjZXQuaXNNYXNrZWQobWFza2luZ0ZhY2V0KTtcblxuICAgICAgcmV0dXJuIHNtYWxsZXJGYWNldE1hc2tlZDtcbiAgICB9KTtcblxuICAgIGNvbnN0IG1hc2tlZFNtYWxsZXJGYWNldHNMZW5ndGggPSBtYXNrZWRTbWFsbGVyRmFjZXRzLmxlbmd0aDtcblxuICAgIGlmIChtYXNrZWRTbWFsbGVyRmFjZXRzTGVuZ3RoID09PSAwKSB7XG4gICAgICB1bm1hc2tlZEZhY2V0cy5wdXNoKHVubWFza2VkRmFjZXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB1bm1hc2tlZFNtYWxsZXJGYWNldHMuZm9yRWFjaCgodW5tYXNrZWRTbWFsbGVyRmFjZXQpID0+IHtcbiAgICAgICAgdW5tYXNrZWRTbWFsbGVyRmFjZXQucm90YXRlKHRoaXMuYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKTtcbiAgICAgIH0pO1xuXG4gICAgICBwdXNoKHVubWFza2VkRmFjZXRzLCB1bm1hc2tlZFNtYWxsZXJGYWNldHMpO1xuICAgIH1cbiAgfVxuICBcbiAgc3BsaXRGYWNldChmYWNldCkge1xuICAgIGxldCBmYWNldHMgPSBbXG4gICAgICAgICAgZmFjZXRcbiAgICAgICAgXSxcbiAgICAgICAgc21hbGxlckZhY2V0cyA9IGZhY2V0czsgLy8vXG5cbiAgICB0aGlzLnZlcnRpY2FsTGluZXMuZm9yRWFjaCgodmVydGljYWxMaW5lKSA9PiB7XG4gICAgICBzbWFsbGVyRmFjZXRzID0gdmVydGljYWxMaW5lLnNwbGl0RmFjZXRzKGZhY2V0cyk7XG5cbiAgICAgIGZhY2V0cyA9IHNtYWxsZXJGYWNldHM7IC8vL1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHNtYWxsZXJGYWNldHM7XG4gIH1cblxuICBzdGF0aWMgZnJvbUZhY2V0KGZhY2V0KSB7XG4gICAgY29uc3QgZmFjZXROb3JtYWwgPSBmYWNldC5nZXROb3JtYWwoKSxcbiAgICAgICAgICBmYWNldFZlcnRpY2VzID0gZmFjZXQuZ2V0VmVydGljZXMoKSxcbiAgICAgICAgICBub3JtYWwgPSBmYWNldE5vcm1hbCwgLy8vXG4gICAgICAgICAgYXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uID0gY2FsY3VsYXRlQXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uKG5vcm1hbCksXG4gICAgICAgICAgcm90YXRpb25RdWF0ZXJuaW9uID0gYXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uLCAvLy9cbiAgICAgICAgICB2ZXJ0aWNlcyA9IHJvdGF0ZVZlcnRpY2VzKGZhY2V0VmVydGljZXMsIHJvdGF0aW9uUXVhdGVybmlvbiksXG4gICAgICAgICAgbWFza2luZ0VkZ2VzID0gY2FsY3VsYXRlTWFza2luZ0VkZ2VzKHZlcnRpY2VzKSxcbiAgICAgICAgICB2ZXJ0aWNhbExpbmVzID0gbWFza2luZ0VkZ2VzLm1hcCgobWFza2luZ0VkZ2UpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHZlcnRpY2FsTGluZSA9IFZlcnRpY2FsTGluZS5mcm9tTWFza2luZ0VkZ2UobWFza2luZ0VkZ2UpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdmVydGljYWxMaW5lO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24ocm90YXRpb25RdWF0ZXJuaW9uKSxcbiAgICAgICAgICBiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24ocm90YXRpb25RdWF0ZXJuaW9uKSxcbiAgICAgICAgICBtYXNraW5nRmFjZXQgPSBuZXcgTWFza2luZ0ZhY2V0KG1hc2tpbmdFZGdlcywgdmVydGljYWxMaW5lcywgZm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24sIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbik7XG5cbiAgICByZXR1cm4gbWFza2luZ0ZhY2V0O1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gTWFza2luZ0ZhY2V0O1xuXG5mdW5jdGlvbiBjYWxjdWxhdGVNYXNraW5nRWRnZXModmVydGljZXMpIHtcbiAgY29uc3QgbWFza2luZ0VkZ2VzID0gdmVydGljZXMubWFwKCh2ZXJ0ZXgsIGluZGV4KSA9PiB7XG4gICAgICAgICAgY29uc3Qgc3RhcnRJbmRleCA9IGluZGV4LFxuICAgICAgICAgICAgICAgIGVuZEluZGV4ID0gKHN0YXJ0SW5kZXggKyAxKSAlIFZFUlRJQ0VTX0xFTkdUSCxcbiAgICAgICAgICAgICAgICBzdGFydFZlcnRleCA9IHZlcnRpY2VzW3N0YXJ0SW5kZXhdLFxuICAgICAgICAgICAgICAgIGVuZFZlcnRleCA9IHZlcnRpY2VzW2VuZEluZGV4XSxcbiAgICAgICAgICAgICAgICBtYXNraW5nRWRnZSA9IE1hc2tpbmdFZGdlLmZyb21TdGFydFZlcnRleEFuZEVuZFZlcnRleChzdGFydFZlcnRleCwgZW5kVmVydGV4KTtcblxuICAgICAgICAgIHJldHVybiBtYXNraW5nRWRnZTtcbiAgICAgICAgfSk7XG5cbiAgcmV0dXJuIG1hc2tpbmdFZGdlcztcbn1cbiJdfQ==