'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _get = function get(object, property, receiver) { if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return get(parent, property, receiver); } } else if ("value" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } };

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var Edge = require('../edge'),
    Facet = require('../facet'),
    matrixMaths = require('../maths/matrix'),
    vectorMaths = require('../maths/vector'),
    facetUtilities = require('../utilities/facet'),
    arrayUtilities = require('../utilities/array'),
    imageMapUtilities = require('../utilities/imageMap'),
    rotationUtilities = require('../utilities/rotation'),
    quaternionUtilities = require('../utilities/quaternion');

var rotateVertices = rotationUtilities.rotateVertices,
    invert2 = matrixMaths.invert2,
    invert3 = matrixMaths.invert3,
    getImageDetails = imageMapUtilities.getImageDetails,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    _permute = arrayUtilities.permute,
    calculateRotationQuaternion = quaternionUtilities.calculateRotationQuaternion,
    add2 = vectorMaths.add2,
    multiply2 = vectorMaths.multiply2,
    transform2 = vectorMaths.transform2,
    transform3 = vectorMaths.transform3,
    cloneEdges = facetUtilities.cloneEdges,
    cloneNormal = facetUtilities.cloneNormal,
    cloneVertices = facetUtilities.cloneVertices,
    calculateEdges = facetUtilities.calculateEdges,
    calculateNormal = facetUtilities.calculateNormal;

var TexturedFacet = function (_Facet) {
  _inherits(TexturedFacet, _Facet);

  function TexturedFacet(vertices, normal, edges, imageName, textureCoordinates) {
    _classCallCheck(this, TexturedFacet);

    var _this = _possibleConstructorReturn(this, (TexturedFacet.__proto__ || Object.getPrototypeOf(TexturedFacet)).call(this, vertices, normal, edges));

    _this.imageName = imageName;
    _this.textureCoordinates = textureCoordinates;
    return _this;
  }

  _createClass(TexturedFacet, [{
    key: 'getImageName',
    value: function getImageName() {
      return this.imageName;
    }
  }, {
    key: 'getTextureCoordinates',
    value: function getTextureCoordinates() {
      return this.textureCoordinates;
    }
  }, {
    key: 'getVertexTextureCoordinates',
    value: function getVertexTextureCoordinates() {
      var imageDetails = getImageDetails(this.imageName),
          left = imageDetails.left,
          bottom = imageDetails.bottom,
          width = imageDetails.width,
          height = imageDetails.height,
          vertexTextureCoordinates = translateTextureCoordinates(this.textureCoordinates, left, bottom, width, height);


      return vertexTextureCoordinates;
    }
  }, {
    key: 'permute',
    value: function permute(places) {
      _get(TexturedFacet.prototype.__proto__ || Object.getPrototypeOf(TexturedFacet.prototype), 'permute', this).call(this, places);

      this.textureCoordinates = _permute(this.textureCoordinates, places);
    }
  }, {
    key: 'splitWithTwoNonNullIntersections',
    value: function splitWithTwoNonNullIntersections(intersections, smallerFacets, Facet) {
      _get(TexturedFacet.prototype.__proto__ || Object.getPrototypeOf(TexturedFacet.prototype), 'splitWithTwoNonNullIntersections', this).call(this, intersections, smallerFacets, this);
    } ///

  }, {
    key: 'splitWithOneNonNullIntersection',
    value: function splitWithOneNonNullIntersection(intersections, smallerFacets, Facet) {
      _get(TexturedFacet.prototype.__proto__ || Object.getPrototypeOf(TexturedFacet.prototype), 'splitWithOneNonNullIntersection', this).call(this, intersections, smallerFacets, this);
    } ///

  }, {
    key: 'clone',
    value: function clone() {
      var vertices = this.getVertices(),
          normal = this.getNormal(),
          edges = this.getEdges();

      vertices = cloneVertices(vertices);
      normal = cloneNormal(normal);
      edges = cloneEdges(edges);

      var imageName = this.imageName,
          textureCoordinates = cloneTextureCoordinates(this.textureCoordinates),
          texturedFacet = new TexturedFacet(vertices, normal, edges, imageName, textureCoordinates);

      return texturedFacet;
    }
  }, {
    key: 'fromVertices',
    value: function fromVertices(vertices) {
      var normal = calculateNormal(vertices),
          edges = calculateEdges(vertices, Edge),
          imageName = this.imageName,
          parentVertices = this.vertices,
          ///
      textureCoordinates = textureCoordinatesFromVerticesParentVerticesAndTextureCoordinates(vertices, parentVertices, this.textureCoordinates),
          texturedFacet = new TexturedFacet(vertices, normal, edges, imageName, textureCoordinates);

      return texturedFacet;
    }
  }], [{
    key: 'fromVerticesIndexesImageNameAndTextureCoordinates',
    value: function fromVerticesIndexesImageNameAndTextureCoordinates(vertices, indexes, imageName, textureCoordinates, index) {
      vertices = verticesFromVerticesAndIndexes(vertices, indexes); ///

      textureCoordinates = textureCoordinatesFromTextureCoordinatesAndIndex(textureCoordinates, index); ///

      var normal = calculateNormal(vertices),
          edges = calculateEdges(vertices, Edge),
          texturedFacet = new TexturedFacet(vertices, normal, edges, imageName, textureCoordinates);

      return texturedFacet;
    }
  }]);

  return TexturedFacet;
}(Facet);

module.exports = TexturedFacet;

function verticesFromVerticesAndIndexes(vertices, indexes) {
  ///
  vertices = indexes.map(function (index) {
    var vertex = vertices[index];

    return vertex;
  });

  return vertices;
}

function textureCoordinatesFromTextureCoordinatesAndIndex(textureCoordinates, index) {
  ///
  textureCoordinates = textureCoordinates.slice(index * 3, index * 3 + 3); ///

  return textureCoordinates;
}

function cloneTextureCoordinates(textureCoordinates) {
  textureCoordinates = textureCoordinates.map(function (textureCoordinates) {
    ///
    textureCoordinates = textureCoordinates.slice();

    return textureCoordinates;
  });

  return textureCoordinates;
}

function translateTextureCoordinates(textureCoordinates, left, bottom, width, height) {
  textureCoordinates = textureCoordinates.map(function (textureCoordinates) {
    ///
    textureCoordinates = add2(multiply2(textureCoordinates, [width, height]), [left, bottom]);

    return textureCoordinates;
  });

  return textureCoordinates;
}

function textureCoordinatesFromVerticesParentVerticesAndTextureCoordinates(vertices, parentVertices, textureCoordinates) {
  var normal = calculateNormal(vertices),
      rotationQuaternion = calculateRotationQuaternion(normal),
      verticesInXYPlane = rotateVertices(vertices, rotationQuaternion),
      parentVerticesInXYPlane = rotateVertices(parentVertices, rotationQuaternion),
      textureCoordinatesMatrix = calculateTextureCoordinatesMatrix(textureCoordinates),
      textureCoordinatesBasis = calculateTextureCoordinatesBasis(parentVerticesInXYPlane, textureCoordinatesMatrix);

  textureCoordinates = calculateTextureCoordinates(verticesInXYPlane, textureCoordinatesBasis);

  return textureCoordinates;
}

function calculateTextureCoordinatesMatrix(textureCoordinates) {
  var firstTextureCoordinate = first(textureCoordinates),
      secondTextureCoordinate = second(textureCoordinates),
      thirdTextureCoordinate = third(textureCoordinates),
      P1u = firstTextureCoordinate[0],
      ///
  P1v = firstTextureCoordinate[1],
      ///
  P2u = secondTextureCoordinate[0],
      ///
  P2v = secondTextureCoordinate[1],
      ///
  P3u = thirdTextureCoordinate[0],
      ///
  P3v = thirdTextureCoordinate[1],
      ///
  textureCoordinatesMatrix = invert3([1, 1, 1, P1u, P2u, P3u, P1v, P2v, P3v]);

  return textureCoordinatesMatrix;
}

function calculateTextureCoordinatesBasis(parentVerticesInXYPlane, textureCoordinatesMatrix) {
  var firstParentVertexInXYPlane = first(parentVerticesInXYPlane),
      secondParentVertexInXYPlane = second(parentVerticesInXYPlane),
      thirdParentVertexInXYPlane = third(parentVerticesInXYPlane),
      P1x = firstParentVertexInXYPlane[0],
      ///
  P1y = firstParentVertexInXYPlane[1],
      ///
  P2x = secondParentVertexInXYPlane[0],
      ///
  P2y = secondParentVertexInXYPlane[1],
      ///
  P3x = thirdParentVertexInXYPlane[0],
      ///
  P3y = thirdParentVertexInXYPlane[1],
      ///
  xVector = transform3([P1x, P2x, P3x], textureCoordinatesMatrix),
      yVector = transform3([P1y, P2y, P3y], textureCoordinatesMatrix),
      textureCoordinatesBasis = [].concat(xVector).concat(yVector);

  return textureCoordinatesBasis;
}

function calculateTextureCoordinates(verticesInXYPlane, textureCoordinatesBasis) {
  var firstVertexInXYPlane = first(verticesInXYPlane),
      secondVertexInXYPlane = second(verticesInXYPlane),
      thirdVertexInXYPlane = third(verticesInXYPlane),
      R1x = firstVertexInXYPlane[0],
      ///
  R1y = firstVertexInXYPlane[1],
      ///
  R2x = secondVertexInXYPlane[0],
      ///
  R2y = secondVertexInXYPlane[1],
      ///
  R3x = thirdVertexInXYPlane[0],
      ///
  R3y = thirdVertexInXYPlane[1],
      ///
  Ox = textureCoordinatesBasis[0],
      ///
  Oy = textureCoordinatesBasis[3],
      ///
  Ux = textureCoordinatesBasis[1],
      ///
  Uy = textureCoordinatesBasis[4],
      ///
  Vx = textureCoordinatesBasis[2],
      ///
  Vy = textureCoordinatesBasis[5],
      ///
  matrix = invert2([Ux, Uy, Vx, Vy]),
      firstTextureCoordinates = transform2([R1x - Ox, R1y - Oy], matrix),
      secondTextureCoordinates = transform2([R2x - Ox, R2y - Oy], matrix),
      thirdTextureCoordinates = transform2([R3x - Ox, R3y - Oy], matrix),
      textureCoordinates = [firstTextureCoordinates, secondTextureCoordinates, thirdTextureCoordinates];

  return textureCoordinates;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9mYWNldC90ZXh0dXJlZC5qcyJdLCJuYW1lcyI6WyJFZGdlIiwicmVxdWlyZSIsIkZhY2V0IiwibWF0cml4TWF0aHMiLCJ2ZWN0b3JNYXRocyIsImZhY2V0VXRpbGl0aWVzIiwiYXJyYXlVdGlsaXRpZXMiLCJpbWFnZU1hcFV0aWxpdGllcyIsInJvdGF0aW9uVXRpbGl0aWVzIiwicXVhdGVybmlvblV0aWxpdGllcyIsInJvdGF0ZVZlcnRpY2VzIiwiaW52ZXJ0MiIsImludmVydDMiLCJnZXRJbWFnZURldGFpbHMiLCJmaXJzdCIsInNlY29uZCIsInRoaXJkIiwicGVybXV0ZSIsImNhbGN1bGF0ZVJvdGF0aW9uUXVhdGVybmlvbiIsImFkZDIiLCJtdWx0aXBseTIiLCJ0cmFuc2Zvcm0yIiwidHJhbnNmb3JtMyIsImNsb25lRWRnZXMiLCJjbG9uZU5vcm1hbCIsImNsb25lVmVydGljZXMiLCJjYWxjdWxhdGVFZGdlcyIsImNhbGN1bGF0ZU5vcm1hbCIsIlRleHR1cmVkRmFjZXQiLCJ2ZXJ0aWNlcyIsIm5vcm1hbCIsImVkZ2VzIiwiaW1hZ2VOYW1lIiwidGV4dHVyZUNvb3JkaW5hdGVzIiwibGVmdCIsImltYWdlRGV0YWlscyIsImJvdHRvbSIsIndpZHRoIiwiaGVpZ2h0IiwidmVydGV4VGV4dHVyZUNvb3JkaW5hdGVzIiwidHJhbnNsYXRlVGV4dHVyZUNvb3JkaW5hdGVzIiwicGxhY2VzIiwiaW50ZXJzZWN0aW9ucyIsInNtYWxsZXJGYWNldHMiLCJnZXRWZXJ0aWNlcyIsImdldE5vcm1hbCIsImdldEVkZ2VzIiwiY2xvbmVUZXh0dXJlQ29vcmRpbmF0ZXMiLCJ0ZXh0dXJlZEZhY2V0IiwicGFyZW50VmVydGljZXMiLCJ0ZXh0dXJlQ29vcmRpbmF0ZXNGcm9tVmVydGljZXNQYXJlbnRWZXJ0aWNlc0FuZFRleHR1cmVDb29yZGluYXRlcyIsImluZGV4ZXMiLCJpbmRleCIsInZlcnRpY2VzRnJvbVZlcnRpY2VzQW5kSW5kZXhlcyIsInRleHR1cmVDb29yZGluYXRlc0Zyb21UZXh0dXJlQ29vcmRpbmF0ZXNBbmRJbmRleCIsIm1vZHVsZSIsImV4cG9ydHMiLCJtYXAiLCJ2ZXJ0ZXgiLCJzbGljZSIsInJvdGF0aW9uUXVhdGVybmlvbiIsInZlcnRpY2VzSW5YWVBsYW5lIiwicGFyZW50VmVydGljZXNJblhZUGxhbmUiLCJ0ZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgiLCJjYWxjdWxhdGVUZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgiLCJ0ZXh0dXJlQ29vcmRpbmF0ZXNCYXNpcyIsImNhbGN1bGF0ZVRleHR1cmVDb29yZGluYXRlc0Jhc2lzIiwiY2FsY3VsYXRlVGV4dHVyZUNvb3JkaW5hdGVzIiwiZmlyc3RUZXh0dXJlQ29vcmRpbmF0ZSIsInNlY29uZFRleHR1cmVDb29yZGluYXRlIiwidGhpcmRUZXh0dXJlQ29vcmRpbmF0ZSIsIlAxdSIsIlAxdiIsIlAydSIsIlAydiIsIlAzdSIsIlAzdiIsImZpcnN0UGFyZW50VmVydGV4SW5YWVBsYW5lIiwic2Vjb25kUGFyZW50VmVydGV4SW5YWVBsYW5lIiwidGhpcmRQYXJlbnRWZXJ0ZXhJblhZUGxhbmUiLCJQMXgiLCJQMXkiLCJQMngiLCJQMnkiLCJQM3giLCJQM3kiLCJ4VmVjdG9yIiwieVZlY3RvciIsImNvbmNhdCIsImZpcnN0VmVydGV4SW5YWVBsYW5lIiwic2Vjb25kVmVydGV4SW5YWVBsYW5lIiwidGhpcmRWZXJ0ZXhJblhZUGxhbmUiLCJSMXgiLCJSMXkiLCJSMngiLCJSMnkiLCJSM3giLCJSM3kiLCJPeCIsIk95IiwiVXgiLCJVeSIsIlZ4IiwiVnkiLCJtYXRyaXgiLCJmaXJzdFRleHR1cmVDb29yZGluYXRlcyIsInNlY29uZFRleHR1cmVDb29yZGluYXRlcyIsInRoaXJkVGV4dHVyZUNvb3JkaW5hdGVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsT0FBT0MsUUFBUSxTQUFSLENBQWI7QUFBQSxJQUNNQyxRQUFRRCxRQUFRLFVBQVIsQ0FEZDtBQUFBLElBRU1F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LE1BWXdDO0FBQ2xDcUMsT0FBS3JDLHdCQUF3QixDQUF4QixDQWJYO0FBQUEsTUFhd0M7QUFDbENzQyxPQUFLdEMsd0JBQXdCLENBQXhCLENBZFg7QUFBQSxNQWN3QztBQUNsQ3VDLFdBQVM3RixRQUFRLENBQUV5RixFQUFGLEVBQU1DLEVBQU4sRUFBVUMsRUFBVixFQUFjQyxFQUFkLENBQVIsQ0FmZjtBQUFBLE1BZ0JNRSwwQkFBMEJwRixXQUFXLENBQUV1RSxNQUFNTSxFQUFSLEVBQVlMLE1BQU1NLEVBQWxCLENBQVgsRUFBbUNLLE1BQW5DLENBaEJoQztBQUFBLE1BaUJNRSwyQkFBMkJyRixXQUFXLENBQUV5RSxNQUFNSSxFQUFSLEVBQVlILE1BQU1JLEVBQWxCLENBQVgsRUFBbUNLLE1BQW5DLENBakJqQztBQUFBLE1Ba0JNRywwQkFBMEJ0RixXQUFXLENBQUUyRSxNQUFNRSxFQUFSLEVBQVlELE1BQU1FLEVBQWxCLENBQVgsRUFBbUNLLE1BQW5DLENBbEJoQztBQUFBLE1BbUJNdkUscUJBQXFCLENBQ25Cd0UsdUJBRG1CLEVBRW5CQyx3QkFGbUIsRUFHbkJDLHVCQUhtQixDQW5CM0I7O0FBeUJBLFNBQU8xRSxrQkFBUDtBQUNEIiwiZmlsZSI6InRleHR1cmVkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBFZGdlID0gcmVxdWlyZSgnLi4vZWRnZScpLFxuICAgICAgRmFjZXQgPSByZXF1aXJlKCcuLi9mYWNldCcpLFxuICAgICAgbWF0cml4TWF0aHMgPSByZXF1aXJlKCcuLi9tYXRocy9tYXRyaXgnKSxcbiAgICAgIHZlY3Rvck1hdGhzID0gcmVxdWlyZSgnLi4vbWF0aHMvdmVjdG9yJyksXG4gICAgICBmYWNldFV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9mYWNldCcpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIGltYWdlTWFwVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2ltYWdlTWFwJyksXG4gICAgICByb3RhdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9yb3RhdGlvbicpLFxuICAgICAgcXVhdGVybmlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9xdWF0ZXJuaW9uJyk7XG5cbmNvbnN0IHsgcm90YXRlVmVydGljZXMgfSA9IHJvdGF0aW9uVXRpbGl0aWVzLFxuICAgICAgeyBpbnZlcnQyLCBpbnZlcnQzIH0gPSBtYXRyaXhNYXRocyxcbiAgICAgIHsgZ2V0SW1hZ2VEZXRhaWxzIH0gPSBpbWFnZU1hcFV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIHNlY29uZCwgdGhpcmQsIHBlcm11dGUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVSb3RhdGlvblF1YXRlcm5pb24gfSA9IHF1YXRlcm5pb25VdGlsaXRpZXMsXG4gICAgICB7IGFkZDIsIG11bHRpcGx5MiwgdHJhbnNmb3JtMiwgdHJhbnNmb3JtMyB9ID0gdmVjdG9yTWF0aHMsXG4gICAgICB7IGNsb25lRWRnZXMsIGNsb25lTm9ybWFsLCBjbG9uZVZlcnRpY2VzLCBjYWxjdWxhdGVFZGdlcywgY2FsY3VsYXRlTm9ybWFsIH0gPSBmYWNldFV0aWxpdGllcztcblxuY2xhc3MgVGV4dHVyZWRGYWNldCBleHRlbmRzIEZhY2V0IHtcbiAgY29uc3RydWN0b3IodmVydGljZXMsIG5vcm1hbCwgZWRnZXMsIGltYWdlTmFtZSwgdGV4dHVyZUNvb3JkaW5hdGVzKSB7XG4gICAgc3VwZXIodmVydGljZXMsIG5vcm1hbCwgZWRnZXMpO1xuXG4gICAgdGhpcy5pbWFnZU5hbWUgPSBpbWFnZU5hbWU7XG4gICAgdGhpcy50ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXM7XG4gIH1cblxuICBnZXRJbWFnZU5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuaW1hZ2VOYW1lO1xuICB9XG5cbiAgZ2V0VGV4dHVyZUNvb3JkaW5hdGVzKCkge1xuICAgIHJldHVybiB0aGlzLnRleHR1cmVDb29yZGluYXRlcztcbiAgfVxuXG4gIGdldFZlcnRleFRleHR1cmVDb29yZGluYXRlcygpIHtcbiAgICBjb25zdCBpbWFnZURldGFpbHMgPSBnZXRJbWFnZURldGFpbHModGhpcy5pbWFnZU5hbWUpLFxuICAgICAgICAgIHsgbGVmdCwgYm90dG9tLCB3aWR0aCwgaGVpZ2h0IH0gPSBpbWFnZURldGFpbHMsXG4gICAgICAgICAgdmVydGV4VGV4dHVyZUNvb3JkaW5hdGVzID0gdHJhbnNsYXRlVGV4dHVyZUNvb3JkaW5hdGVzKHRoaXMudGV4dHVyZUNvb3JkaW5hdGVzLCBsZWZ0LCBib3R0b20sIHdpZHRoLCBoZWlnaHQpO1xuXG4gICAgcmV0dXJuIHZlcnRleFRleHR1cmVDb29yZGluYXRlcztcbiAgfVxuXG4gIHBlcm11dGUocGxhY2VzKSB7XG4gICAgc3VwZXIucGVybXV0ZShwbGFjZXMpO1xuXG4gICAgdGhpcy50ZXh0dXJlQ29vcmRpbmF0ZXMgPSBwZXJtdXRlKHRoaXMudGV4dHVyZUNvb3JkaW5hdGVzLCBwbGFjZXMpO1xuICB9XG5cbiAgc3BsaXRXaXRoVHdvTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cywgRmFjZXQpIHsgc3VwZXIuc3BsaXRXaXRoVHdvTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cywgdGhpcyk7IH0gLy8vXG5cbiAgc3BsaXRXaXRoT25lTm9uTnVsbEludGVyc2VjdGlvbihpbnRlcnNlY3Rpb25zLCBzbWFsbGVyRmFjZXRzLCBGYWNldCkgeyBzdXBlci5zcGxpdFdpdGhPbmVOb25OdWxsSW50ZXJzZWN0aW9uKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMsIHRoaXMpOyB9IC8vL1xuXG4gIGNsb25lKCkge1xuICAgIGxldCB2ZXJ0aWNlcyA9IHRoaXMuZ2V0VmVydGljZXMoKSxcbiAgICAgICAgbm9ybWFsID0gdGhpcy5nZXROb3JtYWwoKSxcbiAgICAgICAgZWRnZXMgPSB0aGlzLmdldEVkZ2VzKCk7XG4gICAgXG4gICAgdmVydGljZXMgPSBjbG9uZVZlcnRpY2VzKHZlcnRpY2VzKTtcbiAgICBub3JtYWwgPSBjbG9uZU5vcm1hbChub3JtYWwpO1xuICAgIGVkZ2VzID0gY2xvbmVFZGdlcyhlZGdlcyk7XG5cbiAgICBjb25zdCBpbWFnZU5hbWUgPSB0aGlzLmltYWdlTmFtZSxcbiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBjbG9uZVRleHR1cmVDb29yZGluYXRlcyh0aGlzLnRleHR1cmVDb29yZGluYXRlcyksXG4gICAgICAgICAgdGV4dHVyZWRGYWNldCA9IG5ldyBUZXh0dXJlZEZhY2V0KHZlcnRpY2VzLCBub3JtYWwsIGVkZ2VzLCBpbWFnZU5hbWUsIHRleHR1cmVDb29yZGluYXRlcyk7XG5cbiAgICByZXR1cm4gdGV4dHVyZWRGYWNldDtcbiAgfVxuXG4gIGZyb21WZXJ0aWNlcyh2ZXJ0aWNlcykge1xuICAgIGNvbnN0IG5vcm1hbCA9IGNhbGN1bGF0ZU5vcm1hbCh2ZXJ0aWNlcyksXG4gICAgICAgICAgZWRnZXMgPSBjYWxjdWxhdGVFZGdlcyh2ZXJ0aWNlcywgRWRnZSksXG4gICAgICAgICAgaW1hZ2VOYW1lID0gdGhpcy5pbWFnZU5hbWUsXG4gICAgICAgICAgcGFyZW50VmVydGljZXMgPSB0aGlzLnZlcnRpY2VzLCAvLy9cbiAgICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXNGcm9tVmVydGljZXNQYXJlbnRWZXJ0aWNlc0FuZFRleHR1cmVDb29yZGluYXRlcyh2ZXJ0aWNlcywgcGFyZW50VmVydGljZXMsIHRoaXMudGV4dHVyZUNvb3JkaW5hdGVzKSxcbiAgICAgICAgICB0ZXh0dXJlZEZhY2V0ID0gbmV3IFRleHR1cmVkRmFjZXQodmVydGljZXMsIG5vcm1hbCwgZWRnZXMsIGltYWdlTmFtZSwgdGV4dHVyZUNvb3JkaW5hdGVzKTtcblxuICAgIHJldHVybiB0ZXh0dXJlZEZhY2V0O1xuICB9XG5cbiAgc3RhdGljIGZyb21WZXJ0aWNlc0luZGV4ZXNJbWFnZU5hbWVBbmRUZXh0dXJlQ29vcmRpbmF0ZXModmVydGljZXMsIGluZGV4ZXMsIGltYWdlTmFtZSwgdGV4dHVyZUNvb3JkaW5hdGVzLCBpbmRleCkge1xuICAgIHZlcnRpY2VzID0gdmVydGljZXNGcm9tVmVydGljZXNBbmRJbmRleGVzKHZlcnRpY2VzLCBpbmRleGVzKTsgLy8vXG5cbiAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXNGcm9tVGV4dHVyZUNvb3JkaW5hdGVzQW5kSW5kZXgodGV4dHVyZUNvb3JkaW5hdGVzLCBpbmRleCk7ICAvLy9cblxuICAgIGNvbnN0IG5vcm1hbCA9IGNhbGN1bGF0ZU5vcm1hbCh2ZXJ0aWNlcyksXG4gICAgICAgICAgZWRnZXMgPSBjYWxjdWxhdGVFZGdlcyh2ZXJ0aWNlcywgRWRnZSksXG4gICAgICAgICAgdGV4dHVyZWRGYWNldCA9IG5ldyBUZXh0dXJlZEZhY2V0KHZlcnRpY2VzLCBub3JtYWwsIGVkZ2VzLCBpbWFnZU5hbWUsIHRleHR1cmVDb29yZGluYXRlcyk7XG5cbiAgICByZXR1cm4gdGV4dHVyZWRGYWNldDtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFRleHR1cmVkRmFjZXQ7XG5cbmZ1bmN0aW9uIHZlcnRpY2VzRnJvbVZlcnRpY2VzQW5kSW5kZXhlcyh2ZXJ0aWNlcywgaW5kZXhlcykgeyAgLy8vXG4gIHZlcnRpY2VzID0gaW5kZXhlcy5tYXAoZnVuY3Rpb24oaW5kZXgpIHtcbiAgICBjb25zdCB2ZXJ0ZXggPSB2ZXJ0aWNlc1tpbmRleF07XG5cbiAgICByZXR1cm4gdmVydGV4O1xuICB9KTtcblxuICByZXR1cm4gdmVydGljZXM7XG59XG5cbmZ1bmN0aW9uIHRleHR1cmVDb29yZGluYXRlc0Zyb21UZXh0dXJlQ29vcmRpbmF0ZXNBbmRJbmRleCh0ZXh0dXJlQ29vcmRpbmF0ZXMsIGluZGV4KSB7ICAvLy9cbiAgdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzLnNsaWNlKGluZGV4ICogMywgaW5kZXggKiAzICsgMyk7ICAvLy9cblxuICByZXR1cm4gdGV4dHVyZUNvb3JkaW5hdGVzO1xufVxuXG5mdW5jdGlvbiBjbG9uZVRleHR1cmVDb29yZGluYXRlcyh0ZXh0dXJlQ29vcmRpbmF0ZXMpIHtcbiAgdGV4dHVyZUNvb3JkaW5hdGVzID0gdGV4dHVyZUNvb3JkaW5hdGVzLm1hcChmdW5jdGlvbih0ZXh0dXJlQ29vcmRpbmF0ZXMpIHsgIC8vL1xuICAgIHRleHR1cmVDb29yZGluYXRlcyA9IHRleHR1cmVDb29yZGluYXRlcy5zbGljZSgpO1xuXG4gICAgcmV0dXJuIHRleHR1cmVDb29yZGluYXRlcztcbiAgfSk7XG5cbiAgcmV0dXJuIHRleHR1cmVDb29yZGluYXRlcztcbn1cblxuZnVuY3Rpb24gdHJhbnNsYXRlVGV4dHVyZUNvb3JkaW5hdGVzKHRleHR1cmVDb29yZGluYXRlcywgbGVmdCwgYm90dG9tLCB3aWR0aCwgaGVpZ2h0ICkge1xuICB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZXMubWFwKGZ1bmN0aW9uKHRleHR1cmVDb29yZGluYXRlcykgeyAgLy8vXG4gICAgdGV4dHVyZUNvb3JkaW5hdGVzID0gYWRkMihtdWx0aXBseTIodGV4dHVyZUNvb3JkaW5hdGVzLCBbIHdpZHRoLCBoZWlnaHQgXSApLCBbIGxlZnQsIGJvdHRvbSBdKTtcblxuICAgIHJldHVybiB0ZXh0dXJlQ29vcmRpbmF0ZXM7XG4gIH0pO1xuXG4gIHJldHVybiB0ZXh0dXJlQ29vcmRpbmF0ZXM7XG59XG5cbmZ1bmN0aW9uIHRleHR1cmVDb29yZGluYXRlc0Zyb21WZXJ0aWNlc1BhcmVudFZlcnRpY2VzQW5kVGV4dHVyZUNvb3JkaW5hdGVzKHZlcnRpY2VzLCBwYXJlbnRWZXJ0aWNlcywgdGV4dHVyZUNvb3JkaW5hdGVzKSB7XG4gIGNvbnN0IG5vcm1hbCA9IGNhbGN1bGF0ZU5vcm1hbCh2ZXJ0aWNlcyksXG4gICAgICAgIHJvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZVJvdGF0aW9uUXVhdGVybmlvbihub3JtYWwpLFxuICAgICAgICB2ZXJ0aWNlc0luWFlQbGFuZSA9IHJvdGF0ZVZlcnRpY2VzKHZlcnRpY2VzLCByb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICBwYXJlbnRWZXJ0aWNlc0luWFlQbGFuZSA9IHJvdGF0ZVZlcnRpY2VzKHBhcmVudFZlcnRpY2VzLCByb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXggPSBjYWxjdWxhdGVUZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgodGV4dHVyZUNvb3JkaW5hdGVzKSxcbiAgICAgICAgdGV4dHVyZUNvb3JkaW5hdGVzQmFzaXMgPSBjYWxjdWxhdGVUZXh0dXJlQ29vcmRpbmF0ZXNCYXNpcyhwYXJlbnRWZXJ0aWNlc0luWFlQbGFuZSwgdGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4KTtcblxuICB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBjYWxjdWxhdGVUZXh0dXJlQ29vcmRpbmF0ZXModmVydGljZXNJblhZUGxhbmUsIHRleHR1cmVDb29yZGluYXRlc0Jhc2lzKTtcblxuICByZXR1cm4gdGV4dHVyZUNvb3JkaW5hdGVzO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVUZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgodGV4dHVyZUNvb3JkaW5hdGVzKSB7XG4gIGNvbnN0IGZpcnN0VGV4dHVyZUNvb3JkaW5hdGUgPSBmaXJzdCh0ZXh0dXJlQ29vcmRpbmF0ZXMpLFxuICAgICAgICBzZWNvbmRUZXh0dXJlQ29vcmRpbmF0ZSA9IHNlY29uZCh0ZXh0dXJlQ29vcmRpbmF0ZXMpLFxuICAgICAgICB0aGlyZFRleHR1cmVDb29yZGluYXRlID0gdGhpcmQodGV4dHVyZUNvb3JkaW5hdGVzKSxcbiAgICAgICAgUDF1ID0gZmlyc3RUZXh0dXJlQ29vcmRpbmF0ZVswXSwgLy8vXG4gICAgICAgIFAxdiA9IGZpcnN0VGV4dHVyZUNvb3JkaW5hdGVbMV0sIC8vL1xuICAgICAgICBQMnUgPSBzZWNvbmRUZXh0dXJlQ29vcmRpbmF0ZVswXSwgLy8vXG4gICAgICAgIFAydiA9IHNlY29uZFRleHR1cmVDb29yZGluYXRlWzFdLCAvLy9cbiAgICAgICAgUDN1ID0gdGhpcmRUZXh0dXJlQ29vcmRpbmF0ZVswXSwgLy8vXG4gICAgICAgIFAzdiA9IHRoaXJkVGV4dHVyZUNvb3JkaW5hdGVbMV0sIC8vL1xuICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXggPSBpbnZlcnQzKFsgMSwgMSwgMSwgUDF1LCBQMnUsIFAzdSwgUDF2LCBQMnYsIFAzdiBdKTtcblxuICByZXR1cm4gdGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4O1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVUZXh0dXJlQ29vcmRpbmF0ZXNCYXNpcyhwYXJlbnRWZXJ0aWNlc0luWFlQbGFuZSwgdGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4KSB7XG4gIGNvbnN0IGZpcnN0UGFyZW50VmVydGV4SW5YWVBsYW5lID0gZmlyc3QocGFyZW50VmVydGljZXNJblhZUGxhbmUpLFxuICAgICAgICBzZWNvbmRQYXJlbnRWZXJ0ZXhJblhZUGxhbmUgPSBzZWNvbmQocGFyZW50VmVydGljZXNJblhZUGxhbmUpLFxuICAgICAgICB0aGlyZFBhcmVudFZlcnRleEluWFlQbGFuZSA9IHRoaXJkKHBhcmVudFZlcnRpY2VzSW5YWVBsYW5lKSxcbiAgICAgICAgUDF4ID0gZmlyc3RQYXJlbnRWZXJ0ZXhJblhZUGxhbmVbMF0sIC8vL1xuICAgICAgICBQMXkgPSBmaXJzdFBhcmVudFZlcnRleEluWFlQbGFuZVsxXSwgLy8vXG4gICAgICAgIFAyeCA9IHNlY29uZFBhcmVudFZlcnRleEluWFlQbGFuZVswXSwgLy8vXG4gICAgICAgIFAyeSA9IHNlY29uZFBhcmVudFZlcnRleEluWFlQbGFuZVsxXSwgLy8vXG4gICAgICAgIFAzeCA9IHRoaXJkUGFyZW50VmVydGV4SW5YWVBsYW5lWzBdLCAvLy9cbiAgICAgICAgUDN5ID0gdGhpcmRQYXJlbnRWZXJ0ZXhJblhZUGxhbmVbMV0sIC8vL1xuICAgICAgICB4VmVjdG9yID0gdHJhbnNmb3JtMyhbIFAxeCwgUDJ4LCBQM3ggXSwgdGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4KSxcbiAgICAgICAgeVZlY3RvciA9IHRyYW5zZm9ybTMoWyBQMXksIFAyeSwgUDN5IF0sIHRleHR1cmVDb29yZGluYXRlc01hdHJpeCksXG4gICAgICAgIHRleHR1cmVDb29yZGluYXRlc0Jhc2lzID0gW10uY29uY2F0KHhWZWN0b3IpLmNvbmNhdCh5VmVjdG9yKTtcblxuICByZXR1cm4gdGV4dHVyZUNvb3JkaW5hdGVzQmFzaXM7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVRleHR1cmVDb29yZGluYXRlcyh2ZXJ0aWNlc0luWFlQbGFuZSwgdGV4dHVyZUNvb3JkaW5hdGVzQmFzaXMpIHtcbiAgY29uc3QgZmlyc3RWZXJ0ZXhJblhZUGxhbmUgPSBmaXJzdCh2ZXJ0aWNlc0luWFlQbGFuZSksXG4gICAgICAgIHNlY29uZFZlcnRleEluWFlQbGFuZSA9IHNlY29uZCh2ZXJ0aWNlc0luWFlQbGFuZSksXG4gICAgICAgIHRoaXJkVmVydGV4SW5YWVBsYW5lID0gdGhpcmQodmVydGljZXNJblhZUGxhbmUpLFxuICAgICAgICBSMXggPSBmaXJzdFZlcnRleEluWFlQbGFuZVswXSwgIC8vL1xuICAgICAgICBSMXkgPSBmaXJzdFZlcnRleEluWFlQbGFuZVsxXSwgIC8vL1xuICAgICAgICBSMnggPSBzZWNvbmRWZXJ0ZXhJblhZUGxhbmVbMF0sIC8vL1xuICAgICAgICBSMnkgPSBzZWNvbmRWZXJ0ZXhJblhZUGxhbmVbMV0sIC8vL1xuICAgICAgICBSM3ggPSB0aGlyZFZlcnRleEluWFlQbGFuZVswXSwgIC8vL1xuICAgICAgICBSM3kgPSB0aGlyZFZlcnRleEluWFlQbGFuZVsxXSwgIC8vL1xuICAgICAgICBPeCA9IHRleHR1cmVDb29yZGluYXRlc0Jhc2lzWzBdLCAgLy8vXG4gICAgICAgIE95ID0gdGV4dHVyZUNvb3JkaW5hdGVzQmFzaXNbM10sICAvLy9cbiAgICAgICAgVXggPSB0ZXh0dXJlQ29vcmRpbmF0ZXNCYXNpc1sxXSwgIC8vL1xuICAgICAgICBVeSA9IHRleHR1cmVDb29yZGluYXRlc0Jhc2lzWzRdLCAgLy8vXG4gICAgICAgIFZ4ID0gdGV4dHVyZUNvb3JkaW5hdGVzQmFzaXNbMl0sICAvLy9cbiAgICAgICAgVnkgPSB0ZXh0dXJlQ29vcmRpbmF0ZXNCYXNpc1s1XSwgIC8vL1xuICAgICAgICBtYXRyaXggPSBpbnZlcnQyKFsgVXgsIFV5LCBWeCwgVnkgXSksXG4gICAgICAgIGZpcnN0VGV4dHVyZUNvb3JkaW5hdGVzID0gdHJhbnNmb3JtMihbIFIxeCAtIE94LCBSMXkgLSBPeSBdLCBtYXRyaXgpLFxuICAgICAgICBzZWNvbmRUZXh0dXJlQ29vcmRpbmF0ZXMgPSB0cmFuc2Zvcm0yKFsgUjJ4IC0gT3gsIFIyeSAtIE95IF0sIG1hdHJpeCksXG4gICAgICAgIHRoaXJkVGV4dHVyZUNvb3JkaW5hdGVzID0gdHJhbnNmb3JtMihbIFIzeCAtIE94LCBSM3kgLSBPeSBdLCBtYXRyaXgpLFxuICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXMgPSBbXG4gICAgICAgICAgZmlyc3RUZXh0dXJlQ29vcmRpbmF0ZXMsXG4gICAgICAgICAgc2Vjb25kVGV4dHVyZUNvb3JkaW5hdGVzLFxuICAgICAgICAgIHRoaXJkVGV4dHVyZUNvb3JkaW5hdGVzLFxuICAgICAgICBdO1xuXG4gIHJldHVybiB0ZXh0dXJlQ29vcmRpbmF0ZXM7XG59XG4iXX0=