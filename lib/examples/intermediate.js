'use strict';

var necessary = require('necessary');

var Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    colourCube = require('./intermediate/cube/colour'),
    textureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    first = arrayUtilities.first,
    repeatedly = asynchronousUtilities.repeatedly;


function intermediate() {
  var canvas = new Canvas();

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createColourCube(canvas, function (count, colourShader) {
    createTextureCube(canvas, function (count, textureShader) {
      canvas.useShader(textureShader);

      textureShader.activateTexture(canvas);

      var render = createRender(canvas, count, textureShader);

      requestAnimationFrame(render);
    });
  });
}

module.exports = intermediate;

function createColourCube(canvas, callback) {
  var offsetPosition = [-1, 0, 0];

  colourCube(offsetPosition, canvas, callback);
}

function createTextureCube(canvas, callback) {
  loadImages(function (images) {
    var firstImage = first(images),
        offsetPosition = [+1, 0, 0],
        image = firstImage; ///

    textureCube(offsetPosition, image, canvas, callback);
  });
}

function loadImages(callback) {
  var imageSources = ['texture/bricks.jpg'],
      images = [],
      context = {
    imageSources: imageSources,
    images: images
  },
      length = imageSources.length; ///

  repeatedly(loadImageCallback, length, function () {
    var images = context.images;


    callback(images);
  }, context);
}

function createRender(canvas, count, shader) {
  var initialTime = null;

  var clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      zCoordinate = -10,
      ///
  position = Position.fromZCoordinate(zCoordinate),
      perspective = Perspective.fromClientWidthAndClientHeight(clientWidth, clientHeight);

  var render = function render(time) {
    if (initialTime === null) {
      initialTime = time;
    }

    var elapsedTime = time - initialTime,

    // xAngle = elapsedTime / 1000,
    // yAngle = elapsedTime / 1000,
    // rotation = Rotation.fromXAngleAndYAngle(xAngle, yAngle),
    rotation = Rotation.fromNothing(),
        normal = Normal.fromRotation(rotation);

    canvas.render(shader, normal, rotation, position, perspective);

    canvas.drawElements(count);

    requestAnimationFrame(render);
  };

  return render;
}

function loadImageCallback(next, done, context, index) {
  var imageSources = context.imageSources,
      images = context.images,
      imageSource = imageSources[index],
      image = new Image();


  images[index] = image;

  image.onload = next; ///

  image.src = imageSource; ///
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsIkNhbnZhcyIsIk5vcm1hbCIsIlJvdGF0aW9uIiwiUG9zaXRpb24iLCJQZXJzcGVjdGl2ZSIsImNvbG91ckN1YmUiLCJ0ZXh0dXJlQ3ViZSIsImFycmF5VXRpbGl0aWVzIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwiZmlyc3QiLCJyZXBlYXRlZGx5IiwiaW50ZXJtZWRpYXRlIiwiY2FudmFzIiwiZW5hYmxlRGVwdGhUZXN0aW5nIiwiZW5hYmxlRGVwdGhGdW5jdGlvbiIsImNyZWF0ZUNvbG91ckN1YmUiLCJjb3VudCIsImNvbG91clNoYWRlciIsImNyZWF0ZVRleHR1cmVDdWJlIiwidGV4dHVyZVNoYWRlciIsInVzZVNoYWRlciIsImFjdGl2YXRlVGV4dHVyZSIsInJlbmRlciIsImNyZWF0ZVJlbmRlciIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJjYWxsYmFjayIsIm9mZnNldFBvc2l0aW9uIiwibG9hZEltYWdlcyIsImltYWdlcyIsImZpcnN0SW1hZ2UiLCJpbWFnZSIsImltYWdlU291cmNlcyIsImNvbnRleHQiLCJsZW5ndGgiLCJsb2FkSW1hZ2VDYWxsYmFjayIsInNoYWRlciIsImluaXRpYWxUaW1lIiwiY2xpZW50V2lkdGgiLCJnZXRDbGllbnRXaWR0aCIsImNsaWVudEhlaWdodCIsImdldENsaWVudEhlaWdodCIsInpDb29yZGluYXRlIiwicG9zaXRpb24iLCJmcm9tWkNvb3JkaW5hdGUiLCJwZXJzcGVjdGl2ZSIsImZyb21DbGllbnRXaWR0aEFuZENsaWVudEhlaWdodCIsInRpbWUiLCJlbGFwc2VkVGltZSIsInJvdGF0aW9uIiwiZnJvbU5vdGhpbmciLCJub3JtYWwiLCJmcm9tUm90YXRpb24iLCJkcmF3RWxlbWVudHMiLCJuZXh0IiwiZG9uZSIsImluZGV4IiwiaW1hZ2VTb3VyY2Ui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ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IENhbnZhcyA9IHJlcXVpcmUoJy4uL2NhbnZhcycpLFxuICAgICAgTm9ybWFsID0gcmVxdWlyZSgnLi4vbm9ybWFsJyksXG4gICAgICBSb3RhdGlvbiA9IHJlcXVpcmUoJy4uL3JvdGF0aW9uJyksXG4gICAgICBQb3NpdGlvbiA9IHJlcXVpcmUoJy4uL3Bvc2l0aW9uJyksXG4gICAgICBQZXJzcGVjdGl2ZSA9IHJlcXVpcmUoJy4uL3BlcnNwZWN0aXZlJyksXG4gICAgICBjb2xvdXJDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS9jb2xvdXInKSxcbiAgICAgIHRleHR1cmVDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS90ZXh0dXJlJyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMsIGFzeW5jaHJvbm91c1V0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJlcGVhdGVkbHkgfSA9IGFzeW5jaHJvbm91c1V0aWxpdGllcztcblxuZnVuY3Rpb24gaW50ZXJtZWRpYXRlKCkge1xuICBjb25zdCBjYW52YXMgPSBuZXcgQ2FudmFzKCk7XG5cbiAgY2FudmFzLmVuYWJsZURlcHRoVGVzdGluZygpO1xuICBjYW52YXMuZW5hYmxlRGVwdGhGdW5jdGlvbigpO1xuXG4gIGNyZWF0ZUNvbG91ckN1YmUoY2FudmFzLCBmdW5jdGlvbihjb3VudCwgY29sb3VyU2hhZGVyKSB7XG4gICAgY3JlYXRlVGV4dHVyZUN1YmUoY2FudmFzLCBmdW5jdGlvbihjb3VudCwgdGV4dHVyZVNoYWRlcikge1xuICAgICAgY2FudmFzLnVzZVNoYWRlcih0ZXh0dXJlU2hhZGVyKTtcblxuICAgICAgdGV4dHVyZVNoYWRlci5hY3RpdmF0ZVRleHR1cmUoY2FudmFzKTtcblxuICAgICAgY29uc3QgcmVuZGVyID0gY3JlYXRlUmVuZGVyKGNhbnZhcywgY291bnQsIHRleHR1cmVTaGFkZXIpO1xuXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVuZGVyKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gaW50ZXJtZWRpYXRlO1xuXG5mdW5jdGlvbiBjcmVhdGVDb2xvdXJDdWJlKGNhbnZhcywgY2FsbGJhY2spIHtcbiAgY29uc3Qgb2Zmc2V0UG9zaXRpb24gPSBbLTEsIDAsIDBdO1xuXG4gIGNvbG91ckN1YmUob2Zmc2V0UG9zaXRpb24sIGNhbnZhcywgY2FsbGJhY2spO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVUZXh0dXJlQ3ViZShjYW52YXMsIGNhbGxiYWNrKSB7XG4gIGxvYWRJbWFnZXMoZnVuY3Rpb24oaW1hZ2VzKSB7XG4gICAgY29uc3QgZmlyc3RJbWFnZSA9IGZpcnN0KGltYWdlcyksXG4gICAgICAgICAgb2Zmc2V0UG9zaXRpb24gPSBbKzEsIDAsIDBdLFxuICAgICAgICAgIGltYWdlID0gZmlyc3RJbWFnZTsgLy8vXG5cbiAgICB0ZXh0dXJlQ3ViZShvZmZzZXRQb3NpdGlvbiwgaW1hZ2UsIGNhbnZhcywgY2FsbGJhY2spO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbG9hZEltYWdlcyhjYWxsYmFjaykge1xuICBjb25zdCBpbWFnZVNvdXJjZXMgPSBbXG4gICAgICAgICAgJ3RleHR1cmUvYnJpY2tzLmpwZydcbiAgICAgICAgXSxcbiAgICAgICAgaW1hZ2VzID0gW10sXG4gICAgICAgIGNvbnRleHQgPSB7XG4gICAgICAgICAgaW1hZ2VTb3VyY2VzOiBpbWFnZVNvdXJjZXMsXG4gICAgICAgICAgaW1hZ2VzOiBpbWFnZXNcbiAgICAgICAgfSxcbiAgICAgICAgbGVuZ3RoID0gaW1hZ2VTb3VyY2VzLmxlbmd0aDsgLy8vXG5cbiAgcmVwZWF0ZWRseShsb2FkSW1hZ2VDYWxsYmFjaywgbGVuZ3RoLCBmdW5jdGlvbigpIHtcbiAgICBjb25zdCB7IGltYWdlcyB9ID0gY29udGV4dDtcblxuICAgIGNhbGxiYWNrKGltYWdlcylcbiAgfSwgY29udGV4dCk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVJlbmRlcihjYW52YXMsIGNvdW50LCBzaGFkZXIpIHtcbiAgbGV0IGluaXRpYWxUaW1lID0gbnVsbDtcblxuICBjb25zdCBjbGllbnRXaWR0aCA9IGNhbnZhcy5nZXRDbGllbnRXaWR0aCgpLFxuICAgICAgICBjbGllbnRIZWlnaHQgPSBjYW52YXMuZ2V0Q2xpZW50SGVpZ2h0KCksXG4gICAgICAgIHpDb29yZGluYXRlID0gLTEwLCAvLy9cbiAgICAgICAgcG9zaXRpb24gPSBQb3NpdGlvbi5mcm9tWkNvb3JkaW5hdGUoekNvb3JkaW5hdGUpLFxuICAgICAgICBwZXJzcGVjdGl2ZSA9IFBlcnNwZWN0aXZlLmZyb21DbGllbnRXaWR0aEFuZENsaWVudEhlaWdodChjbGllbnRXaWR0aCwgY2xpZW50SGVpZ2h0KTtcblxuICBjb25zdCByZW5kZXIgPSAodGltZSkgPT4ge1xuICAgIGlmIChpbml0aWFsVGltZSA9PT0gbnVsbCkge1xuICAgICAgaW5pdGlhbFRpbWUgPSB0aW1lO1xuICAgIH1cblxuICAgIGNvbnN0IGVsYXBzZWRUaW1lID0gdGltZSAtIGluaXRpYWxUaW1lLFxuICAgICAgICAgIC8vIHhBbmdsZSA9IGVsYXBzZWRUaW1lIC8gMTAwMCxcbiAgICAgICAgICAvLyB5QW5nbGUgPSBlbGFwc2VkVGltZSAvIDEwMDAsXG4gICAgICAgICAgLy8gcm90YXRpb24gPSBSb3RhdGlvbi5mcm9tWEFuZ2xlQW5kWUFuZ2xlKHhBbmdsZSwgeUFuZ2xlKSxcbiAgICAgICAgICByb3RhdGlvbiA9IFJvdGF0aW9uLmZyb21Ob3RoaW5nKCksXG4gICAgICAgICAgbm9ybWFsID0gTm9ybWFsLmZyb21Sb3RhdGlvbihyb3RhdGlvbik7XG5cbiAgICBjYW52YXMucmVuZGVyKHNoYWRlciwgbm9ybWFsLCByb3RhdGlvbiwgcG9zaXRpb24sIHBlcnNwZWN0aXZlKTtcblxuICAgIGNhbnZhcy5kcmF3RWxlbWVudHMoY291bnQpO1xuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG4gIH07XG5cbiAgcmV0dXJuIHJlbmRlcjtcbn1cblxuZnVuY3Rpb24gbG9hZEltYWdlQ2FsbGJhY2sobmV4dCwgZG9uZSwgY29udGV4dCwgaW5kZXgpIHtcbiAgY29uc3QgeyBpbWFnZVNvdXJjZXMsIGltYWdlcyB9ID0gY29udGV4dCxcbiAgICAgICAgaW1hZ2VTb3VyY2UgPSBpbWFnZVNvdXJjZXNbaW5kZXhdLFxuICAgICAgICBpbWFnZSA9IG5ldyBJbWFnZSgpO1xuXG4gIGltYWdlc1tpbmRleF0gPSBpbWFnZTtcblxuICBpbWFnZS5vbmxvYWQgPSBuZXh0OyAgLy8vXG5cbiAgaW1hZ2Uuc3JjID0gaW1hZ2VTb3VyY2U7ICAvLy9cbn1cbiJdfQ==