'use strict';

var necessary = require('necessary');

var Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    ColourShader = require('../shader/colour'),
    TextureShader = require('../shader/texture'),
    ColourCube = require('./intermediate/cube/colour'),
    TextureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    first = arrayUtilities.first,
    repeatedly = asynchronousUtilities.repeatedly;


function intermediate() {
  var canvas = new Canvas(),
      colourShader = ColourShader.fromNothing(canvas),
      textureShader = TextureShader.fromNothing(canvas);

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createColourCube(colourShader, canvas, function (colourCube) {
    createTextureCube(textureShader, canvas, function (textureCube) {
      var render = createRender(canvas, colourCube, colourShader, textureCube, textureShader);

      requestAnimationFrame(render);
    });
  });
}

module.exports = intermediate;

function createColourCube(colourShader, canvas, callback) {
  var offsetPosition = [-2, 0, 0],
      colourCube = ColourCube.fromOffsetPosition(offsetPosition, colourShader, canvas);

  callback(colourCube);
}

function createTextureCube(textureShader, canvas, callback) {
  loadImages(function (images) {
    var firstImage = first(images),
        offsetPosition = [+2, 0, 0],
        image = firstImage,
        textureCube = TextureCube.fromOffsetPositionAndImage(offsetPosition, image, textureShader, canvas);

    callback(textureCube);
  });
}

function loadImages(callback) {
  var imageSources = ['texture/bricks.jpg'],
      images = [],
      context = {
    imageSources: imageSources,
    images: images
  },
      length = imageSources.length; ///

  repeatedly(loadImageCallback, length, function () {
    var images = context.images;


    callback(images);
  }, context);
}

function createRender(canvas, colourCube, colourShader, textureCube, textureShader) {
  var initialTime = null;

  var clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      zCoordinate = -10,
      ///
  position = Position.fromZCoordinate(zCoordinate),
      perspective = Perspective.fromClientWidthAndClientHeight(clientWidth, clientHeight),
      colourCubeCount = colourCube.getCount(),
      textureCubeCount = textureCube.getCount();

  var render = function render(time) {
    if (initialTime === null) {
      initialTime = time;
    }

    var elapsedTime = time - initialTime,
        xAngle = elapsedTime / 573,
        yAngle = elapsedTime / 892,
        rotation = Rotation.fromXAngleAndYAngle(xAngle, yAngle),
        normal = Normal.fromRotation(rotation);

    canvas.clear();

    colourCube.bind(colourShader, canvas);

    canvas.useShader(colourShader);

    colourShader.activateTexture(canvas);

    canvas.render(colourShader, normal, rotation, position, perspective);

    canvas.drawElements(colourCubeCount);

    textureCube.bind(textureShader, canvas);

    canvas.useShader(textureShader);

    textureShader.activateTexture(canvas);

    canvas.render(textureShader, normal, rotation, position, perspective);

    canvas.drawElements(textureCubeCount);

    requestAnimationFrame(render);
  };

  return render;
}

function loadImageCallback(next, done, context, index) {
  var imageSources = context.imageSources,
      images = context.images,
      imageSource = imageSources[index],
      image = new Image();


  images[index] = image;

  image.onload = next; ///

  image.src = imageSource; ///
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsIkNhbnZhcyIsIk5vcm1hbCIsIlJvdGF0aW9uIiwiUG9zaXRpb24iLCJQZXJzcGVjdGl2ZSIsIkNvbG91clNoYWRlciIsIlRleHR1cmVTaGFkZXIiLCJDb2xvdXJDdWJlIiwiVGV4dHVyZUN1YmUiLCJhcnJheVV0aWxpdGllcyIsImFzeW5jaHJvbm91c1V0aWxpdGllcyIsImZpcnN0IiwicmVwZWF0ZWRseSIsImludGVybWVkaWF0ZSIsImNhbnZhcyIsImNvbG91clNoYWRlciIsImZyb21Ob3RoaW5nIiwidGV4dHVyZVNoYWRlciIsImVuYWJsZURlcHRoVGVzdGluZyIsImVuYWJsZURlcHRoRnVuY3Rpb24iLCJjcmVhdGVDb2xvdXJDdWJlIiwiY29sb3VyQ3ViZSIsImNyZWF0ZVRleHR1cmVDdWJlIiwidGV4dHVyZUN1YmUiLCJyZW5kZXIiLCJjcmVhdGVSZW5kZXIiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwiY2FsbGJhY2siLCJvZmZzZXRQb3NpdGlvbiIsImZyb21PZmZzZXRQb3NpdGlvbiIsImxvYWRJbWFnZXMiLCJpbWFnZXMiLCJmaXJzdEltYWdlIiwiaW1hZ2UiLCJmcm9tT2Zmc2V0UG9zaXRpb25BbmRJbWFnZSIsImltYWdlU291cmNlcyIsImNvbnRleHQiLCJsZW5ndGgiLCJsb2FkSW1hZ2VDYWxsYmFjayIsImluaXRpYWxUaW1lIiwiY2xpZW50V2lkdGgiLCJnZXRDbGllbnRXaWR0aCIsImNsaWVudEhlaWdodCIsImdldENsaWVudEhlaWdodCIsInpDb29yZGluYXRlIiwicG9zaXRpb24iLCJmcm9tWkNvb3JkaW5hdGUiLCJwZXJzcGVjdGl2ZSIsImZyb21DbGllbnRXaWR0aEFuZENsaWVudEhlaWdodCIsImNvbG91ckN1YmVDb3VudCIsImdldENvdW50IiwidGV4dHVyZUN1YmVDb3VudCIsInRpbWUiLCJlbGFwc2VkVGltZSIsInhBbmdsZSIsInlBbmdsZSIsInJvdGF0aW9uIiwiZnJvbVhBbmdsZUFuZFlBbmdsZSIsIm5vcm1hbCIsImZyb21Sb3RhdGlvbiIsImNsZWFyIiwiYmluZCIsInVzZVNoYWRlciIsImFjdGl2YXRlVGV4dHVyZSIsImRyYXdFbGVtZW50cyIsIm5leHQiLCJkb25lIiwiaW5kZXgiLCJpbWFnZVNvdXJjZSIsIkltYWdlIiwib25sb2FkIiwic3JjIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFNQSxZQUFZQyxRQUFRLFdBQVIsQ0FBbEI7O0FBRUEsSUFBTUMsU0FBU0QsUUFBUSxXQUFSLENBQWY7QUFBQSxJQUNNRSxTQUFTRixRQUFRLFdBQVIsQ0FEZjtBQUFBLElBRU1HLFdBQVdILFFBQVEsYUFBUixDQUZqQjtBQUFBLElBR01JLFdBQVdKLFFBQVEsYUFBUixDQUhqQjtBQUFBLElBSU1LLGNBQWNMLFFBQVEsZ0JBQVIsQ0FKcEI7QUFBQSxJQUtNTSxlQUFlTixRQUFRLGtCQUFSLENBTHJCO0FBQUEsSUFNTU8sZ0JBQWdCUCxRQUFRLG1CQUFSLENBTnRCO0FBQUEsSUFPTVEsYUFBYVIsUUFBUSw0QkFBUixDQVBuQjtBQUFBLElBUU1TLGNBQWNULFFBQVEsNkJBQVIsQ0FScEI7O0lBVVFVLGMsR0FBMENYLFMsQ0FBMUNXLGM7SUFBZ0JDLHFCLEdBQTBCWixTLENBQTFCWSxxQjtJQUNoQkMsSyxHQUFVRixjLENBQVZFLEs7SUFDQUMsVSxHQUFlRixxQixDQUFmRSxVOzs7QUFFUixTQUFTQyxZQUFULEdBQXdCO0FBQ3RCLE1BQU1DLFNBQVMsSUFBSWQsTUFBSixFQUFmO0FBQUEsTUFDTWUsZUFBZVYsYUFBYVcsV0FBYixDQUF5QkYsTUFBekIsQ0FEckI7QUFBQSxNQUVNRyxnQkFBZ0JYLGNBQWNVLFdBQWQsQ0FBMEJGLE1BQTFCLENBRnRCOztBQUlBQSxTQUFPSSxrQkFBUDtBQUNBSixTQUFPSyxtQkFBUDs7QUFFQUMsbUJBQWlCTCxZQUFqQixFQUErQkQsTUFB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QUFFdEJoQyxRQUFNc0MsR0FBTixHQUFZSCxXQUFaLENBVHFELENBUzNCO0FBQzNCIiwiZmlsZSI6ImludGVybWVkaWF0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IENhbnZhcyA9IHJlcXVpcmUoJy4uL2NhbnZhcycpLFxuICAgICAgTm9ybWFsID0gcmVxdWlyZSgnLi4vbm9ybWFsJyksXG4gICAgICBSb3RhdGlvbiA9IHJlcXVpcmUoJy4uL3JvdGF0aW9uJyksXG4gICAgICBQb3NpdGlvbiA9IHJlcXVpcmUoJy4uL3Bvc2l0aW9uJyksXG4gICAgICBQZXJzcGVjdGl2ZSA9IHJlcXVpcmUoJy4uL3BlcnNwZWN0aXZlJyksXG4gICAgICBDb2xvdXJTaGFkZXIgPSByZXF1aXJlKCcuLi9zaGFkZXIvY29sb3VyJyksXG4gICAgICBUZXh0dXJlU2hhZGVyID0gcmVxdWlyZSgnLi4vc2hhZGVyL3RleHR1cmUnKSxcbiAgICAgIENvbG91ckN1YmUgPSByZXF1aXJlKCcuL2ludGVybWVkaWF0ZS9jdWJlL2NvbG91cicpLFxuICAgICAgVGV4dHVyZUN1YmUgPSByZXF1aXJlKCcuL2ludGVybWVkaWF0ZS9jdWJlL3RleHR1cmUnKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcywgYXN5bmNocm9ub3VzVXRpbGl0aWVzIH0gPSBuZWNlc3NhcnksXG4gICAgICB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgcmVwZWF0ZWRseSB9ID0gYXN5bmNocm9ub3VzVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiBpbnRlcm1lZGlhdGUoKSB7XG4gIGNvbnN0IGNhbnZhcyA9IG5ldyBDYW52YXMoKSxcbiAgICAgICAgY29sb3VyU2hhZGVyID0gQ29sb3VyU2hhZGVyLmZyb21Ob3RoaW5nKGNhbnZhcyksXG4gICAgICAgIHRleHR1cmVTaGFkZXIgPSBUZXh0dXJlU2hhZGVyLmZyb21Ob3RoaW5nKGNhbnZhcyk7XG5cbiAgY2FudmFzLmVuYWJsZURlcHRoVGVzdGluZygpO1xuICBjYW52YXMuZW5hYmxlRGVwdGhGdW5jdGlvbigpO1xuXG4gIGNyZWF0ZUNvbG91ckN1YmUoY29sb3VyU2hhZGVyLCBjYW52YXMsIGZ1bmN0aW9uKGNvbG91ckN1YmUpIHtcbiAgICBjcmVhdGVUZXh0dXJlQ3ViZSh0ZXh0dXJlU2hhZGVyLCBjYW52YXMsIGZ1bmN0aW9uKHRleHR1cmVDdWJlKSB7XG4gICAgICBjb25zdCByZW5kZXIgPSBjcmVhdGVSZW5kZXIoY2FudmFzLCBjb2xvdXJDdWJlLCBjb2xvdXJTaGFkZXIsIHRleHR1cmVDdWJlLCB0ZXh0dXJlU2hhZGVyKTtcblxuICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG4gICAgfSk7XG4gIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGludGVybWVkaWF0ZTtcblxuZnVuY3Rpb24gY3JlYXRlQ29sb3VyQ3ViZShjb2xvdXJTaGFkZXIsIGNhbnZhcywgY2FsbGJhY2spIHtcbiAgY29uc3Qgb2Zmc2V0UG9zaXRpb24gPSBbLTIsIDAsIDBdLFxuICAgICAgICBjb2xvdXJDdWJlID0gQ29sb3VyQ3ViZS5mcm9tT2Zmc2V0UG9zaXRpb24ob2Zmc2V0UG9zaXRpb24sIGNvbG91clNoYWRlciwgY2FudmFzKTtcblxuICBjYWxsYmFjayhjb2xvdXJDdWJlKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlVGV4dHVyZUN1YmUodGV4dHVyZVNoYWRlciwgY2FudmFzLCBjYWxsYmFjaykge1xuICBsb2FkSW1hZ2VzKGZ1bmN0aW9uKGltYWdlcykge1xuICAgIGNvbnN0IGZpcnN0SW1hZ2UgPSBmaXJzdChpbWFnZXMpLFxuICAgICAgICAgIG9mZnNldFBvc2l0aW9uID0gWysyLCAwLCAwXSxcbiAgICAgICAgICBpbWFnZSA9IGZpcnN0SW1hZ2UsXG4gICAgICAgICAgdGV4dHVyZUN1YmUgPSBUZXh0dXJlQ3ViZS5mcm9tT2Zmc2V0UG9zaXRpb25BbmRJbWFnZShvZmZzZXRQb3NpdGlvbiwgaW1hZ2UsIHRleHR1cmVTaGFkZXIsIGNhbnZhcyk7XG5cbiAgICBjYWxsYmFjayh0ZXh0dXJlQ3ViZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBsb2FkSW1hZ2VzKGNhbGxiYWNrKSB7XG4gIGNvbnN0IGltYWdlU291cmNlcyA9IFtcbiAgICAgICAgICAndGV4dHVyZS9icmlja3MuanBnJ1xuICAgICAgICBdLFxuICAgICAgICBpbWFnZXMgPSBbXSxcbiAgICAgICAgY29udGV4dCA9IHtcbiAgICAgICAgICBpbWFnZVNvdXJjZXM6IGltYWdlU291cmNlcyxcbiAgICAgICAgICBpbWFnZXM6IGltYWdlc1xuICAgICAgICB9LFxuICAgICAgICBsZW5ndGggPSBpbWFnZVNvdXJjZXMubGVuZ3RoOyAvLy9cblxuICByZXBlYXRlZGx5KGxvYWRJbWFnZUNhbGxiYWNrLCBsZW5ndGgsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHsgaW1hZ2VzIH0gPSBjb250ZXh0O1xuXG4gICAgY2FsbGJhY2soaW1hZ2VzKVxuICB9LCBjb250ZXh0KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmVuZGVyKGNhbnZhcywgY29sb3VyQ3ViZSwgY29sb3VyU2hhZGVyLCB0ZXh0dXJlQ3ViZSwgdGV4dHVyZVNoYWRlcikge1xuICBsZXQgaW5pdGlhbFRpbWUgPSBudWxsO1xuXG4gIGNvbnN0IGNsaWVudFdpZHRoID0gY2FudmFzLmdldENsaWVudFdpZHRoKCksXG4gICAgICAgIGNsaWVudEhlaWdodCA9IGNhbnZhcy5nZXRDbGllbnRIZWlnaHQoKSxcbiAgICAgICAgekNvb3JkaW5hdGUgPSAtMTAsIC8vL1xuICAgICAgICBwb3NpdGlvbiA9IFBvc2l0aW9uLmZyb21aQ29vcmRpbmF0ZSh6Q29vcmRpbmF0ZSksXG4gICAgICAgIHBlcnNwZWN0aXZlID0gUGVyc3BlY3RpdmUuZnJvbUNsaWVudFdpZHRoQW5kQ2xpZW50SGVpZ2h0KGNsaWVudFdpZHRoLCBjbGllbnRIZWlnaHQpLFxuICAgICAgICBjb2xvdXJDdWJlQ291bnQgPSBjb2xvdXJDdWJlLmdldENvdW50KCksXG4gICAgICAgIHRleHR1cmVDdWJlQ291bnQgPSB0ZXh0dXJlQ3ViZS5nZXRDb3VudCgpO1xuXG4gIGNvbnN0IHJlbmRlciA9ICh0aW1lKSA9PiB7XG4gICAgaWYgKGluaXRpYWxUaW1lID09PSBudWxsKSB7XG4gICAgICBpbml0aWFsVGltZSA9IHRpbWU7XG4gICAgfVxuXG4gICAgY29uc3QgZWxhcHNlZFRpbWUgPSB0aW1lIC0gaW5pdGlhbFRpbWUsXG4gICAgICAgICAgeEFuZ2xlID0gZWxhcHNlZFRpbWUgLyA1NzMsXG4gICAgICAgICAgeUFuZ2xlID0gZWxhcHNlZFRpbWUgLyA4OTIsXG4gICAgICAgICAgcm90YXRpb24gPSBSb3RhdGlvbi5mcm9tWEFuZ2xlQW5kWUFuZ2xlKHhBbmdsZSwgeUFuZ2xlKSxcbiAgICAgICAgICBub3JtYWwgPSBOb3JtYWwuZnJvbVJvdGF0aW9uKHJvdGF0aW9uKTtcblxuICAgIGNhbnZhcy5jbGVhcigpO1xuXG5cblxuICAgIGNvbG91ckN1YmUuYmluZChjb2xvdXJTaGFkZXIsIGNhbnZhcyk7XG5cbiAgICBjYW52YXMudXNlU2hhZGVyKGNvbG91clNoYWRlcik7XG5cbiAgICBjb2xvdXJTaGFkZXIuYWN0aXZhdGVUZXh0dXJlKGNhbnZhcyk7XG5cbiAgICBjYW52YXMucmVuZGVyKGNvbG91clNoYWRlciwgbm9ybWFsLCByb3RhdGlvbiwgcG9zaXRpb24sIHBlcnNwZWN0aXZlKTtcblxuICAgIGNhbnZhcy5kcmF3RWxlbWVudHMoY29sb3VyQ3ViZUNvdW50KTtcblxuXG5cblxuICAgIHRleHR1cmVDdWJlLmJpbmQodGV4dHVyZVNoYWRlciwgY2FudmFzKTtcblxuICAgIGNhbnZhcy51c2VTaGFkZXIodGV4dHVyZVNoYWRlcik7XG5cbiAgICB0ZXh0dXJlU2hhZGVyLmFjdGl2YXRlVGV4dHVyZShjYW52YXMpO1xuXG4gICAgY2FudmFzLnJlbmRlcih0ZXh0dXJlU2hhZGVyLCBub3JtYWwsIHJvdGF0aW9uLCBwb3NpdGlvbiwgcGVyc3BlY3RpdmUpO1xuXG4gICAgY2FudmFzLmRyYXdFbGVtZW50cyh0ZXh0dXJlQ3ViZUNvdW50KTtcblxuXG5cblxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShyZW5kZXIpO1xuICB9O1xuXG4gIHJldHVybiByZW5kZXI7XG59XG5cbmZ1bmN0aW9uIGxvYWRJbWFnZUNhbGxiYWNrKG5leHQsIGRvbmUsIGNvbnRleHQsIGluZGV4KSB7XG4gIGNvbnN0IHsgaW1hZ2VTb3VyY2VzLCBpbWFnZXMgfSA9IGNvbnRleHQsXG4gICAgICAgIGltYWdlU291cmNlID0gaW1hZ2VTb3VyY2VzW2luZGV4XSxcbiAgICAgICAgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcblxuICBpbWFnZXNbaW5kZXhdID0gaW1hZ2U7XG5cbiAgaW1hZ2Uub25sb2FkID0gbmV4dDsgIC8vL1xuXG4gIGltYWdlLnNyYyA9IGltYWdlU291cmNlOyAgLy8vXG59XG4iXX0=