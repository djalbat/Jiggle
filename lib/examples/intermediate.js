'use strict';

var necessary = require('necessary');

var angles = require('../angles'),
    zoom = require('../zoom'),
    Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    MouseEvents = require('../mouseEvents'),
    ColourShader = require('../shader/colour'),
    TextureShader = require('../shader/texture'),
    imagesUtilities = require('../utilities/images'),
    ColourCube = require('./intermediate/cube/colour'),
    TextureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    preload = imagesUtilities.preload,
    first = arrayUtilities.first;


var render = void 0,
    resize = void 0;

function intermediate() {
  var canvas = new Canvas(),
      colourShader = ColourShader.fromNothing(canvas),
      textureShader = TextureShader.fromNothing(canvas);

  var mouseEvents = new MouseEvents(canvas);

  mouseEvents.addMouseUpEventHandler(mouseUpEventHandler);
  mouseEvents.addMouseDownEventHandler(mouseDownEventHandler);
  mouseEvents.addMouseMoveEventHandler(mouseMoveEventHandler);
  mouseEvents.addMouseWheelEventHandler(mouseWheelEventHandler);

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createColourCube(colourShader, canvas, function (colourCube) {
    createTextureCube(textureShader, canvas, function (textureCube) {
      render = createRender(canvas, colourCube, colourShader, textureCube, textureShader);
      resize = createResize(canvas);

      window.onresize = resize;

      resize();

      render();
    });
  });
}

module.exports = intermediate;

function createColourCube(colourShader, canvas, callback) {
  var offsetPosition = [-2, 0, 0],
      colourCube = ColourCube.fromOffsetPosition(offsetPosition, colourShader, canvas);

  callback(colourCube);
}

function createTextureCube(textureShader, canvas, callback) {
  var sources = ['texture/bricks.jpg'];

  preload(sources, function (images) {
    var firstImage = first(images),
        offsetPosition = [+2, 0, 0],
        image = firstImage,
        ///
    textureCube = TextureCube.fromOffsetPositionAndImage(offsetPosition, image, textureShader, canvas);

    callback(textureCube);
  });
}

function createRender(canvas, colourCube, colourShader, textureCube, textureShader) {
  var colourCubeCount = colourCube.getCount(),
      textureCubeCount = textureCube.getCount();

  var render = function render() {
    var xAxisAngle = angles.getXAxisAngle(),
        yAxisAngle = angles.getYAxisAngle(),
        distance = zoom.getDistance(),
        xAngle = xAxisAngle,
        ///
    zAngle = yAxisAngle,
        ///
    zCoordinate = -Math.max(10, distance),
        ///
    width = canvas.getWidth(),
        height = canvas.getHeight(),
        perspective = Perspective.fromWidthAndHeight(width, height),
        rotation = Rotation.fromXAngleAndZAngle(xAngle, zAngle),
        position = Position.fromZCoordinate(zCoordinate),
        normal = Normal.fromRotation(rotation);

    canvas.clear();

    colourCube.bind(colourShader, canvas);

    canvas.useShader(colourShader);

    colourShader.activateTexture(canvas);

    canvas.render(colourShader, normal, rotation, position, perspective);

    canvas.drawElements(colourCubeCount);

    textureCube.bind(textureShader, canvas);

    canvas.useShader(textureShader);

    textureShader.activateTexture(canvas);

    canvas.render(textureShader, normal, rotation, position, perspective);

    canvas.drawElements(textureCubeCount);
  };

  return render;
}

function createResize(canvas) {
  var resize = function resize() {
    var clientWidth = canvas.getClientWidth(),
        clientHeight = canvas.getClientHeight(),
        width = clientWidth,
        ///
    height = clientHeight; ///

    canvas.resize(width, height);
  };

  return resize;
}

function mouseUpEventHandler(mouseCoordinates) {
  angles.mouseUpEventHandler(mouseCoordinates);
}

function mouseDownEventHandler(mouseCoordinates) {
  angles.mouseDownEventHandler(mouseCoordinates);
}

function mouseMoveEventHandler(mouseCoordinates) {
  angles.mouseMoveEventHandler(mouseCoordinates);

  if (render) {
    render();
  }
}

function mouseWheelEventHandler(delta) {
  zoom.mouseWheelEventHandler(delta);

  if (render) {
    render();
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsImFuZ2xlcyIsInpvb20iLCJDYW52YXMiLCJOb3JtYWwiLCJSb3RhdGlvbiIsIlBvc2l0aW9uIiwiUGVyc3BlY3RpdmUiLCJNb3VzZUV2ZW50cyIsIkNvbG91clNoYWRlciIsIlRleHR1cmVTaGFkZXIiLCJpbWFnZXNVdGlsaXRpZXMiLCJDb2xvdXJDdWJlIiwiVGV4dHVyZUN1YmUiLCJhcnJheVV0aWxpdGllcyIsInByZWxvYWQiLCJmaXJzdCIsInJlbmRlciIsInJlc2l6ZSIsImludGVybWVkaWF0ZSIsImNhbnZhcyIsImNvbG91clNoYWRlciIsImZyb21Ob3RoaW5nIiwidGV4dHVyZVNoYWRlciIsIm1vdXNlRXZlbnRzIiwiYWRkTW91c2VVcEV2ZW50SGFuZGxlciIsIm1vdXNlVXBFdmVudEhhbmRsZXIiLCJhZGRNb3VzZURvd25FdmVudEhhbmRsZXIiLCJtb3VzZURvd25FdmVudEhhbmRsZXIiLCJhZGRNb3VzZU1vdmVFdmVudEhhbmRsZXIiLCJtb3VzZU1vdmVFdmVudEhhbmRsZXIiLCJhZGRNb3VzZVdoZWVsRXZlbnRIYW5kbGVyIiwibW91c2VXaGVlbEV2ZW50SGFuZGxlciIsImVuYWJsZURlcHRoVGVzdGluZyIsImVuYWJsZURlcHRoRnVuY3Rpb24iLCJjcmVhdGVDb2xvdXJDdWJlIiwiY29sb3VyQ3ViZSIsImNyZWF0ZVRleHR1cmVDdWJlIiwidGV4dHVyZUN1YmUiLCJjcmVhdGVSZW5kZXIiLCJjcmVhdGVSZXNpemUiLCJ3aW5kb3ciLCJvbnJlc2l6ZSIsIm1vZHVsZSIsImV4cG9ydHMiLCJjYWxsYmFjayIsIm9mZnNldFBvc2l0aW9uIiwiZnJvbU9mZnNldFBvc2l0aW9uIiwic291cmNlcyIsImltYWdlcyIsImZpcnN0SW1hZ2UiLCJpbWFnZSIsImZyb21PZmZzZXRQb3NpdGlvbkFuZEltYWdlIiwiY29sb3VyQ3ViZUNvdW50IiwiZ2V0Q291bnQiLCJ0ZXh0dXJlQ3ViZUNvdW50IiwieEF4aXNBbmdsZSIsImdldFhBeGlzQW5nbGUiLCJ5QXhpc0FuZ2xlIiwiZ2V0WUF4aXNBbmdsZSIsImRpc3RhbmNlIiwiZ2V0RGlzdGFuY2UiLCJ4QW5nbGUiLCJ6QW5nbGUiLCJ6Q29vcmRpbmF0ZSIsIk1hdGgiLCJtYXgiLCJ3aWR0aCIsImdldFdpZHRoIiwiaGVpZ2h0IiwiZ2V0SGVpZ2h0IiwicGVyc3BlY3RpdmUiLCJmcm9tV2lkdGhBbmRIZWlnaHQiLCJyb3RhdGlvbiIsImZyb21YQW5nbGVBbmRaQW5nbGUiLCJwb3NpdGlvbiIsImZyb21aQ29vcmRpbmF0ZSIsIm5vcm1hbCIsImZyb21Sb3RhdGlvbiIsImNsZWFyIiwiYmluZCIsInVzZVNoYWRlciIsImFjdGl2YXRlVGV4dHVyZSIsImRyYXdFbGVtZW50cyIsImNsaWVudFdpZHRoIiwiZ2V0Q2xpZW50V2lkdGgiLCJjbGllbnRIZWlnaHQiLCJnZXRDbGllbnRIZWlnaHQiLCJtb3VzZUNvb3JkaW5hdGVzIiwiZGVsdGEiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFlBQVlDLFFBQVEsV0FBUixDQUFsQjs7QUFFQSxJQUFNQyxTQUFTRCxRQUFRLFdBQVIsQ0FBZjtBQUFBLElBQ01FLE9BQU9GLFFBQVEsU0FBUixDQURiO0FBQUEsSUFFTUcsU0FBU0gsUUFBUSxXQUFSLENBRmY7QUFBQSxJQUdNSSxTQUFTSixRQUFRLFdBQVIsQ0FIZjtBQUFBLElBSU1LLFdBQVdMLFFBQVEsYUFBUixDQUpqQjtBQUFBLElBS01NLFdBQVdOLFFBQVEsYUFBUixDQUxqQjtBQUFBLElBTU1PLGNBQWNQLFFBQVEsZ0JBQVIsQ0FOcEI7QUFBQSxJQU9NUSxjQUFjUixRQUFRLGdCQUFSLENBUHBCO0FBQUEsSUFRTVMsZUFBZVQsUUFBUSxrQkFBUixDQVJyQjtBQUFBLElBU01VLGdCQUFnQlYsUUFBUSxtQkFBUixDQVR0QjtBQUFBLElBVU1XLGtCQUFrQlgsUUFBUSxxQkFBUixDQVZ4QjtBQUFB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QyxFQUF5REosV0FBekQ7O0FBRUFuRCxXQUFPK0QsWUFBUCxDQUFvQjVCLGdCQUFwQjtBQUNELEdBbkNEOztBQXFDQSxTQUFPdEMsTUFBUDtBQUNEOztBQUVELFNBQVN1QixZQUFULENBQXNCcEIsTUFBdEIsRUFBOEI7QUFDNUIsTUFBTUYsU0FBUyxTQUFUQSxNQUFTLEdBQU07QUFDbkIsUUFBTWtFLGNBQWNoRSxPQUFPaUUsY0FBUCxFQUFwQjtBQUFBLFFBQ01DLGVBQWVsRSxPQUFPbUUsZUFBUCxFQURyQjtBQUFBLFFBRU1wQixRQUFRaUIsV0FGZDtBQUFBLFFBRTRCO0FBQ3RCZixhQUFTaUIsWUFIZixDQURtQixDQUlXOztBQUU5QmxFLFdBQU9GLE1BQVAsQ0FBY2lELEtBQWQsRUFBcUJFLE1BQXJCO0FBQ0QsR0FQRDs7QUFTQSxTQUFPbkQsTUFBUDtBQUNEOztBQUVELFNBQVNRLG1CQUFULENBQTZCOEQsZ0JBQTdCLEVBQStDO0FBQzdDdkYsU0FBT3lCLG1CQUFQLENBQTJCOEQsZ0JBQTNCO0FBQ0Q7O0FBRUQsU0FBUzVELHFCQUFULENBQStCNEQsZ0JBQS9CLEVBQWlEO0FBQy9DdkYsU0FBTzJCLHFCQUFQLENBQTZCNEQsZ0JBQTdCO0FBQ0Q7O0FBRUQsU0FBUzFELHFCQUFULENBQStCMEQsZ0JBQS9CLEVBQWlEO0FBQy9DdkYsU0FBTzZCLHFCQUFQLENBQTZCMEQsZ0JBQTdCOztBQUVBLE1BQUl2RSxNQUFKLEVBQVk7QUFDVkE7QUFDRDtBQUNGOztBQUVELFNBQVNlLHNCQUFULENBQWdDeUQsS0FBaEMsRUFBdUM7QUFDckN2RixPQUFLOEIsc0JBQUwsQ0FBNEJ5RCxLQUE1Qjs7QUFFQSxNQUFJeEUsTUFBSixFQUFZO0FBQ1ZBO0FBQ0Q7QUFDRiIsImZpbGUiOiJpbnRlcm1lZGlhdGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBhbmdsZXMgPSByZXF1aXJlKCcuLi9hbmdsZXMnKSxcbiAgICAgIHpvb20gPSByZXF1aXJlKCcuLi96b29tJyksXG4gICAgICBDYW52YXMgPSByZXF1aXJlKCcuLi9jYW52YXMnKSxcbiAgICAgIE5vcm1hbCA9IHJlcXVpcmUoJy4uL25vcm1hbCcpLFxuICAgICAgUm90YXRpb24gPSByZXF1aXJlKCcuLi9yb3RhdGlvbicpLFxuICAgICAgUG9zaXRpb24gPSByZXF1aXJlKCcuLi9wb3NpdGlvbicpLFxuICAgICAgUGVyc3BlY3RpdmUgPSByZXF1aXJlKCcuLi9wZXJzcGVjdGl2ZScpLFxuICAgICAgTW91c2VFdmVudHMgPSByZXF1aXJlKCcuLi9tb3VzZUV2ZW50cycpLFxuICAgICAgQ29sb3VyU2hhZGVyID0gcmVxdWlyZSgnLi4vc2hhZGVyL2NvbG91cicpLFxuICAgICAgVGV4dHVyZVNoYWRlciA9IHJlcXVpcmUoJy4uL3NoYWRlci90ZXh0dXJlJyksXG4gICAgICBpbWFnZXNVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvaW1hZ2VzJyksXG4gICAgICBDb2xvdXJDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS9jb2xvdXInKSxcbiAgICAgIFRleHR1cmVDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS90ZXh0dXJlJyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgcHJlbG9hZCB9ID0gaW1hZ2VzVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXM7XG5cbmxldCByZW5kZXIsIHJlc2l6ZTtcblxuZnVuY3Rpb24gaW50ZXJtZWRpYXRlKCkge1xuICBjb25zdCBjYW52YXMgPSBuZXcgQ2FudmFzKCksXG4gICAgICAgIGNvbG91clNoYWRlciA9IENvbG91clNoYWRlci5mcm9tTm90aGluZyhjYW52YXMpLFxuICAgICAgICB0ZXh0dXJlU2hhZGVyID0gVGV4dHVyZVNoYWRlci5mcm9tTm90aGluZyhjYW52YXMpO1xuXG4gIGNvbnN0IG1vdXNlRXZlbnRzID0gbmV3IE1vdXNlRXZlbnRzKGNhbnZhcyk7XG5cbiAgbW91c2VFdmVudHMuYWRkTW91c2VVcEV2ZW50SGFuZGxlcihtb3VzZVVwRXZlbnRIYW5kbGVyKTtcbiAgbW91c2VFdmVudHMuYWRkTW91c2VEb3duRXZlbnRIYW5kbGVyKG1vdXNlRG93bkV2ZW50SGFuZGxlcik7XG4gIG1vdXNlRXZlbnRzLmFkZE1vdXNlTW92ZUV2ZW50SGFuZGxlcihtb3VzZU1vdmVFdmVudEhhbmRsZXIpO1xuICBtb3VzZUV2ZW50cy5hZGRNb3VzZVdoZWVsRXZlbnRIYW5kbGVyKG1vdXNlV2hlZWxFdmVudEhhbmRsZXIpO1xuXG4gIGNhbnZhcy5lbmFibGVEZXB0aFRlc3RpbmcoKTtcbiAgY2FudmFzLmVuYWJsZURlcHRoRnVuY3Rpb24oKTtcblxuXG4gIGNyZWF0ZUNvbG91ckN1YmUoY29sb3VyU2hhZGVyLCBjYW52YXMsIGZ1bmN0aW9uKGNvbG91ckN1YmUpIHtcbiAgICBjcmVhdGVUZXh0dXJlQ3ViZSh0ZXh0dXJlU2hhZGVyLCBjYW52YXMsIGZ1bmN0aW9uKHRleHR1cmVDdWJlKSB7XG4gICAgICByZW5kZXIgPSBjcmVhdGVSZW5kZXIoY2FudmFzLCBjb2xvdXJDdWJlLCBjb2xvdXJTaGFkZXIsIHRleHR1cmVDdWJlLCB0ZXh0dXJlU2hhZGVyKTtcbiAgICAgIHJlc2l6ZSA9IGNyZWF0ZVJlc2l6ZShjYW52YXMpO1xuXG4gICAgICB3aW5kb3cub25yZXNpemUgPSByZXNpemU7XG5cbiAgICAgIHJlc2l6ZSgpO1xuXG4gICAgICByZW5kZXIoKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gaW50ZXJtZWRpYXRlO1xuXG5mdW5jdGlvbiBjcmVhdGVDb2xvdXJDdWJlKGNvbG91clNoYWRlciwgY2FudmFzLCBjYWxsYmFjaykge1xuICBjb25zdCBvZmZzZXRQb3NpdGlvbiA9IFstMiwgMCwgMF0sXG4gICAgICAgIGNvbG91ckN1YmUgPSBDb2xvdXJDdWJlLmZyb21PZmZzZXRQb3NpdGlvbihvZmZzZXRQb3NpdGlvbiwgY29sb3VyU2hhZGVyLCBjYW52YXMpO1xuXG4gIGNhbGxiYWNrKGNvbG91ckN1YmUpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVUZXh0dXJlQ3ViZSh0ZXh0dXJlU2hhZGVyLCBjYW52YXMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHNvdXJjZXMgPSBbXG4gICAgICAgICAgJ3RleHR1cmUvYnJpY2tzLmpwZydcbiAgICAgICAgXTtcblxuICBwcmVsb2FkKHNvdXJjZXMsIGZ1bmN0aW9uKGltYWdlcykge1xuICAgIGNvbnN0IGZpcnN0SW1hZ2UgPSBmaXJzdChpbWFnZXMpLFxuICAgICAgICAgIG9mZnNldFBvc2l0aW9uID0gWysyLCAwLCAwXSxcbiAgICAgICAgICBpbWFnZSA9IGZpcnN0SW1hZ2UsIC8vL1xuICAgICAgICAgIHRleHR1cmVDdWJlID0gVGV4dHVyZUN1YmUuZnJvbU9mZnNldFBvc2l0aW9uQW5kSW1hZ2Uob2Zmc2V0UG9zaXRpb24sIGltYWdlLCB0ZXh0dXJlU2hhZGVyLCBjYW52YXMpO1xuXG4gICAgY2FsbGJhY2sodGV4dHVyZUN1YmUpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmVuZGVyKGNhbnZhcywgY29sb3VyQ3ViZSwgY29sb3VyU2hhZGVyLCB0ZXh0dXJlQ3ViZSwgdGV4dHVyZVNoYWRlcikge1xuICBjb25zdCBjb2xvdXJDdWJlQ291bnQgPSBjb2xvdXJDdWJlLmdldENvdW50KCksXG4gICAgICAgIHRleHR1cmVDdWJlQ291bnQgPSB0ZXh0dXJlQ3ViZS5nZXRDb3VudCgpO1xuXG4gIGNvbnN0IHJlbmRlciA9ICgpID0+IHtcbiAgICBjb25zdCB4QXhpc0FuZ2xlID0gYW5nbGVzLmdldFhBeGlzQW5nbGUoKSxcbiAgICAgICAgICB5QXhpc0FuZ2xlID0gYW5nbGVzLmdldFlBeGlzQW5nbGUoKSxcbiAgICAgICAgICBkaXN0YW5jZSA9IHpvb20uZ2V0RGlzdGFuY2UoKSxcbiAgICAgICAgICB4QW5nbGUgPSB4QXhpc0FuZ2xlLCAgLy8vXG4gICAgICAgICAgekFuZ2xlID0geUF4aXNBbmdsZSwgLy8vXG4gICAgICAgICAgekNvb3JkaW5hdGUgPSAtTWF0aC5tYXgoMTAsIGRpc3RhbmNlKSwgLy8vXG4gICAgICAgICAgd2lkdGggPSBjYW52YXMuZ2V0V2lkdGgoKSxcbiAgICAgICAgICBoZWlnaHQgPSBjYW52YXMuZ2V0SGVpZ2h0KCksXG4gICAgICAgICAgcGVyc3BlY3RpdmUgPSBQZXJzcGVjdGl2ZS5mcm9tV2lkdGhBbmRIZWlnaHQod2lkdGgsIGhlaWdodCksXG4gICAgICAgICAgcm90YXRpb24gPSBSb3RhdGlvbi5mcm9tWEFuZ2xlQW5kWkFuZ2xlKHhBbmdsZSwgekFuZ2xlKSxcbiAgICAgICAgICBwb3NpdGlvbiA9IFBvc2l0aW9uLmZyb21aQ29vcmRpbmF0ZSh6Q29vcmRpbmF0ZSksXG4gICAgICAgICAgbm9ybWFsID0gTm9ybWFsLmZyb21Sb3RhdGlvbihyb3RhdGlvbik7XG5cbiAgICBjYW52YXMuY2xlYXIoKTtcblxuICAgIGNvbG91ckN1YmUuYmluZChjb2xvdXJTaGFkZXIsIGNhbnZhcyk7XG5cbiAgICBjYW52YXMudXNlU2hhZGVyKGNvbG91clNoYWRlcik7XG5cbiAgICBjb2xvdXJTaGFkZXIuYWN0aXZhdGVUZXh0dXJlKGNhbnZhcyk7XG5cbiAgICBjYW52YXMucmVuZGVyKGNvbG91clNoYWRlciwgbm9ybWFsLCByb3RhdGlvbiwgcG9zaXRpb24sIHBlcnNwZWN0aXZlKTtcblxuICAgIGNhbnZhcy5kcmF3RWxlbWVudHMoY29sb3VyQ3ViZUNvdW50KTtcblxuICAgIHRleHR1cmVDdWJlLmJpbmQodGV4dHVyZVNoYWRlciwgY2FudmFzKTtcblxuICAgIGNhbnZhcy51c2VTaGFkZXIodGV4dHVyZVNoYWRlcik7XG5cbiAgICB0ZXh0dXJlU2hhZGVyLmFjdGl2YXRlVGV4dHVyZShjYW52YXMpO1xuXG4gICAgY2FudmFzLnJlbmRlcih0ZXh0dXJlU2hhZGVyLCBub3JtYWwsIHJvdGF0aW9uLCBwb3NpdGlvbiwgcGVyc3BlY3RpdmUpO1xuXG4gICAgY2FudmFzLmRyYXdFbGVtZW50cyh0ZXh0dXJlQ3ViZUNvdW50KTtcbiAgfTtcblxuICByZXR1cm4gcmVuZGVyO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSZXNpemUoY2FudmFzKSB7XG4gIGNvbnN0IHJlc2l6ZSA9ICgpID0+IHtcbiAgICBjb25zdCBjbGllbnRXaWR0aCA9IGNhbnZhcy5nZXRDbGllbnRXaWR0aCgpLFxuICAgICAgICAgIGNsaWVudEhlaWdodCA9IGNhbnZhcy5nZXRDbGllbnRIZWlnaHQoKSxcbiAgICAgICAgICB3aWR0aCA9IGNsaWVudFdpZHRoLCAgLy8vXG4gICAgICAgICAgaGVpZ2h0ID0gY2xpZW50SGVpZ2h0OyAgLy8vXG5cbiAgICBjYW52YXMucmVzaXplKHdpZHRoLCBoZWlnaHQpO1xuICB9O1xuXG4gIHJldHVybiByZXNpemU7XG59XG5cbmZ1bmN0aW9uIG1vdXNlVXBFdmVudEhhbmRsZXIobW91c2VDb29yZGluYXRlcykge1xuICBhbmdsZXMubW91c2VVcEV2ZW50SGFuZGxlcihtb3VzZUNvb3JkaW5hdGVzKTtcbn1cblxuZnVuY3Rpb24gbW91c2VEb3duRXZlbnRIYW5kbGVyKG1vdXNlQ29vcmRpbmF0ZXMpIHtcbiAgYW5nbGVzLm1vdXNlRG93bkV2ZW50SGFuZGxlcihtb3VzZUNvb3JkaW5hdGVzKTtcbn1cblxuZnVuY3Rpb24gbW91c2VNb3ZlRXZlbnRIYW5kbGVyKG1vdXNlQ29vcmRpbmF0ZXMpIHtcbiAgYW5nbGVzLm1vdXNlTW92ZUV2ZW50SGFuZGxlcihtb3VzZUNvb3JkaW5hdGVzKTtcblxuICBpZiAocmVuZGVyKSB7XG4gICAgcmVuZGVyKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbW91c2VXaGVlbEV2ZW50SGFuZGxlcihkZWx0YSkge1xuICB6b29tLm1vdXNlV2hlZWxFdmVudEhhbmRsZXIoZGVsdGEpO1xuXG4gIGlmIChyZW5kZXIpIHtcbiAgICByZW5kZXIoKTtcbiAgfVxufVxuIl19