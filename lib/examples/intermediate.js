'use strict';

var necessary = require('necessary');

var Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    ColourShader = require('../shader/colour'),
    TextureShader = require('../shader/texture'),
    imagesUtilities = require('../utilities/images'),
    ColourCube = require('./intermediate/cube/colour'),
    TextureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    preload = imagesUtilities.preload,
    first = arrayUtilities.first;


function intermediate() {
  var canvas = new Canvas(),
      colourShader = ColourShader.fromNothing(canvas),
      textureShader = TextureShader.fromNothing(canvas);

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createColourCube(colourShader, canvas, function (colourCube) {
    createTextureCube(textureShader, canvas, function (textureCube) {
      var render = createRender(canvas, colourCube, colourShader, textureCube, textureShader);

      requestAnimationFrame(render);
    });
  });
}

module.exports = intermediate;

function createColourCube(colourShader, canvas, callback) {
  var offsetPosition = [-2, 0, 0],
      colourCube = ColourCube.fromOffsetPosition(offsetPosition, colourShader, canvas);

  callback(colourCube);
}

function createTextureCube(textureShader, canvas, callback) {
  var sources = ['texture/bricks.jpg'];

  preload(sources, function (images) {
    var firstImage = first(images),
        offsetPosition = [+2, 0, 0],
        image = firstImage,
        ///
    textureCube = TextureCube.fromOffsetPositionAndImage(offsetPosition, image, textureShader, canvas);

    callback(textureCube);
  });
}

function createRender(canvas, colourCube, colourShader, textureCube, textureShader) {
  var initialTime = null;

  var clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      zCoordinate = -10,
      ///
  position = Position.fromZCoordinate(zCoordinate),
      perspective = Perspective.fromClientWidthAndClientHeight(clientWidth, clientHeight),
      colourCubeCount = colourCube.getCount(),
      textureCubeCount = textureCube.getCount();

  var render = function render(time) {
    if (initialTime === null) {
      initialTime = time;
    }

    var elapsedTime = time - initialTime,
        rotation = Rotation.fromNothing(),
        normal = Normal.fromRotation(rotation);

    canvas.clear();

    colourCube.bind(colourShader, canvas);

    canvas.useShader(colourShader);

    colourShader.activateTexture(canvas);

    canvas.render(colourShader, normal, rotation, position, perspective);

    canvas.drawElements(colourCubeCount);

    textureCube.bind(textureShader, canvas);

    canvas.useShader(textureShader);

    textureShader.activateTexture(canvas);

    canvas.render(textureShader, normal, rotation, position, perspective);

    canvas.drawElements(textureCubeCount);

    requestAnimationFrame(render);
  };

  return render;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsIkNhbnZhcyIsIk5vcm1hbCIsIlJvdGF0aW9uIiwiUG9zaXRpb24iLCJQZXJzcGVjdGl2ZSIsIkNvbG91clNoYWRlciIsIlRleHR1cmVTaGFkZXIiLCJpbWFnZXNVdGlsaXRpZXMiLCJDb2xvdXJDdWJlIiwiVGV4dHVyZUN1YmUiLCJhcnJheVV0aWxpdGllcyIsInByZWxvYWQiLCJmaXJzdCIsImludGVybWVkaWF0ZSIsImNhbnZhcyIsImNvbG91clNoYWRlciIsImZyb21Ob3RoaW5nIiwidGV4dHVyZVNoYWRlciIsImVuYWJsZURlcHRoVGVzdGluZyIsImVuYWJsZURlcHRoRnVuY3Rpb24iLCJjcmVhdGVDb2xvdXJDdWJlIiwiY29sb3VyQ3ViZSIsImNyZWF0ZVRleHR1cmVDdWJlIiwidGV4dHVyZUN1YmUiLCJyZW5kZXIiLCJjcmVhdGVSZW5kZXIiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwiY2FsbGJhY2siLCJvZmZzZXRQb3NpdGlvbiIsImZyb21PZmZzZXRQb3NpdGlvbiIsInNvdXJjZXMiLCJpbWFnZXMiLCJmaXJzdEltYWdlIiwiaW1hZ2UiLCJmcm9tT2Zmc2V0UG9zaXRpb25BbmRJbWFnZSIsImluaXRpYWxUaW1lIiwiY2xpZW50V2lkdGgiLCJnZXRDbGllbnRXaWR0aCIsImNsaWVudEhlaWdodCIsImdldENsaWVudEhlaWdodCIsInpDb29yZGluYXRlIiwicG9zaXRpb24iLCJmcm9tWkNvb3JkaW5hdGUiLCJwZXJzcGVjdGl2ZSIsImZyb21DbGllbnRXaWR0aEFuZENsaWVudEhlaWdodCIsImNvbG91ckN1YmVDb3VudCIsImdldENvdW50IiwidGV4dHVyZUN1YmVDb3VudCIsInRpbWUiLCJlbGFwc2VkVGltZSIsInJvdGF0aW9uIiwibm9ybWFsIiwiZnJvbVJvdGF0aW9uIiwiY2xlYXIi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QUF6RDs7QUFFQS9CLFdBQU82QyxZQUFQLENBQW9CVixnQkFBcEI7O0FBRUF2QiwwQkFBc0JGLE1BQXRCO0FBQ0QsR0FoQ0Q7O0FBa0NBLFNBQU9BLE1BQVA7QUFDRCIsImZpbGUiOiJpbnRlcm1lZGlhdGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBDYW52YXMgPSByZXF1aXJlKCcuLi9jYW52YXMnKSxcbiAgICAgIE5vcm1hbCA9IHJlcXVpcmUoJy4uL25vcm1hbCcpLFxuICAgICAgUm90YXRpb24gPSByZXF1aXJlKCcuLi9yb3RhdGlvbicpLFxuICAgICAgUG9zaXRpb24gPSByZXF1aXJlKCcuLi9wb3NpdGlvbicpLFxuICAgICAgUGVyc3BlY3RpdmUgPSByZXF1aXJlKCcuLi9wZXJzcGVjdGl2ZScpLFxuICAgICAgQ29sb3VyU2hhZGVyID0gcmVxdWlyZSgnLi4vc2hhZGVyL2NvbG91cicpLFxuICAgICAgVGV4dHVyZVNoYWRlciA9IHJlcXVpcmUoJy4uL3NoYWRlci90ZXh0dXJlJyksXG4gICAgICBpbWFnZXNVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvaW1hZ2VzJyksXG4gICAgICBDb2xvdXJDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS9jb2xvdXInKSxcbiAgICAgIFRleHR1cmVDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS90ZXh0dXJlJyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgcHJlbG9hZCB9ID0gaW1hZ2VzVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGludGVybWVkaWF0ZSgpIHtcbiAgY29uc3QgY2FudmFzID0gbmV3IENhbnZhcygpLFxuICAgICAgICBjb2xvdXJTaGFkZXIgPSBDb2xvdXJTaGFkZXIuZnJvbU5vdGhpbmcoY2FudmFzKSxcbiAgICAgICAgdGV4dHVyZVNoYWRlciA9IFRleHR1cmVTaGFkZXIuZnJvbU5vdGhpbmcoY2FudmFzKTtcblxuICBjYW52YXMuZW5hYmxlRGVwdGhUZXN0aW5nKCk7XG4gIGNhbnZhcy5lbmFibGVEZXB0aEZ1bmN0aW9uKCk7XG5cbiAgY3JlYXRlQ29sb3VyQ3ViZShjb2xvdXJTaGFkZXIsIGNhbnZhcywgZnVuY3Rpb24oY29sb3VyQ3ViZSkge1xuICAgIGNyZWF0ZVRleHR1cmVDdWJlKHRleHR1cmVTaGFkZXIsIGNhbnZhcywgZnVuY3Rpb24odGV4dHVyZUN1YmUpIHtcbiAgICAgIGNvbnN0IHJlbmRlciA9IGNyZWF0ZVJlbmRlcihjYW52YXMsIGNvbG91ckN1YmUsIGNvbG91clNoYWRlciwgdGV4dHVyZUN1YmUsIHRleHR1cmVTaGFkZXIpO1xuXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVuZGVyKTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gaW50ZXJtZWRpYXRlO1xuXG5mdW5jdGlvbiBjcmVhdGVDb2xvdXJDdWJlKGNvbG91clNoYWRlciwgY2FudmFzLCBjYWxsYmFjaykge1xuICBjb25zdCBvZmZzZXRQb3NpdGlvbiA9IFstMiwgMCwgMF0sXG4gICAgICAgIGNvbG91ckN1YmUgPSBDb2xvdXJDdWJlLmZyb21PZmZzZXRQb3NpdGlvbihvZmZzZXRQb3NpdGlvbiwgY29sb3VyU2hhZGVyLCBjYW52YXMpO1xuXG4gIGNhbGxiYWNrKGNvbG91ckN1YmUpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVUZXh0dXJlQ3ViZSh0ZXh0dXJlU2hhZGVyLCBjYW52YXMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IHNvdXJjZXMgPSBbXG4gICAgICAgICAgJ3RleHR1cmUvYnJpY2tzLmpwZydcbiAgICAgICAgXTtcblxuICBwcmVsb2FkKHNvdXJjZXMsIGZ1bmN0aW9uKGltYWdlcykge1xuICAgIGNvbnN0IGZpcnN0SW1hZ2UgPSBmaXJzdChpbWFnZXMpLFxuICAgICAgICAgIG9mZnNldFBvc2l0aW9uID0gWysyLCAwLCAwXSxcbiAgICAgICAgICBpbWFnZSA9IGZpcnN0SW1hZ2UsIC8vL1xuICAgICAgICAgIHRleHR1cmVDdWJlID0gVGV4dHVyZUN1YmUuZnJvbU9mZnNldFBvc2l0aW9uQW5kSW1hZ2Uob2Zmc2V0UG9zaXRpb24sIGltYWdlLCB0ZXh0dXJlU2hhZGVyLCBjYW52YXMpO1xuXG4gICAgY2FsbGJhY2sodGV4dHVyZUN1YmUpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmVuZGVyKGNhbnZhcywgY29sb3VyQ3ViZSwgY29sb3VyU2hhZGVyLCB0ZXh0dXJlQ3ViZSwgdGV4dHVyZVNoYWRlcikge1xuICBsZXQgaW5pdGlhbFRpbWUgPSBudWxsO1xuXG4gIGNvbnN0IGNsaWVudFdpZHRoID0gY2FudmFzLmdldENsaWVudFdpZHRoKCksXG4gICAgICAgIGNsaWVudEhlaWdodCA9IGNhbnZhcy5nZXRDbGllbnRIZWlnaHQoKSxcbiAgICAgICAgekNvb3JkaW5hdGUgPSAtMTAsIC8vL1xuICAgICAgICBwb3NpdGlvbiA9IFBvc2l0aW9uLmZyb21aQ29vcmRpbmF0ZSh6Q29vcmRpbmF0ZSksXG4gICAgICAgIHBlcnNwZWN0aXZlID0gUGVyc3BlY3RpdmUuZnJvbUNsaWVudFdpZHRoQW5kQ2xpZW50SGVpZ2h0KGNsaWVudFdpZHRoLCBjbGllbnRIZWlnaHQpLFxuICAgICAgICBjb2xvdXJDdWJlQ291bnQgPSBjb2xvdXJDdWJlLmdldENvdW50KCksXG4gICAgICAgIHRleHR1cmVDdWJlQ291bnQgPSB0ZXh0dXJlQ3ViZS5nZXRDb3VudCgpO1xuXG4gIGNvbnN0IHJlbmRlciA9ICh0aW1lKSA9PiB7XG4gICAgaWYgKGluaXRpYWxUaW1lID09PSBudWxsKSB7XG4gICAgICBpbml0aWFsVGltZSA9IHRpbWU7XG4gICAgfVxuXG4gICAgY29uc3QgZWxhcHNlZFRpbWUgPSB0aW1lIC0gaW5pdGlhbFRpbWUsXG4gICAgICAgICAgcm90YXRpb24gPSBSb3RhdGlvbi5mcm9tTm90aGluZygpLFxuICAgICAgICAgIG5vcm1hbCA9IE5vcm1hbC5mcm9tUm90YXRpb24ocm90YXRpb24pO1xuXG4gICAgY2FudmFzLmNsZWFyKCk7XG5cbiAgICBjb2xvdXJDdWJlLmJpbmQoY29sb3VyU2hhZGVyLCBjYW52YXMpO1xuXG4gICAgY2FudmFzLnVzZVNoYWRlcihjb2xvdXJTaGFkZXIpO1xuXG4gICAgY29sb3VyU2hhZGVyLmFjdGl2YXRlVGV4dHVyZShjYW52YXMpO1xuXG4gICAgY2FudmFzLnJlbmRlcihjb2xvdXJTaGFkZXIsIG5vcm1hbCwgcm90YXRpb24sIHBvc2l0aW9uLCBwZXJzcGVjdGl2ZSk7XG5cbiAgICBjYW52YXMuZHJhd0VsZW1lbnRzKGNvbG91ckN1YmVDb3VudCk7XG5cbiAgICB0ZXh0dXJlQ3ViZS5iaW5kKHRleHR1cmVTaGFkZXIsIGNhbnZhcyk7XG5cbiAgICBjYW52YXMudXNlU2hhZGVyKHRleHR1cmVTaGFkZXIpO1xuXG4gICAgdGV4dHVyZVNoYWRlci5hY3RpdmF0ZVRleHR1cmUoY2FudmFzKTtcblxuICAgIGNhbnZhcy5yZW5kZXIodGV4dHVyZVNoYWRlciwgbm9ybWFsLCByb3RhdGlvbiwgcG9zaXRpb24sIHBlcnNwZWN0aXZlKTtcblxuICAgIGNhbnZhcy5kcmF3RWxlbWVudHModGV4dHVyZUN1YmVDb3VudCk7XG5cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVuZGVyKTtcbiAgfTtcblxuICByZXR1cm4gcmVuZGVyO1xufVxuIl19