'use strict';

var necessary = require('necessary');

var Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    colourCube = require('./intermediate/cube/colour'),
    textureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    first = arrayUtilities.first,
    repeatedly = asynchronousUtilities.repeatedly;


function intermediate() {
  var canvas = new Canvas();

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createTextureCube(canvas, function (count, shader) {
    canvas.useShader(shader);

    shader.activateTexture(canvas);

    var render = createRender(canvas, count, shader);

    requestAnimationFrame(render);
  });
}

module.exports = intermediate;

function createColourCube(canvas, callback) {
  var offsetPosition = [-1, 0, 0];

  colourCube(offsetPosition, canvas, callback);
}

function createTextureCube(canvas, callback) {
  loadImages(function (images) {
    var firstImage = first(images),
        offsetPosition = [+1, 0, 0],
        image = firstImage; ///

    textureCube(offsetPosition, image, canvas, callback);
  });
}

function loadImages(callback) {
  var imageSources = ['texture/bricks.jpg'],
      images = [],
      context = {
    imageSources: imageSources,
    images: images
  },
      length = imageSources.length; ///

  repeatedly(loadImageCallback, length, function () {
    var images = context.images;


    callback(images);
  }, context);
}

function createRender(canvas, count, shader) {
  var initialTime = null;

  var clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      zCoordinate = -10,
      ///
  position = Position.fromZCoordinate(zCoordinate),
      perspective = Perspective.fromClientWidthAndClientHeight(clientWidth, clientHeight);

  var render = function render(time) {
    if (initialTime === null) {
      initialTime = time;
    }

    var elapsedTime = time - initialTime,

    // xAngle = elapsedTime / 1000,
    // yAngle = elapsedTime / 1000,
    // rotation = Rotation.fromXAngleAndYAngle(xAngle, yAngle),
    rotation = Rotation.fromNothing(),
        normal = Normal.fromRotation(rotation);

    canvas.render(shader, normal, rotation, position, perspective);

    canvas.drawElements(count);

    requestAnimationFrame(render);
  };

  return render;
}

function loadImageCallback(next, done, context, index) {
  var imageSources = context.imageSources,
      images = context.images,
      imageSource = imageSources[index],
      image = new Image();


  images[index] = image;

  image.onload = next; ///

  image.src = imageSource; ///
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsIkNhbnZhcyIsIk5vcm1hbCIsIlJvdGF0aW9uIiwiUG9zaXRpb24iLCJQZXJzcGVjdGl2ZSIsImNvbG91ckN1YmUiLCJ0ZXh0dXJlQ3ViZSIsImFycmF5VXRpbGl0aWVzIiwiYXN5bmNocm9ub3VzVXRpbGl0aWVzIiwiZmlyc3QiLCJyZXBlYXRlZGx5IiwiaW50ZXJtZWRpYXRlIiwiY2FudmFzIiwiZW5hYmxlRGVwdGhUZXN0aW5nIiwiZW5hYmxlRGVwdGhGdW5jdGlvbiIsImNyZWF0ZVRleHR1cmVDdWJlIiwiY291bnQiLCJzaGFkZXIiLCJ1c2VTaGFkZXIiLCJhY3RpdmF0ZVRleHR1cmUiLCJyZW5kZXIiLCJjcmVhdGVSZW5kZXIiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwiY3JlYXRlQ29sb3VyQ3ViZSIsImNhbGxiYWNrIiwib2Zmc2V0UG9zaXRpb24iLCJsb2FkSW1hZ2VzIiwiaW1hZ2VzIiwiZmlyc3RJbWFnZSIsImltYWdlIiwiaW1hZ2VTb3VyY2VzIiwiY29udGV4dCIsImxlbmd0aCIsImxvYWRJbWFnZUNhbGxiYWNrIiwiaW5pdGlhbFRpbWUiLCJjbGllbnRXaWR0aCIsImdldENsaWVudFdpZHRoIiwiY2xpZW50SGVpZ2h0IiwiZ2V0Q2xpZW50SGVpZ2h0IiwiekNvb3JkaW5hdGUiLCJwb3NpdGlvbiIsImZyb21aQ29vcmRpbmF0ZSIsInBlcnNwZWN0aXZlIiwiZnJvbUNsaWVudFdpZHRoQW5kQ2xpZW50SGVpZ2h0IiwidGltZSIsImVsYXBzZWRUaW1lIiwicm90YXRpb24iLCJmcm9tTm90aGluZyIsIm5vcm1hbCIsImZyb21Sb3RhdGlvbiIsImRyYXdFbGVtZW50cyIsIm5leHQiLCJkb25lIiwiaW5kZXgiLCJpbWFnZVNvdXJjZSIsIkltYWdlIiwib25sb2FkIiwic3JjIl0sIm1hcHBp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QUFNQSxNQUFNbkIsU0FBUyxTQUFUQSxNQUFTLENBQUMwQixJQUFELEVBQVU7QUFDdkIsUUFBSVYsZ0JBQWdCLElBQXBCLEVBQTBCO0FBQ3hCQSxvQkFBY1UsSUFBZDtBQUNEOztBQUVELFFBQU1DLGNBQWNELE9BQU9WLFdBQTNCOztBQUNNO0FBQ0E7QUFDQTtBQUNBWSxlQUFXOUMsU0FBUytDLFdBQVQsRUFKakI7QUFBQSxRQUtNQyxTQUFTakQsT0FBT2tELFlBQVAsQ0FBb0JILFFBQXBCLENBTGY7O0FBT0FwQyxXQUFPUSxNQUFQLENBQWNILE1BQWQsRUFBc0JpQyxNQUF0QixFQUE4QkYsUUFBOUIsRUFBd0NOLFFBQXhDLEVBQWtERSxXQUFsRDs7QUFFQWhDLFdBQU93QyxZQUFQLENBQW9CcEMsS0FBcEI7O0FBRUFNLDBCQUFzQkYsTUFBdEI7QUFDRCxHQWpCRDs7QUFtQkEsU0FBT0EsTUFBUDtBQUNEOztBQUVELFNBQVNlLGlCQUFULENBQTJCa0IsSUFBM0IsRUFBaUNDLElBQWpDLEVBQXVDckIsT0FBdkMsRUFBZ0RzQixLQUFoRCxFQUF1RDtBQUFBLE1BQzdDdkIsWUFENkMsR0FDcEJDLE9BRG9CLENBQzdDRCxZQUQ2QztBQUFBLE1BQy9CSCxNQUQrQixHQUNwQkksT0FEb0IsQ0FDL0JKLE1BRCtCO0FBQUEsTUFFL0MyQixXQUYrQyxHQUVqQ3hCLGFBQWF1QixLQUFiLENBRmlDO0FBQUEsTUFHL0N4QixLQUgrQyxHQUd2QyxJQUFJMEIsS0FBSixFQUh1Qzs7O0FBS3JENUIsU0FBTzBCLEtBQVAsSUFBZ0J4QixLQUFoQjs7QUFFQUEsUUFBTTJCLE1BQU4sR0FBZUwsSUFBZixDQVBxRCxDQU8vQjs7QUFFdEJ0QixRQUFNNEIsR0FBTixHQUFZSCxXQUFaLENBVHFELENBUzNCO0FBQzNCIiwiZmlsZSI6ImludGVybWVkaWF0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IENhbnZhcyA9IHJlcXVpcmUoJy4uL2NhbnZhcycpLFxuICAgICAgTm9ybWFsID0gcmVxdWlyZSgnLi4vbm9ybWFsJyksXG4gICAgICBSb3RhdGlvbiA9IHJlcXVpcmUoJy4uL3JvdGF0aW9uJyksXG4gICAgICBQb3NpdGlvbiA9IHJlcXVpcmUoJy4uL3Bvc2l0aW9uJyksXG4gICAgICBQZXJzcGVjdGl2ZSA9IHJlcXVpcmUoJy4uL3BlcnNwZWN0aXZlJyksXG4gICAgICBjb2xvdXJDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS9jb2xvdXInKSxcbiAgICAgIHRleHR1cmVDdWJlID0gcmVxdWlyZSgnLi9pbnRlcm1lZGlhdGUvY3ViZS90ZXh0dXJlJyk7XG5cbmNvbnN0IHsgYXJyYXlVdGlsaXRpZXMsIGFzeW5jaHJvbm91c1V0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBmaXJzdCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJlcGVhdGVkbHkgfSA9IGFzeW5jaHJvbm91c1V0aWxpdGllcztcblxuZnVuY3Rpb24gaW50ZXJtZWRpYXRlKCkge1xuICBjb25zdCBjYW52YXMgPSBuZXcgQ2FudmFzKCk7XG5cbiAgY2FudmFzLmVuYWJsZURlcHRoVGVzdGluZygpO1xuICBjYW52YXMuZW5hYmxlRGVwdGhGdW5jdGlvbigpO1xuXG4gIGNyZWF0ZVRleHR1cmVDdWJlKGNhbnZhcywgZnVuY3Rpb24oY291bnQsIHNoYWRlcikge1xuICAgIGNhbnZhcy51c2VTaGFkZXIoc2hhZGVyKTtcblxuICAgIHNoYWRlci5hY3RpdmF0ZVRleHR1cmUoY2FudmFzKTtcblxuICAgIGNvbnN0IHJlbmRlciA9IGNyZWF0ZVJlbmRlcihjYW52YXMsIGNvdW50LCBzaGFkZXIpO1xuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG4gIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGludGVybWVkaWF0ZTtcblxuZnVuY3Rpb24gY3JlYXRlQ29sb3VyQ3ViZShjYW52YXMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IG9mZnNldFBvc2l0aW9uID0gWy0xLCAwLCAwXTtcblxuICBjb2xvdXJDdWJlKG9mZnNldFBvc2l0aW9uLCBjYW52YXMsIGNhbGxiYWNrKTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlVGV4dHVyZUN1YmUoY2FudmFzLCBjYWxsYmFjaykge1xuICBsb2FkSW1hZ2VzKGZ1bmN0aW9uKGltYWdlcykge1xuICAgIGNvbnN0IGZpcnN0SW1hZ2UgPSBmaXJzdChpbWFnZXMpLFxuICAgICAgICAgIG9mZnNldFBvc2l0aW9uID0gWysxLCAwLCAwXSxcbiAgICAgICAgICBpbWFnZSA9IGZpcnN0SW1hZ2U7IC8vL1xuXG4gICAgdGV4dHVyZUN1YmUob2Zmc2V0UG9zaXRpb24sIGltYWdlLCBjYW52YXMsIGNhbGxiYWNrKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvYWRJbWFnZXMoY2FsbGJhY2spIHtcbiAgY29uc3QgaW1hZ2VTb3VyY2VzID0gW1xuICAgICAgICAgICd0ZXh0dXJlL2JyaWNrcy5qcGcnXG4gICAgICAgIF0sXG4gICAgICAgIGltYWdlcyA9IFtdLFxuICAgICAgICBjb250ZXh0ID0ge1xuICAgICAgICAgIGltYWdlU291cmNlczogaW1hZ2VTb3VyY2VzLFxuICAgICAgICAgIGltYWdlczogaW1hZ2VzXG4gICAgICAgIH0sXG4gICAgICAgIGxlbmd0aCA9IGltYWdlU291cmNlcy5sZW5ndGg7IC8vL1xuXG4gIHJlcGVhdGVkbHkobG9hZEltYWdlQ2FsbGJhY2ssIGxlbmd0aCwgZnVuY3Rpb24oKSB7XG4gICAgY29uc3QgeyBpbWFnZXMgfSA9IGNvbnRleHQ7XG5cbiAgICBjYWxsYmFjayhpbWFnZXMpXG4gIH0sIGNvbnRleHQpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSZW5kZXIoY2FudmFzLCBjb3VudCwgc2hhZGVyKSB7XG4gIGxldCBpbml0aWFsVGltZSA9IG51bGw7XG5cbiAgY29uc3QgY2xpZW50V2lkdGggPSBjYW52YXMuZ2V0Q2xpZW50V2lkdGgoKSxcbiAgICAgICAgY2xpZW50SGVpZ2h0ID0gY2FudmFzLmdldENsaWVudEhlaWdodCgpLFxuICAgICAgICB6Q29vcmRpbmF0ZSA9IC0xMCwgLy8vXG4gICAgICAgIHBvc2l0aW9uID0gUG9zaXRpb24uZnJvbVpDb29yZGluYXRlKHpDb29yZGluYXRlKSxcbiAgICAgICAgcGVyc3BlY3RpdmUgPSBQZXJzcGVjdGl2ZS5mcm9tQ2xpZW50V2lkdGhBbmRDbGllbnRIZWlnaHQoY2xpZW50V2lkdGgsIGNsaWVudEhlaWdodCk7XG5cbiAgY29uc3QgcmVuZGVyID0gKHRpbWUpID0+IHtcbiAgICBpZiAoaW5pdGlhbFRpbWUgPT09IG51bGwpIHtcbiAgICAgIGluaXRpYWxUaW1lID0gdGltZTtcbiAgICB9XG5cbiAgICBjb25zdCBlbGFwc2VkVGltZSA9IHRpbWUgLSBpbml0aWFsVGltZSxcbiAgICAgICAgICAvLyB4QW5nbGUgPSBlbGFwc2VkVGltZSAvIDEwMDAsXG4gICAgICAgICAgLy8geUFuZ2xlID0gZWxhcHNlZFRpbWUgLyAxMDAwLFxuICAgICAgICAgIC8vIHJvdGF0aW9uID0gUm90YXRpb24uZnJvbVhBbmdsZUFuZFlBbmdsZSh4QW5nbGUsIHlBbmdsZSksXG4gICAgICAgICAgcm90YXRpb24gPSBSb3RhdGlvbi5mcm9tTm90aGluZygpLFxuICAgICAgICAgIG5vcm1hbCA9IE5vcm1hbC5mcm9tUm90YXRpb24ocm90YXRpb24pO1xuXG4gICAgY2FudmFzLnJlbmRlcihzaGFkZXIsIG5vcm1hbCwgcm90YXRpb24sIHBvc2l0aW9uLCBwZXJzcGVjdGl2ZSk7XG5cbiAgICBjYW52YXMuZHJhd0VsZW1lbnRzKGNvdW50KTtcblxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShyZW5kZXIpO1xuICB9O1xuXG4gIHJldHVybiByZW5kZXI7XG59XG5cbmZ1bmN0aW9uIGxvYWRJbWFnZUNhbGxiYWNrKG5leHQsIGRvbmUsIGNvbnRleHQsIGluZGV4KSB7XG4gIGNvbnN0IHsgaW1hZ2VTb3VyY2VzLCBpbWFnZXMgfSA9IGNvbnRleHQsXG4gICAgICAgIGltYWdlU291cmNlID0gaW1hZ2VTb3VyY2VzW2luZGV4XSxcbiAgICAgICAgaW1hZ2UgPSBuZXcgSW1hZ2UoKTtcblxuICBpbWFnZXNbaW5kZXhdID0gaW1hZ2U7XG5cbiAgaW1hZ2Uub25sb2FkID0gbmV4dDsgIC8vL1xuXG4gIGltYWdlLnNyYyA9IGltYWdlU291cmNlOyAgLy8vXG59XG4iXX0=