'use strict';

var necessary = require('necessary');

var angles = require('../angles'),
    zoom = require('../zoom'),
    Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    MouseEvents = require('../mouseEvents'),
    ColourShader = require('../shader/colour'),
    TextureShader = require('../shader/texture'),
    imagesUtilities = require('../utilities/images'),
    ColourCube = require('./intermediate/cube/colour'),
    TextureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    preload = imagesUtilities.preload,
    first = arrayUtilities.first;


var render = void 0;

function intermediate() {
  var canvas = new Canvas(),
      colourShader = ColourShader.fromNothing(canvas),
      textureShader = TextureShader.fromNothing(canvas);

  var mouseEvents = new MouseEvents(canvas);

  mouseEvents.addMouseUpEventHandler(mouseUpEventHandler);
  mouseEvents.addMouseDownEventHandler(mouseDownEventHandler);
  mouseEvents.addMouseMoveEventHandler(mouseMoveEventHandler);
  mouseEvents.addMouseWheelEventHandler(mouseWheelEventHandler);

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createColourCube(colourShader, canvas, function (colourCube) {
    createTextureCube(textureShader, canvas, function (textureCube) {
      render = createRender(canvas, colourCube, colourShader, textureCube, textureShader);

      render();
    });
  });
}

module.exports = intermediate;

function createColourCube(colourShader, canvas, callback) {
  var offsetPosition = [-2, 0, 0],
      colourCube = ColourCube.fromOffsetPosition(offsetPosition, colourShader, canvas);

  callback(colourCube);
}

function createTextureCube(textureShader, canvas, callback) {
  var sources = ['texture/bricks.jpg'];

  preload(sources, function (images) {
    var firstImage = first(images),
        offsetPosition = [+2, 0, 0],
        image = firstImage,
        ///
    textureCube = TextureCube.fromOffsetPositionAndImage(offsetPosition, image, textureShader, canvas);

    callback(textureCube);
  });
}

function createRender(canvas, colourCube, colourShader, textureCube, textureShader) {
  var clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      perspective = Perspective.fromClientWidthAndClientHeight(clientWidth, clientHeight),
      colourCubeCount = colourCube.getCount(),
      textureCubeCount = textureCube.getCount();

  var render = function render() {
    var xAxisAngle = angles.getXAxisAngle(),
        yAxisAngle = angles.getYAxisAngle(),
        distance = zoom.getDistance(),
        xAngle = xAxisAngle,
        ///
    zAngle = yAxisAngle,
        ///
    zCoordinate = -Math.max(10, distance),
        ///
    position = Position.fromZCoordinate(zCoordinate),
        rotation = Rotation.fromXAngleAndZAngle(xAngle, zAngle),
        normal = Normal.fromRotation(rotation);

    canvas.clear();

    colourCube.bind(colourShader, canvas);

    canvas.useShader(colourShader);

    colourShader.activateTexture(canvas);

    canvas.render(colourShader, normal, rotation, position, perspective);

    canvas.drawElements(colourCubeCount);

    textureCube.bind(textureShader, canvas);

    canvas.useShader(textureShader);

    textureShader.activateTexture(canvas);

    canvas.render(textureShader, normal, rotation, position, perspective);

    canvas.drawElements(textureCubeCount);
  };

  return render;
}

function mouseUpEventHandler(mouseCoordinates) {
  angles.mouseUpEventHandler(mouseCoordinates);
}

function mouseDownEventHandler(mouseCoordinates) {
  angles.mouseDownEventHandler(mouseCoordinates);
}

function mouseMoveEventHandler(mouseCoordinates) {
  angles.mouseMoveEventHandler(mouseCoordinates);

  if (render) {
    render();
  }
}

function mouseWheelEventHandler(delta) {
  zoom.mouseWheelEventHandler(delta);

  if (render) {
    render();
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsImFuZ2xlcyIsInpvb20iLCJDYW52YXMiLCJOb3JtYWwiLCJSb3RhdGlvbiIsIlBvc2l0aW9uIiwiUGVyc3BlY3RpdmUiLCJNb3VzZUV2ZW50cyIsIkNvbG91clNoYWRlciIsIlRleHR1cmVTaGFkZXIiLCJpbWFnZXNVdGlsaXRpZXMiLCJDb2xvdXJDdWJlIiwiVGV4dHVyZUN1YmUiLCJhcnJheVV0aWxpdGllcyIsInByZWxvYWQiLCJmaXJzdCIsInJlbmRlciIsImludGVybWVkaWF0ZSIsImNhbnZhcyIsImNvbG91clNoYWRlciIsImZyb21Ob3RoaW5nIiwidGV4dHVyZVNoYWRlciIsIm1vdXNlRXZlbnRzIiwiYWRkTW91c2VVcEV2ZW50SGFuZGxlciIsIm1vdXNlVXBFdmVudEhhbmRsZXIiLCJhZGRNb3VzZURvd25FdmVudEhhbmRsZXIiLCJtb3VzZURvd25FdmVudEhhbmRsZXIiLCJhZGRNb3VzZU1vdmVFdmVudEhhbmRsZXIiLCJtb3VzZU1vdmVFdmVudEhhbmRsZXIiLCJhZGRNb3VzZVdoZWVsRXZlbnRIYW5kbGVyIiwibW91c2VXaGVlbEV2ZW50SGFuZGxlciIsImVuYWJsZURlcHRoVGVzdGluZyIsImVuYWJsZURlcHRoRnVuY3Rpb24iLCJjcmVhdGVDb2xvdXJDdWJlIiwiY29sb3VyQ3ViZSIsImNyZWF0ZVRleHR1cmVDdWJlIiwidGV4dHVyZUN1YmUiLCJjcmVhdGVSZW5kZXIiLCJtb2R1bGUiLCJleHBvcnRzIiwiY2FsbGJhY2siLCJvZmZzZXRQb3NpdGlvbiIsImZyb21PZmZzZXRQb3NpdGlvbiIsInNvdXJjZXMiLCJpbWFnZXMiLCJmaXJzdEltYWdlIiwiaW1hZ2UiLCJmcm9tT2Zmc2V0UG9zaXRpb25BbmRJbWFnZSIsImNsaWVudFdpZHRoIiwiZ2V0Q2xpZW50V2lkdGgiLCJjbGllbnRIZWlnaHQiLCJnZXRDbGllbnRIZWlnaHQiLCJwZXJzcGVjdGl2ZSIsImZyb21DbGllbnRXaWR0aEFuZENsaWVudEhlaWdodCIsImNvbG91ckN1YmVDb3VudCIsImdldENvdW50IiwidGV4dHVyZUN1YmVDb3VudCIsInhBeGlzQW5nbGUiLCJnZXRYQXhpc0FuZ2xlIiwieUF4aXNBbmdsZSIsImdldFlBeGlzQW5nbGUiLCJkaXN0YW5jZSIsImdldERpc3RhbmNlIiwieEFuZ2xlIiwiekFuZ2xlIiwiekNvb3JkaW5hdGUiLCJNYXRoIiwibWF4IiwicG9zaXRpb24iLCJmcm9tWkNvb3JkaW5hdGUiLCJyb3RhdGlvbiIsImZyb21YQW5nbGVBbmRaQW5nbGUiLCJub3JtYWwiLCJmcm9tUm90YXRpb24iLCJjbGVhciIsImJpbmQiLCJ1c2VTaGFkZXIiLCJhY3RpdmF0ZVRleHR1cmUiLCJkcmF3RWxlbWVudHMiLCJtb3VzZUNvb3JkaW5hdGVzIiwiZGVsdGEiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFlBQVlDLFFBQVEsV0FBUixDQUFsQjs7QUFFQSxJQUFNQyxTQUFTRCxRQUFRLFdBQVIsQ0FBZjtBQUFBLElBQ01FLE9BQU9GLFFBQVEsU0FBUixDQURiO0FBQUEsSUFFTUcsU0FBU0gsUUFBUSxXQUFSLENBRmY7QUFBQSxJQUdNSSxTQUFTSixRQUFRLFdBQVIsQ0FIZjtBQUFBLElBSU1LLFdBQVdMLFFBQVEsYUFBUixDQUpqQjtBQUFBLElBS01NLFdBQVdOLFFBQVEsYUFBUixDQUxqQjtBQUFBLElBTU1PLGNBQWNQLFFBQVEsZ0JBQVIsQ0FOcEI7QUFBQSxJQU9NUSxjQUFjUixRQUFRLGdCQUFSLENBUHBCO0FBQUEsSUFRTVMsZUFBZVQsUUFBUSxrQkFBUixDQVJyQjtBQUFBLElBU01VLGdCQUFnQlYsUUFBUSxtQkFBUixDQVR0QjtBQUFBLElBVU1XLGtCQUFrQlgsUUFBUSxxQkFBUixDQVZ4QjtBQUFBLElBV01ZLGFBQWFaLFFBQVEsNEJBQVIsQ0FYbkI7QUFBQSxJQVlNYSxjQUFjYixRQUFRLDZCQUFSLENBWnBCOztBQWNNLElB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QkFBM0I7QUFDRDs7QUFFRCxTQUFTckQscUJBQVQsQ0FBK0JxRCxnQkFBL0IsRUFBaUQ7QUFDL0MvRSxTQUFPMEIscUJBQVAsQ0FBNkJxRCxnQkFBN0I7QUFDRDs7QUFFRCxTQUFTbkQscUJBQVQsQ0FBK0JtRCxnQkFBL0IsRUFBaUQ7QUFDL0MvRSxTQUFPNEIscUJBQVAsQ0FBNkJtRCxnQkFBN0I7O0FBRUEsTUFBSS9ELE1BQUosRUFBWTtBQUNWQTtBQUNEO0FBQ0Y7O0FBRUQsU0FBU2Msc0JBQVQsQ0FBZ0NrRCxLQUFoQyxFQUF1QztBQUNyQy9FLE9BQUs2QixzQkFBTCxDQUE0QmtELEtBQTVCOztBQUVBLE1BQUloRSxNQUFKLEVBQVk7QUFDVkE7QUFDRDtBQUNGIiwiZmlsZSI6ImludGVybWVkaWF0ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgbmVjZXNzYXJ5ID0gcmVxdWlyZSgnbmVjZXNzYXJ5Jyk7XG5cbmNvbnN0IGFuZ2xlcyA9IHJlcXVpcmUoJy4uL2FuZ2xlcycpLFxuICAgICAgem9vbSA9IHJlcXVpcmUoJy4uL3pvb20nKSxcbiAgICAgIENhbnZhcyA9IHJlcXVpcmUoJy4uL2NhbnZhcycpLFxuICAgICAgTm9ybWFsID0gcmVxdWlyZSgnLi4vbm9ybWFsJyksXG4gICAgICBSb3RhdGlvbiA9IHJlcXVpcmUoJy4uL3JvdGF0aW9uJyksXG4gICAgICBQb3NpdGlvbiA9IHJlcXVpcmUoJy4uL3Bvc2l0aW9uJyksXG4gICAgICBQZXJzcGVjdGl2ZSA9IHJlcXVpcmUoJy4uL3BlcnNwZWN0aXZlJyksXG4gICAgICBNb3VzZUV2ZW50cyA9IHJlcXVpcmUoJy4uL21vdXNlRXZlbnRzJyksXG4gICAgICBDb2xvdXJTaGFkZXIgPSByZXF1aXJlKCcuLi9zaGFkZXIvY29sb3VyJyksXG4gICAgICBUZXh0dXJlU2hhZGVyID0gcmVxdWlyZSgnLi4vc2hhZGVyL3RleHR1cmUnKSxcbiAgICAgIGltYWdlc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9pbWFnZXMnKSxcbiAgICAgIENvbG91ckN1YmUgPSByZXF1aXJlKCcuL2ludGVybWVkaWF0ZS9jdWJlL2NvbG91cicpLFxuICAgICAgVGV4dHVyZUN1YmUgPSByZXF1aXJlKCcuL2ludGVybWVkaWF0ZS9jdWJlL3RleHR1cmUnKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBwcmVsb2FkIH0gPSBpbWFnZXNVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcztcblxubGV0IHJlbmRlcjtcblxuZnVuY3Rpb24gaW50ZXJtZWRpYXRlKCkge1xuICBjb25zdCBjYW52YXMgPSBuZXcgQ2FudmFzKCksXG4gICAgICAgIGNvbG91clNoYWRlciA9IENvbG91clNoYWRlci5mcm9tTm90aGluZyhjYW52YXMpLFxuICAgICAgICB0ZXh0dXJlU2hhZGVyID0gVGV4dHVyZVNoYWRlci5mcm9tTm90aGluZyhjYW52YXMpO1xuXG4gIGNvbnN0IG1vdXNlRXZlbnRzID0gbmV3IE1vdXNlRXZlbnRzKGNhbnZhcyk7XG5cbiAgbW91c2VFdmVudHMuYWRkTW91c2VVcEV2ZW50SGFuZGxlcihtb3VzZVVwRXZlbnRIYW5kbGVyKTtcbiAgbW91c2VFdmVudHMuYWRkTW91c2VEb3duRXZlbnRIYW5kbGVyKG1vdXNlRG93bkV2ZW50SGFuZGxlcik7XG4gIG1vdXNlRXZlbnRzLmFkZE1vdXNlTW92ZUV2ZW50SGFuZGxlcihtb3VzZU1vdmVFdmVudEhhbmRsZXIpO1xuICBtb3VzZUV2ZW50cy5hZGRNb3VzZVdoZWVsRXZlbnRIYW5kbGVyKG1vdXNlV2hlZWxFdmVudEhhbmRsZXIpO1xuXG4gIGNhbnZhcy5lbmFibGVEZXB0aFRlc3RpbmcoKTtcbiAgY2FudmFzLmVuYWJsZURlcHRoRnVuY3Rpb24oKTtcblxuICBjcmVhdGVDb2xvdXJDdWJlKGNvbG91clNoYWRlciwgY2FudmFzLCBmdW5jdGlvbihjb2xvdXJDdWJlKSB7XG4gICAgY3JlYXRlVGV4dHVyZUN1YmUodGV4dHVyZVNoYWRlciwgY2FudmFzLCBmdW5jdGlvbih0ZXh0dXJlQ3ViZSkge1xuICAgICAgcmVuZGVyID0gY3JlYXRlUmVuZGVyKGNhbnZhcywgY29sb3VyQ3ViZSwgY29sb3VyU2hhZGVyLCB0ZXh0dXJlQ3ViZSwgdGV4dHVyZVNoYWRlcik7XG5cbiAgICAgIHJlbmRlcigpO1xuICAgIH0pO1xuICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBpbnRlcm1lZGlhdGU7XG5cbmZ1bmN0aW9uIGNyZWF0ZUNvbG91ckN1YmUoY29sb3VyU2hhZGVyLCBjYW52YXMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IG9mZnNldFBvc2l0aW9uID0gWy0yLCAwLCAwXSxcbiAgICAgICAgY29sb3VyQ3ViZSA9IENvbG91ckN1YmUuZnJvbU9mZnNldFBvc2l0aW9uKG9mZnNldFBvc2l0aW9uLCBjb2xvdXJTaGFkZXIsIGNhbnZhcyk7XG5cbiAgY2FsbGJhY2soY29sb3VyQ3ViZSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVRleHR1cmVDdWJlKHRleHR1cmVTaGFkZXIsIGNhbnZhcywgY2FsbGJhY2spIHtcbiAgY29uc3Qgc291cmNlcyA9IFtcbiAgICAgICAgICAndGV4dHVyZS9icmlja3MuanBnJ1xuICAgICAgICBdO1xuXG4gIHByZWxvYWQoc291cmNlcywgZnVuY3Rpb24oaW1hZ2VzKSB7XG4gICAgY29uc3QgZmlyc3RJbWFnZSA9IGZpcnN0KGltYWdlcyksXG4gICAgICAgICAgb2Zmc2V0UG9zaXRpb24gPSBbKzIsIDAsIDBdLFxuICAgICAgICAgIGltYWdlID0gZmlyc3RJbWFnZSwgLy8vXG4gICAgICAgICAgdGV4dHVyZUN1YmUgPSBUZXh0dXJlQ3ViZS5mcm9tT2Zmc2V0UG9zaXRpb25BbmRJbWFnZShvZmZzZXRQb3NpdGlvbiwgaW1hZ2UsIHRleHR1cmVTaGFkZXIsIGNhbnZhcyk7XG5cbiAgICBjYWxsYmFjayh0ZXh0dXJlQ3ViZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSZW5kZXIoY2FudmFzLCBjb2xvdXJDdWJlLCBjb2xvdXJTaGFkZXIsIHRleHR1cmVDdWJlLCB0ZXh0dXJlU2hhZGVyKSB7XG4gIGNvbnN0IGNsaWVudFdpZHRoID0gY2FudmFzLmdldENsaWVudFdpZHRoKCksXG4gICAgICAgIGNsaWVudEhlaWdodCA9IGNhbnZhcy5nZXRDbGllbnRIZWlnaHQoKSxcbiAgICAgICAgcGVyc3BlY3RpdmUgPSBQZXJzcGVjdGl2ZS5mcm9tQ2xpZW50V2lkdGhBbmRDbGllbnRIZWlnaHQoY2xpZW50V2lkdGgsIGNsaWVudEhlaWdodCksXG4gICAgICAgIGNvbG91ckN1YmVDb3VudCA9IGNvbG91ckN1YmUuZ2V0Q291bnQoKSxcbiAgICAgICAgdGV4dHVyZUN1YmVDb3VudCA9IHRleHR1cmVDdWJlLmdldENvdW50KCk7XG5cbiAgY29uc3QgcmVuZGVyID0gKCkgPT4ge1xuICAgIGNvbnN0IHhBeGlzQW5nbGUgPSBhbmdsZXMuZ2V0WEF4aXNBbmdsZSgpLFxuICAgICAgICAgIHlBeGlzQW5nbGUgPSBhbmdsZXMuZ2V0WUF4aXNBbmdsZSgpLFxuICAgICAgICAgIGRpc3RhbmNlID0gem9vbS5nZXREaXN0YW5jZSgpLFxuICAgICAgICAgIHhBbmdsZSA9IHhBeGlzQW5nbGUsICAvLy9cbiAgICAgICAgICB6QW5nbGUgPSB5QXhpc0FuZ2xlLCAvLy9cbiAgICAgICAgICB6Q29vcmRpbmF0ZSA9IC1NYXRoLm1heCgxMCwgZGlzdGFuY2UpLCAvLy9cbiAgICAgICAgICBwb3NpdGlvbiA9IFBvc2l0aW9uLmZyb21aQ29vcmRpbmF0ZSh6Q29vcmRpbmF0ZSksXG4gICAgICAgICAgcm90YXRpb24gPSBSb3RhdGlvbi5mcm9tWEFuZ2xlQW5kWkFuZ2xlKHhBbmdsZSwgekFuZ2xlKSxcbiAgICAgICAgICBub3JtYWwgPSBOb3JtYWwuZnJvbVJvdGF0aW9uKHJvdGF0aW9uKTtcblxuICAgIGNhbnZhcy5jbGVhcigpO1xuXG4gICAgY29sb3VyQ3ViZS5iaW5kKGNvbG91clNoYWRlciwgY2FudmFzKTtcblxuICAgIGNhbnZhcy51c2VTaGFkZXIoY29sb3VyU2hhZGVyKTtcblxuICAgIGNvbG91clNoYWRlci5hY3RpdmF0ZVRleHR1cmUoY2FudmFzKTtcblxuICAgIGNhbnZhcy5yZW5kZXIoY29sb3VyU2hhZGVyLCBub3JtYWwsIHJvdGF0aW9uLCBwb3NpdGlvbiwgcGVyc3BlY3RpdmUpO1xuXG4gICAgY2FudmFzLmRyYXdFbGVtZW50cyhjb2xvdXJDdWJlQ291bnQpO1xuXG4gICAgdGV4dHVyZUN1YmUuYmluZCh0ZXh0dXJlU2hhZGVyLCBjYW52YXMpO1xuXG4gICAgY2FudmFzLnVzZVNoYWRlcih0ZXh0dXJlU2hhZGVyKTtcblxuICAgIHRleHR1cmVTaGFkZXIuYWN0aXZhdGVUZXh0dXJlKGNhbnZhcyk7XG5cbiAgICBjYW52YXMucmVuZGVyKHRleHR1cmVTaGFkZXIsIG5vcm1hbCwgcm90YXRpb24sIHBvc2l0aW9uLCBwZXJzcGVjdGl2ZSk7XG5cbiAgICBjYW52YXMuZHJhd0VsZW1lbnRzKHRleHR1cmVDdWJlQ291bnQpO1xuICB9O1xuXG4gIHJldHVybiByZW5kZXI7XG59XG5cbmZ1bmN0aW9uIG1vdXNlVXBFdmVudEhhbmRsZXIobW91c2VDb29yZGluYXRlcykge1xuICBhbmdsZXMubW91c2VVcEV2ZW50SGFuZGxlcihtb3VzZUNvb3JkaW5hdGVzKTtcbn1cblxuZnVuY3Rpb24gbW91c2VEb3duRXZlbnRIYW5kbGVyKG1vdXNlQ29vcmRpbmF0ZXMpIHtcbiAgYW5nbGVzLm1vdXNlRG93bkV2ZW50SGFuZGxlcihtb3VzZUNvb3JkaW5hdGVzKTtcbn1cblxuZnVuY3Rpb24gbW91c2VNb3ZlRXZlbnRIYW5kbGVyKG1vdXNlQ29vcmRpbmF0ZXMpIHtcbiAgYW5nbGVzLm1vdXNlTW92ZUV2ZW50SGFuZGxlcihtb3VzZUNvb3JkaW5hdGVzKTtcblxuICBpZiAocmVuZGVyKSB7XG4gICAgcmVuZGVyKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbW91c2VXaGVlbEV2ZW50SGFuZGxlcihkZWx0YSkge1xuICB6b29tLm1vdXNlV2hlZWxFdmVudEhhbmRsZXIoZGVsdGEpO1xuXG4gIGlmIChyZW5kZXIpIHtcbiAgICByZW5kZXIoKTtcbiAgfVxufVxuIl19