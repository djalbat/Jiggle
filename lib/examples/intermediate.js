'use strict';

var Canvas = require('../canvas'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective');

var intermediate = function intermediate() {
  var canvas = new Canvas(),
      context = canvas.getContext();

  if (!context) {
    return;
  }

  var vertexShaderSource = '\n          attribute vec4 aVertexPosition;\n          attribute vec4 aVertexColour;\n          \n          uniform mat4 uRotationMatrix;\n          uniform mat4 uPositionMatrix;\n          uniform mat4 uPerspectiveMatrix;\n          \n          varying lowp vec4 vColour;\n      \n          void main() {\n            gl_Position = uPerspectiveMatrix* uPositionMatrix * uRotationMatrix * aVertexPosition;\n            vColour = aVertexColour;\n          }\n        ',
      fragmentShaderSource = '\n          varying lowp vec4 vColour;\n\n          void main() {\n            gl_FragColor = vColour;\n          }\n        ',
      shaderProgram = canvas.createShaderProgram(vertexShaderSource, fragmentShaderSource),
      clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      position = new Position(),
      perspective = new Perspective(clientWidth, clientHeight);

  createAndBindVertexPositionBuffer(canvas, shaderProgram);

  createAndBindVertexColourBuffer(canvas, shaderProgram);

  var count = createVertexIndexElementBuffer(canvas);

  canvas.useProgram(shaderProgram);

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  var initialTime = null;

  function render(time) {
    if (initialTime === null) {
      initialTime = time;
    }

    var elapsedTime = time - initialTime,
        xAngle = elapsedTime / 1000,
        yAngle = elapsedTime / 1000,
        rotation = new Rotation(xAngle, yAngle);

    canvas.render(rotation, position, perspective, shaderProgram);

    canvas.drawElements(count);

    requestAnimationFrame(render);
  }

  requestAnimationFrame(render);
};

module.exports = intermediate;

function createAndBindVertexPositionBuffer(canvas, shaderProgram) {
  var vertexPositionData = [+1.0, +1.0, +1.0, -1.0, +1.0, +1.0, +1.0, -1.0, +1.0, -1.0, -1.0, +1.0, +1.0, +1.0, -1.0, -1.0, +1.0, -1.0, +1.0, -1.0, -1.0, -1.0, -1.0, -1.0, +1.0, +1.0, +1.0, +1.0, -1.0, +1.0, +1.0, +1.0, -1.0, +1.0, -1.0, -1.0, -1.0, +1.0, +1.0, -1.0, -1.0, +1.0, -1.0, +1.0, -1.0, -1.0, -1.0, -1.0, +1.0, +1.0, +1.0, -1.0, +1.0, +1.0, +1.0, +1.0, -1.0, -1.0, +1.0, -1.0, +1.0, -1.0, +1.0, -1.0, -1.0, +1.0, +1.0, -1.0, -1.0, -1.0, -1.0, -1.0],
      vertexPositionBuffer = canvas.createBuffer(vertexPositionData),
      vertexPositionAttributeLocation = canvas.getAttributeLocation(shaderProgram, 'aVertexPosition'),
      vertexPositionComponents = 3;

  canvas.bindBuffer(vertexPositionBuffer, vertexPositionAttributeLocation, vertexPositionComponents);

  var vertexPositionDataLength = vertexPositionData.length,
      count = vertexPositionDataLength / vertexPositionComponents;

  return count;
}

function createAndBindVertexColourBuffer(canvas, shaderProgram) {
  var vertexColourData = [1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 0.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 0.0, 0.0, 1.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0, 1.0, 1.0, 0.0, 1.0],
      vertexColourBuffer = canvas.createBuffer(vertexColourData),
      vertexColourAttributeLocation = canvas.getAttributeLocation(shaderProgram, 'aVertexColour'),
      vertexColourComponents = 4;

  canvas.bindBuffer(vertexColourBuffer, vertexColourAttributeLocation, vertexColourComponents);
}

function createVertexIndexElementBuffer(canvas) {
  var vertexIndexData = [0, 1, 2, 1, 2, 3, 4, 5, 6, 5, 6, 7, 8, 9, 10, 9, 10, 11, 12, 13, 14, 13, 14, 15, 16, 17, 18, 17, 18, 19, 20, 21, 22, 21, 22, 23],
      vertexIndexElementBuffer = canvas.createElementBuffer(vertexIndexData),
      vertexIndexDataLength = vertexIndexData.length,
      count = vertexIndexDataLength; ///

  canvas.bindElementBuffer(vertexIndexElementBuffer);

  return count;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsiQ2FudmFzIiwicmVxdWlyZSIsIlJvdGF0aW9uIiwiUG9zaXRpb24iLCJQZXJzcGVjdGl2ZSIsImludGVybWVkaWF0ZSIsImNhbnZhcyIsImNvbnRleHQiLCJnZXRDb250ZXh0IiwidmVydGV4U2hhZGVyU291cmNlIiwiZnJhZ21lbnRTaGFkZXJTb3VyY2UiLCJzaGFkZXJQcm9ncmFtIiwiY3JlYXRlU2hhZGVyUHJvZ3JhbSIsImNsaWVudFdpZHRoIiwiZ2V0Q2xpZW50V2lkdGgiLCJjbGllbnRIZWlnaHQiLCJnZXRDbGllbnRIZWlnaHQiLCJwb3NpdGlvbiIsInBlcnNwZWN0aXZlIiwiY3JlYXRlQW5kQmluZFZlcnRleFBvc2l0aW9uQnVmZmVyIiwiY3JlYXRlQW5kQmluZFZlcnRleENvbG91ckJ1ZmZlciIsImNvdW50IiwiY3JlYXRlVmVydGV4SW5kZXhFbGVtZW50QnVmZmVyIiwidXNlUHJvZ3JhbSIsImVuYWJsZURlcHRoVGVzdGluZyIsImVuYWJsZURlcHRoRnVuY3Rpb24iLCJpbml0aWFsVGltZSIsInJlbmRlciIsInRpbWUiLCJlbGFwc2VkVGltZSIsInhBbmdsZSIsInlBbmdsZSIsInJvdGF0aW9uIiwiZHJhd0VsZW1lbnRzIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwibW9kdWxlIiwiZXhwb3J0cyIsInZlcnRleFBvc2l0aW9uRGF0YSIsInZlcnRleFBvc2l0aW9uQnVmZmVyIiwiY3JlYXRlQnVmZmVyIiwidmVydGV4UG9zaXRpb25BdHRyaWJ1dGVMb2NhdGlvbiIsImdldEF0dHJpYnV0ZUxvY2F0aW9uIiwidmVydGV4UG9zaXRpb25Db21wb25lbnRzIiwiYmluZEJ1ZmZlciIsInZlcnRleFBvc2l0aW9uRGF0YUxlbmd0aCIsImxlbmd0aCIsInZlcnRleENvbG91ckRhdGEiLCJ2ZXJ0ZXhDb2xvdXJCdWZmZXIiLCJ2ZXJ0ZXhDb2xvdXJBdHRyaWJ1dGVMb2NhdGlvbiIsInZlcnRleENvbG91ckNvbXBvbmVudHMiLCJ2ZXJ0ZXhJbmRleERhdGEiLCJ2ZXJ0ZXhJbmRleEVsZW1lbnRCdWZmZXIiLCJjcmVhdGVFbGVtZW50QnVmZmVyIiwidmVydGV4SW5kZXhEYXRhTGVuZ3RoIiwiYmluZEVsZW1lbnRCdWZmZXIiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFNBQVNDLFFBQVEsV0FBUixDQUFmO0FBQUEsSUFDTUMsV0FBV0QsUUFBUSxhQUFSLENBRGpCO0FBQUEsSUFFTUUsV0FBV0YsUUFBUSxhQUFSLENBRmpCO0FBQUEsSUFHTUcsY0FBY0gsUUFBUSxnQkFBUixDQUhwQjs7QUFLQSxJQUFNSSxlQUFlLFNBQWZBLFlBQWUsR0FBTTtBQUN6QixNQUFNQyxTQUFTLElBQUlOLE1BQUosRUFBZjtBQUFBLE1BQ01PLFVBQVVELE9BQU9FLFVBQVAsRUFEaEI7O0FBR0EsTUFBSSxDQUFDRCxPQUFMLEVBQWM7QUFDWjtBQUNEOztBQUVELE1BQU1FLHllQUFOO0FBQUEsTUFlTUMsc0pBZk47QUFBQSxNQXNCTUMsZ0JBQWdCTCxPQUFPTSxtQkFBUCxDQUEyQkgsa0JBQTNCLEVBQStDQyxvQkFBL0MsQ0F0QnRCO0FBQUEsTUF1Qk1HLGNBQWNQLE9BQU9RLGNBQVAsRUF2QnBCO0FBQUEsTUF3Qk1DLGVBQWVULE9BQU9VLGVBQVAsRUF4QnJCO0FBQUEsTUF5Qk1DLFdBQVcsSUFBSWQsUUFBSixFQXpCakI7QUFBQSxNQTBCTWUsY0FBYyxJQUFJZCxXQUFKLENBQWdCUyxXQUFoQixFQUE2QkUsWUFBN0IsQ0ExQnBCOztBQTRCQUksb0NBQWtDYixNQUFsQyxFQUEwQ0ssYUFBMUM7O0FBRUFTLGtDQUFnQ2QsTUFBaEMsRUFBd0NLLGFBQXhDOztBQUVBLE1BQU1VLFFBQVFDLCtCQUErQmhCLE1BQS9CLENBQWQ7O0FBRUFBLFNBQU9pQixVQUFQLENBQWtCWixhQUFsQjs7QUFFQUwsU0FBT2tCLGtCQUFQO0FBQ0FsQixTQUFPbUIsbUJBQVA7O0FBRUEsTUFBSUMsY0FBYyxJQUFs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Q0FMVyxFQUtSLEVBTFEsRUFNZixDQU5lLEVBTVosRUFOWSxFQU1SLEVBTlEsRUFPaEIsRUFQZ0IsRUFPWixFQVBZLEVBT1IsRUFQUSxFQVFoQixFQVJnQixFQVFaLEVBUlksRUFRUixFQVJRLEVBU2hCLEVBVGdCLEVBU1osRUFUWSxFQVNSLEVBVFEsRUFVaEIsRUFWZ0IsRUFVWixFQVZZLEVBVVIsRUFWUSxFQVdoQixFQVhnQixFQVdaLEVBWFksRUFXUixFQVhRLEVBWWhCLEVBWmdCLEVBWVosRUFaWSxFQVlSLEVBWlEsQ0FBeEI7QUFBQSxNQWNNQywyQkFBMkI3QyxPQUFPOEMsbUJBQVAsQ0FBMkJGLGVBQTNCLENBZGpDO0FBQUEsTUFlTUcsd0JBQXdCSCxnQkFBZ0JMLE1BZjlDO0FBQUEsTUFnQk14QixRQUFRZ0MscUJBaEJkLENBRDhDLENBaUJSOztBQUV0Qy9DLFNBQU9nRCxpQkFBUCxDQUF5Qkgsd0JBQXpCOztBQUVBLFNBQU85QixLQUFQO0FBQ0QiLCJmaWxlIjoiaW50ZXJtZWRpYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBDYW52YXMgPSByZXF1aXJlKCcuLi9jYW52YXMnKSxcbiAgICAgIFJvdGF0aW9uID0gcmVxdWlyZSgnLi4vcm90YXRpb24nKSxcbiAgICAgIFBvc2l0aW9uID0gcmVxdWlyZSgnLi4vcG9zaXRpb24nKSxcbiAgICAgIFBlcnNwZWN0aXZlID0gcmVxdWlyZSgnLi4vcGVyc3BlY3RpdmUnKTtcblxuY29uc3QgaW50ZXJtZWRpYXRlID0gKCkgPT4ge1xuICBjb25zdCBjYW52YXMgPSBuZXcgQ2FudmFzKCksXG4gICAgICAgIGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgpO1xuXG4gIGlmICghY29udGV4dCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IHZlcnRleFNoYWRlclNvdXJjZSA9IGBcbiAgICAgICAgICBhdHRyaWJ1dGUgdmVjNCBhVmVydGV4UG9zaXRpb247XG4gICAgICAgICAgYXR0cmlidXRlIHZlYzQgYVZlcnRleENvbG91cjtcbiAgICAgICAgICBcbiAgICAgICAgICB1bmlmb3JtIG1hdDQgdVJvdGF0aW9uTWF0cml4O1xuICAgICAgICAgIHVuaWZvcm0gbWF0NCB1UG9zaXRpb25NYXRyaXg7XG4gICAgICAgICAgdW5pZm9ybSBtYXQ0IHVQZXJzcGVjdGl2ZU1hdHJpeDtcbiAgICAgICAgICBcbiAgICAgICAgICB2YXJ5aW5nIGxvd3AgdmVjNCB2Q29sb3VyO1xuICAgICAgXG4gICAgICAgICAgdm9pZCBtYWluKCkge1xuICAgICAgICAgICAgZ2xfUG9zaXRpb24gPSB1UGVyc3BlY3RpdmVNYXRyaXgqIHVQb3NpdGlvbk1hdHJpeCAqIHVSb3RhdGlvbk1hdHJpeCAqIGFWZXJ0ZXhQb3NpdGlvbjtcbiAgICAgICAgICAgIHZDb2xvdXIgPSBhVmVydGV4Q29sb3VyO1xuICAgICAgICAgIH1cbiAgICAgICAgYCxcbiAgICAgICAgZnJhZ21lbnRTaGFkZXJTb3VyY2UgPSBgXG4gICAgICAgICAgdmFyeWluZyBsb3dwIHZlYzQgdkNvbG91cjtcblxuICAgICAgICAgIHZvaWQgbWFpbigpIHtcbiAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZDb2xvdXI7XG4gICAgICAgICAgfVxuICAgICAgICBgLFxuICAgICAgICBzaGFkZXJQcm9ncmFtID0gY2FudmFzLmNyZWF0ZVNoYWRlclByb2dyYW0odmVydGV4U2hhZGVyU291cmNlLCBmcmFnbWVudFNoYWRlclNvdXJjZSksXG4gICAgICAgIGNsaWVudFdpZHRoID0gY2FudmFzLmdldENsaWVudFdpZHRoKCksXG4gICAgICAgIGNsaWVudEhlaWdodCA9IGNhbnZhcy5nZXRDbGllbnRIZWlnaHQoKSxcbiAgICAgICAgcG9zaXRpb24gPSBuZXcgUG9zaXRpb24oKSxcbiAgICAgICAgcGVyc3BlY3RpdmUgPSBuZXcgUGVyc3BlY3RpdmUoY2xpZW50V2lkdGgsIGNsaWVudEhlaWdodCk7XG5cbiAgY3JlYXRlQW5kQmluZFZlcnRleFBvc2l0aW9uQnVmZmVyKGNhbnZhcywgc2hhZGVyUHJvZ3JhbSk7XG5cbiAgY3JlYXRlQW5kQmluZFZlcnRleENvbG91ckJ1ZmZlcihjYW52YXMsIHNoYWRlclByb2dyYW0pO1xuXG4gIGNvbnN0IGNvdW50ID0gY3JlYXRlVmVydGV4SW5kZXhFbGVtZW50QnVmZmVyKGNhbnZhcyk7XG5cbiAgY2FudmFzLnVzZVByb2dyYW0oc2hhZGVyUHJvZ3JhbSk7XG5cbiAgY2FudmFzLmVuYWJsZURlcHRoVGVzdGluZygpO1xuICBjYW52YXMuZW5hYmxlRGVwdGhGdW5jdGlvbigpO1xuXG4gIGxldCBpbml0aWFsVGltZSA9IG51bGw7XG5cbiAgZnVuY3Rpb24gcmVuZGVyKHRpbWUpIHtcbiAgICBpZiAoaW5pdGlhbFRpbWUgPT09IG51bGwpIHtcbiAgICAgIGluaXRpYWxUaW1lID0gdGltZTtcbiAgICB9XG5cbiAgICBjb25zdCBlbGFwc2VkVGltZSA9IHRpbWUgLSBpbml0aWFsVGltZSxcbiAgICAgICAgICB4QW5nbGUgPSBlbGFwc2VkVGltZSAvIDEwMDAsXG4gICAgICAgICAgeUFuZ2xlID0gZWxhcHNlZFRpbWUgLyAxMDAwLFxuICAgICAgICAgIHJvdGF0aW9uID0gbmV3IFJvdGF0aW9uKHhBbmdsZSwgeUFuZ2xlKTtcblxuICAgIGNhbnZhcy5yZW5kZXIocm90YXRpb24sIHBvc2l0aW9uLCBwZXJzcGVjdGl2ZSwgc2hhZGVyUHJvZ3JhbSk7XG5cbiAgICBjYW52YXMuZHJhd0VsZW1lbnRzKGNvdW50KTtcblxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShyZW5kZXIpO1xuICB9XG5cbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IGludGVybWVkaWF0ZTtcblxuZnVuY3Rpb24gY3JlYXRlQW5kQmluZFZlcnRleFBvc2l0aW9uQnVmZmVyKGNhbnZhcywgc2hhZGVyUHJvZ3JhbSkge1xuICBjb25zdCB2ZXJ0ZXhQb3NpdGlvbkRhdGEgPSBbXG4gICAgICAgICAgKzEuMCwgKzEuMCwgKzEuMCxcbiAgICAgICAgICAtMS4wLCArMS4wLCArMS4wLFxuICAgICAgICAgICsxLjAsIC0xLjAsICsxLjAsXG4gICAgICAgICAgLTEuMCwgLTEuMCwgKzEuMCxcblxuICAgICAgICAgICsxLjAsICsxLjAsIC0xLjAsXG4gICAgICAgICAgLTEuMCwgKzEuMCwgLTEuMCxcbiAgICAgICAgICArMS4wLCAtMS4wLCAtMS4wLFxuICAgICAgICAgIC0xLjAsIC0xLjAsIC0xLjAsXG5cbiAgICAgICAgICArMS4wLCArMS4wLCArMS4wLFxuICAgICAgICAgICsxLjAsIC0xLjAsICsxLjAsXG4gICAgICAgICAgKzEuMCwgKzEuMCwgLTEuMCxcbiAgICAgICAgICArMS4wLCAtMS4wLCAtMS4wLFxuXG4gICAgICAgICAgLTEuMCwgKzEuMCwgKzEuMCxcbiAgICAgICAgICAtMS4wLCAtMS4wLCArMS4wLFxuICAgICAgICAgIC0xLjAsICsxLjAsIC0xLjAsXG4gICAgICAgICAgLTEuMCwgLTEuMCwgLTEuMCxcblxuICAgICAgICAgICsxLjAsICsxLjAsICsxLjAsXG4gICAgICAgICAgLTEuMCwgKzEuMCwgKzEuMCxcbiAgICAgICAgICArMS4wLCArMS4wLCAtMS4wLFxuICAgICAgICAgIC0xLjAsICsxLjAsIC0xLjAsXG5cbiAgICAgICAgICArMS4wLCAtMS4wLCArMS4wLFxuICAgICAgICAgIC0xLjAsIC0xLjAsICsxLjAsXG4gICAgICAgICAgKzEuMCwgLTEuMCwgLTEuMCxcbiAgICAgICAgICAtMS4wLCAtMS4wLCAtMS4wXG4gICAgICAgIF0sXG4gICAgICAgIHZlcnRleFBvc2l0aW9uQnVmZmVyID0gY2FudmFzLmNyZWF0ZUJ1ZmZlcih2ZXJ0ZXhQb3NpdGlvbkRhdGEpLFxuICAgICAgICB2ZXJ0ZXhQb3NpdGlvbkF0dHJpYnV0ZUxvY2F0aW9uID0gY2FudmFzLmdldEF0dHJpYnV0ZUxvY2F0aW9uKHNoYWRlclByb2dyYW0sICdhVmVydGV4UG9zaXRpb24nKSxcbiAgICAgICAgdmVydGV4UG9zaXRpb25Db21wb25lbnRzID0gMztcblxuICBjYW52YXMuYmluZEJ1ZmZlcih2ZXJ0ZXhQb3NpdGlvbkJ1ZmZlciwgdmVydGV4UG9zaXRpb25BdHRyaWJ1dGVMb2NhdGlvbiwgdmVydGV4UG9zaXRpb25Db21wb25lbnRzKTtcblxuICBjb25zdCB2ZXJ0ZXhQb3NpdGlvbkRhdGFMZW5ndGggPSB2ZXJ0ZXhQb3NpdGlvbkRhdGEubGVuZ3RoLFxuICAgICAgICBjb3VudCA9IHZlcnRleFBvc2l0aW9uRGF0YUxlbmd0aCAvIHZlcnRleFBvc2l0aW9uQ29tcG9uZW50cztcblxuICByZXR1cm4gY291bnQ7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUFuZEJpbmRWZXJ0ZXhDb2xvdXJCdWZmZXIoY2FudmFzLCBzaGFkZXJQcm9ncmFtKSB7XG4gIGNvbnN0IHZlcnRleENvbG91ckRhdGEgPSBbXG4gICAgICAgICAgMS4wLCAgMC4wLCAgMC4wLCAgMS4wLFxuICAgICAgICAgIDEuMCwgIDAuMCwgIDAuMCwgIDEuMCxcbiAgICAgICAgICAxLjAsICAwLjAsICAwLjAsICAxLjAsXG4gICAgICAgICAgMS4wLCAgMC4wLCAgMC4wLCAgMS4wLFxuXG4gICAgICAgICAgMC4wLCAgMS4wLCAgMS4wLCAgMS4wLFxuICAgICAgICAgIDAuMCwgIDEuMCwgIDEuMCwgIDEuMCxcbiAgICAgICAgICAwLjAsICAxLjAsICAxLjAsICAxLjAsXG4gICAgICAgICAgMC4wLCAgMS4wLCAgMS4wLCAgMS4wLFxuXG4gICAgICAgICAgMC4wLCAgMS4wLCAgMC4wLCAgMS4wLFxuICAgICAgICAgIDAuMCwgIDEuMCwgIDAuMCwgIDEuMCxcbiAgICAgICAgICAwLjAsICAxLjAsICAwLjAsICAxLjAsXG4gICAgICAgICAgMC4wLCAgMS4wLCAgMC4wLCAgMS4wLFxuXG4gICAgICAgICAgMS4wLCAgMC4wLCAgMS4wLCAgMS4wLFxuICAgICAgICAgIDEuMCwgIDAuMCwgIDEuMCwgIDEuMCxcbiAgICAgICAgICAxLjAsICAwLjAsICAxLjAsICAxLjAsXG4gICAgICAgICAgMS4wLCAgMC4wLCAgMS4wLCAgMS4wLFxuXG4gICAgICAgICAgMC4wLCAgMC4wLCAgMS4wLCAgMS4wLFxuICAgICAgICAgIDAuMCwgIDAuMCwgIDEuMCwgIDEuMCxcbiAgICAgICAgICAwLjAsICAwLjAsICAxLjAsICAxLjAsXG4gICAgICAgICAgMC4wLCAgMC4wLCAgMS4wLCAgMS4wLFxuXG4gICAgICAgICAgMS4wLCAgMS4wLCAgMC4wLCAgMS4wLFxuICAgICAgICAgIDEuMCwgIDEuMCwgIDAuMCwgIDEuMCxcbiAgICAgICAgICAxLjAsICAxLjAsICAwLjAsICAxLjAsXG4gICAgICAgICAgMS4wLCAgMS4wLCAgMC4wLCAgMS4wXG4gICAgICAgIF0sXG4gICAgICAgIHZlcnRleENvbG91ckJ1ZmZlciA9IGNhbnZhcy5jcmVhdGVCdWZmZXIodmVydGV4Q29sb3VyRGF0YSksXG4gICAgICAgIHZlcnRleENvbG91ckF0dHJpYnV0ZUxvY2F0aW9uID0gY2FudmFzLmdldEF0dHJpYnV0ZUxvY2F0aW9uKHNoYWRlclByb2dyYW0sICdhVmVydGV4Q29sb3VyJyksXG4gICAgICAgIHZlcnRleENvbG91ckNvbXBvbmVudHMgPSA0O1xuXG4gIGNhbnZhcy5iaW5kQnVmZmVyKHZlcnRleENvbG91ckJ1ZmZlciwgdmVydGV4Q29sb3VyQXR0cmlidXRlTG9jYXRpb24sIHZlcnRleENvbG91ckNvbXBvbmVudHMpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVWZXJ0ZXhJbmRleEVsZW1lbnRCdWZmZXIoY2FudmFzKSB7XG4gIGNvbnN0IHZlcnRleEluZGV4RGF0YSA9IFtcbiAgICAgICAgICAgMCwgIDEsICAyLFxuICAgICAgICAgICAxLCAgMiwgIDMsXG4gICAgICAgICAgIDQsICA1LCAgNixcbiAgICAgICAgICAgNSwgIDYsICA3LFxuICAgICAgICAgICA4LCAgOSwgMTAsXG4gICAgICAgICAgIDksIDEwLCAxMSxcbiAgICAgICAgICAxMiwgMTMsIDE0LFxuICAgICAgICAgIDEzLCAxNCwgMTUsXG4gICAgICAgICAgMTYsIDE3LCAxOCxcbiAgICAgICAgICAxNywgMTgsIDE5LFxuICAgICAgICAgIDIwLCAyMSwgMjIsXG4gICAgICAgICAgMjEsIDIyLCAyM1xuICAgICAgICBdLFxuICAgICAgICB2ZXJ0ZXhJbmRleEVsZW1lbnRCdWZmZXIgPSBjYW52YXMuY3JlYXRlRWxlbWVudEJ1ZmZlcih2ZXJ0ZXhJbmRleERhdGEpLFxuICAgICAgICB2ZXJ0ZXhJbmRleERhdGFMZW5ndGggPSB2ZXJ0ZXhJbmRleERhdGEubGVuZ3RoLFxuICAgICAgICBjb3VudCA9IHZlcnRleEluZGV4RGF0YUxlbmd0aDsgIC8vL1xuXG4gIGNhbnZhcy5iaW5kRWxlbWVudEJ1ZmZlcih2ZXJ0ZXhJbmRleEVsZW1lbnRCdWZmZXIpO1xuXG4gIHJldHVybiBjb3VudDtcbn0iXX0=