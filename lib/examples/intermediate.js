'use strict';

var necessary = require('necessary');

var angles = require('../angles'),
    Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    MouseEvents = require('../mouseEvents'),
    ColourShader = require('../shader/colour'),
    TextureShader = require('../shader/texture'),
    imagesUtilities = require('../utilities/images'),
    ColourCube = require('./intermediate/cube/colour'),
    TextureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    preload = imagesUtilities.preload,
    first = arrayUtilities.first;


var render = void 0;

function intermediate() {
  var canvas = new Canvas(),
      colourShader = ColourShader.fromNothing(canvas),
      textureShader = TextureShader.fromNothing(canvas);

  var mouseEvents = new MouseEvents(canvas);

  mouseEvents.addMouseUpEventHandler(mouseUpEventHandler);
  mouseEvents.addMouseDownEventHandler(mouseDownEventHandler);
  mouseEvents.addMouseMoveEventHandler(mouseMoveEventHandler);
  mouseEvents.addMouseWheelEventHandler(mouseWheelEventHandler);

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createColourCube(colourShader, canvas, function (colourCube) {
    createTextureCube(textureShader, canvas, function (textureCube) {
      render = createRender(canvas, colourCube, colourShader, textureCube, textureShader);

      render();
    });
  });
}

module.exports = intermediate;

function createColourCube(colourShader, canvas, callback) {
  var offsetPosition = [-2, 0, 0],
      colourCube = ColourCube.fromOffsetPosition(offsetPosition, colourShader, canvas);

  callback(colourCube);
}

function createTextureCube(textureShader, canvas, callback) {
  var sources = ['texture/bricks.jpg'];

  preload(sources, function (images) {
    var firstImage = first(images),
        offsetPosition = [+2, 0, 0],
        image = firstImage,
        ///
    textureCube = TextureCube.fromOffsetPositionAndImage(offsetPosition, image, textureShader, canvas);

    callback(textureCube);
  });
}

function createRender(canvas, colourCube, colourShader, textureCube, textureShader) {
  var clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      zCoordinate = -10,
      ///
  position = Position.fromZCoordinate(zCoordinate),
      perspective = Perspective.fromClientWidthAndClientHeight(clientWidth, clientHeight),
      colourCubeCount = colourCube.getCount(),
      textureCubeCount = textureCube.getCount();

  var render = function render() {
    var xAxisAngle = angles.getXAxisAngle(),
        yAxisAngle = angles.getYAxisAngle(),
        xAngle = xAxisAngle,
        ///
    zAngle = yAxisAngle,
        ///
    rotation = Rotation.fromXAngleAndZAngle(xAngle, zAngle),
        normal = Normal.fromRotation(rotation);

    canvas.clear();

    colourCube.bind(colourShader, canvas);

    canvas.useShader(colourShader);

    colourShader.activateTexture(canvas);

    canvas.render(colourShader, normal, rotation, position, perspective);

    canvas.drawElements(colourCubeCount);

    textureCube.bind(textureShader, canvas);

    canvas.useShader(textureShader);

    textureShader.activateTexture(canvas);

    canvas.render(textureShader, normal, rotation, position, perspective);

    canvas.drawElements(textureCubeCount);

    requestAnimationFrame(render);
  };

  return render;
}

function mouseUpEventHandler(mouseCoordinates) {
  angles.mouseUpEventHandler(mouseCoordinates);
}

function mouseDownEventHandler(mouseCoordinates) {
  angles.mouseDownEventHandler(mouseCoordinates);
}

function mouseMoveEventHandler(mouseCoordinates) {
  angles.mouseMoveEventHandler(mouseCoordinates);

  // render();
}

function mouseWheelEventHandler(delta) {
  // zoom.mouseWheelEventHandler(delta);

  // render();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsImFuZ2xlcyIsIkNhbnZhcyIsIk5vcm1hbCIsIlJvdGF0aW9uIiwiUG9zaXRpb24iLCJQZXJzcGVjdGl2ZSIsIk1vdXNlRXZlbnRzIiwiQ29sb3VyU2hhZGVyIiwiVGV4dHVyZVNoYWRlciIsImltYWdlc1V0aWxpdGllcyIsIkNvbG91ckN1YmUiLCJUZXh0dXJlQ3ViZSIsImFycmF5VXRpbGl0aWVzIiwicHJlbG9hZCIsImZpcnN0IiwicmVuZGVyIiwiaW50ZXJtZWRpYXRlIiwiY2FudmFzIiwiY29sb3VyU2hhZGVyIiwiZnJvbU5vdGhpbmciLCJ0ZXh0dXJlU2hhZGVyIiwibW91c2VFdmVudHMiLCJhZGRNb3VzZVVwRXZlbnRIYW5kbGVyIiwibW91c2VVcEV2ZW50SGFuZGxlciIsImFkZE1vdXNlRG93bkV2ZW50SGFuZGxlciIsIm1vdXNlRG93bkV2ZW50SGFuZGxlciIsImFkZE1vdXNlTW92ZUV2ZW50SGFuZGxlciIsIm1vdXNlTW92ZUV2ZW50SGFuZGxlciIsImFkZE1vdXNlV2hlZWxFdmVudEhhbmRsZXIiLCJtb3VzZVdoZWVsRXZlbnRIYW5kbGVyIiwiZW5hYmxlRGVwdGhUZXN0aW5nIiwiZW5hYmxlRGVwdGhGdW5jdGlvbiIsImNyZWF0ZUNvbG91ckN1YmUiLCJjb2xvdXJDdWJlIiwiY3JlYXRlVGV4dHVyZUN1YmUiLCJ0ZXh0dXJlQ3ViZSIsImNyZWF0ZVJlbmRlciIsIm1vZHVsZSIsImV4cG9ydHMiLCJjYWxsYmFjayIsIm9mZnNldFBvc2l0aW9uIiwiZnJvbU9mZnNldFBvc2l0aW9uIiwic291cmNlcyIsImltYWdlcyIsImZpcnN0SW1hZ2UiLCJpbWFnZSIsImZyb21PZmZzZXRQb3NpdGlvbkFuZEltYWdlIiwiY2xpZW50V2lkdGgiLCJnZXRDbGllbnRXaWR0aCIsImNsaWVudEhlaWdodCIsImdldENsaWVudEhlaWdodCIsInpDb29yZGluYXRlIiwicG9zaXRpb24iLCJmcm9tWkNvb3JkaW5hdGUiLCJwZXJzcGVjdGl2ZSIsImZyb21DbGllbnRXaWR0aEFuZENsaWVudEhlaWdodCIsImNvbG91ckN1YmVDb3VudCIsImdldENvdW50IiwidGV4dHVyZUN1YmVDb3VudCIsInhBeGlzQW5nbGUiLCJnZXRYQXhpc0FuZ2xlIiwieUF4aXNBbmdsZSIsImdldFlBeGlzQW5nbGUiLCJ4QW5nbGUiLCJ6QW5nbGUiLCJyb3RhdGlvbiIsImZyb21YQW5nbGVBbmRaQW5nbGUiLCJub3JtYWwiLCJmcm9tUm90YXRpb24iLCJjbGVhciIsImJpbmQiLCJ1c2VTaGFkZXIiLCJhY3RpdmF0ZVRleHR1cmUiLCJkcmF3RWxlbWVudHMiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJtb3VzZUNvb3JkaW5hdGVzIiwiZGVsdGEiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFlBQVlDLFFBQVEsV0FBUixDQUFsQjs7QUFFQSxJQUFNQyxTQUFTRCxRQUFRLFdBQVIsQ0FBZjtBQUFBLElBQ01FLFNBQVNGLFFBQVEsV0FBUixDQURmO0FBQUEsSUFFTUcsU0FBU0gsUUFBUSxXQUFSLENBRmY7QUFBQSxJQUdNSSxXQUFXSixRQUFRLGFBQVIsQ0FIakI7QUFBQSxJQUlNSyxXQUFXTCxRQUFRLGFBQVIsQ0FKakI7QUFBQSxJQUtNTSxjQUFjTixRQUFRLGdCQUFSLENBTHBCO0FBQUEsSUFNTU8sY0FBY1AsUUFBUSxnQkFBUixDQU5wQjtBQUFBLElBT01RLGVBQWVSLFFBQVEsa0JBQVIsQ0FQckI7QUFBQSxJQVFNUyxnQkFBZ0JULFFBQVEsbUJBQVIsQ0FSdEI7QUFBQSxJQVNNVSxrQkFBa0JWLFFBQVEscUJBQVIsQ0FUeEI7QUFBQSxJQVVNVyxhQUFhWCxRQUFRLDRCQUFSLENBVm5CO0FBQUEsSUFXTVksY0FBY1osUUFBUSw2QkFBUixDQVhwQjs7QUFhTSxJQUFFYSxjQUFGLEdBQXFCZCxTQUFyQixDQUFFYyxjQUFGO0FBQUEsSUFDRUMsT0FERixHQUNj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LHFCQUFULENBQStCZ0QsZ0JBQS9CLEVBQWlEO0FBQy9DM0UsU0FBTzJCLHFCQUFQLENBQTZCZ0QsZ0JBQTdCOztBQUVBO0FBQ0Q7O0FBRUQsU0FBUzlDLHNCQUFULENBQWdDK0MsS0FBaEMsRUFBdUM7QUFDckM7O0FBRUE7QUFDRCIsImZpbGUiOiJpbnRlcm1lZGlhdGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IG5lY2Vzc2FyeSA9IHJlcXVpcmUoJ25lY2Vzc2FyeScpO1xuXG5jb25zdCBhbmdsZXMgPSByZXF1aXJlKCcuLi9hbmdsZXMnKSxcbiAgICAgIENhbnZhcyA9IHJlcXVpcmUoJy4uL2NhbnZhcycpLFxuICAgICAgTm9ybWFsID0gcmVxdWlyZSgnLi4vbm9ybWFsJyksXG4gICAgICBSb3RhdGlvbiA9IHJlcXVpcmUoJy4uL3JvdGF0aW9uJyksXG4gICAgICBQb3NpdGlvbiA9IHJlcXVpcmUoJy4uL3Bvc2l0aW9uJyksXG4gICAgICBQZXJzcGVjdGl2ZSA9IHJlcXVpcmUoJy4uL3BlcnNwZWN0aXZlJyksXG4gICAgICBNb3VzZUV2ZW50cyA9IHJlcXVpcmUoJy4uL21vdXNlRXZlbnRzJyksXG4gICAgICBDb2xvdXJTaGFkZXIgPSByZXF1aXJlKCcuLi9zaGFkZXIvY29sb3VyJyksXG4gICAgICBUZXh0dXJlU2hhZGVyID0gcmVxdWlyZSgnLi4vc2hhZGVyL3RleHR1cmUnKSxcbiAgICAgIGltYWdlc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9pbWFnZXMnKSxcbiAgICAgIENvbG91ckN1YmUgPSByZXF1aXJlKCcuL2ludGVybWVkaWF0ZS9jdWJlL2NvbG91cicpLFxuICAgICAgVGV4dHVyZUN1YmUgPSByZXF1aXJlKCcuL2ludGVybWVkaWF0ZS9jdWJlL3RleHR1cmUnKTtcblxuY29uc3QgeyBhcnJheVV0aWxpdGllcyB9ID0gbmVjZXNzYXJ5LFxuICAgICAgeyBwcmVsb2FkIH0gPSBpbWFnZXNVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0IH0gPSBhcnJheVV0aWxpdGllcztcblxubGV0IHJlbmRlcjtcblxuZnVuY3Rpb24gaW50ZXJtZWRpYXRlKCkge1xuICBjb25zdCBjYW52YXMgPSBuZXcgQ2FudmFzKCksXG4gICAgICAgIGNvbG91clNoYWRlciA9IENvbG91clNoYWRlci5mcm9tTm90aGluZyhjYW52YXMpLFxuICAgICAgICB0ZXh0dXJlU2hhZGVyID0gVGV4dHVyZVNoYWRlci5mcm9tTm90aGluZyhjYW52YXMpO1xuXG4gIGNvbnN0IG1vdXNlRXZlbnRzID0gbmV3IE1vdXNlRXZlbnRzKGNhbnZhcyk7XG5cbiAgbW91c2VFdmVudHMuYWRkTW91c2VVcEV2ZW50SGFuZGxlcihtb3VzZVVwRXZlbnRIYW5kbGVyKTtcbiAgbW91c2VFdmVudHMuYWRkTW91c2VEb3duRXZlbnRIYW5kbGVyKG1vdXNlRG93bkV2ZW50SGFuZGxlcik7XG4gIG1vdXNlRXZlbnRzLmFkZE1vdXNlTW92ZUV2ZW50SGFuZGxlcihtb3VzZU1vdmVFdmVudEhhbmRsZXIpO1xuICBtb3VzZUV2ZW50cy5hZGRNb3VzZVdoZWVsRXZlbnRIYW5kbGVyKG1vdXNlV2hlZWxFdmVudEhhbmRsZXIpO1xuXG4gIGNhbnZhcy5lbmFibGVEZXB0aFRlc3RpbmcoKTtcbiAgY2FudmFzLmVuYWJsZURlcHRoRnVuY3Rpb24oKTtcblxuICBjcmVhdGVDb2xvdXJDdWJlKGNvbG91clNoYWRlciwgY2FudmFzLCBmdW5jdGlvbihjb2xvdXJDdWJlKSB7XG4gICAgY3JlYXRlVGV4dHVyZUN1YmUodGV4dHVyZVNoYWRlciwgY2FudmFzLCBmdW5jdGlvbih0ZXh0dXJlQ3ViZSkge1xuICAgICAgcmVuZGVyID0gY3JlYXRlUmVuZGVyKGNhbnZhcywgY29sb3VyQ3ViZSwgY29sb3VyU2hhZGVyLCB0ZXh0dXJlQ3ViZSwgdGV4dHVyZVNoYWRlcik7XG5cbiAgICAgIHJlbmRlcigpO1xuICAgIH0pO1xuICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBpbnRlcm1lZGlhdGU7XG5cbmZ1bmN0aW9uIGNyZWF0ZUNvbG91ckN1YmUoY29sb3VyU2hhZGVyLCBjYW52YXMsIGNhbGxiYWNrKSB7XG4gIGNvbnN0IG9mZnNldFBvc2l0aW9uID0gWy0yLCAwLCAwXSxcbiAgICAgICAgY29sb3VyQ3ViZSA9IENvbG91ckN1YmUuZnJvbU9mZnNldFBvc2l0aW9uKG9mZnNldFBvc2l0aW9uLCBjb2xvdXJTaGFkZXIsIGNhbnZhcyk7XG5cbiAgY2FsbGJhY2soY29sb3VyQ3ViZSk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVRleHR1cmVDdWJlKHRleHR1cmVTaGFkZXIsIGNhbnZhcywgY2FsbGJhY2spIHtcbiAgY29uc3Qgc291cmNlcyA9IFtcbiAgICAgICAgICAndGV4dHVyZS9icmlja3MuanBnJ1xuICAgICAgICBdO1xuXG4gIHByZWxvYWQoc291cmNlcywgZnVuY3Rpb24oaW1hZ2VzKSB7XG4gICAgY29uc3QgZmlyc3RJbWFnZSA9IGZpcnN0KGltYWdlcyksXG4gICAgICAgICAgb2Zmc2V0UG9zaXRpb24gPSBbKzIsIDAsIDBdLFxuICAgICAgICAgIGltYWdlID0gZmlyc3RJbWFnZSwgLy8vXG4gICAgICAgICAgdGV4dHVyZUN1YmUgPSBUZXh0dXJlQ3ViZS5mcm9tT2Zmc2V0UG9zaXRpb25BbmRJbWFnZShvZmZzZXRQb3NpdGlvbiwgaW1hZ2UsIHRleHR1cmVTaGFkZXIsIGNhbnZhcyk7XG5cbiAgICBjYWxsYmFjayh0ZXh0dXJlQ3ViZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVSZW5kZXIoY2FudmFzLCBjb2xvdXJDdWJlLCBjb2xvdXJTaGFkZXIsIHRleHR1cmVDdWJlLCB0ZXh0dXJlU2hhZGVyKSB7XG4gIGNvbnN0IGNsaWVudFdpZHRoID0gY2FudmFzLmdldENsaWVudFdpZHRoKCksXG4gICAgICAgIGNsaWVudEhlaWdodCA9IGNhbnZhcy5nZXRDbGllbnRIZWlnaHQoKSxcbiAgICAgICAgekNvb3JkaW5hdGUgPSAtMTAsIC8vL1xuICAgICAgICBwb3NpdGlvbiA9IFBvc2l0aW9uLmZyb21aQ29vcmRpbmF0ZSh6Q29vcmRpbmF0ZSksXG4gICAgICAgIHBlcnNwZWN0aXZlID0gUGVyc3BlY3RpdmUuZnJvbUNsaWVudFdpZHRoQW5kQ2xpZW50SGVpZ2h0KGNsaWVudFdpZHRoLCBjbGllbnRIZWlnaHQpLFxuICAgICAgICBjb2xvdXJDdWJlQ291bnQgPSBjb2xvdXJDdWJlLmdldENvdW50KCksXG4gICAgICAgIHRleHR1cmVDdWJlQ291bnQgPSB0ZXh0dXJlQ3ViZS5nZXRDb3VudCgpO1xuXG4gIGNvbnN0IHJlbmRlciA9ICgpID0+IHtcbiAgICBjb25zdCB4QXhpc0FuZ2xlID0gYW5nbGVzLmdldFhBeGlzQW5nbGUoKSxcbiAgICAgICAgICB5QXhpc0FuZ2xlID0gYW5nbGVzLmdldFlBeGlzQW5nbGUoKSxcbiAgICAgICAgICB4QW5nbGUgPSB4QXhpc0FuZ2xlLCAgLy8vXG4gICAgICAgICAgekFuZ2xlID0geUF4aXNBbmdsZSwgLy8vXG4gICAgICAgICAgcm90YXRpb24gPSBSb3RhdGlvbi5mcm9tWEFuZ2xlQW5kWkFuZ2xlKHhBbmdsZSwgekFuZ2xlKSxcbiAgICAgICAgICBub3JtYWwgPSBOb3JtYWwuZnJvbVJvdGF0aW9uKHJvdGF0aW9uKTtcblxuICAgIGNhbnZhcy5jbGVhcigpO1xuXG4gICAgY29sb3VyQ3ViZS5iaW5kKGNvbG91clNoYWRlciwgY2FudmFzKTtcblxuICAgIGNhbnZhcy51c2VTaGFkZXIoY29sb3VyU2hhZGVyKTtcblxuICAgIGNvbG91clNoYWRlci5hY3RpdmF0ZVRleHR1cmUoY2FudmFzKTtcblxuICAgIGNhbnZhcy5yZW5kZXIoY29sb3VyU2hhZGVyLCBub3JtYWwsIHJvdGF0aW9uLCBwb3NpdGlvbiwgcGVyc3BlY3RpdmUpO1xuXG4gICAgY2FudmFzLmRyYXdFbGVtZW50cyhjb2xvdXJDdWJlQ291bnQpO1xuXG4gICAgdGV4dHVyZUN1YmUuYmluZCh0ZXh0dXJlU2hhZGVyLCBjYW52YXMpO1xuXG4gICAgY2FudmFzLnVzZVNoYWRlcih0ZXh0dXJlU2hhZGVyKTtcblxuICAgIHRleHR1cmVTaGFkZXIuYWN0aXZhdGVUZXh0dXJlKGNhbnZhcyk7XG5cbiAgICBjYW52YXMucmVuZGVyKHRleHR1cmVTaGFkZXIsIG5vcm1hbCwgcm90YXRpb24sIHBvc2l0aW9uLCBwZXJzcGVjdGl2ZSk7XG5cbiAgICBjYW52YXMuZHJhd0VsZW1lbnRzKHRleHR1cmVDdWJlQ291bnQpO1xuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG4gIH07XG5cbiAgcmV0dXJuIHJlbmRlcjtcbn1cblxuZnVuY3Rpb24gbW91c2VVcEV2ZW50SGFuZGxlcihtb3VzZUNvb3JkaW5hdGVzKSB7XG4gIGFuZ2xlcy5tb3VzZVVwRXZlbnRIYW5kbGVyKG1vdXNlQ29vcmRpbmF0ZXMpO1xufVxuXG5mdW5jdGlvbiBtb3VzZURvd25FdmVudEhhbmRsZXIobW91c2VDb29yZGluYXRlcykge1xuICBhbmdsZXMubW91c2VEb3duRXZlbnRIYW5kbGVyKG1vdXNlQ29vcmRpbmF0ZXMpO1xufVxuXG5mdW5jdGlvbiBtb3VzZU1vdmVFdmVudEhhbmRsZXIobW91c2VDb29yZGluYXRlcykge1xuICBhbmdsZXMubW91c2VNb3ZlRXZlbnRIYW5kbGVyKG1vdXNlQ29vcmRpbmF0ZXMpO1xuXG4gIC8vIHJlbmRlcigpO1xufVxuXG5mdW5jdGlvbiBtb3VzZVdoZWVsRXZlbnRIYW5kbGVyKGRlbHRhKSB7XG4gIC8vIHpvb20ubW91c2VXaGVlbEV2ZW50SGFuZGxlcihkZWx0YSk7XG5cbiAgLy8gcmVuZGVyKCk7XG59XG4iXX0=