'use strict';

var necessary = require('necessary');

var Canvas = require('../canvas'),
    Normal = require('../normal'),
    Rotation = require('../rotation'),
    Position = require('../position'),
    Perspective = require('../perspective'),
    ColourShader = require('../shader/colour'),
    TextureShader = require('../shader/texture'),
    colourCube = require('./intermediate/cube/colour'),
    textureCube = require('./intermediate/cube/texture');

var arrayUtilities = necessary.arrayUtilities,
    asynchronousUtilities = necessary.asynchronousUtilities,
    first = arrayUtilities.first,
    repeatedly = asynchronousUtilities.repeatedly;


function intermediate() {
  var canvas = new Canvas(),
      colourShader = ColourShader.fromNothing(canvas),
      textureShader = TextureShader.fromNothing(canvas);

  canvas.enableDepthTesting();
  canvas.enableDepthFunction();

  createColourCube(colourShader, canvas, function (count, shader) {
    canvas.useShader(shader);

    shader.activateTexture(canvas);

    var render = createRender(canvas, count, shader);

    requestAnimationFrame(render);
  });
}

module.exports = intermediate;

function createColourCube(colourShader, canvas, callback) {
  var offsetPosition = [-1, 0, 0];

  colourCube(offsetPosition, colourShader, canvas, callback);
}

function createTextureCube(textureShader, canvas, callback) {
  loadImages(function (images) {
    var firstImage = first(images),
        offsetPosition = [+1, 0, 0],
        image = firstImage; ///

    textureCube(offsetPosition, image, textureShader, canvas, callback);
  });
}

function loadImages(callback) {
  var imageSources = ['texture/bricks.jpg'],
      images = [],
      context = {
    imageSources: imageSources,
    images: images
  },
      length = imageSources.length; ///

  repeatedly(loadImageCallback, length, function () {
    var images = context.images;


    callback(images);
  }, context);
}

function createRender(canvas, count, shader) {
  var initialTime = null;

  var clientWidth = canvas.getClientWidth(),
      clientHeight = canvas.getClientHeight(),
      zCoordinate = -10,
      ///
  position = Position.fromZCoordinate(zCoordinate),
      perspective = Perspective.fromClientWidthAndClientHeight(clientWidth, clientHeight);

  var render = function render(time) {
    if (initialTime === null) {
      initialTime = time;
    }

    var elapsedTime = time - initialTime,

    // xAngle = elapsedTime / 1000,
    // yAngle = elapsedTime / 1000,
    // rotation = Rotation.fromXAngleAndYAngle(xAngle, yAngle),
    rotation = Rotation.fromNothing(),
        normal = Normal.fromRotation(rotation);

    canvas.render(shader, normal, rotation, position, perspective);

    canvas.drawElements(count);

    requestAnimationFrame(render);
  };

  return render;
}

function loadImageCallback(next, done, context, index) {
  var imageSources = context.imageSources,
      images = context.images,
      imageSource = imageSources[index],
      image = new Image();


  images[index] = image;

  image.onload = next; ///

  image.src = imageSource; ///
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi9leGFtcGxlcy9pbnRlcm1lZGlhdGUuanMiXSwibmFtZXMiOlsibmVjZXNzYXJ5IiwicmVxdWlyZSIsIkNhbnZhcyIsIk5vcm1hbCIsIlJvdGF0aW9uIiwiUG9zaXRpb24iLCJQZXJzcGVjdGl2ZSIsIkNvbG91clNoYWRlciIsIlRleHR1cmVTaGFkZXIiLCJjb2xvdXJDdWJlIiwidGV4dHVyZUN1YmUiLCJhcnJheVV0aWxpdGllcyIsImFzeW5jaHJvbm91c1V0aWxpdGllcyIsImZpcnN0IiwicmVwZWF0ZWRseSIsImludGVybWVkaWF0ZSIsImNhbnZhcyIsImNvbG91clNoYWRlciIsImZyb21Ob3RoaW5nIiwidGV4dHVyZVNoYWRlciIsImVuYWJsZURlcHRoVGVzdGluZyIsImVuYWJsZURlcHRoRnVuY3Rpb24iLCJjcmVhdGVDb2xvdXJDdWJlIiwiY291bnQiLCJzaGFkZXIiLCJ1c2VTaGFkZXIiLCJhY3RpdmF0ZVRleHR1cmUiLCJyZW5kZXIiLCJjcmVhdGVSZW5kZXIiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJtb2R1bGUiLCJleHBvcnRzIiwiY2FsbGJhY2siLCJvZmZzZXRQb3NpdGlvbiIsImNyZWF0ZVRleHR1cmVDdWJlIiwibG9hZEltYWdlcyIsImltYWdlcyIsImZpcnN0SW1hZ2UiLCJpbWFnZSIsImltYWdlU291cmNlcyIsImNvbnRleHQiLCJsZW5ndGgiLCJsb2FkSW1hZ2VDYWxsYmFjayIsImluaXRpYWxUaW1lIiwiY2xpZW50V2lkdGgiLCJnZXRDbGllbnRXaWR0aCIsImNsaWVudEhlaWdodCIsImdldENsaWVudEhlaWdodCIsInpDb29yZGluYXRlIiwicG9zaXRpb24iLCJmcm9tWkNvb3JkaW5hdGUiLCJwZXJzcGVjdGl2ZSIsImZyb21DbGllbnRXaWR0aEFuZENsaWVudEhlaWdodCIsInRpbWUiLCJlbGFwc2VkVGltZSIsInJvdGF0aW9uIiwibm9ybWFsIiwiZnJvbVJvdGF0aW9uIiwiZHJhd0VsZW1lbnRzIiwibmV4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QWIsQ0FGaUM7QUFBQSxNQUcvQ3ZCLEtBSCtDLEdBR3ZDLElBQUl5QixLQUFKLEVBSHVDOzs7QUFLckQzQixTQUFPeUIsS0FBUCxJQUFnQnZCLEtBQWhCOztBQUVBQSxRQUFNMEIsTUFBTixHQUFlTCxJQUFmLENBUHFELENBTy9COztBQUV0QnJCLFFBQU0yQixHQUFOLEdBQVlILFdBQVosQ0FUcUQsQ0FTM0I7QUFDM0IiLCJmaWxlIjoiaW50ZXJtZWRpYXRlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBuZWNlc3NhcnkgPSByZXF1aXJlKCduZWNlc3NhcnknKTtcblxuY29uc3QgQ2FudmFzID0gcmVxdWlyZSgnLi4vY2FudmFzJyksXG4gICAgICBOb3JtYWwgPSByZXF1aXJlKCcuLi9ub3JtYWwnKSxcbiAgICAgIFJvdGF0aW9uID0gcmVxdWlyZSgnLi4vcm90YXRpb24nKSxcbiAgICAgIFBvc2l0aW9uID0gcmVxdWlyZSgnLi4vcG9zaXRpb24nKSxcbiAgICAgIFBlcnNwZWN0aXZlID0gcmVxdWlyZSgnLi4vcGVyc3BlY3RpdmUnKSxcbiAgICAgIENvbG91clNoYWRlciA9IHJlcXVpcmUoJy4uL3NoYWRlci9jb2xvdXInKSxcbiAgICAgIFRleHR1cmVTaGFkZXIgPSByZXF1aXJlKCcuLi9zaGFkZXIvdGV4dHVyZScpLFxuICAgICAgY29sb3VyQ3ViZSA9IHJlcXVpcmUoJy4vaW50ZXJtZWRpYXRlL2N1YmUvY29sb3VyJyksXG4gICAgICB0ZXh0dXJlQ3ViZSA9IHJlcXVpcmUoJy4vaW50ZXJtZWRpYXRlL2N1YmUvdGV4dHVyZScpO1xuXG5jb25zdCB7IGFycmF5VXRpbGl0aWVzLCBhc3luY2hyb25vdXNVdGlsaXRpZXMgfSA9IG5lY2Vzc2FyeSxcbiAgICAgIHsgZmlyc3QgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyByZXBlYXRlZGx5IH0gPSBhc3luY2hyb25vdXNVdGlsaXRpZXM7XG5cbmZ1bmN0aW9uIGludGVybWVkaWF0ZSgpIHtcbiAgY29uc3QgY2FudmFzID0gbmV3IENhbnZhcygpLFxuICAgICAgICBjb2xvdXJTaGFkZXIgPSBDb2xvdXJTaGFkZXIuZnJvbU5vdGhpbmcoY2FudmFzKSxcbiAgICAgICAgdGV4dHVyZVNoYWRlciA9IFRleHR1cmVTaGFkZXIuZnJvbU5vdGhpbmcoY2FudmFzKTtcblxuICBjYW52YXMuZW5hYmxlRGVwdGhUZXN0aW5nKCk7XG4gIGNhbnZhcy5lbmFibGVEZXB0aEZ1bmN0aW9uKCk7XG5cbiAgY3JlYXRlQ29sb3VyQ3ViZShjb2xvdXJTaGFkZXIsIGNhbnZhcywgZnVuY3Rpb24oY291bnQsIHNoYWRlcikge1xuICAgIGNhbnZhcy51c2VTaGFkZXIoc2hhZGVyKTtcblxuICAgIHNoYWRlci5hY3RpdmF0ZVRleHR1cmUoY2FudmFzKTtcblxuICAgIGNvbnN0IHJlbmRlciA9IGNyZWF0ZVJlbmRlcihjYW52YXMsIGNvdW50LCBzaGFkZXIpO1xuXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKHJlbmRlcik7XG4gIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGludGVybWVkaWF0ZTtcblxuZnVuY3Rpb24gY3JlYXRlQ29sb3VyQ3ViZShjb2xvdXJTaGFkZXIsIGNhbnZhcywgY2FsbGJhY2spIHtcbiAgY29uc3Qgb2Zmc2V0UG9zaXRpb24gPSBbLTEsIDAsIDBdO1xuXG4gIGNvbG91ckN1YmUob2Zmc2V0UG9zaXRpb24sIGNvbG91clNoYWRlciwgY2FudmFzLCBjYWxsYmFjayk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVRleHR1cmVDdWJlKHRleHR1cmVTaGFkZXIsIGNhbnZhcywgY2FsbGJhY2spIHtcbiAgbG9hZEltYWdlcyhmdW5jdGlvbihpbWFnZXMpIHtcbiAgICBjb25zdCBmaXJzdEltYWdlID0gZmlyc3QoaW1hZ2VzKSxcbiAgICAgICAgICBvZmZzZXRQb3NpdGlvbiA9IFsrMSwgMCwgMF0sXG4gICAgICAgICAgaW1hZ2UgPSBmaXJzdEltYWdlOyAvLy9cblxuICAgIHRleHR1cmVDdWJlKG9mZnNldFBvc2l0aW9uLCBpbWFnZSwgdGV4dHVyZVNoYWRlciwgY2FudmFzLCBjYWxsYmFjayk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBsb2FkSW1hZ2VzKGNhbGxiYWNrKSB7XG4gIGNvbnN0IGltYWdlU291cmNlcyA9IFtcbiAgICAgICAgICAndGV4dHVyZS9icmlja3MuanBnJ1xuICAgICAgICBdLFxuICAgICAgICBpbWFnZXMgPSBbXSxcbiAgICAgICAgY29udGV4dCA9IHtcbiAgICAgICAgICBpbWFnZVNvdXJjZXM6IGltYWdlU291cmNlcyxcbiAgICAgICAgICBpbWFnZXM6IGltYWdlc1xuICAgICAgICB9LFxuICAgICAgICBsZW5ndGggPSBpbWFnZVNvdXJjZXMubGVuZ3RoOyAvLy9cblxuICByZXBlYXRlZGx5KGxvYWRJbWFnZUNhbGxiYWNrLCBsZW5ndGgsIGZ1bmN0aW9uKCkge1xuICAgIGNvbnN0IHsgaW1hZ2VzIH0gPSBjb250ZXh0O1xuXG4gICAgY2FsbGJhY2soaW1hZ2VzKVxuICB9LCBjb250ZXh0KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmVuZGVyKGNhbnZhcywgY291bnQsIHNoYWRlcikge1xuICBsZXQgaW5pdGlhbFRpbWUgPSBudWxsO1xuXG4gIGNvbnN0IGNsaWVudFdpZHRoID0gY2FudmFzLmdldENsaWVudFdpZHRoKCksXG4gICAgICAgIGNsaWVudEhlaWdodCA9IGNhbnZhcy5nZXRDbGllbnRIZWlnaHQoKSxcbiAgICAgICAgekNvb3JkaW5hdGUgPSAtMTAsIC8vL1xuICAgICAgICBwb3NpdGlvbiA9IFBvc2l0aW9uLmZyb21aQ29vcmRpbmF0ZSh6Q29vcmRpbmF0ZSksXG4gICAgICAgIHBlcnNwZWN0aXZlID0gUGVyc3BlY3RpdmUuZnJvbUNsaWVudFdpZHRoQW5kQ2xpZW50SGVpZ2h0KGNsaWVudFdpZHRoLCBjbGllbnRIZWlnaHQpO1xuXG4gIGNvbnN0IHJlbmRlciA9ICh0aW1lKSA9PiB7XG4gICAgaWYgKGluaXRpYWxUaW1lID09PSBudWxsKSB7XG4gICAgICBpbml0aWFsVGltZSA9IHRpbWU7XG4gICAgfVxuXG4gICAgY29uc3QgZWxhcHNlZFRpbWUgPSB0aW1lIC0gaW5pdGlhbFRpbWUsXG4gICAgICAgICAgLy8geEFuZ2xlID0gZWxhcHNlZFRpbWUgLyAxMDAwLFxuICAgICAgICAgIC8vIHlBbmdsZSA9IGVsYXBzZWRUaW1lIC8gMTAwMCxcbiAgICAgICAgICAvLyByb3RhdGlvbiA9IFJvdGF0aW9uLmZyb21YQW5nbGVBbmRZQW5nbGUoeEFuZ2xlLCB5QW5nbGUpLFxuICAgICAgICAgIHJvdGF0aW9uID0gUm90YXRpb24uZnJvbU5vdGhpbmcoKSxcbiAgICAgICAgICBub3JtYWwgPSBOb3JtYWwuZnJvbVJvdGF0aW9uKHJvdGF0aW9uKTtcblxuICAgIGNhbnZhcy5yZW5kZXIoc2hhZGVyLCBub3JtYWwsIHJvdGF0aW9uLCBwb3NpdGlvbiwgcGVyc3BlY3RpdmUpO1xuXG4gICAgY2FudmFzLmRyYXdFbGVtZW50cyhjb3VudCk7XG5cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUocmVuZGVyKTtcbiAgfTtcblxuICByZXR1cm4gcmVuZGVyO1xufVxuXG5mdW5jdGlvbiBsb2FkSW1hZ2VDYWxsYmFjayhuZXh0LCBkb25lLCBjb250ZXh0LCBpbmRleCkge1xuICBjb25zdCB7IGltYWdlU291cmNlcywgaW1hZ2VzIH0gPSBjb250ZXh0LFxuICAgICAgICBpbWFnZVNvdXJjZSA9IGltYWdlU291cmNlc1tpbmRleF0sXG4gICAgICAgIGltYWdlID0gbmV3IEltYWdlKCk7XG5cbiAgaW1hZ2VzW2luZGV4XSA9IGltYWdlO1xuXG4gIGltYWdlLm9ubG9hZCA9IG5leHQ7ICAvLy9cblxuICBpbWFnZS5zcmMgPSBpbWFnZVNvdXJjZTsgIC8vL1xufVxuIl19