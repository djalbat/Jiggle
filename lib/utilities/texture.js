'use strict';

var matrixMaths = require('../maths/matrix'),
    vectorMaths = require('../maths/vector'),
    arrayUtilities = require('../utilities/array'),
    verticesUtilities = require('../utilities/vertices'),
    quaternionUtilities = require('../utilities/quaternion');

var rotateVertices = verticesUtilities.rotateVertices,
    invert2 = matrixMaths.invert2,
    invert3 = matrixMaths.invert3,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    calculateArbitraryRotationQuaternion = quaternionUtilities.calculateArbitraryRotationQuaternion,
    add2 = vectorMaths.add2,
    multiply2 = vectorMaths.multiply2,
    transform2 = vectorMaths.transform2,
    transform3 = vectorMaths.transform3;


function cloneTextureCoordinateTuples(textureCoordinateTuples) {
      textureCoordinateTuples = textureCoordinateTuples.map(function (textureCoordinateTuple) {
            return textureCoordinateTuple.slice();
      }); ///

      return textureCoordinateTuples;
}

function calculateMappedTextureCoordinateTuples(textureCoordinateTuples, extent) {
      var left = extent.left,
          bottom = extent.bottom,
          width = extent.width,
          height = extent.height,
          mappedTextureCoordinateTuples = textureCoordinateTuples.map(function (textureCoordinateTuple) {
            return add2(multiply2(textureCoordinateTuple, [width, height]), [left, bottom]);
      }); ///

      return mappedTextureCoordinateTuples;
}

function calculateAdjustedTextureCoordinateTuples(vertices, normal, parentVertices, textureCoordinateTuples) {
      var arbitraryRotationQuaternion = calculateArbitraryRotationQuaternion(normal),
          rotationQuaternion = arbitraryRotationQuaternion; ///

      var tempVertices = rotateVertices(vertices, rotationQuaternion);

      parentVertices = rotateVertices(parentVertices, rotationQuaternion);

      vertices = tempVertices; ///

      var firstVertex = first(vertices),
          secondVertex = second(vertices),
          thirdVertex = third(vertices),
          firstParentVertex = first(parentVertices),
          secondParentVertex = second(parentVertices),
          thirdParentVertex = third(parentVertices),
          firstTextureCoordinateTuple = first(textureCoordinateTuples),
          secondTextureCoordinateTuple = second(textureCoordinateTuples),
          thirdTextureCoordinateTuple = third(textureCoordinateTuples),
          firstVertexPosition = firstVertex.getPosition(),
          secondVertexPosition = secondVertex.getPosition(),
          thirdVertexPosition = thirdVertex.getPosition(),
          firstParentVertexPosition = firstParentVertex.getPosition(),
          secondParentVertexPosition = secondParentVertex.getPosition(),
          thirdParentVertexPosition = thirdParentVertex.getPosition(),
          R1x = firstVertexPosition[0],
          ///
      R1y = firstVertexPosition[1],
          ///
      R2x = secondVertexPosition[0],
          ///
      R2y = secondVertexPosition[1],
          ///
      R3x = thirdVertexPosition[0],
          ///
      R3y = thirdVertexPosition[1],
          ///
      P1x = firstParentVertexPosition[0],
          ///
      P2x = secondParentVertexPosition[0],
          ///
      P3x = thirdParentVertexPosition[0],
          ///
      P1y = firstParentVertexPosition[1],
          ///
      P2y = secondParentVertexPosition[1],
          ///
      P3y = thirdParentVertexPosition[1],
          ///
      P1u = firstTextureCoordinateTuple[0],
          ///
      P1v = firstTextureCoordinateTuple[1],
          ///
      P2u = secondTextureCoordinateTuple[0],
          ///
      P2v = secondTextureCoordinateTuple[1],
          ///
      P3u = thirdTextureCoordinateTuple[0],
          ///
      P3v = thirdTextureCoordinateTuple[1],
          ///
      textureCoordinatesMatrix = invert3([1, 1, 1, P1u, P2u, P3u, P1v, P2v, P3v]),
          firstTransformedParentVerticesComponent = transform3([P1x, P2x, P3x], textureCoordinatesMatrix),
          secondTransformedParentVerticesComponent = transform3([P1y, P2y, P3y], textureCoordinatesMatrix),
          Ox = firstTransformedParentVerticesComponent[0],
          ///
      Ux = firstTransformedParentVerticesComponent[1],
          ///
      Vx = firstTransformedParentVerticesComponent[2],
          ///
      Oy = secondTransformedParentVerticesComponent[0],
          ///
      Uy = secondTransformedParentVerticesComponent[1],
          ///
      Vy = secondTransformedParentVerticesComponent[2],
          ///
      transformedParentVerticesMatrix = invert2([Ux, Uy, Vx, Vy]),
          firstAdjustedTextureCoordinate = transform2([R1x - Ox, R1y - Oy], transformedParentVerticesMatrix),
          secondAdjustedTextureCoordinate = transform2([R2x - Ox, R2y - Oy], transformedParentVerticesMatrix),
          thirdAdjustedTextureCoordinate = transform2([R3x - Ox, R3y - Oy], transformedParentVerticesMatrix),
          adjustedTextureCoordinateTuple = [firstAdjustedTextureCoordinate, secondAdjustedTextureCoordinate, thirdAdjustedTextureCoordinate];

      return adjustedTextureCoordinateTuple;
}

module.exports = {
      cloneTextureCoordinateTuples: cloneTextureCoordinateTuples,
      calculateMappedTextureCoordinateTuples: calculateMappedTextureCoordinateTuples,
      calculateAdjustedTextureCoordinateTuples: calculateAdjustedTextureCoordinateTuples
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvdGV4dHVyZS5qcyJdLCJuYW1lcyI6WyJtYXRyaXhNYXRocyIsInJlcXVpcmUiLCJ2ZWN0b3JNYXRocyIsImFycmF5VXRpbGl0aWVzIiwidmVydGljZXNVdGlsaXRpZXMiLCJxdWF0ZXJuaW9uVXRpbGl0aWVzIiwicm90YXRlVmVydGljZXMiLCJpbnZlcnQyIiwiaW52ZXJ0MyIsImZpcnN0Iiwic2Vjb25kIiwidGhpcmQiLCJjYWxjdWxhdGVBcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24iLCJhZGQyIiwibXVsdGlwbHkyIiwidHJhbnNmb3JtMiIsInRyYW5zZm9ybTMiLCJjbG9uZVRleHR1cmVDb29yZGluYXRlVHVwbGVzIiwidGV4dHVyZUNvb3JkaW5hdGVUdXBsZXMiLCJtYXAiLCJ0ZXh0dXJlQ29vcmRpbmF0ZVR1cGxlIiwic2xpY2UiLCJjYWxjdWxhdGVNYXBwZWRUZXh0dXJlQ29vcmRpbmF0ZVR1cGxlcyIsImV4dGVudCIsImxlZnQiLCJib3R0b20iLCJ3aWR0aCIsImhlaWdodCIsIm1hcHBlZFRleHR1cmVDb29yZGluYXRlVHVwbGVzIiwiY2FsY3VsYXRlQWRqdXN0ZWRUZXh0dXJlQ29vcmRpbmF0ZVR1cGxlcyIsInZlcnRpY2VzIiwibm9ybWFsIiwicGFyZW50VmVydGljZXMiLCJhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24iLCJyb3RhdGlvblF1YXRlcm5pb24iLCJ0ZW1wVmVydGljZXMiLCJmaXJzdFZlcnRleCIsInNlY29uZFZlcnRleCIsInRoaXJkVmVydGV4IiwiZmlyc3RQYXJlbnRWZXJ0ZXgiLCJzZWNvbmRQYXJlbnRWZXJ0ZXgiLCJ0aGlyZFBhcmVudFZlcnRleCIsImZpcnN0VGV4dHVyZUNvb3JkaW5hdGVUdXBsZSIsInNlY29uZFRleHR1cmVDb29yZGluYXRlVHVwbGUiLCJ0aGlyZFRleHR1cmVDb29yZGluYXRlVHVwbGUiLCJmaXJzdFZlcnRleFBvc2l0aW9uIiwiZ2V0UG9zaXRpb24iLCJzZWNvbmRWZXJ0ZXhQb3NpdGlvbiIsInRoaXJkVmVydGV4UG9zaXRpb24iLCJmaXJzdFBhcmVudFZlcnRleFBvc2l0aW9uIiwic2Vjb25kUGFyZW50VmVydGV4UG9zaXRpb24iLCJ0aGlyZFBhcmVudFZlcnRleFBvc2l0aW9uIiwiUjF4IiwiUjF5IiwiUjJ4IiwiUjJ5IiwiUjN4IiwiUjN5IiwiUDF4IiwiUDJ4IiwiUDN4IiwiUDF5IiwiUDJ5IiwiUDN5IiwiUDF1IiwiUDF2IiwiUDJ1IiwiUDJ2IiwiUDN1IiwiUDN2IiwidGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4IiwiZmlyc3RUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50Iiwic2Vjb25kVHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc0NvbXBvbmVudCIsIk94IiwiVXgiLCJWeCIsIk95IiwiVXkiLCJWeSIsInRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNNYXRyaXgiLCJmaXJzdEFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGUiLCJzZWNvbmRBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlIiwidGhpcmRBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlIiwiYWRqdXN0ZWRUZXh0dXJlQ29vcmRpbmF0ZVR1cGxlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxpQkFBUixDQUFwQjtBQUFBLElBQ01DLGNBQWNELFFBQVEsaUJBQVIsQ0FEcEI7QUFBQSxJQUVNRSxpQkFBaUJGLFFBQVEsb0JBQVIsQ0FGdkI7QUFBQSxJQUdNRyxvQkFBb0JILFFBQVEsdUJBQVIsQ0FIMUI7QUFBQSxJQUlNSSxzQkFBc0JKLFFBQVEseUJBQVIsQ0FKNUI7O0FBTU0sSUFBRUssY0FBRixHQUFxQkYsaUJBQXJCLENBQUVFLGNBQUY7QUFBQSxJQUNFQyxPQURGLEdBQ3VCUCxXQUR2QixDQUNFTyxPQURGO0FBQUEsSUFDV0MsT0FEWCxHQUN1QlIsV0FEdkIsQ0FDV1EsT0FEWDtBQUFBLElBRUVDLEtBRkYsR0FF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T0MsOEJBQVA7QUFDRDs7QUFFREMsT0FBT0MsT0FBUCxHQUFpQjtBQUNmcEUsZ0VBRGU7QUFFZkssb0ZBRmU7QUFHZk87QUFIZSxDQUFqQiIsImZpbGUiOiJ0ZXh0dXJlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBtYXRyaXhNYXRocyA9IHJlcXVpcmUoJy4uL21hdGhzL21hdHJpeCcpLFxuICAgICAgdmVjdG9yTWF0aHMgPSByZXF1aXJlKCcuLi9tYXRocy92ZWN0b3InKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICB2ZXJ0aWNlc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy92ZXJ0aWNlcycpLFxuICAgICAgcXVhdGVybmlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9xdWF0ZXJuaW9uJyk7XG5cbmNvbnN0IHsgcm90YXRlVmVydGljZXMgfSA9IHZlcnRpY2VzVXRpbGl0aWVzLFxuICAgICAgeyBpbnZlcnQyLCBpbnZlcnQzIH0gPSBtYXRyaXhNYXRocyxcbiAgICAgIHsgZmlyc3QsIHNlY29uZCwgdGhpcmQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVBcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24gfSA9IHF1YXRlcm5pb25VdGlsaXRpZXMsXG4gICAgICB7IGFkZDIsIG11bHRpcGx5MiwgdHJhbnNmb3JtMiwgdHJhbnNmb3JtMyB9ID0gdmVjdG9yTWF0aHM7XG5cbmZ1bmN0aW9uIGNsb25lVGV4dHVyZUNvb3JkaW5hdGVUdXBsZXModGV4dHVyZUNvb3JkaW5hdGVUdXBsZXMpIHtcbiAgdGV4dHVyZUNvb3JkaW5hdGVUdXBsZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZVR1cGxlcy5tYXAoKHRleHR1cmVDb29yZGluYXRlVHVwbGUpID0+IHRleHR1cmVDb29yZGluYXRlVHVwbGUuc2xpY2UoKSk7ICAvLy9cblxuICByZXR1cm4gdGV4dHVyZUNvb3JkaW5hdGVUdXBsZXM7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU1hcHBlZFRleHR1cmVDb29yZGluYXRlVHVwbGVzKHRleHR1cmVDb29yZGluYXRlVHVwbGVzLCBleHRlbnQpIHtcbiAgY29uc3QgeyBsZWZ0LCBib3R0b20sIHdpZHRoLCBoZWlnaHQgfSA9IGV4dGVudCxcbiAgICAgICAgbWFwcGVkVGV4dHVyZUNvb3JkaW5hdGVUdXBsZXMgPSB0ZXh0dXJlQ29vcmRpbmF0ZVR1cGxlcy5tYXAoKHRleHR1cmVDb29yZGluYXRlVHVwbGUpID0+IGFkZDIobXVsdGlwbHkyKHRleHR1cmVDb29yZGluYXRlVHVwbGUsIFsgd2lkdGgsIGhlaWdodCBdICksIFsgbGVmdCwgYm90dG9tIF0pKTsgLy8vXG5cbiAgcmV0dXJuIG1hcHBlZFRleHR1cmVDb29yZGluYXRlVHVwbGVzO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlVHVwbGVzKHZlcnRpY2VzLCBub3JtYWwsIHBhcmVudFZlcnRpY2VzLCB0ZXh0dXJlQ29vcmRpbmF0ZVR1cGxlcykge1xuICBjb25zdCBhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVBcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24obm9ybWFsKSxcbiAgICAgICAgcm90YXRpb25RdWF0ZXJuaW9uID0gYXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uOyAvLy9cblxuICBjb25zdCB0ZW1wVmVydGljZXMgPSByb3RhdGVWZXJ0aWNlcyh2ZXJ0aWNlcywgcm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICBwYXJlbnRWZXJ0aWNlcyA9IHJvdGF0ZVZlcnRpY2VzKHBhcmVudFZlcnRpY2VzLCByb3RhdGlvblF1YXRlcm5pb24pO1xuXG4gIHZlcnRpY2VzID0gdGVtcFZlcnRpY2VzOyAgLy8vXG5cbiAgY29uc3QgZmlyc3RWZXJ0ZXggPSBmaXJzdCh2ZXJ0aWNlcyksXG4gICAgICAgIHNlY29uZFZlcnRleCA9IHNlY29uZCh2ZXJ0aWNlcyksXG4gICAgICAgIHRoaXJkVmVydGV4ID0gdGhpcmQodmVydGljZXMpLFxuICAgICAgICBmaXJzdFBhcmVudFZlcnRleCA9IGZpcnN0KHBhcmVudFZlcnRpY2VzKSxcbiAgICAgICAgc2Vjb25kUGFyZW50VmVydGV4ID0gc2Vjb25kKHBhcmVudFZlcnRpY2VzKSxcbiAgICAgICAgdGhpcmRQYXJlbnRWZXJ0ZXggPSB0aGlyZChwYXJlbnRWZXJ0aWNlcyksXG4gICAgICAgIGZpcnN0VGV4dHVyZUNvb3JkaW5hdGVUdXBsZSA9IGZpcnN0KHRleHR1cmVDb29yZGluYXRlVHVwbGVzKSxcbiAgICAgICAgc2Vjb25kVGV4dHVyZUNvb3JkaW5hdGVUdXBsZSA9IHNlY29uZCh0ZXh0dXJlQ29vcmRpbmF0ZVR1cGxlcyksXG4gICAgICAgIHRoaXJkVGV4dHVyZUNvb3JkaW5hdGVUdXBsZSA9IHRoaXJkKHRleHR1cmVDb29yZGluYXRlVHVwbGVzKSxcbiAgICAgICAgZmlyc3RWZXJ0ZXhQb3NpdGlvbiA9IGZpcnN0VmVydGV4LmdldFBvc2l0aW9uKCksXG4gICAgICAgIHNlY29uZFZlcnRleFBvc2l0aW9uID0gc2Vjb25kVmVydGV4LmdldFBvc2l0aW9uKCksXG4gICAgICAgIHRoaXJkVmVydGV4UG9zaXRpb24gPSB0aGlyZFZlcnRleC5nZXRQb3NpdGlvbigpLFxuICAgICAgICBmaXJzdFBhcmVudFZlcnRleFBvc2l0aW9uID0gZmlyc3RQYXJlbnRWZXJ0ZXguZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgc2Vjb25kUGFyZW50VmVydGV4UG9zaXRpb24gPSBzZWNvbmRQYXJlbnRWZXJ0ZXguZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgdGhpcmRQYXJlbnRWZXJ0ZXhQb3NpdGlvbiA9IHRoaXJkUGFyZW50VmVydGV4LmdldFBvc2l0aW9uKCksXG4gICAgICAgIFIxeCA9IGZpcnN0VmVydGV4UG9zaXRpb25bMF0sICAvLy9cbiAgICAgICAgUjF5ID0gZmlyc3RWZXJ0ZXhQb3NpdGlvblsxXSwgIC8vL1xuICAgICAgICBSMnggPSBzZWNvbmRWZXJ0ZXhQb3NpdGlvblswXSwgLy8vXG4gICAgICAgIFIyeSA9IHNlY29uZFZlcnRleFBvc2l0aW9uWzFdLCAvLy9cbiAgICAgICAgUjN4ID0gdGhpcmRWZXJ0ZXhQb3NpdGlvblswXSwgIC8vL1xuICAgICAgICBSM3kgPSB0aGlyZFZlcnRleFBvc2l0aW9uWzFdLCAgLy8vXG4gICAgICAgIFAxeCA9IGZpcnN0UGFyZW50VmVydGV4UG9zaXRpb25bMF0sIC8vL1xuICAgICAgICBQMnggPSBzZWNvbmRQYXJlbnRWZXJ0ZXhQb3NpdGlvblswXSwgLy8vXG4gICAgICAgIFAzeCA9IHRoaXJkUGFyZW50VmVydGV4UG9zaXRpb25bMF0sIC8vL1xuICAgICAgICBQMXkgPSBmaXJzdFBhcmVudFZlcnRleFBvc2l0aW9uWzFdLCAvLy9cbiAgICAgICAgUDJ5ID0gc2Vjb25kUGFyZW50VmVydGV4UG9zaXRpb25bMV0sIC8vL1xuICAgICAgICBQM3kgPSB0aGlyZFBhcmVudFZlcnRleFBvc2l0aW9uWzFdLCAvLy9cbiAgICAgICAgUDF1ID0gZmlyc3RUZXh0dXJlQ29vcmRpbmF0ZVR1cGxlWzBdLCAvLy9cbiAgICAgICAgUDF2ID0gZmlyc3RUZXh0dXJlQ29vcmRpbmF0ZVR1cGxlWzFdLCAvLy9cbiAgICAgICAgUDJ1ID0gc2Vjb25kVGV4dHVyZUNvb3JkaW5hdGVUdXBsZVswXSwgLy8vXG4gICAgICAgIFAydiA9IHNlY29uZFRleHR1cmVDb29yZGluYXRlVHVwbGVbMV0sIC8vL1xuICAgICAgICBQM3UgPSB0aGlyZFRleHR1cmVDb29yZGluYXRlVHVwbGVbMF0sIC8vL1xuICAgICAgICBQM3YgPSB0aGlyZFRleHR1cmVDb29yZGluYXRlVHVwbGVbMV0sIC8vL1xuICAgICAgICB0ZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXggPSBpbnZlcnQzKFsgMSwgMSwgMSwgUDF1LCBQMnUsIFAzdSwgUDF2LCBQMnYsIFAzdiBdKSxcbiAgICAgICAgZmlyc3RUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50ID0gdHJhbnNmb3JtMyhbIFAxeCwgUDJ4LCBQM3ggXSwgdGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4KSxcbiAgICAgICAgc2Vjb25kVHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc0NvbXBvbmVudCA9IHRyYW5zZm9ybTMoWyBQMXksIFAyeSwgUDN5IF0sIHRleHR1cmVDb29yZGluYXRlc01hdHJpeCksXG4gICAgICAgIE94ID0gZmlyc3RUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50WzBdLCAgLy8vXG4gICAgICAgIFV4ID0gZmlyc3RUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50WzFdLCAgLy8vXG4gICAgICAgIFZ4ID0gZmlyc3RUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50WzJdLCAgLy8vXG4gICAgICAgIE95ID0gc2Vjb25kVHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc0NvbXBvbmVudFswXSwgIC8vL1xuICAgICAgICBVeSA9IHNlY29uZFRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNDb21wb25lbnRbMV0sICAvLy9cbiAgICAgICAgVnkgPSBzZWNvbmRUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50WzJdLCAgLy8vXG4gICAgICAgIHRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNNYXRyaXggPSBpbnZlcnQyKFsgVXgsIFV5LCBWeCwgVnkgXSksXG4gICAgICAgIGZpcnN0QWRqdXN0ZWRUZXh0dXJlQ29vcmRpbmF0ZSA9IHRyYW5zZm9ybTIoWyBSMXggLSBPeCwgUjF5IC0gT3kgXSwgdHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc01hdHJpeCksXG4gICAgICAgIHNlY29uZEFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGUgPSB0cmFuc2Zvcm0yKFsgUjJ4IC0gT3gsIFIyeSAtIE95IF0sIHRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNNYXRyaXgpLFxuICAgICAgICB0aGlyZEFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGUgPSB0cmFuc2Zvcm0yKFsgUjN4IC0gT3gsIFIzeSAtIE95IF0sIHRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNNYXRyaXgpLFxuICAgICAgICBhZGp1c3RlZFRleHR1cmVDb29yZGluYXRlVHVwbGUgPSBbXG4gICAgICAgICAgZmlyc3RBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlLFxuICAgICAgICAgIHNlY29uZEFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGUsXG4gICAgICAgICAgdGhpcmRBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlLFxuICAgICAgICBdO1xuXG4gIHJldHVybiBhZGp1c3RlZFRleHR1cmVDb29yZGluYXRlVHVwbGU7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBjbG9uZVRleHR1cmVDb29yZGluYXRlVHVwbGVzLFxuICBjYWxjdWxhdGVNYXBwZWRUZXh0dXJlQ29vcmRpbmF0ZVR1cGxlcyxcbiAgY2FsY3VsYXRlQWRqdXN0ZWRUZXh0dXJlQ29vcmRpbmF0ZVR1cGxlc1xufTtcbiJdfQ==