'use strict';

var matrixMaths = require('../maths/matrix'),
    vectorMaths = require('../maths/vector'),
    arrayUtilities = require('../utilities/array'),
    verticesUtilities = require('../utilities/vertices'),
    quaternionUtilities = require('../utilities/quaternion');

var rotateVertices = verticesUtilities.rotateVertices,
    invert2 = matrixMaths.invert2,
    invert3 = matrixMaths.invert3,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    calculateArbitraryRotationQuaternion = quaternionUtilities.calculateArbitraryRotationQuaternion,
    add2 = vectorMaths.add2,
    multiply2 = vectorMaths.multiply2,
    transform2 = vectorMaths.transform2,
    transform3 = vectorMaths.transform3;


function cloneTextureCoordinatesTuple(textureCoordinatesTuple) {
  textureCoordinatesTuple = textureCoordinatesTuple.map(function (textureCoordinates) {
    return textureCoordinates.slice();
  }); ///

  return textureCoordinatesTuple;
}

function calculateVertexTextureCoordinatesTuple(textureCoordinatesTuple, left, bottom, width, height) {
  var vertexTextureCoordinatesTuple = textureCoordinatesTuple.map(function (textureCoordinates) {
    return add2(multiply2(textureCoordinates, [width, height]), [left, bottom]);
  }); ///

  return vertexTextureCoordinatesTuple;
}

function calculateAdjustedTextureCoordinatesTuple(vertices, normal, parentVertices, textureCoordinatesTuple) {
  var arbitraryRotationQuaternion = calculateArbitraryRotationQuaternion(normal),
      rotationQuaternion = arbitraryRotationQuaternion; ///

  vertices = rotateVertices(vertices, rotationQuaternion);

  parentVertices = rotateVertices(parentVertices, rotationQuaternion);

  var firstVertex = first(vertices),
      secondVertex = second(vertices),
      thirdVertex = third(vertices),
      firstParentVertex = first(parentVertices),
      secondParentVertex = second(parentVertices),
      thirdParentVertex = third(parentVertices),
      firstTextureCoordinates = first(textureCoordinatesTuple),
      secondTextureCoordinates = second(textureCoordinatesTuple),
      thirdTextureCoordinates = third(textureCoordinatesTuple),
      firstVertexPosition = firstVertex.getPosition(),
      secondVertexPosition = secondVertex.getPosition(),
      thirdVertexPosition = thirdVertex.getPosition(),
      firstParentVertexPosition = firstParentVertex.getPosition(),
      secondParentVertexPosition = secondParentVertex.getPosition(),
      thirdParentVertexPosition = thirdParentVertex.getPosition(),
      R1x = firstVertexPosition[0],
      ///
  R1y = firstVertexPosition[1],
      ///
  R2x = secondVertexPosition[0],
      ///
  R2y = secondVertexPosition[1],
      ///
  R3x = thirdVertexPosition[0],
      ///
  R3y = thirdVertexPosition[1],
      ///
  P1x = firstParentVertexPosition[0],
      ///
  P2x = secondParentVertexPosition[0],
      ///
  P3x = thirdParentVertexPosition[0],
      ///
  P1y = firstParentVertexPosition[1],
      ///
  P2y = secondParentVertexPosition[1],
      ///
  P3y = thirdParentVertexPosition[1],
      ///
  P1u = firstTextureCoordinates[0],
      ///
  P1v = firstTextureCoordinates[1],
      ///
  P2u = secondTextureCoordinates[0],
      ///
  P2v = secondTextureCoordinates[1],
      ///
  P3u = thirdTextureCoordinates[0],
      ///
  P3v = thirdTextureCoordinates[1],
      ///
  textureCoordinatesMatrix = invert3([1, 1, 1, P1u, P2u, P3u, P1v, P2v, P3v]),
      firstTransformedParentVerticesComponent = transform3([P1x, P2x, P3x], textureCoordinatesMatrix),
      secondTransformedParentVerticesComponent = transform3([P1y, P2y, P3y], textureCoordinatesMatrix),
      Ox = firstTransformedParentVerticesComponent[0],
      ///
  Ux = firstTransformedParentVerticesComponent[1],
      ///
  Vx = firstTransformedParentVerticesComponent[2],
      ///
  Oy = secondTransformedParentVerticesComponent[0],
      ///
  Uy = secondTransformedParentVerticesComponent[1],
      ///
  Vy = secondTransformedParentVerticesComponent[2],
      ///
  transformedParentVerticesMatrix = invert2([Ux, Uy, Vx, Vy]),
      firstAdjustedTextureCoordinatesComponent = transform2([R1x - Ox, R1y - Oy], transformedParentVerticesMatrix),
      secondAdjustedTextureCoordinatesComponent = transform2([R2x - Ox, R2y - Oy], transformedParentVerticesMatrix),
      thirdAdjustedTextureCoordinatesComponent = transform2([R3x - Ox, R3y - Oy], transformedParentVerticesMatrix),
      adjustedTextureCoordinatesTuple = [firstAdjustedTextureCoordinatesComponent, secondAdjustedTextureCoordinatesComponent, thirdAdjustedTextureCoordinatesComponent];

  return adjustedTextureCoordinatesTuple;
}

module.exports = {
  cloneTextureCoordinatesTuple: cloneTextureCoordinatesTuple,
  calculateVertexTextureCoordinatesTuple: calculateVertexTextureCoordinatesTuple,
  calculateAdjustedTextureCoordinatesTuple: calculateAdjustedTextureCoordinatesTuple
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvdGV4dHVyZS5qcyJdLCJuYW1lcyI6WyJtYXRyaXhNYXRocyIsInJlcXVpcmUiLCJ2ZWN0b3JNYXRocyIsImFycmF5VXRpbGl0aWVzIiwidmVydGljZXNVdGlsaXRpZXMiLCJxdWF0ZXJuaW9uVXRpbGl0aWVzIiwicm90YXRlVmVydGljZXMiLCJpbnZlcnQyIiwiaW52ZXJ0MyIsImZpcnN0Iiwic2Vjb25kIiwidGhpcmQiLCJjYWxjdWxhdGVBcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24iLCJhZGQyIiwibXVsdGlwbHkyIiwidHJhbnNmb3JtMiIsInRyYW5zZm9ybTMiLCJjbG9uZVRleHR1cmVDb29yZGluYXRlc1R1cGxlIiwidGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUiLCJtYXAiLCJ0ZXh0dXJlQ29vcmRpbmF0ZXMiLCJzbGljZSIsImNhbGN1bGF0ZVZlcnRleFRleHR1cmVDb29yZGluYXRlc1R1cGxlIiwibGVmdCIsImJvdHRvbSIsIndpZHRoIiwiaGVpZ2h0IiwidmVydGV4VGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUiLCJjYWxjdWxhdGVBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc1R1cGxlIiwidmVydGljZXMiLCJub3JtYWwiLCJwYXJlbnRWZXJ0aWNlcyIsImFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbiIsInJvdGF0aW9uUXVhdGVybmlvbiIsImZpcnN0VmVydGV4Iiwic2Vjb25kVmVydGV4IiwidGhpcmRWZXJ0ZXgiLCJmaXJzdFBhcmVudFZlcnRleCIsInNlY29uZFBhcmVudFZlcnRleCIsInRoaXJkUGFyZW50VmVydGV4IiwiZmlyc3RUZXh0dXJlQ29vcmRpbmF0ZXMiLCJzZWNvbmRUZXh0dXJlQ29vcmRpbmF0ZXMiLCJ0aGlyZFRleHR1cmVDb29yZGluYXRlcyIsImZpcnN0VmVydGV4UG9zaXRpb24iLCJnZXRQb3NpdGlvbiIsInNlY29uZFZlcnRleFBvc2l0aW9uIiwidGhpcmRWZXJ0ZXhQb3NpdGlvbiIsImZpcnN0UGFyZW50VmVydGV4UG9zaXRpb24iLCJzZWNvbmRQYXJlbnRWZXJ0ZXhQb3NpdGlvbiIsInRoaXJkUGFyZW50VmVydGV4UG9zaXRpb24iLCJSMXgiLCJSMXkiLCJSMngiLCJSMnkiLCJSM3giLCJSM3kiLCJQMXgiLCJQMngiLCJQM3giLCJQMXkiLCJQMnkiLCJQM3kiLCJQMXUiLCJQMXYiLCJQMnUiLCJQMnYiLCJQM3UiLCJQM3YiLCJ0ZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgiLCJmaXJzdFRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNDb21wb25lbnQiLCJzZWNvbmRUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50IiwiT3giLCJVeCIsIlZ4IiwiT3kiLCJVeSIsIlZ5IiwidHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc01hdHJpeCIsImZpcnN0QWRqdXN0ZWRUZXh0dXJlQ29vcmRpbmF0ZXNDb21wb25lbnQiLCJzZWNvbmRBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc0NvbXBvbmVudCIsInRoaXJkQWRqdXN0ZWRUZXh0dXJlQ29vcmRpbmF0ZXNDb21wb25lbnQiLCJhZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc1R1cGxlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsY0FBY0MsUUFBUSxpQkFBUixDQUFwQjtBQUFBLElBQ01DLGNBQWNELFFBQVEsaUJBQVIsQ0FEcEI7QUFBQSxJQUVNRSxpQkFBaUJGLFFBQVEsb0JBQVIsQ0FGdkI7QUFBQSxJQUdNRyxvQkFBb0JILFFBQVEsdUJBQVIsQ0FIMUI7QUFBQSxJQUlNSSxzQkFBc0JKLFFBQVEseUJBQVIsQ0FKNUI7O0FBTU0sSUFBRUssY0FBRixHQUFxQkYsaUJBQXJCLENBQUVFLGNBQUY7QUFBQSxJQUNFQyxPQURGLEdBQ3VCUCxXQUR2QixDQUNFTyxPQURGO0FBQUEsSUFDV0MsT0FEWCxHQUN1QlIsV0FEdkIsQ0FDV1EsT0FEWDtBQUFBLElBRUVDLEtBRkYsR0FFMkJOLGNBRjNC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Tyx3QkFBOUIsQ0FuQ2pEO0FBQUEsTUFvQ01HLEtBQUtGLHdDQUF3QyxDQUF4QyxDQXBDWDtBQUFBLE1Bb0N3RDtBQUNsREcsT0FBS0gsd0NBQXdDLENBQXhDLENBckNYO0FBQUEsTUFxQ3dEO0FBQ2xESSxPQUFLSix3Q0FBd0MsQ0FBeEMsQ0F0Q1g7QUFBQSxNQXNDd0Q7QUFDbERLLE9BQUtKLHlDQUF5QyxDQUF6QyxDQXZDWDtBQUFBLE1BdUN5RDtBQUNuREssT0FBS0wseUNBQXlDLENBQXpDLENBeENYO0FBQUEsTUF3Q3lEO0FBQ25ETSxPQUFLTix5Q0FBeUMsQ0FBekMsQ0F6Q1g7QUFBQSxNQXlDeUQ7QUFDbkRPLG9DQUFrQ3RFLFFBQVEsQ0FBRWlFLEVBQUYsRUFBTUcsRUFBTixFQUFVRixFQUFWLEVBQWNHLEVBQWQsQ0FBUixDQTFDeEM7QUFBQSxNQTJDTUUsMkNBQTJDL0QsV0FBVyxDQUFFbUMsTUFBTXFCLEVBQVIsRUFBWXBCLE1BQU11QixFQUFsQixDQUFYLEVBQW1DRywrQkFBbkMsQ0EzQ2pEO0FBQUEsTUE0Q01FLDRDQUE0Q2hFLFdBQVcsQ0FBRXFDLE1BQU1tQixFQUFSLEVBQVlsQixNQUFNcUIsRUFBbEIsQ0FBWCxFQUFtQ0csK0JBQW5DLENBNUNsRDtBQUFBLE1BNkNNRywyQ0FBMkNqRSxXQUFXLENBQUV1QyxNQUFNaUIsRUFBUixFQUFZaEIsTUFBTW1CLEVBQWxCLENBQVgsRUFBbUNHLCtCQUFuQyxDQTdDakQ7QUFBQSxNQThDTUksa0NBQWtDLENBQ2hDSCx3Q0FEZ0MsRUFFaENDLHlDQUZnQyxFQUdoQ0Msd0NBSGdDLENBOUN4Qzs7QUFvREEsU0FBT0MsK0JBQVA7QUFDRDs7QUFFREMsT0FBT0MsT0FBUCxHQUFpQjtBQUNmbEUsNERBRGU7QUFFZkssZ0ZBRmU7QUFHZk07QUFIZSxDQUFqQiIsImZpbGUiOiJ0ZXh0dXJlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBtYXRyaXhNYXRocyA9IHJlcXVpcmUoJy4uL21hdGhzL21hdHJpeCcpLFxuICAgICAgdmVjdG9yTWF0aHMgPSByZXF1aXJlKCcuLi9tYXRocy92ZWN0b3InKSxcbiAgICAgIGFycmF5VXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICB2ZXJ0aWNlc1V0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy92ZXJ0aWNlcycpLFxuICAgICAgcXVhdGVybmlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9xdWF0ZXJuaW9uJyk7XG5cbmNvbnN0IHsgcm90YXRlVmVydGljZXMgfSA9IHZlcnRpY2VzVXRpbGl0aWVzLFxuICAgICAgeyBpbnZlcnQyLCBpbnZlcnQzIH0gPSBtYXRyaXhNYXRocyxcbiAgICAgIHsgZmlyc3QsIHNlY29uZCwgdGhpcmQgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVBcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24gfSA9IHF1YXRlcm5pb25VdGlsaXRpZXMsXG4gICAgICB7IGFkZDIsIG11bHRpcGx5MiwgdHJhbnNmb3JtMiwgdHJhbnNmb3JtMyB9ID0gdmVjdG9yTWF0aHM7XG5cbmZ1bmN0aW9uIGNsb25lVGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUodGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUpIHtcbiAgdGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUgPSB0ZXh0dXJlQ29vcmRpbmF0ZXNUdXBsZS5tYXAoKHRleHR1cmVDb29yZGluYXRlcykgPT4gdGV4dHVyZUNvb3JkaW5hdGVzLnNsaWNlKCkpOyAgLy8vXG5cbiAgcmV0dXJuIHRleHR1cmVDb29yZGluYXRlc1R1cGxlO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVWZXJ0ZXhUZXh0dXJlQ29vcmRpbmF0ZXNUdXBsZSh0ZXh0dXJlQ29vcmRpbmF0ZXNUdXBsZSwgbGVmdCwgYm90dG9tLCB3aWR0aCwgaGVpZ2h0KSB7XG4gIGNvbnN0IHZlcnRleFRleHR1cmVDb29yZGluYXRlc1R1cGxlID0gdGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUubWFwKCh0ZXh0dXJlQ29vcmRpbmF0ZXMpID0+IGFkZDIobXVsdGlwbHkyKHRleHR1cmVDb29yZGluYXRlcywgWyB3aWR0aCwgaGVpZ2h0IF0gKSwgWyBsZWZ0LCBib3R0b20gXSkpOyAvLy9cblxuICByZXR1cm4gdmVydGV4VGV4dHVyZUNvb3JkaW5hdGVzVHVwbGU7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUodmVydGljZXMsIG5vcm1hbCwgcGFyZW50VmVydGljZXMsIHRleHR1cmVDb29yZGluYXRlc1R1cGxlKSB7XG4gIGNvbnN0IGFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZUFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbihub3JtYWwpLFxuICAgICAgICByb3RhdGlvblF1YXRlcm5pb24gPSBhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb247IC8vL1xuXG4gIHZlcnRpY2VzID0gcm90YXRlVmVydGljZXModmVydGljZXMsIHJvdGF0aW9uUXVhdGVybmlvbik7XG5cbiAgcGFyZW50VmVydGljZXMgPSByb3RhdGVWZXJ0aWNlcyhwYXJlbnRWZXJ0aWNlcywgcm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICBjb25zdCBmaXJzdFZlcnRleCA9IGZpcnN0KHZlcnRpY2VzKSxcbiAgICAgICAgc2Vjb25kVmVydGV4ID0gc2Vjb25kKHZlcnRpY2VzKSxcbiAgICAgICAgdGhpcmRWZXJ0ZXggPSB0aGlyZCh2ZXJ0aWNlcyksXG4gICAgICAgIGZpcnN0UGFyZW50VmVydGV4ID0gZmlyc3QocGFyZW50VmVydGljZXMpLFxuICAgICAgICBzZWNvbmRQYXJlbnRWZXJ0ZXggPSBzZWNvbmQocGFyZW50VmVydGljZXMpLFxuICAgICAgICB0aGlyZFBhcmVudFZlcnRleCA9IHRoaXJkKHBhcmVudFZlcnRpY2VzKSxcbiAgICAgICAgZmlyc3RUZXh0dXJlQ29vcmRpbmF0ZXMgPSBmaXJzdCh0ZXh0dXJlQ29vcmRpbmF0ZXNUdXBsZSksXG4gICAgICAgIHNlY29uZFRleHR1cmVDb29yZGluYXRlcyA9IHNlY29uZCh0ZXh0dXJlQ29vcmRpbmF0ZXNUdXBsZSksXG4gICAgICAgIHRoaXJkVGV4dHVyZUNvb3JkaW5hdGVzID0gdGhpcmQodGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUpLFxuICAgICAgICBmaXJzdFZlcnRleFBvc2l0aW9uID0gZmlyc3RWZXJ0ZXguZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgc2Vjb25kVmVydGV4UG9zaXRpb24gPSBzZWNvbmRWZXJ0ZXguZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgdGhpcmRWZXJ0ZXhQb3NpdGlvbiA9IHRoaXJkVmVydGV4LmdldFBvc2l0aW9uKCksXG4gICAgICAgIGZpcnN0UGFyZW50VmVydGV4UG9zaXRpb24gPSBmaXJzdFBhcmVudFZlcnRleC5nZXRQb3NpdGlvbigpLFxuICAgICAgICBzZWNvbmRQYXJlbnRWZXJ0ZXhQb3NpdGlvbiA9IHNlY29uZFBhcmVudFZlcnRleC5nZXRQb3NpdGlvbigpLFxuICAgICAgICB0aGlyZFBhcmVudFZlcnRleFBvc2l0aW9uID0gdGhpcmRQYXJlbnRWZXJ0ZXguZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgUjF4ID0gZmlyc3RWZXJ0ZXhQb3NpdGlvblswXSwgIC8vL1xuICAgICAgICBSMXkgPSBmaXJzdFZlcnRleFBvc2l0aW9uWzFdLCAgLy8vXG4gICAgICAgIFIyeCA9IHNlY29uZFZlcnRleFBvc2l0aW9uWzBdLCAvLy9cbiAgICAgICAgUjJ5ID0gc2Vjb25kVmVydGV4UG9zaXRpb25bMV0sIC8vL1xuICAgICAgICBSM3ggPSB0aGlyZFZlcnRleFBvc2l0aW9uWzBdLCAgLy8vXG4gICAgICAgIFIzeSA9IHRoaXJkVmVydGV4UG9zaXRpb25bMV0sICAvLy9cbiAgICAgICAgUDF4ID0gZmlyc3RQYXJlbnRWZXJ0ZXhQb3NpdGlvblswXSwgLy8vXG4gICAgICAgIFAyeCA9IHNlY29uZFBhcmVudFZlcnRleFBvc2l0aW9uWzBdLCAvLy9cbiAgICAgICAgUDN4ID0gdGhpcmRQYXJlbnRWZXJ0ZXhQb3NpdGlvblswXSwgLy8vXG4gICAgICAgIFAxeSA9IGZpcnN0UGFyZW50VmVydGV4UG9zaXRpb25bMV0sIC8vL1xuICAgICAgICBQMnkgPSBzZWNvbmRQYXJlbnRWZXJ0ZXhQb3NpdGlvblsxXSwgLy8vXG4gICAgICAgIFAzeSA9IHRoaXJkUGFyZW50VmVydGV4UG9zaXRpb25bMV0sIC8vL1xuICAgICAgICBQMXUgPSBmaXJzdFRleHR1cmVDb29yZGluYXRlc1swXSwgLy8vXG4gICAgICAgIFAxdiA9IGZpcnN0VGV4dHVyZUNvb3JkaW5hdGVzWzFdLCAvLy9cbiAgICAgICAgUDJ1ID0gc2Vjb25kVGV4dHVyZUNvb3JkaW5hdGVzWzBdLCAvLy9cbiAgICAgICAgUDJ2ID0gc2Vjb25kVGV4dHVyZUNvb3JkaW5hdGVzWzFdLCAvLy9cbiAgICAgICAgUDN1ID0gdGhpcmRUZXh0dXJlQ29vcmRpbmF0ZXNbMF0sIC8vL1xuICAgICAgICBQM3YgPSB0aGlyZFRleHR1cmVDb29yZGluYXRlc1sxXSwgLy8vXG4gICAgICAgIHRleHR1cmVDb29yZGluYXRlc01hdHJpeCA9IGludmVydDMoWyAxLCAxLCAxLCBQMXUsIFAydSwgUDN1LCBQMXYsIFAydiwgUDN2IF0pLFxuICAgICAgICBmaXJzdFRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNDb21wb25lbnQgPSB0cmFuc2Zvcm0zKFsgUDF4LCBQMngsIFAzeCBdLCB0ZXh0dXJlQ29vcmRpbmF0ZXNNYXRyaXgpLFxuICAgICAgICBzZWNvbmRUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50ID0gdHJhbnNmb3JtMyhbIFAxeSwgUDJ5LCBQM3kgXSwgdGV4dHVyZUNvb3JkaW5hdGVzTWF0cml4KSxcbiAgICAgICAgT3ggPSBmaXJzdFRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNDb21wb25lbnRbMF0sICAvLy9cbiAgICAgICAgVXggPSBmaXJzdFRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNDb21wb25lbnRbMV0sICAvLy9cbiAgICAgICAgVnggPSBmaXJzdFRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNDb21wb25lbnRbMl0sICAvLy9cbiAgICAgICAgT3kgPSBzZWNvbmRUcmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzQ29tcG9uZW50WzBdLCAgLy8vXG4gICAgICAgIFV5ID0gc2Vjb25kVHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc0NvbXBvbmVudFsxXSwgIC8vL1xuICAgICAgICBWeSA9IHNlY29uZFRyYW5zZm9ybWVkUGFyZW50VmVydGljZXNDb21wb25lbnRbMl0sICAvLy9cbiAgICAgICAgdHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc01hdHJpeCA9IGludmVydDIoWyBVeCwgVXksIFZ4LCBWeSBdKSxcbiAgICAgICAgZmlyc3RBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc0NvbXBvbmVudCA9IHRyYW5zZm9ybTIoWyBSMXggLSBPeCwgUjF5IC0gT3kgXSwgdHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc01hdHJpeCksXG4gICAgICAgIHNlY29uZEFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGVzQ29tcG9uZW50ID0gdHJhbnNmb3JtMihbIFIyeCAtIE94LCBSMnkgLSBPeSBdLCB0cmFuc2Zvcm1lZFBhcmVudFZlcnRpY2VzTWF0cml4KSxcbiAgICAgICAgdGhpcmRBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc0NvbXBvbmVudCA9IHRyYW5zZm9ybTIoWyBSM3ggLSBPeCwgUjN5IC0gT3kgXSwgdHJhbnNmb3JtZWRQYXJlbnRWZXJ0aWNlc01hdHJpeCksXG4gICAgICAgIGFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUgPSBbXG4gICAgICAgICAgZmlyc3RBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc0NvbXBvbmVudCxcbiAgICAgICAgICBzZWNvbmRBZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc0NvbXBvbmVudCxcbiAgICAgICAgICB0aGlyZEFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGVzQ29tcG9uZW50LFxuICAgICAgICBdO1xuXG4gIHJldHVybiBhZGp1c3RlZFRleHR1cmVDb29yZGluYXRlc1R1cGxlO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgY2xvbmVUZXh0dXJlQ29vcmRpbmF0ZXNUdXBsZSxcbiAgY2FsY3VsYXRlVmVydGV4VGV4dHVyZUNvb3JkaW5hdGVzVHVwbGUsXG4gIGNhbGN1bGF0ZUFkanVzdGVkVGV4dHVyZUNvb3JkaW5hdGVzVHVwbGVcbn07XG4iXX0=