'use strict';

var arrayUtilities = require('../utilities/array'),
    angleUtilities = require('../utilities/angle'),
    vectorUtilities = require('../utilities/vector');

var normalise3 = vectorUtilities.normalise3,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    fourth = arrayUtilities.fourth,
    calculateHalfAngleCosine = angleUtilities.calculateHalfAngleCosine,
    calculateHalfAngleSine = angleUtilities.calculateHalfAngleSine;


function rotateImaginaryQuaternion(imaginaryQuaternion, rotationQuaternion, inverseRotationQuaternion) {
  var rotatedImaginaryQuaternion = hamiltonProduct(hamiltonProduct(rotationQuaternion, imaginaryQuaternion), inverseRotationQuaternion);

  return rotatedImaginaryQuaternion;
}

function calculateRotationQuaternion(normal) {
  var angleCosineBetweenNormalAndZAxis = calculateAngleCosineBetweenNormalAndZAxis(normal),
      crossProductOfNormalWithZAxis = calculateCrossProductOfNormalWithZAxis(normal),
      angleOfRotationCosine = angleCosineBetweenNormalAndZAxis,
      angleOfRotationCosineAbsoluteValue = Math.abs(angleOfRotationCosine),
      axisOfRotation = angleOfRotationCosineAbsoluteValue === 1 ? [1, 0, 0] : ///
  crossProductOfNormalWithZAxis,
      unitAxisOfRotation = normalise3(axisOfRotation),
      halfAngleOfRotationCosine = calculateHalfAngleCosine(angleOfRotationCosine),
      halfAngleOfRotationSine = calculateHalfAngleSine(angleOfRotationCosine),
      unitAxisOfRotationComponents = unitAxisOfRotation,
      ///
  firstAxisOfRotationComponent = first(unitAxisOfRotationComponents),
      secondAxisOfRotationComponent = second(unitAxisOfRotationComponents),
      thirdAxisOfRotationComponent = third(unitAxisOfRotationComponents),
      rotationQuaternion = [halfAngleOfRotationCosine, firstAxisOfRotationComponent * halfAngleOfRotationSine, secondAxisOfRotationComponent * halfAngleOfRotationSine, thirdAxisOfRotationComponent * halfAngleOfRotationSine];

  return rotationQuaternion;
}

function calculateInverseRotationQuaternion(rotationQuaternion) {
  var rotationQuaternionComponents = rotationQuaternion,
      ///
  firstRotationQuaternionComponent = first(rotationQuaternionComponents),
      secondRotationQuaternionComponent = second(rotationQuaternionComponents),
      thirdRotationQuaternionComponent = third(rotationQuaternionComponents),
      fourthRotationQuaternionComponent = fourth(rotationQuaternionComponents),
      inverseRotationQuaternion = [firstRotationQuaternionComponent, -secondRotationQuaternionComponent, -thirdRotationQuaternionComponent, -fourthRotationQuaternionComponent];

  return inverseRotationQuaternion;
}

function calculateForwardsRotationQuaternion(rotationQuaternion) {
  var forwardsRotationQuaternion = rotationQuaternion; ///

  return forwardsRotationQuaternion;
}

function calculateBackwardsRotationQuaternion(rotationQuaternion) {
  var rotationQuaternionComponents = rotationQuaternion,
      ///
  backwardsRotationQuaternionComponents = rotationQuaternionComponents.map(function (rotationQuaternionComponent, index) {
    var backwardsRotationQuaternionComponent = index < 1 ? ///
    +rotationQuaternionComponent : -rotationQuaternionComponent;

    return backwardsRotationQuaternionComponent;
  }),
      backwardsRotationQuaternion = backwardsRotationQuaternionComponents;

  return backwardsRotationQuaternion;
}

function calculateForwardsRotationAboutZAxisMatrix(rotationAboutZAxisMatrix) {
  var forwardsRotationAboutZAxisMatrix = rotationAboutZAxisMatrix; ///

  return forwardsRotationAboutZAxisMatrix;
}

function calculateBackwardsRotationAboutZAxisMatrix(rotationAboutZAxisMatrix) {
  var rotationAboutZAxisMatrixComponents = rotationAboutZAxisMatrix,
      ///
  firstRotationAboutZAxisMatrixComponent = first(rotationAboutZAxisMatrixComponents),
      fourthRotationAboutZAxisMatrixComponent = fourth(rotationAboutZAxisMatrixComponents),
      c = firstRotationAboutZAxisMatrixComponent,
      ///
  s = fourthRotationAboutZAxisMatrixComponent,
      ///
  backwardsRotationAboutZAxisMatrix = [c, +s, 0, -s, c, 0, 0, 0, 1];

  return backwardsRotationAboutZAxisMatrix;
}

module.exports = {
  rotateImaginaryQuaternion: rotateImaginaryQuaternion,
  calculateRotationQuaternion: calculateRotationQuaternion,
  calculateInverseRotationQuaternion: calculateInverseRotationQuaternion,
  calculateForwardsRotationQuaternion: calculateForwardsRotationQuaternion,
  calculateBackwardsRotationQuaternion: calculateBackwardsRotationQuaternion,
  calculateForwardsRotationAboutZAxisMatrix: calculateForwardsRotationAboutZAxisMatrix,
  calculateBackwardsRotationAboutZAxisMatrix: calculateBackwardsRotationAboutZAxisMatrix
};

function calculateAngleCosineBetweenNormalAndZAxis(normal) {
  var unitNormal = normalise3(normal),
      unitNormalComponents = unitNormal,
      ///
  thirdUnitNormalComponent = third(unitNormalComponents),
      angleCosineBetweenNormalAndZAxis = thirdUnitNormalComponent; ///

  return angleCosineBetweenNormalAndZAxis;
}

function calculateCrossProductOfNormalWithZAxis(normal) {
  var normalComponents = normal,
      ///
  firstNormalComponent = first(normalComponents),
      secondNormalComponent = second(normalComponents),
      crossProductOfNormalWithZAxis = [+secondNormalComponent, -firstNormalComponent, 0];

  return crossProductOfNormalWithZAxis;
}

function hamiltonProduct(quaternionA, quaternionB) {
  var quaternionAComponents = quaternionA,
      ///
  quaternionBComponents = quaternionB,
      ///
  firstQuaternionAComponent = first(quaternionAComponents),
      secondQuaternionAComponent = second(quaternionAComponents),
      thirdQuaternionAComponent = third(quaternionAComponents),
      fourthQuaternionAComponent = fourth(quaternionAComponents),
      firstQuaternionBComponent = first(quaternionBComponents),
      secondQuaternionBComponent = second(quaternionBComponents),
      thirdQuaternionBComponent = third(quaternionBComponents),
      fourthQuaternionBComponent = fourth(quaternionBComponents),
      a1 = firstQuaternionAComponent,
      b1 = secondQuaternionAComponent,
      c1 = thirdQuaternionAComponent,
      d1 = fourthQuaternionAComponent,
      a2 = firstQuaternionBComponent,
      b2 = secondQuaternionBComponent,
      c2 = thirdQuaternionBComponent,
      d2 = fourthQuaternionBComponent,
      a = a1 * a2 - b1 * b2 - c1 * c2 - d1 * d2,
      b = a1 * b2 + b1 * a2 + c1 * d2 - d1 * c2,
      c = a1 * c2 - b1 * d2 + c1 * a2 + d1 * b2,
      d = a1 * d2 + b1 * c2 - c1 * b2 + d1 * a2,
      quaternion = [a, b, c, d];

  return quaternion;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcm90YXRpb24uanMiXSwibmFtZXMiOlsiYXJyYXlVdGlsaXRpZXMiLCJyZXF1aXJlIiwiYW5nbGVVdGlsaXRpZXMiLCJ2ZWN0b3JVdGlsaXRpZXMiLCJub3JtYWxpc2UzIiwiZmlyc3QiLCJzZWNvbmQiLCJ0aGlyZCIsImZvdXJ0aCIsImNhbGN1bGF0ZUhhbGZBbmdsZUNvc2luZSIsImNhbGN1bGF0ZUhhbGZBbmdsZVNpbmUiLCJyb3RhdGVJbWFnaW5hcnlRdWF0ZXJuaW9uIiwiaW1hZ2luYXJ5UXVhdGVybmlvbiIsInJvdGF0aW9uUXVhdGVybmlvbiIsImludmVyc2VSb3RhdGlvblF1YXRlcm5pb24iLCJyb3RhdGVkSW1hZ2luYXJ5UXVhdGVybmlvbiIsImhhbWlsdG9uUHJvZHVjdCIsImNhbGN1bGF0ZVJvdGF0aW9uUXVhdGVybmlvbiIsIm5vcm1hbCIsImFuZ2xlQ29zaW5lQmV0d2Vlbk5vcm1hbEFuZFpBeGlzIiwiY2FsY3VsYXRlQW5nbGVDb3NpbmVCZXR3ZWVuTm9ybWFsQW5kWkF4aXMiLCJjcm9zc1Byb2R1Y3RPZk5vcm1hbFdpdGhaQXhpcyIsImNhbGN1bGF0ZUNyb3NzUHJvZHVjdE9mTm9ybWFsV2l0aFpBeGlzIiwiYW5nbGVPZlJvdGF0aW9uQ29zaW5lIiwiYW5nbGVPZlJvdGF0aW9uQ29zaW5lQWJzb2x1dGVWYWx1ZSIsIk1hdGgiLCJhYnMiLCJheGlzT2ZSb3RhdGlvbiIsInVuaXRBeGlzT2ZSb3RhdGlvbiIsImhhbGZBbmdsZU9mUm90YXRpb25Db3NpbmUiLCJoYWxmQW5nbGVPZlJvdGF0aW9uU2luZSIsInVuaXRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudHMiLCJmaXJzdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50Iiwic2Vjb25kQXhpc09mUm90YXRpb25Db21wb25lbnQiLCJ0aGlyZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50IiwiY2FsY3VsYXRlSW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbiIsInJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMiLCJmaXJzdFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCIsInNlY29uZFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCIsInRoaXJkUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50IiwiZm91cnRoUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50IiwiY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiIsImNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiIsImJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMiLCJtYXAiLCJyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJpbmRleCIsImJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCIsImJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiIsImNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4Iiwicm90YXRpb25BYm91dFpBeGlzTWF0cml4IiwiZm9yd2FyZHNSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgiLCJjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgiLCJyb3RhdGlvbkFib3V0WkF4aXNNYXRyaXhDb21wb25lbnRzIiwiZmlyc3RSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXhDb21wb25lbnQiLCJmb3VydGhSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXhDb21wb25lbnQiLCJjIiwicyIsImJhY2t3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCIsIm1vZHVsZSIsImV4cG9ydHMiLCJ1bml0Tm9ybWFsIiwidW5pdE5vcm1hbENvbXBvbmVudHMiLCJ0aGlyZFVuaXROb3JtYWxDb21wb25lbnQiLCJub3JtYWxDb21wb25lbnRzIiwiZmlyc3ROb3JtYWxDb21wb25lbnQiLCJzZWNvbmROb3JtYWxDb21wb25lbnQiLCJxdWF0ZXJuaW9uQSIsInF1YXRlcm5pb25CIiwicXVhdGVybmlvbkFDb21wb25lbnRzIiwicXVhdGVybmlvbkJDb21wb25lbnRzIiwiZmlyc3RRdWF0ZXJuaW9uQUNvbXBvbmVudCIsInNlY29uZFF1YXRlcm5pb25BQ29tcG9uZW50IiwidGhpcmRRdWF0ZXJuaW9uQUNvbXBvbmVudCIsImZvdXJ0aFF1YXRlcm5pb25BQ29tcG9uZW50IiwiZmlyc3RRdWF0ZXJuaW9uQkNvbXBvbmVudCIsInNlY29uZFF1YXRlcm5pb25CQ29tcG9uZW50IiwidGhpcmRRdWF0ZXJuaW9uQkNvbXBvbmVudCIsImZvdXJ0aFF1YXRlcm5pb25CQ29tcG9uZW50IiwiYTEiLCJiMSIsImMxIiwiZDEiLCJhMiIsImIyIiwiYzIiLCJkMiIsImEiLCJiIiwiZCIsInF1YXRlcm5pb24iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLGlCQUFpQkMsUUFBUSxvQkFBUixDQUF2QjtBQUFBLElBQ01DLGlCQUFpQkQsUUFBUSxvQkFBUixDQUR2QjtBQUFBLElBRU1FLGtCQUFrQkYsUUFBUSxxQkFBUixDQUZ4Qjs7QUFJTSxJQUFFRyxVQUFGLEdBQWlCRCxlQUFqQixDQUFFQyxVQUFGO0FBQUEsSUFDRUMsS0FERixHQUNtQ0wsY0FEbkMsQ0FDRUssS0FERjtBQUFBLElBQ1NDLE1BRFQsR0FDbUNOLGNBRG5DLENBQ1NNLE1BRFQ7QUFBQSxJQUNpQkMsS0FEakIsR0FDbUNQLGNBRG5DLENBQ2lCTyxLQURqQjtBQUFBLElBQ3dCQyxNQUR4QixHQUNtQ1IsY0FEbkMsQ0FDd0JRLE1BRHhCO0FBQUEsSUFFRUMsd0JBRkYsR0FFdURQLGNBRnZELENBRUVPLHdCQUZGO0FBQUEsSUFFNEJDLHNCQUY1QixHQUV1RFIsY0FGdkQsQ0FFNEJRLHNCQUY1Qjs7O0FBSU4sU0FBU0MseUJBQVQsQ0FBbUNDLG1CQUFuQyxFQUF3REMsa0JBQXhELEVBQTRFQyx5QkFBNUUsRUFBdUc7QUFDckcsTUFBTUMsNkJBQTZCQyxnQkFBZ0JBLGdCQUFnQkgsa0JBQWhCLEVBQW9DRCxt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QUFRaEMsQ0FBUixFQUFXaUMsQ0FBWCxDQXRCbkI7O0FBd0JBLFNBQU9DLFVBQVA7QUFDRCIsImZpbGUiOiJyb3RhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKSxcbiAgICAgIGFuZ2xlVXRpbGl0aWVzID0gcmVxdWlyZSgnLi4vdXRpbGl0aWVzL2FuZ2xlJyksXG4gICAgICB2ZWN0b3JVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvdmVjdG9yJyk7XG5cbmNvbnN0IHsgbm9ybWFsaXNlMyB9ID0gdmVjdG9yVXRpbGl0aWVzLFxuICAgICAgeyBmaXJzdCwgc2Vjb25kLCB0aGlyZCwgZm91cnRoIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgY2FsY3VsYXRlSGFsZkFuZ2xlQ29zaW5lLCBjYWxjdWxhdGVIYWxmQW5nbGVTaW5lIH0gPSBhbmdsZVV0aWxpdGllcztcblxuZnVuY3Rpb24gcm90YXRlSW1hZ2luYXJ5UXVhdGVybmlvbihpbWFnaW5hcnlRdWF0ZXJuaW9uLCByb3RhdGlvblF1YXRlcm5pb24sIGludmVyc2VSb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgY29uc3Qgcm90YXRlZEltYWdpbmFyeVF1YXRlcm5pb24gPSBoYW1pbHRvblByb2R1Y3QoaGFtaWx0b25Qcm9kdWN0KHJvdGF0aW9uUXVhdGVybmlvbiwgaW1hZ2luYXJ5UXVhdGVybmlvbiksIGludmVyc2VSb3RhdGlvblF1YXRlcm5pb24pO1xuXG4gIHJldHVybiByb3RhdGVkSW1hZ2luYXJ5UXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlUm90YXRpb25RdWF0ZXJuaW9uKG5vcm1hbCkge1xuICBjb25zdCBhbmdsZUNvc2luZUJldHdlZW5Ob3JtYWxBbmRaQXhpcyA9IGNhbGN1bGF0ZUFuZ2xlQ29zaW5lQmV0d2Vlbk5vcm1hbEFuZFpBeGlzKG5vcm1hbCksXG4gICAgICAgIGNyb3NzUHJvZHVjdE9mTm9ybWFsV2l0aFpBeGlzID0gY2FsY3VsYXRlQ3Jvc3NQcm9kdWN0T2ZOb3JtYWxXaXRoWkF4aXMobm9ybWFsKSxcbiAgICAgICAgYW5nbGVPZlJvdGF0aW9uQ29zaW5lID0gYW5nbGVDb3NpbmVCZXR3ZWVuTm9ybWFsQW5kWkF4aXMsXG4gICAgICAgIGFuZ2xlT2ZSb3RhdGlvbkNvc2luZUFic29sdXRlVmFsdWUgPSBNYXRoLmFicyhhbmdsZU9mUm90YXRpb25Db3NpbmUpLFxuICAgICAgICBheGlzT2ZSb3RhdGlvbiA9IChhbmdsZU9mUm90YXRpb25Db3NpbmVBYnNvbHV0ZVZhbHVlID09PSAxKSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBbMSwgMCwgMF0gOiAvLy9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Jvc3NQcm9kdWN0T2ZOb3JtYWxXaXRoWkF4aXMsXG4gICAgICAgIHVuaXRBeGlzT2ZSb3RhdGlvbiA9IG5vcm1hbGlzZTMoYXhpc09mUm90YXRpb24pLFxuICAgICAgICBoYWxmQW5nbGVPZlJvdGF0aW9uQ29zaW5lID0gY2FsY3VsYXRlSGFsZkFuZ2xlQ29zaW5lKGFuZ2xlT2ZSb3RhdGlvbkNvc2luZSksXG4gICAgICAgIGhhbGZBbmdsZU9mUm90YXRpb25TaW5lID0gY2FsY3VsYXRlSGFsZkFuZ2xlU2luZShhbmdsZU9mUm90YXRpb25Db3NpbmUpLFxuICAgICAgICB1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzID0gdW5pdEF4aXNPZlJvdGF0aW9uLCAgLy8vXG4gICAgICAgIGZpcnN0QXhpc09mUm90YXRpb25Db21wb25lbnQgPSBmaXJzdCh1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgc2Vjb25kQXhpc09mUm90YXRpb25Db21wb25lbnQgPSBzZWNvbmQodW5pdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50cyksXG4gICAgICAgIHRoaXJkQXhpc09mUm90YXRpb25Db21wb25lbnQgPSB0aGlyZCh1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgcm90YXRpb25RdWF0ZXJuaW9uID0gW1xuICAgICAgICAgIGhhbGZBbmdsZU9mUm90YXRpb25Db3NpbmUsXG4gICAgICAgICAgZmlyc3RBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCAqIGhhbGZBbmdsZU9mUm90YXRpb25TaW5lLFxuICAgICAgICAgIHNlY29uZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ICogaGFsZkFuZ2xlT2ZSb3RhdGlvblNpbmUsXG4gICAgICAgICAgdGhpcmRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCAqIGhhbGZBbmdsZU9mUm90YXRpb25TaW5lXG4gICAgICAgIF07XG5cbiAgcmV0dXJuIHJvdGF0aW9uUXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbihyb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgY29uc3Qgcm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyA9IHJvdGF0aW9uUXVhdGVybmlvbiwgIC8vL1xuICAgICAgICBmaXJzdFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCA9IGZpcnN0KHJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMpLFxuICAgICAgICBzZWNvbmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQgPSBzZWNvbmQocm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyksXG4gICAgICAgIHRoaXJkUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gdGhpcmQocm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyksXG4gICAgICAgIGZvdXJ0aFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCA9IGZvdXJ0aChyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzKSxcbiAgICAgICAgaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbiA9IFtcbiAgICAgICAgICBmaXJzdFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCxcbiAgICAgICAgICAtc2Vjb25kUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50LFxuICAgICAgICAgIC10aGlyZFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCxcbiAgICAgICAgICAtZm91cnRoUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50XG4gICAgICAgIF07XG5cbiAgcmV0dXJuIGludmVyc2VSb3RhdGlvblF1YXRlcm5pb247XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbikge1xuICBjb25zdCBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IHJvdGF0aW9uUXVhdGVybmlvbjsgIC8vL1xuXG4gIHJldHVybiBmb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbikge1xuICBjb25zdCByb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzID0gcm90YXRpb25RdWF0ZXJuaW9uLCAgLy8vXG4gICAgICAgIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMgPSByb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzLm1hcChmdW5jdGlvbihyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQsIGluZGV4KSB7XG4gICAgICAgICAgY29uc3QgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gKGluZGV4IDwgMSkgPyAgLy8vXG4gICAgICAgICAgICAgICtyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQgOlxuICAgICAgICAgICAgICAtcm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50O1xuICBcbiAgICAgICAgICByZXR1cm4gYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50O1xuICAgICAgICB9KSxcbiAgICAgICAgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cztcblxuICByZXR1cm4gYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xuXG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4KHJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCkge1xuICBjb25zdCBmb3J3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCA9IHJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeDsgLy8vXG5cbiAgcmV0dXJuIGZvcndhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4O1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgocm90YXRpb25BYm91dFpBeGlzTWF0cml4KSB7XG4gIGNvbnN0IHJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeENvbXBvbmVudHMgPSByb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgsIC8vL1xuICAgICAgICBmaXJzdFJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeENvbXBvbmVudCA9IGZpcnN0KHJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeENvbXBvbmVudHMpLFxuICAgICAgICBmb3VydGhSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXhDb21wb25lbnQgPSBmb3VydGgocm90YXRpb25BYm91dFpBeGlzTWF0cml4Q29tcG9uZW50cyksXG4gICAgICAgIGMgPSBmaXJzdFJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeENvbXBvbmVudCwgLy8vXG4gICAgICAgIHMgPSBmb3VydGhSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXhDb21wb25lbnQsICAvLy9cbiAgICAgICAgYmFja3dhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4ID0gWyBjLCArcywgMCwgLXMsIGMsIDAsIDAsIDAsIDEgXTtcblxuICByZXR1cm4gYmFja3dhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4O1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgcm90YXRlSW1hZ2luYXJ5UXVhdGVybmlvbjogcm90YXRlSW1hZ2luYXJ5UXVhdGVybmlvbixcbiAgY2FsY3VsYXRlUm90YXRpb25RdWF0ZXJuaW9uOiBjYWxjdWxhdGVSb3RhdGlvblF1YXRlcm5pb24sXG4gIGNhbGN1bGF0ZUludmVyc2VSb3RhdGlvblF1YXRlcm5pb246IGNhbGN1bGF0ZUludmVyc2VSb3RhdGlvblF1YXRlcm5pb24sXG4gIGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uOiBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbixcbiAgY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uOiBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24sXG4gIGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4OiBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCxcbiAgY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4OiBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXhcbn07XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUFuZ2xlQ29zaW5lQmV0d2Vlbk5vcm1hbEFuZFpBeGlzKG5vcm1hbCkge1xuICBjb25zdCB1bml0Tm9ybWFsID0gbm9ybWFsaXNlMyhub3JtYWwpLFxuICAgICAgICB1bml0Tm9ybWFsQ29tcG9uZW50cyA9IHVuaXROb3JtYWwsICAvLy9cbiAgICAgICAgdGhpcmRVbml0Tm9ybWFsQ29tcG9uZW50ID0gdGhpcmQodW5pdE5vcm1hbENvbXBvbmVudHMpLFxuICAgICAgICBhbmdsZUNvc2luZUJldHdlZW5Ob3JtYWxBbmRaQXhpcyA9IHRoaXJkVW5pdE5vcm1hbENvbXBvbmVudDsgIC8vL1xuXG4gIHJldHVybiBhbmdsZUNvc2luZUJldHdlZW5Ob3JtYWxBbmRaQXhpcztcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlQ3Jvc3NQcm9kdWN0T2ZOb3JtYWxXaXRoWkF4aXMobm9ybWFsKSB7XG4gIGNvbnN0IG5vcm1hbENvbXBvbmVudHMgPSBub3JtYWwsICAvLy9cbiAgICAgICAgZmlyc3ROb3JtYWxDb21wb25lbnQgPSBmaXJzdChub3JtYWxDb21wb25lbnRzKSxcbiAgICAgICAgc2Vjb25kTm9ybWFsQ29tcG9uZW50ID0gc2Vjb25kKG5vcm1hbENvbXBvbmVudHMpLFxuICAgICAgICBjcm9zc1Byb2R1Y3RPZk5vcm1hbFdpdGhaQXhpcyA9IFtcbiAgICAgICAgICArc2Vjb25kTm9ybWFsQ29tcG9uZW50LFxuICAgICAgICAgIC1maXJzdE5vcm1hbENvbXBvbmVudCxcbiAgICAgICAgICAwXG4gICAgICAgIF07XG5cbiAgcmV0dXJuIGNyb3NzUHJvZHVjdE9mTm9ybWFsV2l0aFpBeGlzO1xufVxuXG5mdW5jdGlvbiBoYW1pbHRvblByb2R1Y3QocXVhdGVybmlvbkEsIHF1YXRlcm5pb25CKSB7XG4gIGNvbnN0IHF1YXRlcm5pb25BQ29tcG9uZW50cyA9IHF1YXRlcm5pb25BLCAgLy8vXG4gICAgICAgIHF1YXRlcm5pb25CQ29tcG9uZW50cyA9IHF1YXRlcm5pb25CLCAgLy8vXG4gICAgICAgIGZpcnN0UXVhdGVybmlvbkFDb21wb25lbnQgPSBmaXJzdChxdWF0ZXJuaW9uQUNvbXBvbmVudHMpLFxuICAgICAgICBzZWNvbmRRdWF0ZXJuaW9uQUNvbXBvbmVudCA9IHNlY29uZChxdWF0ZXJuaW9uQUNvbXBvbmVudHMpLFxuICAgICAgICB0aGlyZFF1YXRlcm5pb25BQ29tcG9uZW50ID0gdGhpcmQocXVhdGVybmlvbkFDb21wb25lbnRzKSxcbiAgICAgICAgZm91cnRoUXVhdGVybmlvbkFDb21wb25lbnQgPSBmb3VydGgocXVhdGVybmlvbkFDb21wb25lbnRzKSxcbiAgICAgICAgZmlyc3RRdWF0ZXJuaW9uQkNvbXBvbmVudCA9IGZpcnN0KHF1YXRlcm5pb25CQ29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZFF1YXRlcm5pb25CQ29tcG9uZW50ID0gc2Vjb25kKHF1YXRlcm5pb25CQ29tcG9uZW50cyksXG4gICAgICAgIHRoaXJkUXVhdGVybmlvbkJDb21wb25lbnQgPSB0aGlyZChxdWF0ZXJuaW9uQkNvbXBvbmVudHMpLFxuICAgICAgICBmb3VydGhRdWF0ZXJuaW9uQkNvbXBvbmVudCA9IGZvdXJ0aChxdWF0ZXJuaW9uQkNvbXBvbmVudHMpLFxuICAgICAgICBhMSA9IGZpcnN0UXVhdGVybmlvbkFDb21wb25lbnQsXG4gICAgICAgIGIxID0gc2Vjb25kUXVhdGVybmlvbkFDb21wb25lbnQsXG4gICAgICAgIGMxID0gdGhpcmRRdWF0ZXJuaW9uQUNvbXBvbmVudCxcbiAgICAgICAgZDEgPSBmb3VydGhRdWF0ZXJuaW9uQUNvbXBvbmVudCxcbiAgICAgICAgYTIgPSBmaXJzdFF1YXRlcm5pb25CQ29tcG9uZW50LFxuICAgICAgICBiMiA9IHNlY29uZFF1YXRlcm5pb25CQ29tcG9uZW50LFxuICAgICAgICBjMiA9IHRoaXJkUXVhdGVybmlvbkJDb21wb25lbnQsXG4gICAgICAgIGQyID0gZm91cnRoUXVhdGVybmlvbkJDb21wb25lbnQsXG4gICAgICAgIGEgPSBhMSAqIGEyIC0gYjEgKiBiMiAtIGMxICogYzIgLSBkMSAqIGQyLFxuICAgICAgICBiID0gYTEgKiBiMiArIGIxICogYTIgKyBjMSAqIGQyIC0gZDEgKiBjMixcbiAgICAgICAgYyA9IGExICogYzIgLSBiMSAqIGQyICsgYzEgKiBhMiArIGQxICogYjIsXG4gICAgICAgIGQgPSBhMSAqIGQyICsgYjEgKiBjMiAtIGMxICogYjIgKyBkMSAqIGEyLFxuICAgICAgICBxdWF0ZXJuaW9uID0gWyBhLCBiLCBjLCBkIF07XG5cbiAgcmV0dXJuIHF1YXRlcm5pb247XG59XG4iXX0=