'use strict';

var vec3 = require('../maths/vec3'),
    arrayUtilities = require('../utilities/array');

var first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    fourth = arrayUtilities.fourth,
    subtract = vec3.subtract,
    cross = vec3.cross,
    normalise = vec3.normalise;


function calculateVertexNormal(vertexPositions) {
  var firstVertexPosition = first(vertexPositions),
      secondVertexPosition = second(vertexPositions),
      fourthVertexPosition = fourth(vertexPositions),
      firstVector = subtract(secondVertexPosition, firstVertexPosition),
      secondVector = subtract(fourthVertexPosition, firstVertexPosition),
      normal = normalise(cross(firstVector, secondVector));

  return normal;
}

function calculateIntersectionOfPlanes(vertexPositionsA, vertexPositionsB) {
  var normalA = calculateVertexNormal(vertexPositionsA),
      normalAComponents = normalA,
      ///
  firstNormalAComponent = first(normalAComponents),
      secondNormalAComponent = second(normalAComponents),
      thirdNormalAComponent = third(normalAComponents),
      angleOfRotationCosine = thirdNormalAComponent,
      ///
  axisOfRotation = [secondNormalAComponent, -firstNormalAComponent, 0],
      unitAxisOfRotation = normalise(axisOfRotation),
      rotationQuaternion = calculateRotationQuarternion(angleOfRotationCosine, unitAxisOfRotation),
      rotatedVertexPositionsA = vertexPositionsA.map(function (vertexPositionA) {
    var rotatedVertexPositionA = rotatePosition(vertexPositionA, rotationQuaternion);

    return rotatedVertexPositionA;
  });

  debugger;
}

function rotatePosition(position, rotationQuaternion) {
  var imaginaryQuaternion = calculateImaginaryQuaternion(position),
      rotatedImaginaryQuaternion = rotateImaginaryQuaternion(imaginaryQuaternion, rotationQuaternion),
      rotatedPosition = calculatePosition(rotatedImaginaryQuaternion);

  return rotatedPosition;
}

function rotateImaginaryQuaternion(imaginaryQuaternion, rotationQuaternion) {
  var inverseRotationQuaternion = calculateInverseRotationQuarternion(rotationQuaternion),
      rotatedImaginaryQuaternion = hamiltonProduct(hamiltonProduct(rotationQuaternion, imaginaryQuaternion), inverseRotationQuaternion);

  return rotatedImaginaryQuaternion;
}

function hamiltonProduct(quaternionA, quarternionB) {
  var quaternionAComponents = quaternionA,
      ///
  quaternionBComponents = quarternionB,
      ///
  firstQuarternionAComponent = first(quaternionAComponents),
      secondQuarternionAComponent = second(quaternionAComponents),
      thirdQuarternionAComponent = third(quaternionAComponents),
      fourthQuarternionAComponent = fourth(quaternionAComponents),
      firstQuarternionBComponent = first(quaternionBComponents),
      secondQuarternionBComponent = second(quaternionBComponents),
      thirdQuarternionBComponent = third(quaternionBComponents),
      fourthQuarternionBComponent = fourth(quaternionBComponents),
      a1 = firstQuarternionAComponent,
      b1 = secondQuarternionAComponent,
      c1 = thirdQuarternionAComponent,
      d1 = fourthQuarternionAComponent,
      a2 = firstQuarternionBComponent,
      b2 = secondQuarternionBComponent,
      c2 = thirdQuarternionBComponent,
      d2 = fourthQuarternionBComponent,
      a = a1 * a2 - b1 * b2 - c1 * c2 - d1 * d2,
      b = a1 * b2 + b1 * a2 + c1 * d2 - d1 * c2,
      c = a1 * c2 - b1 * d2 + c1 * a2 + d1 * b2,
      d = a1 * d2 + b1 * c2 - c1 * b2 + d1 * a2,
      quaternion = [a, b, c, d];

  return quaternion;
}

function calculateImaginaryQuaternion(position) {
  var positionComponents = position,
      ///
  firstPositionComponent = first(positionComponents),
      secondPositionComponent = second(positionComponents),
      thirdPositionComponent = third(positionComponents),
      imaginaryQuaternion = [0, firstPositionComponent, secondPositionComponent, thirdPositionComponent];

  return imaginaryQuaternion;
}

function calculatePosition(imaginaryQuaternion) {
  var imaginaryQuaternionComponents = imaginaryQuaternion,
      ///
  secondImaginaryQuaternionComponent = second(imaginaryQuaternionComponents),
      thirdImaginaryQuaternionComponent = third(imaginaryQuaternionComponents),
      fourthImaginaryQuaternionComponent = fourth(imaginaryQuaternionComponents),
      position = [secondImaginaryQuaternionComponent, thirdImaginaryQuaternionComponent, fourthImaginaryQuaternionComponent];

  return position;
}

function calculateRotationQuarternion(angleOfRotationCosine, unitAxisOfRotation) {
  var halfAngleOfRotationCosine = calculateHalfAngleCosine(angleOfRotationCosine),
      halfAngleOfRotationSine = calculateHalfAngleSine(angleOfRotationCosine),
      unitAxisOfRotationComponents = unitAxisOfRotation,
      ///
  firstAxisOfRotationComponent = first(unitAxisOfRotationComponents),
      secondAxisOfRotationComponent = second(unitAxisOfRotationComponents),
      thirdAxisOfRotationComponent = third(unitAxisOfRotationComponents),
      rotationQuarternion = [halfAngleOfRotationCosine, firstAxisOfRotationComponent * halfAngleOfRotationSine, secondAxisOfRotationComponent * halfAngleOfRotationSine, thirdAxisOfRotationComponent * halfAngleOfRotationSine];

  return rotationQuarternion;
}

function calculateInverseRotationQuarternion(rotationQuaternion) {
  var rotationQuaternionComponents = rotationQuaternion,
      ///
  firstRotationQuaternionComponent = first(rotationQuaternionComponents),
      secondRotationQuaternionComponent = second(rotationQuaternionComponents),
      thirdRotationQuaternionComponent = third(rotationQuaternionComponents),
      fourthRotationQuaternionComponent = fourth(rotationQuaternionComponents),
      inverseRotationQuaternion = [firstRotationQuaternionComponent, -secondRotationQuaternionComponent, -thirdRotationQuaternionComponent, -fourthRotationQuaternionComponent];

  return inverseRotationQuaternion;
}

function calculateHalfAngleCosine(angleCosine) {
  var halfAngleCosine = Math.sqrt((1 + angleCosine) / 2);

  return halfAngleCosine;
}

function calculateHalfAngleSine(angleCosine) {
  var halfAngleSine = Math.sqrt((1 - angleCosine) / 2);

  return halfAngleSine;
}

module.exports = {
  calculateIntersectionOfPlanes: calculateIntersectionOfPlanes
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvbWFzay5qcyJdLCJuYW1lcyI6WyJ2ZWMzIiwicmVxdWlyZSIsImFycmF5VXRpbGl0aWVzIiwiZmlyc3QiLCJzZWNvbmQiLCJ0aGlyZCIsImZvdXJ0aCIsInN1YnRyYWN0IiwiY3Jvc3MiLCJub3JtYWxpc2UiLCJjYWxjdWxhdGVWZXJ0ZXhOb3JtYWwiLCJ2ZXJ0ZXhQb3NpdGlvbnMiLCJmaXJzdFZlcnRleFBvc2l0aW9uIiwic2Vjb25kVmVydGV4UG9zaXRpb24iLCJmb3VydGhWZXJ0ZXhQb3NpdGlvbiIsImZpcnN0VmVjdG9yIiwic2Vjb25kVmVjdG9yIiwibm9ybWFsIiwiY2FsY3VsYXRlSW50ZXJzZWN0aW9uT2ZQbGFuZXMiLCJ2ZXJ0ZXhQb3NpdGlvbnNBIiwidmVydGV4UG9zaXRpb25zQiIsIm5vcm1hbEEiLCJub3JtYWxBQ29tcG9uZW50cyIsImZpcnN0Tm9ybWFsQUNvbXBvbmVudCIsInNlY29uZE5vcm1hbEFDb21wb25lbnQiLCJ0aGlyZE5vcm1hbEFDb21wb25lbnQiLCJhbmdsZU9mUm90YXRpb25Db3NpbmUiLCJheGlzT2ZSb3RhdGlvbiIsInVuaXRBeGlzT2ZSb3RhdGlvbiIsInJvdGF0aW9uUXVhdGVybmlvbiIsImNhbGN1bGF0ZVJvdGF0aW9uUXVhcnRlcm5pb24iLCJyb3RhdGVkVmVydGV4UG9zaXRpb25zQSIsIm1hcCIsInZlcnRleFBvc2l0aW9uQSIsInJvdGF0ZWRWZXJ0ZXhQb3NpdGlvbkEiLCJyb3RhdGVQb3NpdGlvbiIsInBvc2l0aW9uIiwiaW1hZ2luYXJ5UXVhdGVybmlvbiIsImNhbGN1bGF0ZUltYWdpbmFyeVF1YXRlcm5pb24iLCJyb3RhdGVkSW1hZ2luYXJ5UXVhdGVybmlvbiIsInJvdGF0ZUltYWdpbmFyeVF1YXRlcm5pb24iLCJyb3RhdGVkUG9zaXRpb24iLCJjYWxjdWxhdGVQb3NpdGlvbiIsImludmVyc2VSb3RhdGlvblF1YXRlcm5pb24iLCJjYWxjdWxhdGVJbnZlcnNlUm90YXRpb25RdWFydGVybmlvbiIsImhhbWlsdG9uUHJvZHVjdCIsInF1YXRlcm5pb25BIiwicXVhcnRlcm5pb25CIiwicXVhdGVybmlvbkFDb21wb25lbnRzIiwicXVhdGVybmlvbkJDb21wb25lbnRzIiwiZmlyc3RRdWFydGVybmlvbkFDb21wb25lbnQiLCJzZWNvbmRRdWFydGVybmlvbkFDb21wb25lbnQiLCJ0aGlyZFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCIsImZvdXJ0aFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCIsImZpcnN0UXVhcnRlcm5pb25CQ29tcG9uZW50Iiwic2Vjb25kUXVhcnRlcm5pb25CQ29tcG9uZW50IiwidGhpcmRRdWFydGVybmlvbkJDb21wb25lbnQiLCJmb3VydGhRdWFydGVybmlvbkJDb21wb25lbnQiLCJhMSIsImIxIiwiYzEiLCJkMSIsImEyIiwiYjIiLCJjMiIsImQyIiwiYSIsImIiLCJjIiwiZCIsInF1YXRlcm5pb24iLCJwb3NpdGlvbkNvbXBvbmVudHMiLCJmaXJzdFBvc2l0aW9uQ29tcG9uZW50Iiwic2Vjb25kUG9zaXRpb25Db21wb25lbnQiLCJ0aGlyZFBvc2l0aW9uQ29tcG9uZW50IiwiaW1hZ2luYXJ5UXVhdGVybmlvbkNvbXBvbmVudHMiLCJzZWNvbmRJbWFnaW5hcnlRdWF0ZXJuaW9uQ29tcG9uZW50IiwidGhpcmRJbWFnaW5hcnlRdWF0ZXJuaW9uQ29tcG9uZW50IiwiZm91cnRoSW1hZ2luYXJ5UXVhdGVybmlvbkNvbXBvbmVudCIsImhhbGZBbmdsZU9mUm90YXRpb25Db3NpbmUiLCJjYWxjdWxhdGVIYWxmQW5nbGVDb3NpbmUiLCJoYWxmQW5nbGVPZlJvdGF0aW9uU2luZSIsImNhbGN1bGF0ZUhhbGZBbmdsZVNpbmUiLCJ1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzIiwiZmlyc3RBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCIsInNlY29uZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50IiwidGhpcmRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCIsInJvdGF0aW9uUXVhcnRlcm5pb24iLCJyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzIiwiZmlyc3RSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJzZWNvbmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJ0aGlyZFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCIsImZvdXJ0aFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCIsImFuZ2xlQ29zaW5lIiwiaGFsZkFuZ2xlQ29zaW5lIiwiTWF0aCIsInNxcnQiLCJoYWxmQW5nbGVTaW5lIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsSUFBTUEsT0FBT0MsUUFBUSxlQUFSLENBQWI7QUFBQSxJQUNNQyxpQkFBaUJELFFBQVEsb0JBQVIsQ0FEdkI7O0lBR1FFLEssR0FBaUNELGMsQ0FBakNDLEs7SUFBT0MsTSxHQUEwQkYsYyxDQUExQkUsTTtJQUFRQyxLLEdBQWtCSCxjLENBQWxCRyxLO0lBQU9DLE0sR0FBV0osYyxDQUFYSSxNO0lBQ3RCQyxRLEdBQStCUCxJLENBQS9CTyxRO0lBQVVDLEssR0FBcUJSLEksQ0FBckJRLEs7SUFBT0MsUyxHQUFjVCxJLENBQWRTLFM7OztBQUV6QixTQUFTQyxxQkFBVCxDQUErQkMsZUFBL0IsRUFBZ0Q7QUFDOUMsTUFBTUMsc0JBQXNCVCxNQUFNUSxlQUFOLENBQTVCO0FBQUEsTUFDTUUsdUJBQXVCVCxPQUFPTyxlQUFQLENBRDdCO0FBQUEsTUFFTUcsdUJBQXVCUixPQUFPSyxlQUFQLENBRjdCO0FBQUEsTUFHTUksY0FBY1IsU0FBU00sb0JBQVQsRUFBK0JELG1CQUEvQixDQUhwQjtBQUFBLE1BSU1JLGVBQWVULFNBQVNPLG9CQUFULEVBQStCRixtQkFBL0IsQ0FKckI7QUFBQSxNQUtNSyxTQUFTUixVQUFVRCxNQUFNTyxXQUFOLEVBQW1CQyxZQUFuQixDQUFWLENBTGY7O0FBT0EsU0FBT0MsTUFBUDtBQUNEOztBQUVELFNBQVNDLDZCQUFULENBQXVDQyxnQkFBdkMsRUFBeURDLGdCQUF6RCxFQUEyRTtBQUN6RSxNQUFNQyxVQUFVWCxzQkFBc0JTLGdCQUF0QixDQUFoQjtBQUFBLE1BQ01HLG9CQUFvQkQsT0FEMUI7QUFBQSxNQUNvQztBQUM5QkUsMEJBQXdCcEIsTUFBTW1CLGlCQUFOLENBRjlCO0FBQUEsTUFHTUUseUJBQXlCcEIsT0FBT2tCLGlCQUFQLENBSC9CO0FBQUEsTUFJTUcsd0JBQXdCcEIsTUFBTWlCLGlCQUFOLENBSjlCO0FBQUEsTUFLTUksd0JBQXdCRCxxQkFMOUI7QUFBQSxNQUtzRDtBQUNoREUsbUJBQWlCLENBQ2ZILHNCQURlLEVBRWYsQ0FBQ0QscUJBRmMsRUFFUyxDQUZULENBTnZCO0FBQUEsTUFVTUsscUJBQXFCbkIsVUFBVWtCLGNBQVYsQ0FWM0I7QUFBQSxNQVdNRSxxQkFBcUJDLDZCQUE2QkoscUJBQTdCLEVBQW9ERSxrQkFBcEQsQ0FYM0I7QUFBQSxNQVlNRywwQkFBMEJaLGlCQUFpQmEsR0FBakIsQ0FBcUIsVUFBU0MsZUFBVCxFQUEwQjtBQUN2RSxRQUFNQyx5QkFBeUJDLGVBQWVGLGVBQWYsRUFBZ0NKLGtCQUFoQyxDQUEvQjs7QUFFQSxXQUFPSyxzQkFBUDtBQUNELEdBSnlCLENBWmhDOztBQWtCQTtBQUNEOztBQUVELFNBQVNDLGNBQVQsQ0FBd0JDLFFBQXhCLEVBQWtDUCxrQkFBbEMsRUFBc0Q7QUFDcEQsTUFBTVEsc0JBQXNCQyw2QkFBNkJGLFFBQTdCLENBQTVCO0FBQUEsTUFDTUcsNkJBQTZCQywwQkFBMEJILG1CQUExQixFQUErQ1Isa0JBQS9DLENBRG5DO0FBQUEsTUFFTVksa0JBQWtCQyxrQkFBa0JILDBCQUFsQixDQUZ4Qjs7QUFJQSxTQUFPRSxlQUFQO0FBQ0Q7O0FBRUQsU0FBU0QseUJBQVQsQ0FBbUNILG1CQUFuQyxFQUF3RFIsa0JBQXhELEVBQTRFO0FBQzFFLE1BQU1jLDRCQUE0QkMsb0NBQW9DZixrQkFBcEMsQ0FBbEM7QUFBQSxNQUNNVSw2QkFBNkJNLGdCQUFnQkEsZ0JBQWdCaEIsa0JBQWhCLEVBQW9DUSxtQkFBcEMsQ0FBaEIsRUFBMEVNLHlCQUExRSxDQURuQzs7QUFHQSxTQUFPSiwwQkFBUDtBQUNEOztBQUVELFNBQVNNLGVBQVQsQ0FBeUJDLFdBQXpCLEVBQXNDQyxZQUF0QyxFQUFvRDtBQUNsRCxNQUFNQyx3QkFBd0JGLFdBQTlCO0FBQUEsTUFBNEM7QUFDdENHLDBCQUF3QkYsWUFEOUI7QUFBQSxNQUM2QztBQUN2Q0csK0JBQTZCL0MsTUFBTTZDLHFCQUFOLENBRm5DO0FBQUEsTUFHTUcsOEJBQThCL0MsT0FBTzRDLHFCQUFQLENBSHBDO0FBQUEsTUFJTUksNkJBQTZCL0MsTUFBTTJDLHFCQUFOLENBSm5DO0FBQUEsTUFLTUssOEJBQThCL0MsT0FBTzBDLHFCQUFQLENBTHBDO0FBQUEsTUFNTU0sNkJBQTZCbkQsTUFBTThDLHFCQUFOLENBTm5DO0FBQUEsTUFPTU0sOEJBQThCbkQsT0FBTzZDLHFCQUFQLENBUHBDO0FBQUEsTUFRTU8sNkJBQTZCbkQsTUFBTTRDLHFCQUFOLENBUm5DO0FBQUEsTUFTTVEsOEJBQThCbkQsT0FBTzJDLHFCQUFQLENBVHBDO0FBQUEsTUFVTVMsS0FBS1IsMEJBVlg7QUFBQSxNQVdNUyxLQUFLUiwyQkFYWDtBQUFBLE1BWU1TLEtBQUtSLDBCQVpYO0FBQUEsTUFhTVMsS0FBS1IsMkJBYlg7QUFBQSxNQWNNUyxLQUFLUiwwQkFkWDtBQUFBLE1BZU1TLEtBQUtSLDJCQWZYO0FBQUEsTUFnQk1TLEtBQUtSLDBCQWhCWDtBQUFBLE1BaUJNUyxLQUFLUiwyQkFqQlg7QUFBQSxNQWtCTVMsSUFBSVIsS0FBS0ksRUFBTCxHQUFVSCxLQUFLSSxFQUFmLEdBQW9CSCxLQUFLSSxFQUF6QixHQUE4QkgsS0FBS0ksRUFsQjdDO0FBQUEsTUFtQk1FLElBQUlULEtBQUtLLEVBQUwsR0FBVUosS0FBS0csRUFBZixHQUFvQkYsS0FBS0ssRUFBekIsR0FBOEJKLEtBQUtHLEVBbkI3QztBQUFBLE1Bb0JNSSxJQUFJVixLQUFLTSxFQUFMLEdBQVVMLEtBQUtNLEVBQWYsR0FBb0JMLEtBQUtFLEVBQXpCLEdBQThCRCxLQUFLRSxFQXBCN0M7QUFBQSxNQXFCTU0sSUFBSVgsS0FBS08sRUFBTCxHQUFVTixLQUFLSyxFQUFmLEdBQW9CSixLQUFLRyxFQUF6QixHQUE4QkYsS0FBS0MsRUFyQjdDO0FBQUEsTUFzQk1RLGFBQWEsQ0FBRUosQ0FBRixFQUFLQyxDQUFMLEVBQVFDLENBQVIsRUFBV0MsQ0FBWCxDQXRCbkI7O0FBd0JBLFNBQU9DLFVBQVA7QUFDRDs7QUFFRCxTQUFTaEMsNEJBQVQsQ0FBc0NGLFFBQXRDLEVBQWdEO0FBQzlDLE1BQU1tQyxxQkFBcUJuQyxRQUEzQjtBQUFBLE1BQXNDO0FBQ2hDb0MsMkJBQXlCckUsTUFBTW9FLGtCQUFOLENBRC9CO0FBQUEsTUFFTUUsMEJBQTBCckUsT0FBT21FLGtCQUFQLENBRmhDO0FBQUEsTUFHTUcseUJBQXlCckUsTUFBTWtFLGtCQUFOLENBSC9CO0FBQUEsTUFJTWxDLHNCQUFzQixDQUNwQixDQURvQixFQUVwQm1DLHNCQUZvQixFQUdwQkMsdUJBSG9CLEVBSXBCQyxzQkFKb0IsQ0FKNUI7O0FBV0EsU0FBT3JDLG1CQUFQO0FBQ0Q7O0FBRUQsU0FBU0ssaUJBQVQsQ0FBMkJMLG1CQUEzQixFQUFnRDtBQUM5QyxNQUFNc0MsZ0NBQWdDdEMsbUJBQXRDO0FBQUEsTUFBNEQ7QUFDdER1Qyx1Q0FBcUN4RSxPQUFPdUUsNkJBQVAsQ0FEM0M7QUFBQSxNQUVNRSxvQ0FBb0N4RSxNQUFNc0UsNkJBQU4sQ0FGMUM7QUFBQSxNQUdNRyxxQ0FBcUN4RSxPQUFPcUUsNkJBQVAsQ0FIM0M7QUFBQSxNQUlNdkMsV0FBVyxDQUNUd0Msa0NBRFMsRUFFVEMsaUNBRlMsRUFHVEMsa0NBSFMsQ0FKakI7O0FBVUEsU0FBTzFDLFFBQVA7QUFDRDs7QUFFRCxTQUFTTiw0QkFBVCxDQUFzQ0oscUJBQXRDLEVBQTZERSxrQkFBN0QsRUFBaUY7QUFDL0UsTUFBTW1ELDRCQUE0QkMseUJBQXlCdEQscUJBQXpCLENBQWxDO0FBQUEsTUFDTXVELDBCQUEwQkMsdUJBQXVCeEQscUJBQXZCLENBRGhDO0FBQUEsTUFFTXlELCtCQUErQnZELGtCQUZyQztBQUFBLE1BRTBEO0FBQ3BEd0QsaUNBQStCakYsTUFBTWdGLDRCQUFOLENBSHJDO0FBQUEsTUFJTUUsZ0NBQWdDakYsT0FBTytFLDRCQUFQLENBSnRDO0FBQUEsTUFLTUcsK0JBQStCakYsTUFBTThFLDRCQUFOLENBTHJDO0FBQUEsTUFNTUksc0JBQXNCLENBQ3BCUix5QkFEb0IsRUFFcEJLLCtCQUErQkgsdUJBRlgsRUFHcEJJLGdDQUFnQ0osdUJBSFosRUFJcEJLLCtCQUErQkwsdUJBSlgsQ0FONUI7O0FBYUEsU0FBT00sbUJBQVA7QUFDRDs7QUFFRCxTQUFTM0MsbUNBQVQsQ0FBNkNmLGtCQUE3QyxFQUFpRTtBQUMvRCxNQUFNMkQsK0JBQStCM0Qsa0JBQXJDO0FBQUEsTUFBMEQ7QUFDcEQ0RCxxQ0FBbUN0RixNQUFNcUYsNEJBQU4sQ0FEekM7QUFBQSxNQUVNRSxvQ0FBb0N0RixPQUFPb0YsNEJBQVAsQ0FGMUM7QUFBQSxNQUdNRyxtQ0FBbUN0RixNQUFNbUYsNEJBQU4sQ0FIekM7QUFBQSxNQUlNSSxvQ0FBb0N0RixPQUFPa0YsNEJBQVAsQ0FKMUM7QUFBQSxNQUtNN0MsNEJBQTRCLENBQzFCOEMsZ0NBRDBCLEVBRTFCLENBQUNDLGlDQUZ5QixFQUcxQixDQUFDQyxnQ0FIeUIsRUFJMUIsQ0FBQ0MsaUNBSnlCLENBTGxDOztBQVlBLFNBQU9qRCx5QkFBUDtBQUNEOztBQUVELFNBQVNxQyx3QkFBVCxDQUFrQ2EsV0FBbEMsRUFBK0M7QUFDN0MsTUFBTUMsa0JBQWtCQyxLQUFLQyxJQUFMLENBQVUsQ0FBQyxJQUFJSCxXQUFMLElBQW9CLENBQTlCLENBQXhCOztBQUVBLFNBQU9DLGVBQVA7QUFDRDs7QUFFRCxTQUFTWixzQkFBVCxDQUFnQ1csV0FBaEMsRUFBNkM7QUFDM0MsTUFBTUksZ0JBQWdCRixLQUFLQyxJQUFMLENBQVUsQ0FBQyxJQUFJSCxXQUFMLElBQW9CLENBQTlCLENBQXRCOztBQUVBLFNBQU9JLGFBQVA7QUFDRDs7QUFFREMsT0FBT0MsT0FBUCxHQUFpQjtBQUNmakYsaUNBQStCQTtBQURoQixDQUFqQiIsImZpbGUiOiJtYXNrLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCB2ZWMzID0gcmVxdWlyZSgnLi4vbWF0aHMvdmVjMycpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYXJyYXknKTtcblxuY29uc3QgeyBmaXJzdCwgc2Vjb25kLCB0aGlyZCwgZm91cnRoIH0gPSBhcnJheVV0aWxpdGllcyxcbiAgICAgIHsgc3VidHJhY3QsIGNyb3NzLCBub3JtYWxpc2UgfSA9IHZlYzM7XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVZlcnRleE5vcm1hbCh2ZXJ0ZXhQb3NpdGlvbnMpIHtcbiAgY29uc3QgZmlyc3RWZXJ0ZXhQb3NpdGlvbiA9IGZpcnN0KHZlcnRleFBvc2l0aW9ucyksXG4gICAgICAgIHNlY29uZFZlcnRleFBvc2l0aW9uID0gc2Vjb25kKHZlcnRleFBvc2l0aW9ucyksXG4gICAgICAgIGZvdXJ0aFZlcnRleFBvc2l0aW9uID0gZm91cnRoKHZlcnRleFBvc2l0aW9ucyksXG4gICAgICAgIGZpcnN0VmVjdG9yID0gc3VidHJhY3Qoc2Vjb25kVmVydGV4UG9zaXRpb24sIGZpcnN0VmVydGV4UG9zaXRpb24pLFxuICAgICAgICBzZWNvbmRWZWN0b3IgPSBzdWJ0cmFjdChmb3VydGhWZXJ0ZXhQb3NpdGlvbiwgZmlyc3RWZXJ0ZXhQb3NpdGlvbiksXG4gICAgICAgIG5vcm1hbCA9IG5vcm1hbGlzZShjcm9zcyhmaXJzdFZlY3Rvciwgc2Vjb25kVmVjdG9yKSk7XG5cbiAgcmV0dXJuIG5vcm1hbDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSW50ZXJzZWN0aW9uT2ZQbGFuZXModmVydGV4UG9zaXRpb25zQSwgdmVydGV4UG9zaXRpb25zQikge1xuICBjb25zdCBub3JtYWxBID0gY2FsY3VsYXRlVmVydGV4Tm9ybWFsKHZlcnRleFBvc2l0aW9uc0EpLFxuICAgICAgICBub3JtYWxBQ29tcG9uZW50cyA9IG5vcm1hbEEsICAvLy9cbiAgICAgICAgZmlyc3ROb3JtYWxBQ29tcG9uZW50ID0gZmlyc3Qobm9ybWFsQUNvbXBvbmVudHMpLFxuICAgICAgICBzZWNvbmROb3JtYWxBQ29tcG9uZW50ID0gc2Vjb25kKG5vcm1hbEFDb21wb25lbnRzKSxcbiAgICAgICAgdGhpcmROb3JtYWxBQ29tcG9uZW50ID0gdGhpcmQobm9ybWFsQUNvbXBvbmVudHMpLFxuICAgICAgICBhbmdsZU9mUm90YXRpb25Db3NpbmUgPSB0aGlyZE5vcm1hbEFDb21wb25lbnQsICAvLy9cbiAgICAgICAgYXhpc09mUm90YXRpb24gPSBbXG4gICAgICAgICAgc2Vjb25kTm9ybWFsQUNvbXBvbmVudCxcbiAgICAgICAgICAtZmlyc3ROb3JtYWxBQ29tcG9uZW50LCAwXG4gICAgICAgIF0sXG4gICAgICAgIHVuaXRBeGlzT2ZSb3RhdGlvbiA9IG5vcm1hbGlzZShheGlzT2ZSb3RhdGlvbiksXG4gICAgICAgIHJvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZVJvdGF0aW9uUXVhcnRlcm5pb24oYW5nbGVPZlJvdGF0aW9uQ29zaW5lLCB1bml0QXhpc09mUm90YXRpb24pLFxuICAgICAgICByb3RhdGVkVmVydGV4UG9zaXRpb25zQSA9IHZlcnRleFBvc2l0aW9uc0EubWFwKGZ1bmN0aW9uKHZlcnRleFBvc2l0aW9uQSkge1xuICAgICAgICAgIGNvbnN0IHJvdGF0ZWRWZXJ0ZXhQb3NpdGlvbkEgPSByb3RhdGVQb3NpdGlvbih2ZXJ0ZXhQb3NpdGlvbkEsIHJvdGF0aW9uUXVhdGVybmlvbik7XG5cbiAgICAgICAgICByZXR1cm4gcm90YXRlZFZlcnRleFBvc2l0aW9uQTtcbiAgICAgICAgfSk7XG5cbiAgZGVidWdnZXJcbn1cblxuZnVuY3Rpb24gcm90YXRlUG9zaXRpb24ocG9zaXRpb24sIHJvdGF0aW9uUXVhdGVybmlvbikge1xuICBjb25zdCBpbWFnaW5hcnlRdWF0ZXJuaW9uID0gY2FsY3VsYXRlSW1hZ2luYXJ5UXVhdGVybmlvbihwb3NpdGlvbiksXG4gICAgICAgIHJvdGF0ZWRJbWFnaW5hcnlRdWF0ZXJuaW9uID0gcm90YXRlSW1hZ2luYXJ5UXVhdGVybmlvbihpbWFnaW5hcnlRdWF0ZXJuaW9uLCByb3RhdGlvblF1YXRlcm5pb24pLFxuICAgICAgICByb3RhdGVkUG9zaXRpb24gPSBjYWxjdWxhdGVQb3NpdGlvbihyb3RhdGVkSW1hZ2luYXJ5UXVhdGVybmlvbik7XG5cbiAgcmV0dXJuIHJvdGF0ZWRQb3NpdGlvbjtcbn1cblxuZnVuY3Rpb24gcm90YXRlSW1hZ2luYXJ5UXVhdGVybmlvbihpbWFnaW5hcnlRdWF0ZXJuaW9uLCByb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgY29uc3QgaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbiA9IGNhbGN1bGF0ZUludmVyc2VSb3RhdGlvblF1YXJ0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbiksXG4gICAgICAgIHJvdGF0ZWRJbWFnaW5hcnlRdWF0ZXJuaW9uID0gaGFtaWx0b25Qcm9kdWN0KGhhbWlsdG9uUHJvZHVjdChyb3RhdGlvblF1YXRlcm5pb24sIGltYWdpbmFyeVF1YXRlcm5pb24pLCBpbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uKTtcblxuICByZXR1cm4gcm90YXRlZEltYWdpbmFyeVF1YXRlcm5pb247XG59XG5cbmZ1bmN0aW9uIGhhbWlsdG9uUHJvZHVjdChxdWF0ZXJuaW9uQSwgcXVhcnRlcm5pb25CKSB7XG4gIGNvbnN0IHF1YXRlcm5pb25BQ29tcG9uZW50cyA9IHF1YXRlcm5pb25BLCAgLy8vXG4gICAgICAgIHF1YXRlcm5pb25CQ29tcG9uZW50cyA9IHF1YXJ0ZXJuaW9uQiwgIC8vL1xuICAgICAgICBmaXJzdFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCA9IGZpcnN0KHF1YXRlcm5pb25BQ29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCA9IHNlY29uZChxdWF0ZXJuaW9uQUNvbXBvbmVudHMpLFxuICAgICAgICB0aGlyZFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCA9IHRoaXJkKHF1YXRlcm5pb25BQ29tcG9uZW50cyksXG4gICAgICAgIGZvdXJ0aFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCA9IGZvdXJ0aChxdWF0ZXJuaW9uQUNvbXBvbmVudHMpLFxuICAgICAgICBmaXJzdFF1YXJ0ZXJuaW9uQkNvbXBvbmVudCA9IGZpcnN0KHF1YXRlcm5pb25CQ29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZFF1YXJ0ZXJuaW9uQkNvbXBvbmVudCA9IHNlY29uZChxdWF0ZXJuaW9uQkNvbXBvbmVudHMpLFxuICAgICAgICB0aGlyZFF1YXJ0ZXJuaW9uQkNvbXBvbmVudCA9IHRoaXJkKHF1YXRlcm5pb25CQ29tcG9uZW50cyksXG4gICAgICAgIGZvdXJ0aFF1YXJ0ZXJuaW9uQkNvbXBvbmVudCA9IGZvdXJ0aChxdWF0ZXJuaW9uQkNvbXBvbmVudHMpLFxuICAgICAgICBhMSA9IGZpcnN0UXVhcnRlcm5pb25BQ29tcG9uZW50LFxuICAgICAgICBiMSA9IHNlY29uZFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCxcbiAgICAgICAgYzEgPSB0aGlyZFF1YXJ0ZXJuaW9uQUNvbXBvbmVudCxcbiAgICAgICAgZDEgPSBmb3VydGhRdWFydGVybmlvbkFDb21wb25lbnQsXG4gICAgICAgIGEyID0gZmlyc3RRdWFydGVybmlvbkJDb21wb25lbnQsXG4gICAgICAgIGIyID0gc2Vjb25kUXVhcnRlcm5pb25CQ29tcG9uZW50LFxuICAgICAgICBjMiA9IHRoaXJkUXVhcnRlcm5pb25CQ29tcG9uZW50LFxuICAgICAgICBkMiA9IGZvdXJ0aFF1YXJ0ZXJuaW9uQkNvbXBvbmVudCxcbiAgICAgICAgYSA9IGExICogYTIgLSBiMSAqIGIyIC0gYzEgKiBjMiAtIGQxICogZDIsXG4gICAgICAgIGIgPSBhMSAqIGIyICsgYjEgKiBhMiArIGMxICogZDIgLSBkMSAqIGMyLFxuICAgICAgICBjID0gYTEgKiBjMiAtIGIxICogZDIgKyBjMSAqIGEyICsgZDEgKiBiMixcbiAgICAgICAgZCA9IGExICogZDIgKyBiMSAqIGMyIC0gYzEgKiBiMiArIGQxICogYTIsXG4gICAgICAgIHF1YXRlcm5pb24gPSBbIGEsIGIsIGMsIGQgXTtcblxuICByZXR1cm4gcXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSW1hZ2luYXJ5UXVhdGVybmlvbihwb3NpdGlvbikge1xuICBjb25zdCBwb3NpdGlvbkNvbXBvbmVudHMgPSBwb3NpdGlvbiwgIC8vL1xuICAgICAgICBmaXJzdFBvc2l0aW9uQ29tcG9uZW50ID0gZmlyc3QocG9zaXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgc2Vjb25kUG9zaXRpb25Db21wb25lbnQgPSBzZWNvbmQocG9zaXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgdGhpcmRQb3NpdGlvbkNvbXBvbmVudCA9IHRoaXJkKHBvc2l0aW9uQ29tcG9uZW50cyksXG4gICAgICAgIGltYWdpbmFyeVF1YXRlcm5pb24gPSBbXG4gICAgICAgICAgMCxcbiAgICAgICAgICBmaXJzdFBvc2l0aW9uQ29tcG9uZW50LFxuICAgICAgICAgIHNlY29uZFBvc2l0aW9uQ29tcG9uZW50LFxuICAgICAgICAgIHRoaXJkUG9zaXRpb25Db21wb25lbnRcbiAgICAgICAgXTtcblxuICByZXR1cm4gaW1hZ2luYXJ5UXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlUG9zaXRpb24oaW1hZ2luYXJ5UXVhdGVybmlvbikge1xuICBjb25zdCBpbWFnaW5hcnlRdWF0ZXJuaW9uQ29tcG9uZW50cyA9IGltYWdpbmFyeVF1YXRlcm5pb24sICAvLy9cbiAgICAgICAgc2Vjb25kSW1hZ2luYXJ5UXVhdGVybmlvbkNvbXBvbmVudCA9IHNlY29uZChpbWFnaW5hcnlRdWF0ZXJuaW9uQ29tcG9uZW50cyksXG4gICAgICAgIHRoaXJkSW1hZ2luYXJ5UXVhdGVybmlvbkNvbXBvbmVudCA9IHRoaXJkKGltYWdpbmFyeVF1YXRlcm5pb25Db21wb25lbnRzKSxcbiAgICAgICAgZm91cnRoSW1hZ2luYXJ5UXVhdGVybmlvbkNvbXBvbmVudCA9IGZvdXJ0aChpbWFnaW5hcnlRdWF0ZXJuaW9uQ29tcG9uZW50cyksXG4gICAgICAgIHBvc2l0aW9uID0gW1xuICAgICAgICAgIHNlY29uZEltYWdpbmFyeVF1YXRlcm5pb25Db21wb25lbnQsXG4gICAgICAgICAgdGhpcmRJbWFnaW5hcnlRdWF0ZXJuaW9uQ29tcG9uZW50LFxuICAgICAgICAgIGZvdXJ0aEltYWdpbmFyeVF1YXRlcm5pb25Db21wb25lbnRcbiAgICAgICAgXTtcblxuICByZXR1cm4gcG9zaXRpb247XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVJvdGF0aW9uUXVhcnRlcm5pb24oYW5nbGVPZlJvdGF0aW9uQ29zaW5lLCB1bml0QXhpc09mUm90YXRpb24pIHtcbiAgY29uc3QgaGFsZkFuZ2xlT2ZSb3RhdGlvbkNvc2luZSA9IGNhbGN1bGF0ZUhhbGZBbmdsZUNvc2luZShhbmdsZU9mUm90YXRpb25Db3NpbmUpLFxuICAgICAgICBoYWxmQW5nbGVPZlJvdGF0aW9uU2luZSA9IGNhbGN1bGF0ZUhhbGZBbmdsZVNpbmUoYW5nbGVPZlJvdGF0aW9uQ29zaW5lKSxcbiAgICAgICAgdW5pdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50cyA9IHVuaXRBeGlzT2ZSb3RhdGlvbiwgIC8vL1xuICAgICAgICBmaXJzdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ID0gZmlyc3QodW5pdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ID0gc2Vjb25kKHVuaXRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudHMpLFxuICAgICAgICB0aGlyZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ID0gdGhpcmQodW5pdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50cyksXG4gICAgICAgIHJvdGF0aW9uUXVhcnRlcm5pb24gPSBbXG4gICAgICAgICAgaGFsZkFuZ2xlT2ZSb3RhdGlvbkNvc2luZSxcbiAgICAgICAgICBmaXJzdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ICogaGFsZkFuZ2xlT2ZSb3RhdGlvblNpbmUsXG4gICAgICAgICAgc2Vjb25kQXhpc09mUm90YXRpb25Db21wb25lbnQgKiBoYWxmQW5nbGVPZlJvdGF0aW9uU2luZSxcbiAgICAgICAgICB0aGlyZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ICogaGFsZkFuZ2xlT2ZSb3RhdGlvblNpbmVcbiAgICAgICAgXTtcblxuICByZXR1cm4gcm90YXRpb25RdWFydGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSW52ZXJzZVJvdGF0aW9uUXVhcnRlcm5pb24ocm90YXRpb25RdWF0ZXJuaW9uKSB7XG4gIGNvbnN0IHJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMgPSByb3RhdGlvblF1YXRlcm5pb24sICAvLy9cbiAgICAgICAgZmlyc3RSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQgPSBmaXJzdChyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzKSxcbiAgICAgICAgc2Vjb25kUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gc2Vjb25kKHJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMpLFxuICAgICAgICB0aGlyZFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCA9IHRoaXJkKHJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMpLFxuICAgICAgICBmb3VydGhSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQgPSBmb3VydGgocm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyksXG4gICAgICAgIGludmVyc2VSb3RhdGlvblF1YXRlcm5pb24gPSBbXG4gICAgICAgICAgZmlyc3RSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQsXG4gICAgICAgICAgLXNlY29uZFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCxcbiAgICAgICAgICAtdGhpcmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQsXG4gICAgICAgICAgLWZvdXJ0aFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudFxuICAgICAgICBdO1xuXG4gIHJldHVybiBpbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVIYWxmQW5nbGVDb3NpbmUoYW5nbGVDb3NpbmUpIHtcbiAgY29uc3QgaGFsZkFuZ2xlQ29zaW5lID0gTWF0aC5zcXJ0KCgxICsgYW5nbGVDb3NpbmUpIC8gMik7XG5cbiAgcmV0dXJuIGhhbGZBbmdsZUNvc2luZTtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlSGFsZkFuZ2xlU2luZShhbmdsZUNvc2luZSkge1xuICBjb25zdCBoYWxmQW5nbGVTaW5lID0gTWF0aC5zcXJ0KCgxIC0gYW5nbGVDb3NpbmUpIC8gMik7XG5cbiAgcmV0dXJuIGhhbGZBbmdsZVNpbmU7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBjYWxjdWxhdGVJbnRlcnNlY3Rpb25PZlBsYW5lczogY2FsY3VsYXRlSW50ZXJzZWN0aW9uT2ZQbGFuZXNcbn07XG4iXX0=