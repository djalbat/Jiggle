"use strict";

var vectorMaths = require("../maths/vector"),
    arrayUtilities = require("../utilities/array"),
    angleUtilities = require("../utilities/angle"),
    approximateUtilities = require("../utilities/approximate");

var dot3 = vectorMaths.dot3,
    cross3 = vectorMaths.cross3,
    normalise3 = vectorMaths.normalise3,
    isApproximatelyEqualToOne = approximateUtilities.isApproximatelyEqualToOne,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    fourth = arrayUtilities.fourth,
    calculateHalfAngleCosine = angleUtilities.calculateHalfAngleCosine,
    calculateHalfAngleSine = angleUtilities.calculateHalfAngleSine;

function rotateImaginaryQuaternion(imaginaryQuaternion, rotationQuaternion, inverseRotationQuaternion) {
  return hamiltonProduct(hamiltonProduct(rotationQuaternion, imaginaryQuaternion), inverseRotationQuaternion);
}

function calculateInverseRotationQuaternion(rotationQuaternion) {
  var rotationQuaternionComponents = rotationQuaternion,
      ///
  firstRotationQuaternionComponent = first(rotationQuaternionComponents),
      secondRotationQuaternionComponent = second(rotationQuaternionComponents),
      thirdRotationQuaternionComponent = third(rotationQuaternionComponents),
      fourthRotationQuaternionComponent = fourth(rotationQuaternionComponents),
      inverseRotationQuaternion = [firstRotationQuaternionComponent, -secondRotationQuaternionComponent, -thirdRotationQuaternionComponent, -fourthRotationQuaternionComponent];
  return inverseRotationQuaternion;
}

function calculateForwardsRotationQuaternion(rotationQuaternion) {
  var forwardsRotationQuaternion = rotationQuaternion; ///

  return forwardsRotationQuaternion;
}

function calculateBackwardsRotationQuaternion(rotationQuaternion) {
  var inverseRotationQuaternion = calculateInverseRotationQuaternion(rotationQuaternion),
      backwardsRotationQuaternion = inverseRotationQuaternion; ///

  return backwardsRotationQuaternion;
}

function calculateArbitraryRotationQuaternion(normal) {
  var extent = normal.getExtent(),
      unitNormal = extent,
      ///
  zAxis = [0, 0, 1],
      dotProductOfUnitNormalAndZAxis = dot3(unitNormal, zAxis),
      crossProductOfUnitNormalAndZAxis = cross3(unitNormal, zAxis),
      angleOfRotationCosine = dotProductOfUnitNormalAndZAxis,
      ///
  angleOfRotationCosineAbsoluteValue = Math.abs(angleOfRotationCosine),
      angleOfRotationCosineAbsoluteValueApproximatelyEqualToOne = isApproximatelyEqualToOne(angleOfRotationCosineAbsoluteValue),
      axisOfRotation = angleOfRotationCosineAbsoluteValueApproximatelyEqualToOne ? [1, 0, 0] : ///
  crossProductOfUnitNormalAndZAxis,
      unitAxisOfRotation = normalise3(axisOfRotation),
      halfAngleOfRotationCosine = calculateHalfAngleCosine(angleOfRotationCosine),
      halfAngleOfRotationSine = calculateHalfAngleSine(angleOfRotationCosine),
      unitAxisOfRotationComponents = unitAxisOfRotation,
      ///
  firstAxisOfRotationComponent = first(unitAxisOfRotationComponents),
      secondAxisOfRotationComponent = second(unitAxisOfRotationComponents),
      thirdAxisOfRotationComponent = third(unitAxisOfRotationComponents),
      arbitraryRotationQuaternion = [halfAngleOfRotationCosine, firstAxisOfRotationComponent * halfAngleOfRotationSine, secondAxisOfRotationComponent * halfAngleOfRotationSine, thirdAxisOfRotationComponent * halfAngleOfRotationSine];
  return arbitraryRotationQuaternion;
}

function calculateRotationAboutZAxisQuaternion(maskingEdge) {
  var maskingEdgeExtent = maskingEdge.getExtent(),
      unitMaskingEdgeExtent = normalise3(maskingEdgeExtent),
      unitMaskingEdgeExtentComponents = unitMaskingEdgeExtent,
      ///
  firstUnitMaskingEdgeExtentComponent = first(unitMaskingEdgeExtentComponents),
      secondUnitMaskingEdgeExtentComponent = second(unitMaskingEdgeExtentComponents),
      angleOfRotationSine = firstUnitMaskingEdgeExtentComponent,
      ///
  angleOfRotationCosine = secondUnitMaskingEdgeExtentComponent,
      ///
  halfAngleOfRotationCosine = calculateHalfAngleCosine(angleOfRotationCosine),
      halfAngleOfRotationSine = angleOfRotationSine > 0 ? +calculateHalfAngleSine(angleOfRotationCosine) : -calculateHalfAngleSine(angleOfRotationCosine),
      rotationAboutZAxisQuaternion = [halfAngleOfRotationCosine, 0, 0, halfAngleOfRotationSine];
  return rotationAboutZAxisQuaternion;
}

module.exports = {
  rotateImaginaryQuaternion: rotateImaginaryQuaternion,
  calculateInverseRotationQuaternion: calculateInverseRotationQuaternion,
  calculateForwardsRotationQuaternion: calculateForwardsRotationQuaternion,
  calculateBackwardsRotationQuaternion: calculateBackwardsRotationQuaternion,
  calculateArbitraryRotationQuaternion: calculateArbitraryRotationQuaternion,
  calculateRotationAboutZAxisQuaternion: calculateRotationAboutZAxisQuaternion
};

function hamiltonProduct(quaternionA, quaternionB) {
  var a1 = quaternionA[0],
      b1 = quaternionA[1],
      c1 = quaternionA[2],
      d1 = quaternionA[3],
      a2 = quaternionB[0],
      b2 = quaternionB[1],
      c2 = quaternionB[2],
      d2 = quaternionB[3],
      a = a1 * a2 - b1 * b2 - c1 * c2 - d1 * d2,
      b = a1 * b2 + b1 * a2 + c1 * d2 - d1 * c2,
      c = a1 * c2 - b1 * d2 + c1 * a2 + d1 * b2,
      d = a1 * d2 + b1 * c2 - c1 * b2 + d1 * a2,
      quaternion = [a, b, c, d];
  return quaternion;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInF1YXRlcm5pb24uanMiXSwibmFtZXMiOlsidmVjdG9yTWF0aHMiLCJyZXF1aXJlIiwiYXJyYXlVdGlsaXRpZXMiLCJhbmdsZVV0aWxpdGllcyIsImFwcHJveGltYXRlVXRpbGl0aWVzIiwiZG90MyIsImNyb3NzMyIsIm5vcm1hbGlzZTMiLCJpc0FwcHJveGltYXRlbHlFcXVhbFRvT25lIiwiZmlyc3QiLCJzZWNvbmQiLCJ0aGlyZCIsImZvdXJ0aCIsImNhbGN1bGF0ZUhhbGZBbmdsZUNvc2luZSIsImNhbGN1bGF0ZUhhbGZBbmdsZVNpbmUiLCJyb3RhdGVJbWFnaW5hcnlRdWF0ZXJuaW9uIiwiaW1hZ2luYXJ5UXVhdGVybmlvbiIsInJvdGF0aW9uUXVhdGVybmlvbiIsImludmVyc2VSb3RhdGlvblF1YXRlcm5pb24iLCJoYW1pbHRvblByb2R1Y3QiLCJjYWxjdWxhdGVJbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uIiwicm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyIsImZpcnN0Um90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50Iiwic2Vjb25kUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50IiwidGhpcmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJmb3VydGhSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiIsImZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwiY2FsY3VsYXRlQXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uIiwibm9ybWFsIiwiZXh0ZW50IiwiZ2V0RXh0ZW50IiwidW5pdE5vcm1hbCIsInpBeGlzIiwiZG90UHJvZHVjdE9mVW5pdE5vcm1hbEFuZFpBeGlzIiwiY3Jvc3NQcm9kdWN0T2ZVbml0Tm9ybWFsQW5kWkF4aXMiLCJhbmdsZU9mUm90YXRpb25Db3NpbmUiLCJhbmdsZU9mUm90YXRpb25Db3NpbmVBYnNvbHV0ZVZhbHVlIiwiTWF0aCIsImFicyIsImFuZ2xlT2ZSb3RhdGlvbkNvc2luZUFic29sdXRlVmFsdWVBcHByb3hpbWF0ZWx5RXF1YWxUb09uZSIsImF4aXNPZlJvdGF0aW9uIiwidW5pdEF4aXNPZlJvdGF0aW9uIiwiaGFsZkFuZ2xlT2ZSb3RhdGlvbkNvc2luZSIsImhhbGZBbmdsZU9mUm90YXRpb25TaW5lIiwidW5pdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50cyIsImZpcnN0QXhpc09mUm90YXRpb25Db21wb25lbnQiLCJzZWNvbmRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCIsInRoaXJkQXhpc09mUm90YXRpb25Db21wb25lbnQiLCJhcmJpdHJhcnlSb3RhdGlvblF1YXRlcm5pb24iLCJjYWxjdWxhdGVSb3RhdGlvbkFib3V0WkF4aXNRdWF0ZXJuaW9uIiwibWFza2luZ0VkZ2UiLCJtYXNraW5nRWRnZUV4dGVudCIsInVuaXRNYXNraW5nRWRnZUV4dGVudCIsInVuaXRNYXNraW5nRWRnZUV4dGVudENvbXBvbmVudHMiLCJmaXJzdFVuaXRNYXNraW5nRWRnZUV4dGVudENvbXBvbmVudCIsInNlY29uZFVuaXRNYXNraW5nRWRnZUV4dGVudENvbXBvbmVudCIsImFuZ2xlT2ZSb3RhdGlvblNpbmUiLCJyb3RhdGlvbkFib3V0WkF4aXNRdWF0ZXJuaW9uIiwibW9kdWxlIiwiZXhwb3J0cyIsInF1YXRlcm5pb25BIiwicXVhdGVybmlvbkIiLCJhMSIsImIxIiwiYzEiLCJkMSIsImEyIiwiYjIiLCJjMiIsImQyIiwiYSIsImIiLCJjIiwiZCIsInF1YXRlcm5pb24iXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQU1BLFdBQVcsR0FBR0MsT0FBTyxDQUFDLGlCQUFELENBQTNCO0FBQUEsSUFDTUMsY0FBYyxHQUFHRCxPQUFPLENBQUMsb0JBQUQsQ0FEOUI7QUFBQSxJQUVNRSxjQUFjLEdBQUdGLE9BQU8sQ0FBQyxvQkFBRCxD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QUUsR0FBR0ssRUFBekIsR0FBOEJKLEVBQUUsR0FBR0csRUFUN0M7QUFBQSxNQVVNSSxDQUFDLEdBQUdWLEVBQUUsR0FBR00sRUFBTCxHQUFVTCxFQUFFLEdBQUdNLEVBQWYsR0FBb0JMLEVBQUUsR0FBR0UsRUFBekIsR0FBOEJELEVBQUUsR0FBR0UsRUFWN0M7QUFBQSxNQVdNTSxDQUFDLEdBQUdYLEVBQUUsR0FBR08sRUFBTCxHQUFVTixFQUFFLEdBQUdLLEVBQWYsR0FBb0JKLEVBQUUsR0FBR0csRUFBekIsR0FBOEJGLEVBQUUsR0FBR0MsRUFYN0M7QUFBQSxNQVlNUSxVQUFVLEdBQUcsQ0FBRUosQ0FBRixFQUFLQyxDQUFMLEVBQVFDLENBQVIsRUFBV0MsQ0FBWCxDQVpuQjtBQWNBLFNBQU9DLFVBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5jb25zdCB2ZWN0b3JNYXRocyA9IHJlcXVpcmUoXCIuLi9tYXRocy92ZWN0b3JcIiksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoXCIuLi91dGlsaXRpZXMvYXJyYXlcIiksXG4gICAgICBhbmdsZVV0aWxpdGllcyA9IHJlcXVpcmUoXCIuLi91dGlsaXRpZXMvYW5nbGVcIiksXG4gICAgICBhcHByb3hpbWF0ZVV0aWxpdGllcyA9IHJlcXVpcmUoXCIuLi91dGlsaXRpZXMvYXBwcm94aW1hdGVcIik7XG5cbmNvbnN0IHsgZG90MywgY3Jvc3MzLCBub3JtYWxpc2UzIH0gPSB2ZWN0b3JNYXRocyxcbiAgICAgIHsgaXNBcHByb3hpbWF0ZWx5RXF1YWxUb09uZSB9ID0gYXBwcm94aW1hdGVVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBzZWNvbmQsIHRoaXJkLCBmb3VydGggfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVIYWxmQW5nbGVDb3NpbmUsIGNhbGN1bGF0ZUhhbGZBbmdsZVNpbmUgfSA9IGFuZ2xlVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiByb3RhdGVJbWFnaW5hcnlRdWF0ZXJuaW9uKGltYWdpbmFyeVF1YXRlcm5pb24sIHJvdGF0aW9uUXVhdGVybmlvbiwgaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbikgeyByZXR1cm4gaGFtaWx0b25Qcm9kdWN0KGhhbWlsdG9uUHJvZHVjdChyb3RhdGlvblF1YXRlcm5pb24sIGltYWdpbmFyeVF1YXRlcm5pb24pLCBpbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uKTsgfVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVJbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbikge1xuICBjb25zdCByb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzID0gcm90YXRpb25RdWF0ZXJuaW9uLCAgLy8vXG4gICAgICAgIGZpcnN0Um90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gZmlyc3Qocm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCA9IHNlY29uZChyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzKSxcbiAgICAgICAgdGhpcmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQgPSB0aGlyZChyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzKSxcbiAgICAgICAgZm91cnRoUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gZm91cnRoKHJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMpLFxuICAgICAgICBpbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uID0gW1xuICAgICAgICAgIGZpcnN0Um90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50LFxuICAgICAgICAgIC1zZWNvbmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQsXG4gICAgICAgICAgLXRoaXJkUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50LFxuICAgICAgICAgIC1mb3VydGhSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRcbiAgICAgICAgXTtcblxuICByZXR1cm4gaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24ocm90YXRpb25RdWF0ZXJuaW9uKSB7XG4gIGNvbnN0IGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gcm90YXRpb25RdWF0ZXJuaW9uOyAgLy8vXG5cbiAgcmV0dXJuIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24ocm90YXRpb25RdWF0ZXJuaW9uKSB7XG4gIGNvbnN0IGludmVyc2VSb3RhdGlvblF1YXRlcm5pb24gPSBjYWxjdWxhdGVJbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbiksXG4gICAgICAgIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiA9IGludmVyc2VSb3RhdGlvblF1YXRlcm5pb247ICAvLy9cblxuICByZXR1cm4gYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xuXG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbihub3JtYWwpIHtcbiAgY29uc3QgZXh0ZW50ID0gbm9ybWFsLmdldEV4dGVudCgpLFxuICAgICAgICB1bml0Tm9ybWFsID0gZXh0ZW50LCAgLy8vXG4gICAgICAgIHpBeGlzID0gWyAwLCAwLCAxIF0sXG4gICAgICAgIGRvdFByb2R1Y3RPZlVuaXROb3JtYWxBbmRaQXhpcyA9IGRvdDModW5pdE5vcm1hbCwgekF4aXMpLFxuICAgICAgICBjcm9zc1Byb2R1Y3RPZlVuaXROb3JtYWxBbmRaQXhpcyA9IGNyb3NzMyh1bml0Tm9ybWFsLCB6QXhpcyksXG4gICAgICAgIGFuZ2xlT2ZSb3RhdGlvbkNvc2luZSA9IGRvdFByb2R1Y3RPZlVuaXROb3JtYWxBbmRaQXhpcywgLy8vXG4gICAgICAgIGFuZ2xlT2ZSb3RhdGlvbkNvc2luZUFic29sdXRlVmFsdWUgPSBNYXRoLmFicyhhbmdsZU9mUm90YXRpb25Db3NpbmUpLFxuICAgICAgICBhbmdsZU9mUm90YXRpb25Db3NpbmVBYnNvbHV0ZVZhbHVlQXBwcm94aW1hdGVseUVxdWFsVG9PbmUgPSBpc0FwcHJveGltYXRlbHlFcXVhbFRvT25lKGFuZ2xlT2ZSb3RhdGlvbkNvc2luZUFic29sdXRlVmFsdWUpLFxuICAgICAgICBheGlzT2ZSb3RhdGlvbiA9IGFuZ2xlT2ZSb3RhdGlvbkNvc2luZUFic29sdXRlVmFsdWVBcHByb3hpbWF0ZWx5RXF1YWxUb09uZSA/XG4gICAgICAgICAgICAgICAgICAgICAgICAgIFsgMSwgMCwgMCBdIDogLy8vXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3Jvc3NQcm9kdWN0T2ZVbml0Tm9ybWFsQW5kWkF4aXMsXG4gICAgICAgIHVuaXRBeGlzT2ZSb3RhdGlvbiA9IG5vcm1hbGlzZTMoYXhpc09mUm90YXRpb24pLFxuICAgICAgICBoYWxmQW5nbGVPZlJvdGF0aW9uQ29zaW5lID0gY2FsY3VsYXRlSGFsZkFuZ2xlQ29zaW5lKGFuZ2xlT2ZSb3RhdGlvbkNvc2luZSksXG4gICAgICAgIGhhbGZBbmdsZU9mUm90YXRpb25TaW5lID0gY2FsY3VsYXRlSGFsZkFuZ2xlU2luZShhbmdsZU9mUm90YXRpb25Db3NpbmUpLFxuICAgICAgICB1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzID0gdW5pdEF4aXNPZlJvdGF0aW9uLCAgLy8vXG4gICAgICAgIGZpcnN0QXhpc09mUm90YXRpb25Db21wb25lbnQgPSBmaXJzdCh1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgc2Vjb25kQXhpc09mUm90YXRpb25Db21wb25lbnQgPSBzZWNvbmQodW5pdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50cyksXG4gICAgICAgIHRoaXJkQXhpc09mUm90YXRpb25Db21wb25lbnQgPSB0aGlyZCh1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgYXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uID0gW1xuICAgICAgICAgIGhhbGZBbmdsZU9mUm90YXRpb25Db3NpbmUsXG4gICAgICAgICAgZmlyc3RBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCAqIGhhbGZBbmdsZU9mUm90YXRpb25TaW5lLFxuICAgICAgICAgIHNlY29uZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ICogaGFsZkFuZ2xlT2ZSb3RhdGlvblNpbmUsXG4gICAgICAgICAgdGhpcmRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCAqIGhhbGZBbmdsZU9mUm90YXRpb25TaW5lXG4gICAgICAgIF07XG5cbiAgcmV0dXJuIGFyYml0cmFyeVJvdGF0aW9uUXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlUm90YXRpb25BYm91dFpBeGlzUXVhdGVybmlvbihtYXNraW5nRWRnZSkge1xuICBjb25zdCBtYXNraW5nRWRnZUV4dGVudCA9IG1hc2tpbmdFZGdlLmdldEV4dGVudCgpLFxuICAgICAgICB1bml0TWFza2luZ0VkZ2VFeHRlbnQgPSBub3JtYWxpc2UzKG1hc2tpbmdFZGdlRXh0ZW50KSxcbiAgICAgICAgdW5pdE1hc2tpbmdFZGdlRXh0ZW50Q29tcG9uZW50cyA9IHVuaXRNYXNraW5nRWRnZUV4dGVudCwgIC8vL1xuICAgICAgICBmaXJzdFVuaXRNYXNraW5nRWRnZUV4dGVudENvbXBvbmVudCA9IGZpcnN0KHVuaXRNYXNraW5nRWRnZUV4dGVudENvbXBvbmVudHMpLFxuICAgICAgICBzZWNvbmRVbml0TWFza2luZ0VkZ2VFeHRlbnRDb21wb25lbnQgPSBzZWNvbmQodW5pdE1hc2tpbmdFZGdlRXh0ZW50Q29tcG9uZW50cyksXG4gICAgICAgIGFuZ2xlT2ZSb3RhdGlvblNpbmUgPSBmaXJzdFVuaXRNYXNraW5nRWRnZUV4dGVudENvbXBvbmVudCwgIC8vL1xuICAgICAgICBhbmdsZU9mUm90YXRpb25Db3NpbmUgPSBzZWNvbmRVbml0TWFza2luZ0VkZ2VFeHRlbnRDb21wb25lbnQsICAvLy9cbiAgICAgICAgaGFsZkFuZ2xlT2ZSb3RhdGlvbkNvc2luZSA9IGNhbGN1bGF0ZUhhbGZBbmdsZUNvc2luZShhbmdsZU9mUm90YXRpb25Db3NpbmUpLFxuICAgICAgICBoYWxmQW5nbGVPZlJvdGF0aW9uU2luZSA9IChhbmdsZU9mUm90YXRpb25TaW5lID4gMCApID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgK2NhbGN1bGF0ZUhhbGZBbmdsZVNpbmUoYW5nbGVPZlJvdGF0aW9uQ29zaW5lKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLWNhbGN1bGF0ZUhhbGZBbmdsZVNpbmUoYW5nbGVPZlJvdGF0aW9uQ29zaW5lKSxcbiAgICAgICAgcm90YXRpb25BYm91dFpBeGlzUXVhdGVybmlvbiA9IFtcbiAgICAgICAgICBoYWxmQW5nbGVPZlJvdGF0aW9uQ29zaW5lLFxuICAgICAgICAgIDAsXG4gICAgICAgICAgMCxcbiAgICAgICAgICBoYWxmQW5nbGVPZlJvdGF0aW9uU2luZVxuICAgICAgICBdO1xuXG4gIHJldHVybiByb3RhdGlvbkFib3V0WkF4aXNRdWF0ZXJuaW9uO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgcm90YXRlSW1hZ2luYXJ5UXVhdGVybmlvbixcbiAgY2FsY3VsYXRlSW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbixcbiAgY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24sXG4gIGNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbixcbiAgY2FsY3VsYXRlQXJiaXRyYXJ5Um90YXRpb25RdWF0ZXJuaW9uLFxuICBjYWxjdWxhdGVSb3RhdGlvbkFib3V0WkF4aXNRdWF0ZXJuaW9uXG59O1xuXG5mdW5jdGlvbiBoYW1pbHRvblByb2R1Y3QocXVhdGVybmlvbkEsIHF1YXRlcm5pb25CKSB7XG4gIGNvbnN0IGExID0gcXVhdGVybmlvbkFbMF0sXG4gICAgICAgIGIxID0gcXVhdGVybmlvbkFbMV0sXG4gICAgICAgIGMxID0gcXVhdGVybmlvbkFbMl0sXG4gICAgICAgIGQxID0gcXVhdGVybmlvbkFbM10sXG4gICAgICAgIGEyID0gcXVhdGVybmlvbkJbMF0sXG4gICAgICAgIGIyID0gcXVhdGVybmlvbkJbMV0sXG4gICAgICAgIGMyID0gcXVhdGVybmlvbkJbMl0sXG4gICAgICAgIGQyID0gcXVhdGVybmlvbkJbM10sXG4gICAgICAgIGEgPSBhMSAqIGEyIC0gYjEgKiBiMiAtIGMxICogYzIgLSBkMSAqIGQyLFxuICAgICAgICBiID0gYTEgKiBiMiArIGIxICogYTIgKyBjMSAqIGQyIC0gZDEgKiBjMixcbiAgICAgICAgYyA9IGExICogYzIgLSBiMSAqIGQyICsgYzEgKiBhMiArIGQxICogYjIsXG4gICAgICAgIGQgPSBhMSAqIGQyICsgYjEgKiBjMiAtIGMxICogYjIgKyBkMSAqIGEyLFxuICAgICAgICBxdWF0ZXJuaW9uID0gWyBhLCBiLCBjLCBkIF07XG5cbiAgcmV0dXJuIHF1YXRlcm5pb247XG59XG4iXX0=