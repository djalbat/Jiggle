'use strict';

var arrayUtilities = require('../utilities/array'),
    angleUtilities = require('../utilities/angle'),
    vectorUtilities = require('../utilities/vector');

var normalise3 = vectorUtilities.normalise3,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    fourth = arrayUtilities.fourth,
    calculateHalfAngleCosine = angleUtilities.calculateHalfAngleCosine,
    calculateHalfAngleSine = angleUtilities.calculateHalfAngleSine;


function rotateImaginaryQuaternion(imaginaryQuaternion, rotationQuaternion, inverseRotationQuaternion) {
  var rotatedImaginaryQuaternion = hamiltonProduct(hamiltonProduct(rotationQuaternion, imaginaryQuaternion), inverseRotationQuaternion);

  return rotatedImaginaryQuaternion;
}

function calculateRotationQuaternion(normal) {
  var angleCosineBetweenNormalAndZAxis = calculateAngleCosineBetweenNormalAndZAxis(normal),
      crossProductOfNormalWithZAxis = calculateCrossProductOfNormalWithZAxis(normal),
      angleOfRotationCosine = angleCosineBetweenNormalAndZAxis,
      angleOfRotationCosineAbsoluteValue = Math.abs(angleOfRotationCosine),
      axisOfRotation = angleOfRotationCosineAbsoluteValue === 1 ? [1, 0, 0] : ///
  crossProductOfNormalWithZAxis,
      unitAxisOfRotation = normalise3(axisOfRotation),
      halfAngleOfRotationCosine = calculateHalfAngleCosine(angleOfRotationCosine),
      halfAngleOfRotationSine = calculateHalfAngleSine(angleOfRotationCosine),
      unitAxisOfRotationComponents = unitAxisOfRotation,
      ///
  firstAxisOfRotationComponent = first(unitAxisOfRotationComponents),
      secondAxisOfRotationComponent = second(unitAxisOfRotationComponents),
      thirdAxisOfRotationComponent = third(unitAxisOfRotationComponents),
      rotationQuaternion = [halfAngleOfRotationCosine, firstAxisOfRotationComponent * halfAngleOfRotationSine, secondAxisOfRotationComponent * halfAngleOfRotationSine, thirdAxisOfRotationComponent * halfAngleOfRotationSine];

  return rotationQuaternion;
}

function calculateInverseRotationQuaternion(rotationQuaternion) {
  var rotationQuaternionComponents = rotationQuaternion,
      ///
  firstRotationQuaternionComponent = first(rotationQuaternionComponents),
      secondRotationQuaternionComponent = second(rotationQuaternionComponents),
      thirdRotationQuaternionComponent = third(rotationQuaternionComponents),
      fourthRotationQuaternionComponent = fourth(rotationQuaternionComponents),
      inverseRotationQuaternion = [firstRotationQuaternionComponent, -secondRotationQuaternionComponent, -thirdRotationQuaternionComponent, -fourthRotationQuaternionComponent];

  return inverseRotationQuaternion;
}

function calculateForwardsRotationQuaternion(rotationQuaternion) {
  var forwardsRotationQuaternion = rotationQuaternion.slice();

  return forwardsRotationQuaternion;
}

function calculateBackwardsRotationQuaternion(rotationQuaternion) {
  var rotationQuaternionComponents = rotationQuaternion.slice(),
      ///
  backwardsRotationQuaternionComponents = rotationQuaternionComponents.map(function (rotationQuaternionComponent, index) {
    var backwardsRotationQuaternionComponent = index < 1 ? ///
    +rotationQuaternionComponent : -rotationQuaternionComponent;

    return backwardsRotationQuaternionComponent;
  }),
      backwardsRotationQuaternion = backwardsRotationQuaternionComponents;

  return backwardsRotationQuaternion;
}

module.exports = {
  rotateImaginaryQuaternion: rotateImaginaryQuaternion,
  calculateRotationQuaternion: calculateRotationQuaternion,
  calculateInverseRotationQuaternion: calculateInverseRotationQuaternion,
  calculateForwardsRotationQuaternion: calculateForwardsRotationQuaternion,
  calculateBackwardsRotationQuaternion: calculateBackwardsRotationQuaternion
};

function calculateAngleCosineBetweenNormalAndZAxis(normal) {
  var unitNormal = normalise3(normal),
      unitNormalComponents = unitNormal,
      ///
  thirdUnitNormalComponent = third(unitNormalComponents),
      angleCosineBetweenNormalAndZAxis = thirdUnitNormalComponent; ///

  return angleCosineBetweenNormalAndZAxis;
}

function calculateCrossProductOfNormalWithZAxis(normal) {
  var normalComponents = normal,
      ///
  firstNormalComponent = first(normalComponents),
      secondNormalComponent = second(normalComponents),
      crossProductOfNormalWithZAxis = [+secondNormalComponent, -firstNormalComponent, 0];

  return crossProductOfNormalWithZAxis;
}

function hamiltonProduct(quaternionA, quaternionB) {
  var quaternionAComponents = quaternionA,
      ///
  quaternionBComponents = quaternionB,
      ///
  firstQuaternionAComponent = first(quaternionAComponents),
      secondQuaternionAComponent = second(quaternionAComponents),
      thirdQuaternionAComponent = third(quaternionAComponents),
      fourthQuaternionAComponent = fourth(quaternionAComponents),
      firstQuaternionBComponent = first(quaternionBComponents),
      secondQuaternionBComponent = second(quaternionBComponents),
      thirdQuaternionBComponent = third(quaternionBComponents),
      fourthQuaternionBComponent = fourth(quaternionBComponents),
      a1 = firstQuaternionAComponent,
      b1 = secondQuaternionAComponent,
      c1 = thirdQuaternionAComponent,
      d1 = fourthQuaternionAComponent,
      a2 = firstQuaternionBComponent,
      b2 = secondQuaternionBComponent,
      c2 = thirdQuaternionBComponent,
      d2 = fourthQuaternionBComponent,
      a = a1 * a2 - b1 * b2 - c1 * c2 - d1 * d2,
      b = a1 * b2 + b1 * a2 + c1 * d2 - d1 * c2,
      c = a1 * c2 - b1 * d2 + c1 * a2 + d1 * b2,
      d = a1 * d2 + b1 * c2 - c1 * b2 + d1 * a2,
      quaternion = [a, b, c, d];

  return quaternion;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2VzNi91dGlsaXRpZXMvcXVhdGVybmlvbi5qcyJdLCJuYW1lcyI6WyJhcnJheVV0aWxpdGllcyIsInJlcXVpcmUiLCJhbmdsZVV0aWxpdGllcyIsInZlY3RvclV0aWxpdGllcyIsIm5vcm1hbGlzZTMiLCJmaXJzdCIsInNlY29uZCIsInRoaXJkIiwiZm91cnRoIiwiY2FsY3VsYXRlSGFsZkFuZ2xlQ29zaW5lIiwiY2FsY3VsYXRlSGFsZkFuZ2xlU2luZSIsInJvdGF0ZUltYWdpbmFyeVF1YXRlcm5pb24iLCJpbWFnaW5hcnlRdWF0ZXJuaW9uIiwicm90YXRpb25RdWF0ZXJuaW9uIiwiaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbiIsInJvdGF0ZWRJbWFnaW5hcnlRdWF0ZXJuaW9uIiwiaGFtaWx0b25Qcm9kdWN0IiwiY2FsY3VsYXRlUm90YXRpb25RdWF0ZXJuaW9uIiwibm9ybWFsIiwiYW5nbGVDb3NpbmVCZXR3ZWVuTm9ybWFsQW5kWkF4aXMiLCJjYWxjdWxhdGVBbmdsZUNvc2luZUJldHdlZW5Ob3JtYWxBbmRaQXhpcyIsImNyb3NzUHJvZHVjdE9mTm9ybWFsV2l0aFpBeGlzIiwiY2FsY3VsYXRlQ3Jvc3NQcm9kdWN0T2ZOb3JtYWxXaXRoWkF4aXMiLCJhbmdsZU9mUm90YXRpb25Db3NpbmUiLCJhbmdsZU9mUm90YXRpb25Db3NpbmVBYnNvbHV0ZVZhbHVlIiwiTWF0aCIsImFicyIsImF4aXNPZlJvdGF0aW9uIiwidW5pdEF4aXNPZlJvdGF0aW9uIiwiaGFsZkFuZ2xlT2ZSb3RhdGlvbkNvc2luZSIsImhhbGZBbmdsZU9mUm90YXRpb25TaW5lIiwidW5pdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50cyIsImZpcnN0QXhpc09mUm90YXRpb25Db21wb25lbnQiLCJzZWNvbmRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCIsInRoaXJkQXhpc09mUm90YXRpb25Db21wb25lbnQiLCJjYWxjdWxhdGVJbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uIiwicm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyIsImZpcnN0Um90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50Iiwic2Vjb25kUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50IiwidGhpcmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJmb3VydGhSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uUXVhdGVybmlvbiIsImZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uIiwic2xpY2UiLCJjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzIiwibWFwIiwicm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50IiwiaW5kZXgiLCJiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQiLCJiYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24iLCJtb2R1bGUiLCJleHBvcnRzIiwidW5pdE5vcm1hbCIsInVuaXROb3JtYWxDb21wb25lbnRzIiwidGhpcmRVbml0Tm9ybWFsQ29tcG9uZW50Iiwibm9ybWFsQ29tcG9uZW50cyIsImZpcnN0Tm9ybWFsQ29tcG9uZW50Iiwic2Vjb25kTm9ybWFsQ29tcG9uZW50IiwicXVhdGVybmlvbkEiLCJxdWF0ZXJuaW9uQiIsInF1YXRlcm5pb25BQ29tcG9uZW50cyIsInF1YXRlcm5pb25CQ29tcG9uZW50cyIsImZpcnN0UXVhdGVybmlvbkFDb21wb25lbnQiLCJzZWNvbmRRdWF0ZXJuaW9uQUNvbXBvbmVudCIsInRoaXJkUXVhdGVybmlvbkFDb21wb25lbnQiLCJmb3VydGhRdWF0ZXJuaW9uQUNvbXBvbmVudCIsImZpcnN0UXVhdGVybmlvbkJDb21wb25lbnQiLCJzZWNvbmRRdWF0ZXJuaW9uQkNvbXBvbmVudCIsInRoaXJkUXVhdGVybmlvbkJDb21wb25lbnQiLCJmb3VydGhRdWF0ZXJuaW9uQkNvbXBvbmVudCIsImExIiwiYjEiLCJj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TCxHQUFVTixLQUFLSyxFQUFmLEdBQW9CSixLQUFLRyxFQUF6QixHQUE4QkYsS0FBS0MsRUFyQjdDO0FBQUEsTUFzQk1RLGFBQWEsQ0FBRUosQ0FBRixFQUFLQyxDQUFMLEVBQVFDLENBQVIsRUFBV0MsQ0FBWCxDQXRCbkI7O0FBd0JBLFNBQU9DLFVBQVA7QUFDRCIsImZpbGUiOiJxdWF0ZXJuaW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgYW5nbGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuLi91dGlsaXRpZXMvYW5nbGUnKSxcbiAgICAgIHZlY3RvclV0aWxpdGllcyA9IHJlcXVpcmUoJy4uL3V0aWxpdGllcy92ZWN0b3InKTtcblxuY29uc3QgeyBub3JtYWxpc2UzIH0gPSB2ZWN0b3JVdGlsaXRpZXMsXG4gICAgICB7IGZpcnN0LCBzZWNvbmQsIHRoaXJkLCBmb3VydGggfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVIYWxmQW5nbGVDb3NpbmUsIGNhbGN1bGF0ZUhhbGZBbmdsZVNpbmUgfSA9IGFuZ2xlVXRpbGl0aWVzO1xuXG5mdW5jdGlvbiByb3RhdGVJbWFnaW5hcnlRdWF0ZXJuaW9uKGltYWdpbmFyeVF1YXRlcm5pb24sIHJvdGF0aW9uUXVhdGVybmlvbiwgaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbikge1xuICBjb25zdCByb3RhdGVkSW1hZ2luYXJ5UXVhdGVybmlvbiA9IGhhbWlsdG9uUHJvZHVjdChoYW1pbHRvblByb2R1Y3Qocm90YXRpb25RdWF0ZXJuaW9uLCBpbWFnaW5hcnlRdWF0ZXJuaW9uKSwgaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbik7XG5cbiAgcmV0dXJuIHJvdGF0ZWRJbWFnaW5hcnlRdWF0ZXJuaW9uO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVSb3RhdGlvblF1YXRlcm5pb24obm9ybWFsKSB7XG4gIGNvbnN0IGFuZ2xlQ29zaW5lQmV0d2Vlbk5vcm1hbEFuZFpBeGlzID0gY2FsY3VsYXRlQW5nbGVDb3NpbmVCZXR3ZWVuTm9ybWFsQW5kWkF4aXMobm9ybWFsKSxcbiAgICAgICAgY3Jvc3NQcm9kdWN0T2ZOb3JtYWxXaXRoWkF4aXMgPSBjYWxjdWxhdGVDcm9zc1Byb2R1Y3RPZk5vcm1hbFdpdGhaQXhpcyhub3JtYWwpLFxuICAgICAgICBhbmdsZU9mUm90YXRpb25Db3NpbmUgPSBhbmdsZUNvc2luZUJldHdlZW5Ob3JtYWxBbmRaQXhpcyxcbiAgICAgICAgYW5nbGVPZlJvdGF0aW9uQ29zaW5lQWJzb2x1dGVWYWx1ZSA9IE1hdGguYWJzKGFuZ2xlT2ZSb3RhdGlvbkNvc2luZSksXG4gICAgICAgIGF4aXNPZlJvdGF0aW9uID0gKGFuZ2xlT2ZSb3RhdGlvbkNvc2luZUFic29sdXRlVmFsdWUgPT09IDEpID9cbiAgICAgICAgICAgICAgICAgICAgICAgICAgIFsxLCAwLCAwXSA6IC8vL1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcm9zc1Byb2R1Y3RPZk5vcm1hbFdpdGhaQXhpcyxcbiAgICAgICAgdW5pdEF4aXNPZlJvdGF0aW9uID0gbm9ybWFsaXNlMyhheGlzT2ZSb3RhdGlvbiksXG4gICAgICAgIGhhbGZBbmdsZU9mUm90YXRpb25Db3NpbmUgPSBjYWxjdWxhdGVIYWxmQW5nbGVDb3NpbmUoYW5nbGVPZlJvdGF0aW9uQ29zaW5lKSxcbiAgICAgICAgaGFsZkFuZ2xlT2ZSb3RhdGlvblNpbmUgPSBjYWxjdWxhdGVIYWxmQW5nbGVTaW5lKGFuZ2xlT2ZSb3RhdGlvbkNvc2luZSksXG4gICAgICAgIHVuaXRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudHMgPSB1bml0QXhpc09mUm90YXRpb24sICAvLy9cbiAgICAgICAgZmlyc3RBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCA9IGZpcnN0KHVuaXRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudHMpLFxuICAgICAgICBzZWNvbmRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCA9IHNlY29uZCh1bml0QXhpc09mUm90YXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgdGhpcmRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudCA9IHRoaXJkKHVuaXRBeGlzT2ZSb3RhdGlvbkNvbXBvbmVudHMpLFxuICAgICAgICByb3RhdGlvblF1YXRlcm5pb24gPSBbXG4gICAgICAgICAgaGFsZkFuZ2xlT2ZSb3RhdGlvbkNvc2luZSxcbiAgICAgICAgICBmaXJzdEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ICogaGFsZkFuZ2xlT2ZSb3RhdGlvblNpbmUsXG4gICAgICAgICAgc2Vjb25kQXhpc09mUm90YXRpb25Db21wb25lbnQgKiBoYWxmQW5nbGVPZlJvdGF0aW9uU2luZSxcbiAgICAgICAgICB0aGlyZEF4aXNPZlJvdGF0aW9uQ29tcG9uZW50ICogaGFsZkFuZ2xlT2ZSb3RhdGlvblNpbmVcbiAgICAgICAgXTtcblxuICByZXR1cm4gcm90YXRpb25RdWF0ZXJuaW9uO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVJbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uKHJvdGF0aW9uUXVhdGVybmlvbikge1xuICBjb25zdCByb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzID0gcm90YXRpb25RdWF0ZXJuaW9uLCAgLy8vXG4gICAgICAgIGZpcnN0Um90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gZmlyc3Qocm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZFJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudCA9IHNlY29uZChyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzKSxcbiAgICAgICAgdGhpcmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQgPSB0aGlyZChyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzKSxcbiAgICAgICAgZm91cnRoUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gZm91cnRoKHJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMpLFxuICAgICAgICBpbnZlcnNlUm90YXRpb25RdWF0ZXJuaW9uID0gW1xuICAgICAgICAgIGZpcnN0Um90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50LFxuICAgICAgICAgIC1zZWNvbmRSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQsXG4gICAgICAgICAgLXRoaXJkUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50LFxuICAgICAgICAgIC1mb3VydGhSb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRcbiAgICAgICAgXTtcblxuICByZXR1cm4gaW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbjtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb24ocm90YXRpb25RdWF0ZXJuaW9uKSB7XG4gIGNvbnN0IGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gcm90YXRpb25RdWF0ZXJuaW9uLnNsaWNlKCk7XG5cbiAgcmV0dXJuIGZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb24ocm90YXRpb25RdWF0ZXJuaW9uKSB7XG4gIGNvbnN0IHJvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMgPSByb3RhdGlvblF1YXRlcm5pb24uc2xpY2UoKSwgLy8vXG4gICAgICAgIGJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvbkNvbXBvbmVudHMgPSByb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnRzLm1hcChmdW5jdGlvbihyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQsIGluZGV4KSB7XG4gICAgICAgICAgY29uc3QgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50ID0gKGluZGV4IDwgMSkgPyAgLy8vXG4gICAgICAgICAgICAgICtyb3RhdGlvblF1YXRlcm5pb25Db21wb25lbnQgOlxuICAgICAgICAgICAgICAtcm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50O1xuICBcbiAgICAgICAgICByZXR1cm4gYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50O1xuICAgICAgICB9KSxcbiAgICAgICAgYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uID0gYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uQ29tcG9uZW50cztcblxuICByZXR1cm4gYmFja3dhcmRzUm90YXRpb25RdWF0ZXJuaW9uO1xuXG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICByb3RhdGVJbWFnaW5hcnlRdWF0ZXJuaW9uOiByb3RhdGVJbWFnaW5hcnlRdWF0ZXJuaW9uLFxuICBjYWxjdWxhdGVSb3RhdGlvblF1YXRlcm5pb246IGNhbGN1bGF0ZVJvdGF0aW9uUXVhdGVybmlvbixcbiAgY2FsY3VsYXRlSW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbjogY2FsY3VsYXRlSW52ZXJzZVJvdGF0aW9uUXVhdGVybmlvbixcbiAgY2FsY3VsYXRlRm9yd2FyZHNSb3RhdGlvblF1YXRlcm5pb246IGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25RdWF0ZXJuaW9uLFxuICBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvblF1YXRlcm5pb246IGNhbGN1bGF0ZUJhY2t3YXJkc1JvdGF0aW9uUXVhdGVybmlvblxufTtcblxuZnVuY3Rpb24gY2FsY3VsYXRlQW5nbGVDb3NpbmVCZXR3ZWVuTm9ybWFsQW5kWkF4aXMobm9ybWFsKSB7XG4gIGNvbnN0IHVuaXROb3JtYWwgPSBub3JtYWxpc2UzKG5vcm1hbCksXG4gICAgICAgIHVuaXROb3JtYWxDb21wb25lbnRzID0gdW5pdE5vcm1hbCwgIC8vL1xuICAgICAgICB0aGlyZFVuaXROb3JtYWxDb21wb25lbnQgPSB0aGlyZCh1bml0Tm9ybWFsQ29tcG9uZW50cyksXG4gICAgICAgIGFuZ2xlQ29zaW5lQmV0d2Vlbk5vcm1hbEFuZFpBeGlzID0gdGhpcmRVbml0Tm9ybWFsQ29tcG9uZW50OyAgLy8vXG5cbiAgcmV0dXJuIGFuZ2xlQ29zaW5lQmV0d2Vlbk5vcm1hbEFuZFpBeGlzO1xufVxuXG5mdW5jdGlvbiBjYWxjdWxhdGVDcm9zc1Byb2R1Y3RPZk5vcm1hbFdpdGhaQXhpcyhub3JtYWwpIHtcbiAgY29uc3Qgbm9ybWFsQ29tcG9uZW50cyA9IG5vcm1hbCwgIC8vL1xuICAgICAgICBmaXJzdE5vcm1hbENvbXBvbmVudCA9IGZpcnN0KG5vcm1hbENvbXBvbmVudHMpLFxuICAgICAgICBzZWNvbmROb3JtYWxDb21wb25lbnQgPSBzZWNvbmQobm9ybWFsQ29tcG9uZW50cyksXG4gICAgICAgIGNyb3NzUHJvZHVjdE9mTm9ybWFsV2l0aFpBeGlzID0gW1xuICAgICAgICAgICtzZWNvbmROb3JtYWxDb21wb25lbnQsXG4gICAgICAgICAgLWZpcnN0Tm9ybWFsQ29tcG9uZW50LFxuICAgICAgICAgIDBcbiAgICAgICAgXTtcblxuICByZXR1cm4gY3Jvc3NQcm9kdWN0T2ZOb3JtYWxXaXRoWkF4aXM7XG59XG5cbmZ1bmN0aW9uIGhhbWlsdG9uUHJvZHVjdChxdWF0ZXJuaW9uQSwgcXVhdGVybmlvbkIpIHtcbiAgY29uc3QgcXVhdGVybmlvbkFDb21wb25lbnRzID0gcXVhdGVybmlvbkEsICAvLy9cbiAgICAgICAgcXVhdGVybmlvbkJDb21wb25lbnRzID0gcXVhdGVybmlvbkIsICAvLy9cbiAgICAgICAgZmlyc3RRdWF0ZXJuaW9uQUNvbXBvbmVudCA9IGZpcnN0KHF1YXRlcm5pb25BQ29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZFF1YXRlcm5pb25BQ29tcG9uZW50ID0gc2Vjb25kKHF1YXRlcm5pb25BQ29tcG9uZW50cyksXG4gICAgICAgIHRoaXJkUXVhdGVybmlvbkFDb21wb25lbnQgPSB0aGlyZChxdWF0ZXJuaW9uQUNvbXBvbmVudHMpLFxuICAgICAgICBmb3VydGhRdWF0ZXJuaW9uQUNvbXBvbmVudCA9IGZvdXJ0aChxdWF0ZXJuaW9uQUNvbXBvbmVudHMpLFxuICAgICAgICBmaXJzdFF1YXRlcm5pb25CQ29tcG9uZW50ID0gZmlyc3QocXVhdGVybmlvbkJDb21wb25lbnRzKSxcbiAgICAgICAgc2Vjb25kUXVhdGVybmlvbkJDb21wb25lbnQgPSBzZWNvbmQocXVhdGVybmlvbkJDb21wb25lbnRzKSxcbiAgICAgICAgdGhpcmRRdWF0ZXJuaW9uQkNvbXBvbmVudCA9IHRoaXJkKHF1YXRlcm5pb25CQ29tcG9uZW50cyksXG4gICAgICAgIGZvdXJ0aFF1YXRlcm5pb25CQ29tcG9uZW50ID0gZm91cnRoKHF1YXRlcm5pb25CQ29tcG9uZW50cyksXG4gICAgICAgIGExID0gZmlyc3RRdWF0ZXJuaW9uQUNvbXBvbmVudCxcbiAgICAgICAgYjEgPSBzZWNvbmRRdWF0ZXJuaW9uQUNvbXBvbmVudCxcbiAgICAgICAgYzEgPSB0aGlyZFF1YXRlcm5pb25BQ29tcG9uZW50LFxuICAgICAgICBkMSA9IGZvdXJ0aFF1YXRlcm5pb25BQ29tcG9uZW50LFxuICAgICAgICBhMiA9IGZpcnN0UXVhdGVybmlvbkJDb21wb25lbnQsXG4gICAgICAgIGIyID0gc2Vjb25kUXVhdGVybmlvbkJDb21wb25lbnQsXG4gICAgICAgIGMyID0gdGhpcmRRdWF0ZXJuaW9uQkNvbXBvbmVudCxcbiAgICAgICAgZDIgPSBmb3VydGhRdWF0ZXJuaW9uQkNvbXBvbmVudCxcbiAgICAgICAgYSA9IGExICogYTIgLSBiMSAqIGIyIC0gYzEgKiBjMiAtIGQxICogZDIsXG4gICAgICAgIGIgPSBhMSAqIGIyICsgYjEgKiBhMiArIGMxICogZDIgLSBkMSAqIGMyLFxuICAgICAgICBjID0gYTEgKiBjMiAtIGIxICogZDIgKyBjMSAqIGEyICsgZDEgKiBiMixcbiAgICAgICAgZCA9IGExICogZDIgKyBiMSAqIGMyIC0gYzEgKiBiMiArIGQxICogYTIsXG4gICAgICAgIHF1YXRlcm5pb24gPSBbIGEsIGIsIGMsIGQgXTtcblxuICByZXR1cm4gcXVhdGVybmlvbjtcbn1cbiJdfQ==