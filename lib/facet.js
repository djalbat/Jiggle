'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Edge = require('./edge'),
    Normal = require('./normal'),
    Vertex = require('./vertex'),
    constants = require('./constants'),
    facetUtilities = require('./utilities/facet'),
    arrayUtilities = require('./utilities/array'),
    midPointUtilities = require('./utilities/midPoint'),
    approximateUtilities = require('./utilities/approximate'),
    intersectionUtilities = require('./utilities/intersection');

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    push = arrayUtilities.push,
    _permute = arrayUtilities.permute,
    isApproximatelyEqualToZero = approximateUtilities.isApproximatelyEqualToZero,
    calculateEdges = facetUtilities.calculateEdges,
    calculateNormal = facetUtilities.calculateNormal,
    calculateArea = facetUtilities.calculateArea,
    calculateMidPointPosition = midPointUtilities.calculateMidPointPosition,
    isMidPointPositionToOneSideOfMaskingEdges = midPointUtilities.isMidPointPositionToOneSideOfMaskingEdges,
    calculateIntermediateVertexPosition = intersectionUtilities.calculateIntermediateVertexPosition,
    calculateNonNullIntersections = intersectionUtilities.calculateNonNullIntersections,
    calculateNullIntersectionIndex = intersectionUtilities.calculateNullIntersectionIndex,
    calculateNonNullIntersectionIndex = intersectionUtilities.calculateNonNullIntersectionIndex;

var Facet = function () {
  function Facet(vertices, normal, edges) {
    _classCallCheck(this, Facet);

    this.vertices = vertices;
    this.normal = normal;
    this.edges = edges;
  }

  _createClass(Facet, [{
    key: 'getVertices',
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: 'getNormal',
    value: function getNormal() {
      return this.normal;
    }
  }, {
    key: 'getEdges',
    value: function getEdges() {
      return this.edges;
    }
  }, {
    key: 'getVertexPositions',
    value: function getVertexPositions() {
      var vertexPositions = this.vertices.map(function (vertex) {
        return vertex.getPosition();
      });

      return vertexPositions;
    }
  }, {
    key: 'getVertexNormals',
    value: function getVertexNormals() {
      var extent = this.normal.getExtent(),
          vertexNormal = extent,
          ///
      vertexNormals = [vertexNormal, vertexNormal, vertexNormal];

      return vertexNormals;
    }
  }, {
    key: 'getVertexIndexes',
    value: function getVertexIndexes(index) {
      ///
      var vertexIndex = index * 3,
          vertexIndexes = [vertexIndex + 0, vertexIndex + 1, vertexIndex + 2];

      return vertexIndexes;
    }
  }, {
    key: 'isTooSmall',
    value: function isTooSmall() {
      var area = calculateArea(this.vertices),
          areaApproximatelyEqualToZero = isApproximatelyEqualToZero(area),
          tooSmall = areaApproximatelyEqualToZero; ///

      return tooSmall;
    }
  }, {
    key: 'isMasked',
    value: function isMasked(maskingFacet) {
      var maskingEdges = maskingFacet.getMaskingEdges(),
          midPointPosition = calculateMidPointPosition(this.vertices),
          midPointPositionToOneSideOfMaskingEdges = isMidPointPositionToOneSideOfMaskingEdges(midPointPosition, maskingEdges),
          masked = midPointPositionToOneSideOfMaskingEdges; ///

      return masked;
    }
  }, {
    key: 'permute',
    value: function permute(places) {
      this.vertices = _permute(this.vertices, places);

      this.normal = calculateNormal(this.vertices, Normal);

      this.edges = calculateEdges(this.vertices, Edge);
    }
  }, {
    key: 'rotate',
    value: function rotate(rotationQuaternion) {
      this.vertices.forEach(function (vertex) {
        return vertex.rotate(rotationQuaternion);
      });

      this.normal = calculateNormal(this.vertices, Normal);

      this.edges = calculateEdges(this.vertices, Edge);
    }
  }, {
    key: 'applyTransforms',
    value: function applyTransforms(transforms) {
      this.vertices.forEach(function (vertex) {
        return vertex.applyTransforms(transforms);
      });

      this.normal = calculateNormal(this.vertices, Normal);

      this.edges = calculateEdges(this.vertices, Edge);
    }
  }, {
    key: 'splitWithIntersections',
    value: function splitWithIntersections(intersections, smallerFacets) {
      var nonNullIntersections = calculateNonNullIntersections(intersections),
          nonNullIntersectionsLength = nonNullIntersections.length;

      switch (nonNullIntersectionsLength) {
        case 2:
          this.splitWithTwoNonNullIntersections(intersections, smallerFacets);
          break;

        case 1:
          this.splitWithOneNonNullIntersection(intersections, smallerFacets);
          break;

        case 0:
          this.splitWithNoNonNullIntersections(intersections, smallerFacets);
          break;
      }
    }
  }, {
    key: 'splitWithTwoNonNullIntersections',
    value: function splitWithTwoNonNullIntersections(intersections, smallerFacets) {
      var nullIntersectionIndex = calculateNullIntersectionIndex(intersections),
          places = (VERTICES_LENGTH - nullIntersectionIndex) % VERTICES_LENGTH;

      intersections = _permute(intersections, places);

      intersections = intersections.slice(1); ///

      this.permute(places);

      var startVertexPositionIndices = [1, 2],
          endVertexPositionIndices = [2, 0],
          smallerFacetsIndices = [[0, 1, 3], [3, 4, 0], [3, 2, 4]];

      this.splitWithIndicesAndIntersections(startVertexPositionIndices, endVertexPositionIndices, smallerFacetsIndices, intersections, smallerFacets);
    }
  }, {
    key: 'splitWithOneNonNullIntersection',
    value: function splitWithOneNonNullIntersection(intersections, smallerFacets) {
      var nonNullIntersectionIndex = calculateNonNullIntersectionIndex(intersections),
          places = (VERTICES_LENGTH - nonNullIntersectionIndex) % VERTICES_LENGTH;

      intersections = _permute(intersections, places);

      intersections = intersections.slice(0, 1); ///

      this.permute(places);

      var startVertexPositionIndices = [0],
          endVertexPositionIndices = [1],
          smallerFacetsIndices = [[0, 3, 2], [3, 1, 2]];

      this.splitWithIndicesAndIntersections(startVertexPositionIndices, endVertexPositionIndices, smallerFacetsIndices, intersections, smallerFacets);
    }
  }, {
    key: 'splitWithNoNonNullIntersections',
    value: function splitWithNoNonNullIntersections(intersections, smallerFacets) {
      var smallerFacet = this.fromVertices(this.vertices); ///

      smallerFacets.push(smallerFacet);
    }
  }, {
    key: 'splitWithIndicesAndIntersections',
    value: function splitWithIndicesAndIntersections(startVertexPositionIndices, endVertexPositionIndices, smallerFacetsIndices, intersections, smallerFacets) {
      var _this = this;

      var vertexPositions = this.getVertexPositions(),
          intermediateVertexPositions = intersections.map(function (intersection, index) {
        var startVertexPositionIndex = startVertexPositionIndices[index],
            endVertexPositionIndex = endVertexPositionIndices[index],
            startVertexPosition = vertexPositions[startVertexPositionIndex],
            endVertexPosition = vertexPositions[endVertexPositionIndex],
            intermediateVertexPosition = calculateIntermediateVertexPosition(startVertexPosition, endVertexPosition, intersection);

        return intermediateVertexPosition;
      });

      push(vertexPositions, intermediateVertexPositions);

      smallerFacetsIndices.forEach(function (smallerFacetIndices) {
        var positions = vertexPositions,
            ///
        indices = smallerFacetIndices,
            ///
        facet = _this,
            smallerFacet = smallerFacetFromVerticesAndVertexPositions(positions, indices, facet),
            smallerFacetTooSmall = smallerFacet.isTooSmall();

        if (!smallerFacetTooSmall) {
          smallerFacets.push(smallerFacet);
        }
      });
    }
  }]);

  return Facet;
}();

module.exports = Facet;

function smallerFacetFromVerticesAndVertexPositions(vertexPositions, indices, facet) {
  var vertices = indices.map(function (index) {
    var vertexPosition = vertexPositions[index];

    var position = vertexPosition; ///

    position = clonePosition(position);

    var vertex = Vertex.fromPosition(position);

    return vertex;
  }),
      smallerFacet = facet.fromVertices(vertices);

  return smallerFacet;
}

function clonePosition(position) {
  return position.slice();
} ///
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9mYWNldC5qcyJdLCJuYW1lcyI6WyJFZGdlIiwicmVxdWlyZSIsIk5vcm1hbCIsIlZlcnRleCIsImNvbnN0YW50cyIsImZhY2V0VXRpbGl0aWVzIiwiYXJyYXlVdGlsaXRpZXMiLCJtaWRQb2ludFV0aWxpdGllcyIsImFwcHJveGltYXRlVXRpbGl0aWVzIiwiaW50ZXJzZWN0aW9uVXRpbGl0aWVzIiwiVkVSVElDRVNfTEVOR1RIIiwicHVzaCIsInBlcm11dGUiLCJpc0FwcHJveGltYXRlbHlFcXVhbFRvWmVybyIsImNhbGN1bGF0ZUVkZ2VzIiwiY2FsY3VsYXRlTm9ybWFsIiwiY2FsY3VsYXRlQXJlYSIsImNhbGN1bGF0ZU1pZFBvaW50UG9zaXRpb24iLCJpc01pZFBvaW50UG9zaXRpb25Ub09uZVNpZGVPZk1hc2tpbmdFZGdlcyIsImNhbGN1bGF0ZUludGVybWVkaWF0ZVZlcnRleFBvc2l0aW9uIiwiY2FsY3VsYXRlTm9uTnVsbEludGVyc2VjdGlvbnMiLCJjYWxjdWxhdGVOdWxsSW50ZXJzZWN0aW9uSW5kZXgiLCJjYWxjdWxhdGVOb25OdWxsSW50ZXJzZWN0aW9uSW5kZXgiLCJGYWNldCIsInZlcnRpY2VzIiwibm9ybWFsIiwiZWRnZXMiLCJ2ZXJ0ZXhQb3NpdGlvbnMiLCJtYXAiLCJ2ZXJ0ZXgiLCJnZXRQb3NpdGlvbiIsImV4dGVudCIsImdldEV4dGVudCIsInZlcnRleE5vcm1hbCIsInZlcnRleE5vcm1hbHMiLCJpbmRleCIsInZlcnRleEluZGV4IiwidmVydGV4SW5kZXhlcyIsImFyZWEiLCJhcmVhQXBwcm94aW1hdGVseUVxdWFsVG9aZXJvIiwidG9vU21hbGwiLCJtYXNraW5nRmFjZXQiLCJtYXNraW5nRWRnZXMiLCJnZXRNYXNraW5nRWRnZXMiLCJtaWRQb2ludFBvc2l0aW9uIiwibWlkUG9pbnRQb3NpdGlvblRvT25lU2lkZU9mTWFza2luZ0VkZ2VzIiwibWFza2VkIiwicGxhY2VzIiwicm90YXRpb25RdWF0ZXJuaW9uIiwiZm9yRWFjaCIsInJvdGF0ZSIsInRyYW5zZm9ybXMiLCJhcHBseVRyYW5zZm9ybXMiLCJpbnRlcnNlY3Rpb25zIiwic21hbGxlckZhY2V0cyIsIm5vbk51bGxJbnRlcnNlY3Rpb25zIiwibm9uTnVsbEludGVyc2VjdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJzcGxpdFdpdGhUd29Ob25OdWxsSW50ZXJzZWN0aW9ucyIsInNwbGl0V2l0aE9uZU5vbk51bGxJbnRlcnNlY3Rpb24iLCJzcGxpdFdpdGhOb05vbk51bGxJbnRlcnNlY3Rpb25zIiwibnVsbEludGVyc2VjdGlvbkluZGV4Iiwic2xpY2UiLCJzdGFydFZlcnRleFBvc2l0aW9uSW5kaWNlcyIsImVuZFZlcnRleFBvc2l0aW9uSW5kaWNlcyIsInNtYWxsZXJGYWNldHNJbmRpY2VzIiwic3BsaXRXaXRoSW5kaWNlc0FuZEludGVyc2VjdGlvbnMiLCJub25OdWxsSW50ZXJzZWN0aW9uSW5kZXgiLCJzbWFsbGVyRmFjZXQiLCJmcm9tVmVydGljZXMiLCJnZXRWZXJ0ZXhQb3NpdGlvbnMiLCJpbnRlcm1lZGlhdGVWZXJ0ZXhQb3NpdGlvbnMiLCJpbnRlcnNlY3Rpb24iLCJzdGFydFZlcnRleFBvc2l0aW9uSW5kZXgiLCJlbmRWZXJ0ZXhQb3NpdGlvbkluZGV4Iiwic3RhcnRWZXJ0ZXhQb3NpdGlvbiIsImVuZFZlcnRleFBvc2l0aW9uIiwiaW50ZXJtZWRpYXRlVmVydGV4UG9zaXRpb24iLCJzbWFsbGVyRmFjZXRJbmRpY2VzIiwicG9zaXRpb25zIiwiaW5kaWNlcyIsImZhY2V0Iiwic21hbGxlckZhY2V0RnJvbVZlcnRpY2VzQW5kVmVydGV4UG9zaXRpb25zIiwic21hbGxlckZhY2V0VG9vU21hbGwiLCJpc1Rvb1NtYWxsIiwibW9kdWxlIiwiZXhwb3J0cyIsInZlcnRleFBvc2l0aW9uIiwicG9zaXRpb24iLCJjbG9uZVBvc2l0aW9uIiwiZnJvbVBvc2l0aW9uIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7O0FBRUEsSUFBTUEsT0FBT0MsUUFBUSxRQUFSLENBQWI7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dkIsRUFBaUM7QUFBRSxTQUFPQSxTQUFTMUIsS0FBVCxFQUFQO0FBQTBCLEMsQ0FBQyIsImZpbGUiOiJmYWNldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgRWRnZSA9IHJlcXVpcmUoJy4vZWRnZScpLFxuICAgICAgTm9ybWFsID0gcmVxdWlyZSgnLi9ub3JtYWwnKSxcbiAgICAgIFZlcnRleCA9IHJlcXVpcmUoJy4vdmVydGV4JyksXG4gICAgICBjb25zdGFudHMgPSByZXF1aXJlKCcuL2NvbnN0YW50cycpLFxuICAgICAgZmFjZXRVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9mYWNldCcpLFxuICAgICAgYXJyYXlVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcnJheScpLFxuICAgICAgbWlkUG9pbnRVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9taWRQb2ludCcpLFxuICAgICAgYXBwcm94aW1hdGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcHByb3hpbWF0ZScpLFxuICAgICAgaW50ZXJzZWN0aW9uVXRpbGl0aWVzID0gcmVxdWlyZSgnLi91dGlsaXRpZXMvaW50ZXJzZWN0aW9uJyk7XG5cbmNvbnN0IHsgVkVSVElDRVNfTEVOR1RIIH0gPSBjb25zdGFudHMsXG4gICAgICB7IHB1c2gsIHBlcm11dGUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBpc0FwcHJveGltYXRlbHlFcXVhbFRvWmVybyB9ID0gYXBwcm94aW1hdGVVdGlsaXRpZXMsXG4gICAgICB7IGNhbGN1bGF0ZUVkZ2VzLCBjYWxjdWxhdGVOb3JtYWwsIGNhbGN1bGF0ZUFyZWEgfSA9IGZhY2V0VXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVNaWRQb2ludFBvc2l0aW9uLCBpc01pZFBvaW50UG9zaXRpb25Ub09uZVNpZGVPZk1hc2tpbmdFZGdlcyB9ID0gbWlkUG9pbnRVdGlsaXRpZXMsXG4gICAgICB7IGNhbGN1bGF0ZUludGVybWVkaWF0ZVZlcnRleFBvc2l0aW9uLCBjYWxjdWxhdGVOb25OdWxsSW50ZXJzZWN0aW9ucywgY2FsY3VsYXRlTnVsbEludGVyc2VjdGlvbkluZGV4LCBjYWxjdWxhdGVOb25OdWxsSW50ZXJzZWN0aW9uSW5kZXggfSA9IGludGVyc2VjdGlvblV0aWxpdGllcztcblxuY2xhc3MgRmFjZXQge1xuICBjb25zdHJ1Y3Rvcih2ZXJ0aWNlcywgbm9ybWFsLCBlZGdlcykge1xuICAgIHRoaXMudmVydGljZXMgPSB2ZXJ0aWNlcztcbiAgICB0aGlzLm5vcm1hbCA9IG5vcm1hbDtcbiAgICB0aGlzLmVkZ2VzID0gZWRnZXM7XG4gIH1cblxuICBnZXRWZXJ0aWNlcygpIHtcbiAgICByZXR1cm4gdGhpcy52ZXJ0aWNlcztcbiAgfVxuXG4gIGdldE5vcm1hbCgpIHtcbiAgICByZXR1cm4gdGhpcy5ub3JtYWw7XG4gIH1cblxuICBnZXRFZGdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5lZGdlcztcbiAgfVxuICBcbiAgZ2V0VmVydGV4UG9zaXRpb25zKCkge1xuICAgIGNvbnN0IHZlcnRleFBvc2l0aW9ucyA9IHRoaXMudmVydGljZXMubWFwKCh2ZXJ0ZXgpID0+IHZlcnRleC5nZXRQb3NpdGlvbigpKTtcbiAgICBcbiAgICByZXR1cm4gdmVydGV4UG9zaXRpb25zO1xuICB9XG4gIFxuICBnZXRWZXJ0ZXhOb3JtYWxzKCkge1xuICAgIGNvbnN0IGV4dGVudCA9IHRoaXMubm9ybWFsLmdldEV4dGVudCgpLFxuICAgICAgICAgIHZlcnRleE5vcm1hbCA9IGV4dGVudCwgIC8vL1xuICAgICAgICAgIHZlcnRleE5vcm1hbHMgPSBbXG4gICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwsXG4gICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwsXG4gICAgICAgICAgICB2ZXJ0ZXhOb3JtYWwsXG4gICAgICAgICAgXTtcbiAgICBcbiAgICByZXR1cm4gdmVydGV4Tm9ybWFscztcbiAgfVxuICBcbiAgZ2V0VmVydGV4SW5kZXhlcyhpbmRleCkgeyAvLy9cbiAgICBjb25zdCB2ZXJ0ZXhJbmRleCA9IGluZGV4ICogMyxcbiAgICAgICAgICB2ZXJ0ZXhJbmRleGVzID0gW1xuICAgICAgICAgICAgdmVydGV4SW5kZXggKyAwLFxuICAgICAgICAgICAgdmVydGV4SW5kZXggKyAxLFxuICAgICAgICAgICAgdmVydGV4SW5kZXggKyAyLFxuICAgICAgICAgIF07XG4gICAgXG4gICAgcmV0dXJuIHZlcnRleEluZGV4ZXM7XG4gIH1cblxuICBpc1Rvb1NtYWxsKCkge1xuICAgIGNvbnN0IGFyZWEgPSBjYWxjdWxhdGVBcmVhKHRoaXMudmVydGljZXMpLFxuICAgICAgICAgIGFyZWFBcHByb3hpbWF0ZWx5RXF1YWxUb1plcm8gPSBpc0FwcHJveGltYXRlbHlFcXVhbFRvWmVybyhhcmVhKSxcbiAgICAgICAgICB0b29TbWFsbCA9IGFyZWFBcHByb3hpbWF0ZWx5RXF1YWxUb1plcm87ICAvLy9cblxuICAgIHJldHVybiB0b29TbWFsbDtcbiAgfVxuXG4gIGlzTWFza2VkKG1hc2tpbmdGYWNldCkge1xuICAgIGNvbnN0IG1hc2tpbmdFZGdlcyA9IG1hc2tpbmdGYWNldC5nZXRNYXNraW5nRWRnZXMoKSxcbiAgICAgICAgICBtaWRQb2ludFBvc2l0aW9uID0gY2FsY3VsYXRlTWlkUG9pbnRQb3NpdGlvbih0aGlzLnZlcnRpY2VzKSxcbiAgICAgICAgICBtaWRQb2ludFBvc2l0aW9uVG9PbmVTaWRlT2ZNYXNraW5nRWRnZXMgPSBpc01pZFBvaW50UG9zaXRpb25Ub09uZVNpZGVPZk1hc2tpbmdFZGdlcyhtaWRQb2ludFBvc2l0aW9uLCBtYXNraW5nRWRnZXMpLFxuICAgICAgICAgIG1hc2tlZCA9IG1pZFBvaW50UG9zaXRpb25Ub09uZVNpZGVPZk1hc2tpbmdFZGdlczsgIC8vL1xuICAgIFxuICAgIHJldHVybiBtYXNrZWQ7XG4gIH1cblxuICBwZXJtdXRlKHBsYWNlcykge1xuICAgIHRoaXMudmVydGljZXMgPSBwZXJtdXRlKHRoaXMudmVydGljZXMsIHBsYWNlcyk7XG5cbiAgICB0aGlzLm5vcm1hbCA9IGNhbGN1bGF0ZU5vcm1hbCh0aGlzLnZlcnRpY2VzLCBOb3JtYWwpO1xuXG4gICAgdGhpcy5lZGdlcyA9IGNhbGN1bGF0ZUVkZ2VzKHRoaXMudmVydGljZXMsIEVkZ2UpO1xuICB9XG5cbiAgcm90YXRlKHJvdGF0aW9uUXVhdGVybmlvbikge1xuICAgIHRoaXMudmVydGljZXMuZm9yRWFjaCgodmVydGV4KSA9PiB2ZXJ0ZXgucm90YXRlKHJvdGF0aW9uUXVhdGVybmlvbikpO1xuXG4gICAgdGhpcy5ub3JtYWwgPSBjYWxjdWxhdGVOb3JtYWwodGhpcy52ZXJ0aWNlcywgTm9ybWFsKTtcblxuICAgIHRoaXMuZWRnZXMgPSBjYWxjdWxhdGVFZGdlcyh0aGlzLnZlcnRpY2VzLCBFZGdlKTtcbiAgfVxuXG4gIGFwcGx5VHJhbnNmb3Jtcyh0cmFuc2Zvcm1zKSB7XG4gICAgdGhpcy52ZXJ0aWNlcy5mb3JFYWNoKCh2ZXJ0ZXgpID0+IHZlcnRleC5hcHBseVRyYW5zZm9ybXModHJhbnNmb3JtcykpO1xuXG4gICAgdGhpcy5ub3JtYWwgPSBjYWxjdWxhdGVOb3JtYWwodGhpcy52ZXJ0aWNlcywgTm9ybWFsKTtcblxuICAgIHRoaXMuZWRnZXMgPSBjYWxjdWxhdGVFZGdlcyh0aGlzLnZlcnRpY2VzLCBFZGdlKTtcbiAgfVxuXG4gIHNwbGl0V2l0aEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cykge1xuICAgIGNvbnN0IG5vbk51bGxJbnRlcnNlY3Rpb25zID0gY2FsY3VsYXRlTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucyksXG4gICAgICAgICAgbm9uTnVsbEludGVyc2VjdGlvbnNMZW5ndGggPSBub25OdWxsSW50ZXJzZWN0aW9ucy5sZW5ndGg7XG5cbiAgICBzd2l0Y2ggKG5vbk51bGxJbnRlcnNlY3Rpb25zTGVuZ3RoKSB7XG4gICAgICBjYXNlIDIgOlxuICAgICAgICB0aGlzLnNwbGl0V2l0aFR3b05vbk51bGxJbnRlcnNlY3Rpb25zKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAxIDpcbiAgICAgICAgdGhpcy5zcGxpdFdpdGhPbmVOb25OdWxsSW50ZXJzZWN0aW9uKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAwIDpcbiAgICAgICAgdGhpcy5zcGxpdFdpdGhOb05vbk51bGxJbnRlcnNlY3Rpb25zKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMpO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cbiAgXG4gIHNwbGl0V2l0aFR3b05vbk51bGxJbnRlcnNlY3Rpb25zKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMpIHtcbiAgICBjb25zdCBudWxsSW50ZXJzZWN0aW9uSW5kZXggPSBjYWxjdWxhdGVOdWxsSW50ZXJzZWN0aW9uSW5kZXgoaW50ZXJzZWN0aW9ucyksXG4gICAgICAgICAgcGxhY2VzID0gKFZFUlRJQ0VTX0xFTkdUSCAtIG51bGxJbnRlcnNlY3Rpb25JbmRleCkgJSBWRVJUSUNFU19MRU5HVEg7XG5cbiAgICBpbnRlcnNlY3Rpb25zID0gcGVybXV0ZShpbnRlcnNlY3Rpb25zLCBwbGFjZXMpO1xuXG4gICAgaW50ZXJzZWN0aW9ucyA9IGludGVyc2VjdGlvbnMuc2xpY2UoMSk7IC8vL1xuXG4gICAgdGhpcy5wZXJtdXRlKHBsYWNlcyk7XG5cbiAgICBjb25zdCBzdGFydFZlcnRleFBvc2l0aW9uSW5kaWNlcyA9IFsgMSwgMiBdLFxuICAgICAgICAgIGVuZFZlcnRleFBvc2l0aW9uSW5kaWNlcyA9IFsgMiwgMCBdLFxuICAgICAgICAgIHNtYWxsZXJGYWNldHNJbmRpY2VzID0gW1xuXG4gICAgICAgICAgICBbIDAsIDEsIDMgXSxcbiAgICAgICAgICAgIFsgMywgNCwgMCBdLFxuICAgICAgICAgICAgWyAzLCAyLCA0IF0sXG5cbiAgICAgICAgICBdO1xuXG4gICAgdGhpcy5zcGxpdFdpdGhJbmRpY2VzQW5kSW50ZXJzZWN0aW9ucyhzdGFydFZlcnRleFBvc2l0aW9uSW5kaWNlcywgZW5kVmVydGV4UG9zaXRpb25JbmRpY2VzLCBzbWFsbGVyRmFjZXRzSW5kaWNlcywgaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cyk7XG4gIH1cblxuICBzcGxpdFdpdGhPbmVOb25OdWxsSW50ZXJzZWN0aW9uKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMpIHtcbiAgICBjb25zdCBub25OdWxsSW50ZXJzZWN0aW9uSW5kZXggPSBjYWxjdWxhdGVOb25OdWxsSW50ZXJzZWN0aW9uSW5kZXgoaW50ZXJzZWN0aW9ucyksXG4gICAgICAgICAgcGxhY2VzID0gKFZFUlRJQ0VTX0xFTkdUSCAtIG5vbk51bGxJbnRlcnNlY3Rpb25JbmRleCkgJSBWRVJUSUNFU19MRU5HVEg7XG5cbiAgICBpbnRlcnNlY3Rpb25zID0gcGVybXV0ZShpbnRlcnNlY3Rpb25zLCBwbGFjZXMpO1xuXG4gICAgaW50ZXJzZWN0aW9ucyA9IGludGVyc2VjdGlvbnMuc2xpY2UoMCwgMSk7ICAvLy9cblxuICAgIHRoaXMucGVybXV0ZShwbGFjZXMpO1xuXG4gICAgY29uc3Qgc3RhcnRWZXJ0ZXhQb3NpdGlvbkluZGljZXMgPSBbIDAgXSxcbiAgICAgICAgICBlbmRWZXJ0ZXhQb3NpdGlvbkluZGljZXMgPSBbIDEgXSxcbiAgICAgICAgICBzbWFsbGVyRmFjZXRzSW5kaWNlcyA9IFtcblxuICAgICAgICAgICAgWyAwLCAzLCAyIF0sXG4gICAgICAgICAgICBbIDMsIDEsIDIgXSxcblxuICAgICAgICAgIF07XG5cbiAgICB0aGlzLnNwbGl0V2l0aEluZGljZXNBbmRJbnRlcnNlY3Rpb25zKHN0YXJ0VmVydGV4UG9zaXRpb25JbmRpY2VzLCBlbmRWZXJ0ZXhQb3NpdGlvbkluZGljZXMsIHNtYWxsZXJGYWNldHNJbmRpY2VzLCBpbnRlcnNlY3Rpb25zLCBzbWFsbGVyRmFjZXRzKTtcbiAgfVxuXG4gIHNwbGl0V2l0aE5vTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cykge1xuICAgIGNvbnN0IHNtYWxsZXJGYWNldCA9IHRoaXMuZnJvbVZlcnRpY2VzKHRoaXMudmVydGljZXMpOyAgLy8vXG5cbiAgICBzbWFsbGVyRmFjZXRzLnB1c2goc21hbGxlckZhY2V0KTtcbiAgfVxuXG4gIHNwbGl0V2l0aEluZGljZXNBbmRJbnRlcnNlY3Rpb25zKHN0YXJ0VmVydGV4UG9zaXRpb25JbmRpY2VzLCBlbmRWZXJ0ZXhQb3NpdGlvbkluZGljZXMsIHNtYWxsZXJGYWNldHNJbmRpY2VzLCBpbnRlcnNlY3Rpb25zLCBzbWFsbGVyRmFjZXRzKSB7XG4gICAgY29uc3QgdmVydGV4UG9zaXRpb25zID0gdGhpcy5nZXRWZXJ0ZXhQb3NpdGlvbnMoKSxcbiAgICAgICAgICBpbnRlcm1lZGlhdGVWZXJ0ZXhQb3NpdGlvbnMgPSBpbnRlcnNlY3Rpb25zLm1hcCgoaW50ZXJzZWN0aW9uLCBpbmRleCkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgc3RhcnRWZXJ0ZXhQb3NpdGlvbkluZGV4ID0gc3RhcnRWZXJ0ZXhQb3NpdGlvbkluZGljZXNbaW5kZXhdLFxuICAgICAgICAgICAgICAgICAgZW5kVmVydGV4UG9zaXRpb25JbmRleCA9IGVuZFZlcnRleFBvc2l0aW9uSW5kaWNlc1tpbmRleF0sXG4gICAgICAgICAgICAgICAgICBzdGFydFZlcnRleFBvc2l0aW9uID0gdmVydGV4UG9zaXRpb25zW3N0YXJ0VmVydGV4UG9zaXRpb25JbmRleF0sXG4gICAgICAgICAgICAgICAgICBlbmRWZXJ0ZXhQb3NpdGlvbiA9IHZlcnRleFBvc2l0aW9uc1tlbmRWZXJ0ZXhQb3NpdGlvbkluZGV4XSxcbiAgICAgICAgICAgICAgICAgIGludGVybWVkaWF0ZVZlcnRleFBvc2l0aW9uID0gY2FsY3VsYXRlSW50ZXJtZWRpYXRlVmVydGV4UG9zaXRpb24oc3RhcnRWZXJ0ZXhQb3NpdGlvbiwgZW5kVmVydGV4UG9zaXRpb24sIGludGVyc2VjdGlvbik7XG5cbiAgICAgICAgICAgIHJldHVybiBpbnRlcm1lZGlhdGVWZXJ0ZXhQb3NpdGlvbjtcbiAgICAgICAgICB9KTtcblxuICAgIHB1c2godmVydGV4UG9zaXRpb25zLCBpbnRlcm1lZGlhdGVWZXJ0ZXhQb3NpdGlvbnMpO1xuXG4gICAgc21hbGxlckZhY2V0c0luZGljZXMuZm9yRWFjaCgoc21hbGxlckZhY2V0SW5kaWNlcykgPT4ge1xuICAgICAgY29uc3QgcG9zaXRpb25zID0gdmVydGV4UG9zaXRpb25zLCAgLy8vXG4gICAgICAgICAgICBpbmRpY2VzID0gc21hbGxlckZhY2V0SW5kaWNlcywgIC8vL1xuICAgICAgICAgICAgZmFjZXQgPSB0aGlzLCBcbiAgICAgICAgICAgIHNtYWxsZXJGYWNldCA9IHNtYWxsZXJGYWNldEZyb21WZXJ0aWNlc0FuZFZlcnRleFBvc2l0aW9ucyhwb3NpdGlvbnMsIGluZGljZXMsIGZhY2V0KSxcbiAgICAgICAgICAgIHNtYWxsZXJGYWNldFRvb1NtYWxsID0gc21hbGxlckZhY2V0LmlzVG9vU21hbGwoKTtcblxuICAgICAgaWYgKCFzbWFsbGVyRmFjZXRUb29TbWFsbCkge1xuICAgICAgICBzbWFsbGVyRmFjZXRzLnB1c2goc21hbGxlckZhY2V0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IEZhY2V0O1xuXG5mdW5jdGlvbiBzbWFsbGVyRmFjZXRGcm9tVmVydGljZXNBbmRWZXJ0ZXhQb3NpdGlvbnModmVydGV4UG9zaXRpb25zLCBpbmRpY2VzLCBmYWNldCkge1xuICBjb25zdCB2ZXJ0aWNlcyA9IGluZGljZXMubWFwKChpbmRleCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHZlcnRleFBvc2l0aW9uID0gdmVydGV4UG9zaXRpb25zW2luZGV4XTtcbiAgICBcbiAgICAgICAgICBsZXQgcG9zaXRpb24gPSB2ZXJ0ZXhQb3NpdGlvbjsgIC8vL1xuICAgIFxuICAgICAgICAgIHBvc2l0aW9uID0gY2xvbmVQb3NpdGlvbihwb3NpdGlvbik7XG4gICAgXG4gICAgICAgICAgY29uc3QgdmVydGV4ID0gVmVydGV4LmZyb21Qb3NpdGlvbihwb3NpdGlvbik7XG5cbiAgICAgICAgICByZXR1cm4gdmVydGV4O1xuICAgICAgICB9KSxcbiAgICAgICAgc21hbGxlckZhY2V0ID0gZmFjZXQuZnJvbVZlcnRpY2VzKHZlcnRpY2VzKTtcblxuICByZXR1cm4gc21hbGxlckZhY2V0O1xufVxuXG5mdW5jdGlvbiBjbG9uZVBvc2l0aW9uKHBvc2l0aW9uKSB7IHJldHVybiBwb3NpdGlvbi5zbGljZSgpOyB9IC8vL1xuIl19