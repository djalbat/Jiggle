'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Edge = require('./edge'),
    Vertex = require('./vertex'),
    constants = require('./constants'),
    vectorMaths = require('./maths/vector'),
    facetUtilities = require('./utilities/facet'),
    arrayUtilities = require('./utilities/array'),
    rotationUtilities = require('./utilities/rotation'),
    approximateUtilities = require('./utilities/approximate');

var VERTICES_LENGTH = constants.VERTICES_LENGTH,
    add3 = vectorMaths.add3,
    subtract3 = vectorMaths.subtract3,
    scale3 = vectorMaths.scale3,
    normalise3 = vectorMaths.normalise3,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    third = arrayUtilities.third,
    _permute = arrayUtilities.permute,
    isApproximatelyEqualToZero = approximateUtilities.isApproximatelyEqualToZero,
    rotateVertices = rotationUtilities.rotateVertices,
    rotateVerticesAboutZAxis = rotationUtilities.rotateVerticesAboutZAxis,
    calculateEdges = facetUtilities.calculateEdges,
    calculateNormal = facetUtilities.calculateNormal,
    calculateArea = facetUtilities.calculateArea;

var Facet = function () {
  function Facet(vertices, normal, edges) {
    _classCallCheck(this, Facet);

    this.vertices = vertices;
    this.normal = normal;
    this.edges = edges;
  }

  _createClass(Facet, [{
    key: 'getVertices',
    value: function getVertices() {
      return this.vertices;
    }
  }, {
    key: 'getNormal',
    value: function getNormal() {
      return this.normal;
    }
  }, {
    key: 'getEdges',
    value: function getEdges() {
      return this.edges;
    }
  }, {
    key: 'getVertexPositions',
    value: function getVertexPositions() {
      var vertexPositions = this.vertices.map(function (vertex) {
        var vertexPosition = vertex.getPosition();

        return vertexPosition;
      });

      return vertexPositions;
    }
  }, {
    key: 'getVertexNormals',
    value: function getVertexNormals() {
      var vertexNormal = normalise3(this.normal),
          vertexNormals = [vertexNormal, vertexNormal, vertexNormal];

      return vertexNormals;
    }
  }, {
    key: 'getVertexIndexes',
    value: function getVertexIndexes(index) {
      ///
      var vertexIndex = index * 3,
          vertexIndexes = [vertexIndex + 0, vertexIndex + 1, vertexIndex + 2];

      return vertexIndexes;
    }
  }, {
    key: 'getMidPointPosition',
    value: function getMidPointPosition() {
      var midPointPosition = this.vertices.reduce(function (midPointPosition, vertex) {
        var position = vertex.getPosition(),
            scaledVertexPosition = scale3(position, 1 / 3);

        midPointPosition = add3(midPointPosition, scaledVertexPosition);

        return midPointPosition;
      }, [0, 0, 0]);

      return midPointPosition;
    }
  }, {
    key: 'isTooSmall',
    value: function isTooSmall() {
      var area = calculateArea(this.vertices),
          areaApproximatelyEqualToZero = isApproximatelyEqualToZero(area),
          tooSmall = areaApproximatelyEqualToZero; ///

      return tooSmall;
    }
  }, {
    key: 'isMasked',
    value: function isMasked(maskingFacet) {
      var maskingEdges = maskingFacet.getMaskingEdges(),
          midPointPosition = this.getMidPointPosition(),
          midPointPositionToOneSideOfMaskingEdges = isMidPointPositionToOneSideOfMaskingEdges(midPointPosition, maskingEdges),
          masked = midPointPositionToOneSideOfMaskingEdges; ///

      return masked;
    }
  }, {
    key: 'permute',
    value: function permute(places) {
      this.vertices = _permute(this.vertices, places);
    }
  }, {
    key: 'rotate',
    value: function rotate(rotationQuaternion) {
      this.vertices = rotateVertices(this.vertices, rotationQuaternion);

      this.normal = calculateNormal(this.vertices);

      this.edges = calculateEdges(this.vertices, Edge);
    }
  }, {
    key: 'rotateAboutZAxis',
    value: function rotateAboutZAxis(rotationAboutZAxisMatrix) {
      this.vertices = rotateVerticesAboutZAxis(this.vertices, rotationAboutZAxisMatrix);

      this.normal = calculateNormal(this.vertices);

      this.edges = calculateEdges(this.vertices, Edge);
    }
  }, {
    key: 'applyTransforms',
    value: function applyTransforms(transforms) {
      this.vertices = this.vertices.map(function (vertex) {
        transforms.forEach(function (transform) {
          vertex.applyTransform(transform);
        });

        return vertex;
      });

      this.normal = calculateNormal(this.vertices);

      this.edges = calculateEdges(this.vertices, Edge);
    }
  }, {
    key: 'splitWithIntersections',
    value: function splitWithIntersections(intersections, smallerFacets) {
      var nonNullIntersections = calculateNonNullIntersections(intersections),
          nonNullIntersectionsLength = nonNullIntersections.length;

      switch (nonNullIntersectionsLength) {
        case 2:
          this.splitWithTwoNonNullIntersections(intersections, smallerFacets);
          break;

        case 1:
          this.splitWithOneNonNullIntersection(intersections, smallerFacets);
          break;

        case 0:
          this.splitWithZeroNonNullIntersections(intersections, smallerFacets);
          break;
      }
    }
  }, {
    key: 'splitWithTwoNonNullIntersections',
    value: function splitWithTwoNonNullIntersections(intersections, smallerFacets, facet) {
      var nullIntersectionIndex = calculateNullIntersectionIndex(intersections),
          places = (VERTICES_LENGTH - nullIntersectionIndex) % VERTICES_LENGTH;

      intersections = _permute(intersections, places);

      intersections = intersections.slice(1); ///

      this.permute(places);

      var firstVertex = first(this.vertices),
          secondVertex = second(this.vertices),
          thirdVertex = third(this.vertices),
          firstIntersection = first(intersections),
          secondIntersection = second(intersections),
          firstIntermediateVertex = calculateIntermediateVertex(secondVertex, thirdVertex, firstIntersection),
          secondIntermediateVertex = calculateIntermediateVertex(thirdVertex, firstVertex, secondIntersection),
          firstVertices = [firstVertex, secondVertex, firstIntermediateVertex],
          secondVertices = [firstIntermediateVertex, secondIntermediateVertex, firstVertex],
          thirdVertices = [firstIntermediateVertex, thirdVertex, secondIntermediateVertex],
          firstFacet = facet.fromVertices(firstVertices),
          secondFacet = facet.fromVertices(secondVertices),
          thirdFacet = facet.fromVertices(thirdVertices),
          firstFacetTooSmall = firstFacet.isTooSmall(),
          secondFacetTooSmall = secondFacet.isTooSmall(),
          thirdFacetTooSmall = thirdFacet.isTooSmall();

      if (!firstFacetTooSmall) {
        smallerFacets.push(firstFacet);
      }

      if (!secondFacetTooSmall) {
        smallerFacets.push(secondFacet);
      }

      if (!thirdFacetTooSmall) {
        smallerFacets.push(thirdFacet);
      }
    }
  }, {
    key: 'splitWithOneNonNullIntersection',
    value: function splitWithOneNonNullIntersection(intersections, smallerFacets, facet) {
      var nonNullIntersectionIndex = calculateNonNullIntersectionIndex(intersections),
          places = (VERTICES_LENGTH - nonNullIntersectionIndex) % VERTICES_LENGTH;

      intersections = _permute(intersections, places);

      this.permute(places);

      var firstVertex = first(this.vertices),
          secondVertex = second(this.vertices),
          thirdVertex = third(this.vertices),
          firstIntersection = first(intersections),
          intermediateVertex = calculateIntermediateVertex(firstVertex, secondVertex, firstIntersection),
          firstVertices = [firstVertex, intermediateVertex, thirdVertex],
          secondVertices = [intermediateVertex, secondVertex, thirdVertex],
          firstFacet = facet.fromVertices(firstVertices),
          secondFacet = facet.fromVertices(secondVertices),
          firstFacetTooSmall = firstFacet.isTooSmall(),
          secondFacetTooSmall = secondFacet.isTooSmall();

      if (!firstFacetTooSmall) {
        smallerFacets.push(firstFacet);
      }

      if (!secondFacetTooSmall) {
        smallerFacets.push(secondFacet);
      }
    }
  }, {
    key: 'splitWithZeroNonNullIntersections',
    value: function splitWithZeroNonNullIntersections(intersections, smallerFacets) {
      var smallerFacet = this; ///

      smallerFacets.push(smallerFacet);
    }
  }]);

  return Facet;
}();

module.exports = Facet;

function calculateIntermediateVertex(startVertex, endVertex, intersection) {
  var startPosition = startVertex.getPosition(),
      endPosition = endVertex.getPosition(),
      extent = subtract3(endPosition, startPosition),
      offset = scale3(extent, intersection),
      position = add3(startPosition, offset),
      vertex = new Vertex(position),
      intermediateVertex = vertex; ///

  return intermediateVertex;
}

function calculateNonNullIntersections(intersections) {
  var nonNullIntersections = intersections.reduce(function (nonNullIntersections, intersection) {
    if (intersection !== null) {
      var nonNullIntersection = intersection; ///

      nonNullIntersections.push(nonNullIntersection);
    }

    return nonNullIntersections;
  }, []);

  return nonNullIntersections;
}

function calculateNullIntersectionIndex(intersections) {
  var nullIntersectionIndex = intersections.reduce(function (nullIntersectionIndex, intersection, index) {
    if (nullIntersectionIndex === null) {
      if (intersection === null) {
        nullIntersectionIndex = index;
      }
    }

    return nullIntersectionIndex;
  }, null);

  return nullIntersectionIndex;
}

function calculateNonNullIntersectionIndex(intersections) {
  var nullIntersectionIndex = intersections.reduce(function (nullIntersectionIndex, intersection, index) {
    if (nullIntersectionIndex === null) {
      if (intersection !== null) {
        nullIntersectionIndex = index;
      }
    }

    return nullIntersectionIndex;
  }, null);

  return nullIntersectionIndex;
}

function isMidPointPositionToOneSideOfMaskingEdges(midPointPosition, maskingEdges) {
  var midPointPositionToTheLeftOfMaskingEdges = isMidPointPositionToTheLeftOfMaskingEdges(midPointPosition, maskingEdges),
      midPointPositionToTheRightOfMaskingEdges = isMidPointPositionToTheRightOfMaskingEdges(midPointPosition, maskingEdges),
      midPointPositionToOneSideOfMaskingEdges = midPointPositionToTheLeftOfMaskingEdges || midPointPositionToTheRightOfMaskingEdges; ///

  return midPointPositionToOneSideOfMaskingEdges;
}

function isMidPointPositionToTheLeftOfMaskingEdges(midPointPosition, maskingEdges) {
  var midPointPositionToTheLeftOfMaskingEdges = maskingEdges.reduce(function (midPointPositionToTheLeftOfMaskingEdges, maskingEdge) {
    if (midPointPositionToTheLeftOfMaskingEdges) {
      var midPointPositionToTheLeftOfMaskingEdge = maskingEdge.isMidPointPositionToTheLeft(midPointPosition);

      midPointPositionToTheLeftOfMaskingEdges = midPointPositionToTheLeftOfMaskingEdge;
    }

    return midPointPositionToTheLeftOfMaskingEdges;
  }, true);

  return midPointPositionToTheLeftOfMaskingEdges;
}

function isMidPointPositionToTheRightOfMaskingEdges(midPointPosition, maskingEdges) {
  var midPointPositionToTheRightOfMaskingEdges = maskingEdges.reduce(function (midPointPositionToTheRightOfMaskingEdges, maskingEdge) {
    if (midPointPositionToTheRightOfMaskingEdges) {
      var midPointPositionToTheRightOfMaskingEdge = maskingEdge.isMidPointPositionToTheRight(midPointPosition);

      midPointPositionToTheRightOfMaskingEdges = midPointPositionToTheRightOfMaskingEdge;
    }

    return midPointPositionToTheRightOfMaskingEdges;
  }, true);

  return midPointPositionToTheRightOfMaskingEdges;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi9mYWNldC5qcyJdLCJuYW1lcyI6WyJFZGdlIiwicmVxdWlyZSIsIlZlcnRleCIsImNvbnN0YW50cyIsInZlY3Rvck1hdGhzIiwiZmFjZXRVdGlsaXRpZXMiLCJhcnJheVV0aWxpdGllcyIsInJvdGF0aW9uVXRpbGl0aWVzIiwiYXBwcm94aW1hdGVVdGlsaXRpZXMiLCJWRVJUSUNFU19MRU5HVEgiLCJhZGQzIiwic3VidHJhY3QzIiwic2NhbGUzIiwibm9ybWFsaXNlMyIsImZpcnN0Iiwic2Vjb25kIiwidGhpcmQiLCJwZXJtdXRlIiwiaXNBcHByb3hpbWF0ZWx5RXF1YWxUb1plcm8iLCJyb3RhdGVWZXJ0aWNlcyIsInJvdGF0ZVZlcnRpY2VzQWJvdXRaQXhpcyIsImNhbGN1bGF0ZUVkZ2VzIiwiY2FsY3VsYXRlTm9ybWFsIiwiY2FsY3VsYXRlQXJlYSIsIkZhY2V0IiwidmVydGljZXMiLCJub3JtYWwiLCJlZGdlcyIsInZlcnRleFBvc2l0aW9ucyIsIm1hcCIsInZlcnRleCIsInZlcnRleFBvc2l0aW9uIiwiZ2V0UG9zaXRpb24iLCJ2ZXJ0ZXhOb3JtYWwiLCJ2ZXJ0ZXhOb3JtYWxzIiwiaW5kZXgiLCJ2ZXJ0ZXhJbmRleCIsInZlcnRleEluZGV4ZXMiLCJtaWRQb2ludFBvc2l0aW9uIiwicmVkdWNlIiwicG9zaXRpb24iLCJzY2FsZWRWZXJ0ZXhQb3NpdGlvbiIsImFyZWEiLCJhcmVhQXBwcm94aW1hdGVseUVxdWFsVG9aZXJvIiwidG9vU21hbGwiLCJtYXNraW5nRmFjZXQiLCJtYXNraW5nRWRnZXMiLCJnZXRNYXNraW5nRWRnZXMiLCJnZXRNaWRQb2ludFBvc2l0aW9uIiwibWlkUG9pbnRQb3NpdGlvblRvT25lU2lkZU9mTWFza2luZ0VkZ2VzIiwiaXNNaWRQb2ludFBvc2l0aW9uVG9PbmVTaWRlT2ZNYXNraW5nRWRnZXMiLCJtYXNrZWQiLCJwbGFjZXMiLCJyb3RhdGlvblF1YXRlcm5pb24iLCJyb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgiLCJ0cmFuc2Zvcm1zIiwiZm9yRWFjaCIsInRyYW5zZm9ybSIsImFwcGx5VHJhbnNmb3JtIiwiaW50ZXJzZWN0aW9ucyIsInNtYWxsZXJGYWNldHMiLCJub25OdWxsSW50ZXJzZWN0aW9ucyIsImNhbGN1bGF0ZU5vbk51bGxJbnRlcnNlY3Rpb25zIiwibm9uTnVsbEludGVyc2VjdGlvbnNMZW5ndGgiLCJsZW5ndGgiLCJzcGxpdFdpdGhUd29Ob25OdWxsSW50ZXJzZWN0aW9ucyIsInNwbGl0V2l0aE9uZU5vbk51bGxJbnRlcnNlY3Rpb24iLCJzcGxpdFdpdGhaZXJvTm9uTnVsbEludGVyc2VjdGlvbnMiLCJmYWNldCIsIm51bGxJbnRlcnNlY3Rpb25JbmRleCIsImNhbGN1bGF0ZU51bGxJbnRlcnNlY3Rpb25JbmRleCIsInNsaWNlIiwiZmlyc3RWZXJ0ZXgiLCJzZWNvbmRWZXJ0ZXgiLCJ0aGlyZFZlcnRleCIsImZpcnN0SW50ZXJzZWN0aW9uIiwic2Vjb25kSW50ZXJzZWN0aW9uIiwiZmlyc3RJbnRlcm1lZGlhdGVWZXJ0ZXgiLCJjYWxjdWxhdGVJbnRlcm1lZGlhdGVWZXJ0ZXgiLCJzZWNvbmRJbnRlcm1lZGlhdGVWZXJ0ZXgiLCJmaXJzdFZlcnRpY2VzIiwic2Vjb25kVmVydGljZXMiLCJ0aGlyZFZlcnRpY2VzIiwiZmlyc3RGYWNldCIsImZyb21WZXJ0aWNlcyIsInNlY29uZEZhY2V0IiwidGhpcmRGYWNldCIsImZpcnN0RmFjZXRUb29TbWFsbCIsImlzVG9vU21hbGwiLCJzZWNvbmRGYWNldFRvb1NtYWxsIiwidGhpcmRGYWNldFRvb1NtYWxsIiwicHVzaCIsIm5vbk51bGxJbnRlcnNlY3Rpb25JbmRleCIsImNhbGN1bGF0ZU5vbk51bGxJbnRlcnNlY3Rpb25JbmRleCIsImludGVybWVkaWF0ZVZlcnRleCIsInNtYWxsZXJGYWNldCIsIm1vZHVsZSIsImV4cG9ydHMiLCJzdGFydFZlcnRleCIsImVuZFZlcnRleCIsImludGVyc2VjdGlvbiIsInN0YXJ0UG9zaXRpb24iLCJlbmRQb3NpdGlvbiIsImV4dGVudCIsIm9mZnNldCIsIm5vbk51bGxJbnRlcnNlY3Rpb24iLCJtaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0T2ZNYXNraW5nRWRnZXMiLCJpc01pZFBvaW50UG9zaXRpb25Ub1RoZUxlZnRPZk1hc2tpbmdFZGdlcyIsIm1pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXMiLCJpc01pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXMiLCJtYXNraW5nRWRnZSIsIm1pZFBvaW50UG9zaXRpb25Ub1RoZUxlZnRPZk1hc2tpbmdFZGdlIiwiaXNNaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0IiwibWlkUG9pbnRQb3NpdGlvblRvVGhlUmlnaHRPZk1hc2tpbmdFZGdlIiwiaXNNaWRQb2ludFBvc2l0aW9uVG9UaGVSaWdodCJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLE9BQU9DLFFBQVEsUUFBUixDQUFiO0FBQUEsSUFDTUMsU0FBU0QsUUFBUSxVQUFSLENBRGY7QUFBQSxJQUVNRSxZQUFZRixRQUFRLGFBQVIsQ0FGbEI7QUFBQSxJQUdNRyxjQUFjSCxRQUFRLGdCQUFSLENBSHBCO0FBQUEsSUFJTUksaUJBQWlCSixRQUFRLG1CQUFSLENBSnZCO0FBQUEsSUFLTUssaUJBQWlCTCxRQUFRLG1CQUFSLENBTHZCO0FBQUEsSUFNTU0sb0JBQW9CTixRQUFRLHNCQUFSLENBTjFCO0FBQUEsSUFPTU8sdUJBQXVCUCxRQUFRLHlCQUFSLENBUDdCOztBQVNNLElBQUVRLGVBQUYsR0FBc0JOLFNBQXRCLENBQUVNLGVBQUY7QUFBQSxJQUNFQyxJQURGLEdBQzBDTixXQUQxQyxDQUNFTSxJQURGO0FBQUEsSUFDUUMsU0FEUixHQUMwQ1AsV0FEMUMsQ0FDUU8sU0FEUjtBQUFBLElBQ21CQyxNQURuQixHQUMwQ1IsV0FEMUMsQ0FDbUJRLE1BRG5CO0FBQUEsSUFDMkJDLFVBRDNCLEdBQzBDVCxXQUQxQyxDQUMyQlMsVUFEM0I7QUFBQSxJQUVFQyxLQUZGLEdBRW9D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Q0QsR0FSZ0QsRUFROUMsSUFSOEMsQ0FBakQ7O0FBVUEsU0FBT0Esd0NBQVA7QUFDRCIsImZpbGUiOiJmYWNldC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgRWRnZSA9IHJlcXVpcmUoJy4vZWRnZScpLFxuICAgICAgVmVydGV4ID0gcmVxdWlyZSgnLi92ZXJ0ZXgnKSxcbiAgICAgIGNvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJyksXG4gICAgICB2ZWN0b3JNYXRocyA9IHJlcXVpcmUoJy4vbWF0aHMvdmVjdG9yJyksXG4gICAgICBmYWNldFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2ZhY2V0JyksXG4gICAgICBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICByb3RhdGlvblV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3JvdGF0aW9uJyksXG4gICAgICBhcHByb3hpbWF0ZVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FwcHJveGltYXRlJyk7XG5cbmNvbnN0IHsgVkVSVElDRVNfTEVOR1RIIH0gPSBjb25zdGFudHMsXG4gICAgICB7IGFkZDMsIHN1YnRyYWN0Mywgc2NhbGUzLCBub3JtYWxpc2UzIH0gPSB2ZWN0b3JNYXRocyxcbiAgICAgIHsgZmlyc3QsIHNlY29uZCwgdGhpcmQsIHBlcm11dGUgfSA9IGFycmF5VXRpbGl0aWVzLFxuICAgICAgeyBpc0FwcHJveGltYXRlbHlFcXVhbFRvWmVybyB9ID0gYXBwcm94aW1hdGVVdGlsaXRpZXMsXG4gICAgICB7IHJvdGF0ZVZlcnRpY2VzLCByb3RhdGVWZXJ0aWNlc0Fib3V0WkF4aXMgfSA9IHJvdGF0aW9uVXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVFZGdlcywgY2FsY3VsYXRlTm9ybWFsLCBjYWxjdWxhdGVBcmVhIH0gPSBmYWNldFV0aWxpdGllcztcblxuY2xhc3MgRmFjZXQge1xuICBjb25zdHJ1Y3Rvcih2ZXJ0aWNlcywgbm9ybWFsLCBlZGdlcykge1xuICAgIHRoaXMudmVydGljZXMgPSB2ZXJ0aWNlcztcbiAgICB0aGlzLm5vcm1hbCA9IG5vcm1hbDtcbiAgICB0aGlzLmVkZ2VzID0gZWRnZXM7XG4gIH1cblxuICBnZXRWZXJ0aWNlcygpIHtcbiAgICByZXR1cm4gdGhpcy52ZXJ0aWNlcztcbiAgfVxuXG4gIGdldE5vcm1hbCgpIHtcbiAgICByZXR1cm4gdGhpcy5ub3JtYWw7XG4gIH1cblxuICBnZXRFZGdlcygpIHtcbiAgICByZXR1cm4gdGhpcy5lZGdlcztcbiAgfVxuICBcbiAgZ2V0VmVydGV4UG9zaXRpb25zKCkge1xuICAgIGNvbnN0IHZlcnRleFBvc2l0aW9ucyA9IHRoaXMudmVydGljZXMubWFwKGZ1bmN0aW9uKHZlcnRleCkge1xuICAgICAgY29uc3QgdmVydGV4UG9zaXRpb24gPSB2ZXJ0ZXguZ2V0UG9zaXRpb24oKTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHZlcnRleFBvc2l0aW9uO1xuICAgIH0pO1xuICAgIFxuICAgIHJldHVybiB2ZXJ0ZXhQb3NpdGlvbnM7XG4gIH1cbiAgXG4gIGdldFZlcnRleE5vcm1hbHMoKSB7XG4gICAgY29uc3QgdmVydGV4Tm9ybWFsID0gbm9ybWFsaXNlMyh0aGlzLm5vcm1hbCksXG4gICAgICAgICAgdmVydGV4Tm9ybWFscyA9IFtcbiAgICAgICAgICAgIHZlcnRleE5vcm1hbCxcbiAgICAgICAgICAgIHZlcnRleE5vcm1hbCxcbiAgICAgICAgICAgIHZlcnRleE5vcm1hbCxcbiAgICAgICAgICBdO1xuICAgIFxuICAgIHJldHVybiB2ZXJ0ZXhOb3JtYWxzO1xuICB9XG4gIFxuICBnZXRWZXJ0ZXhJbmRleGVzKGluZGV4KSB7IC8vL1xuICAgIGNvbnN0IHZlcnRleEluZGV4ID0gaW5kZXggKiAzLFxuICAgICAgICAgIHZlcnRleEluZGV4ZXMgPSBbXG4gICAgICAgICAgICB2ZXJ0ZXhJbmRleCArIDAsXG4gICAgICAgICAgICB2ZXJ0ZXhJbmRleCArIDEsXG4gICAgICAgICAgICB2ZXJ0ZXhJbmRleCArIDIsXG4gICAgICAgICAgXTtcbiAgICBcbiAgICByZXR1cm4gdmVydGV4SW5kZXhlcztcbiAgfVxuXG4gIGdldE1pZFBvaW50UG9zaXRpb24oKSB7XG4gICAgY29uc3QgbWlkUG9pbnRQb3NpdGlvbiA9IHRoaXMudmVydGljZXMucmVkdWNlKGZ1bmN0aW9uKG1pZFBvaW50UG9zaXRpb24sIHZlcnRleCkge1xuICAgICAgY29uc3QgcG9zaXRpb24gPSB2ZXJ0ZXguZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICAgIHNjYWxlZFZlcnRleFBvc2l0aW9uID0gc2NhbGUzKHBvc2l0aW9uLCAxLzMpO1xuXG4gICAgICBtaWRQb2ludFBvc2l0aW9uID0gYWRkMyhtaWRQb2ludFBvc2l0aW9uLCBzY2FsZWRWZXJ0ZXhQb3NpdGlvbik7XG5cbiAgICAgIHJldHVybiBtaWRQb2ludFBvc2l0aW9uO1xuICAgIH0sIFsgMCwgMCwgMCBdKTtcblxuICAgIHJldHVybiBtaWRQb2ludFBvc2l0aW9uO1xuICB9XG5cbiAgaXNUb29TbWFsbCgpIHtcbiAgICBjb25zdCBhcmVhID0gY2FsY3VsYXRlQXJlYSh0aGlzLnZlcnRpY2VzKSxcbiAgICAgICAgICBhcmVhQXBwcm94aW1hdGVseUVxdWFsVG9aZXJvID0gaXNBcHByb3hpbWF0ZWx5RXF1YWxUb1plcm8oYXJlYSksXG4gICAgICAgICAgdG9vU21hbGwgPSBhcmVhQXBwcm94aW1hdGVseUVxdWFsVG9aZXJvOyAgLy8vXG4gICAgXG4gICAgcmV0dXJuIHRvb1NtYWxsO1xuICB9XG4gIFxuICBpc01hc2tlZChtYXNraW5nRmFjZXQpIHtcbiAgICBjb25zdCBtYXNraW5nRWRnZXMgPSBtYXNraW5nRmFjZXQuZ2V0TWFza2luZ0VkZ2VzKCksXG4gICAgICAgICAgbWlkUG9pbnRQb3NpdGlvbiA9IHRoaXMuZ2V0TWlkUG9pbnRQb3NpdGlvbigpLFxuICAgICAgICAgIG1pZFBvaW50UG9zaXRpb25Ub09uZVNpZGVPZk1hc2tpbmdFZGdlcyA9IGlzTWlkUG9pbnRQb3NpdGlvblRvT25lU2lkZU9mTWFza2luZ0VkZ2VzKG1pZFBvaW50UG9zaXRpb24sIG1hc2tpbmdFZGdlcyksXG4gICAgICAgICAgbWFza2VkID0gbWlkUG9pbnRQb3NpdGlvblRvT25lU2lkZU9mTWFza2luZ0VkZ2VzOyAgLy8vXG4gICAgXG4gICAgcmV0dXJuIG1hc2tlZDtcbiAgfVxuXG4gIHBlcm11dGUocGxhY2VzKSB7XG4gICAgdGhpcy52ZXJ0aWNlcyA9IHBlcm11dGUodGhpcy52ZXJ0aWNlcywgcGxhY2VzKTtcbiAgfVxuXG4gIHJvdGF0ZShyb3RhdGlvblF1YXRlcm5pb24pIHtcbiAgICB0aGlzLnZlcnRpY2VzID0gcm90YXRlVmVydGljZXModGhpcy52ZXJ0aWNlcywgcm90YXRpb25RdWF0ZXJuaW9uKTtcbiAgICBcbiAgICB0aGlzLm5vcm1hbCA9IGNhbGN1bGF0ZU5vcm1hbCh0aGlzLnZlcnRpY2VzKTtcblxuICAgIHRoaXMuZWRnZXMgPSBjYWxjdWxhdGVFZGdlcyh0aGlzLnZlcnRpY2VzLCBFZGdlKTtcbiAgfVxuXG4gIHJvdGF0ZUFib3V0WkF4aXMocm90YXRpb25BYm91dFpBeGlzTWF0cml4KSB7XG4gICAgdGhpcy52ZXJ0aWNlcyA9IHJvdGF0ZVZlcnRpY2VzQWJvdXRaQXhpcyh0aGlzLnZlcnRpY2VzLCByb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgpO1xuICAgIFxuICAgIHRoaXMubm9ybWFsID0gY2FsY3VsYXRlTm9ybWFsKHRoaXMudmVydGljZXMpO1xuXG4gICAgdGhpcy5lZGdlcyA9IGNhbGN1bGF0ZUVkZ2VzKHRoaXMudmVydGljZXMsIEVkZ2UpO1xuICB9XG5cbiAgYXBwbHlUcmFuc2Zvcm1zKHRyYW5zZm9ybXMpIHtcbiAgICB0aGlzLnZlcnRpY2VzID0gdGhpcy52ZXJ0aWNlcy5tYXAoZnVuY3Rpb24odmVydGV4KSB7XG4gICAgICB0cmFuc2Zvcm1zLmZvckVhY2goZnVuY3Rpb24odHJhbnNmb3JtKSB7XG4gICAgICAgIHZlcnRleC5hcHBseVRyYW5zZm9ybSh0cmFuc2Zvcm0pO1xuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB2ZXJ0ZXg7XG4gICAgfSk7XG5cbiAgICB0aGlzLm5vcm1hbCA9IGNhbGN1bGF0ZU5vcm1hbCh0aGlzLnZlcnRpY2VzKTtcblxuICAgIHRoaXMuZWRnZXMgPSBjYWxjdWxhdGVFZGdlcyh0aGlzLnZlcnRpY2VzLCBFZGdlKTtcbiAgfVxuXG4gIHNwbGl0V2l0aEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cykge1xuICAgIGNvbnN0IG5vbk51bGxJbnRlcnNlY3Rpb25zID0gY2FsY3VsYXRlTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucyksXG4gICAgICAgICAgbm9uTnVsbEludGVyc2VjdGlvbnNMZW5ndGggPSBub25OdWxsSW50ZXJzZWN0aW9ucy5sZW5ndGg7XG5cbiAgICBzd2l0Y2ggKG5vbk51bGxJbnRlcnNlY3Rpb25zTGVuZ3RoKSB7XG4gICAgICBjYXNlIDIgOlxuICAgICAgICB0aGlzLnNwbGl0V2l0aFR3b05vbk51bGxJbnRlcnNlY3Rpb25zKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAxIDpcbiAgICAgICAgdGhpcy5zcGxpdFdpdGhPbmVOb25OdWxsSW50ZXJzZWN0aW9uKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAwIDpcbiAgICAgICAgdGhpcy5zcGxpdFdpdGhaZXJvTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cyk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICBcbiAgc3BsaXRXaXRoVHdvTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cywgZmFjZXQpIHtcbiAgICBjb25zdCBudWxsSW50ZXJzZWN0aW9uSW5kZXggPSBjYWxjdWxhdGVOdWxsSW50ZXJzZWN0aW9uSW5kZXgoaW50ZXJzZWN0aW9ucyksXG4gICAgICAgICAgcGxhY2VzID0gKFZFUlRJQ0VTX0xFTkdUSCAtIG51bGxJbnRlcnNlY3Rpb25JbmRleCkgJSBWRVJUSUNFU19MRU5HVEg7XG5cbiAgICBpbnRlcnNlY3Rpb25zID0gcGVybXV0ZShpbnRlcnNlY3Rpb25zLCBwbGFjZXMpO1xuXG4gICAgaW50ZXJzZWN0aW9ucyA9IGludGVyc2VjdGlvbnMuc2xpY2UoMSk7IC8vL1xuICAgIFxuICAgIHRoaXMucGVybXV0ZShwbGFjZXMpO1xuXG4gICAgY29uc3QgZmlyc3RWZXJ0ZXggPSBmaXJzdCh0aGlzLnZlcnRpY2VzKSxcbiAgICAgICAgICBzZWNvbmRWZXJ0ZXggPSBzZWNvbmQodGhpcy52ZXJ0aWNlcyksXG4gICAgICAgICAgdGhpcmRWZXJ0ZXggPSB0aGlyZCh0aGlzLnZlcnRpY2VzKSxcbiAgICAgICAgICBmaXJzdEludGVyc2VjdGlvbiA9IGZpcnN0KGludGVyc2VjdGlvbnMpLFxuICAgICAgICAgIHNlY29uZEludGVyc2VjdGlvbiA9IHNlY29uZChpbnRlcnNlY3Rpb25zKSxcbiAgICAgICAgICBmaXJzdEludGVybWVkaWF0ZVZlcnRleCA9IGNhbGN1bGF0ZUludGVybWVkaWF0ZVZlcnRleChzZWNvbmRWZXJ0ZXgsIHRoaXJkVmVydGV4LCBmaXJzdEludGVyc2VjdGlvbiksXG4gICAgICAgICAgc2Vjb25kSW50ZXJtZWRpYXRlVmVydGV4ID0gY2FsY3VsYXRlSW50ZXJtZWRpYXRlVmVydGV4KHRoaXJkVmVydGV4LCBmaXJzdFZlcnRleCwgc2Vjb25kSW50ZXJzZWN0aW9uKSxcbiAgICAgICAgICBmaXJzdFZlcnRpY2VzID0gW1xuICAgICAgICAgICAgZmlyc3RWZXJ0ZXgsXG4gICAgICAgICAgICBzZWNvbmRWZXJ0ZXgsXG4gICAgICAgICAgICBmaXJzdEludGVybWVkaWF0ZVZlcnRleFxuICAgICAgICAgIF0sXG4gICAgICAgICAgc2Vjb25kVmVydGljZXMgPSBbXG4gICAgICAgICAgICBmaXJzdEludGVybWVkaWF0ZVZlcnRleCxcbiAgICAgICAgICAgIHNlY29uZEludGVybWVkaWF0ZVZlcnRleCxcbiAgICAgICAgICAgIGZpcnN0VmVydGV4XG4gICAgICAgICAgXSxcbiAgICAgICAgICB0aGlyZFZlcnRpY2VzID0gW1xuICAgICAgICAgICAgZmlyc3RJbnRlcm1lZGlhdGVWZXJ0ZXgsXG4gICAgICAgICAgICB0aGlyZFZlcnRleCxcbiAgICAgICAgICAgIHNlY29uZEludGVybWVkaWF0ZVZlcnRleFxuICAgICAgICAgIF0sXG4gICAgICAgICAgZmlyc3RGYWNldCA9IGZhY2V0LmZyb21WZXJ0aWNlcyhmaXJzdFZlcnRpY2VzKSxcbiAgICAgICAgICBzZWNvbmRGYWNldCA9IGZhY2V0LmZyb21WZXJ0aWNlcyhzZWNvbmRWZXJ0aWNlcyksXG4gICAgICAgICAgdGhpcmRGYWNldCA9IGZhY2V0LmZyb21WZXJ0aWNlcyh0aGlyZFZlcnRpY2VzKSxcbiAgICAgICAgICBmaXJzdEZhY2V0VG9vU21hbGwgPSBmaXJzdEZhY2V0LmlzVG9vU21hbGwoKSxcbiAgICAgICAgICBzZWNvbmRGYWNldFRvb1NtYWxsID0gc2Vjb25kRmFjZXQuaXNUb29TbWFsbCgpLFxuICAgICAgICAgIHRoaXJkRmFjZXRUb29TbWFsbCA9IHRoaXJkRmFjZXQuaXNUb29TbWFsbCgpO1xuXG4gICAgaWYgKCFmaXJzdEZhY2V0VG9vU21hbGwpIHtcbiAgICAgIHNtYWxsZXJGYWNldHMucHVzaChmaXJzdEZhY2V0KTtcbiAgICB9XG5cbiAgICBpZiAoIXNlY29uZEZhY2V0VG9vU21hbGwpIHtcbiAgICAgIHNtYWxsZXJGYWNldHMucHVzaChzZWNvbmRGYWNldCk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlyZEZhY2V0VG9vU21hbGwpIHtcbiAgICAgIHNtYWxsZXJGYWNldHMucHVzaCh0aGlyZEZhY2V0KTtcbiAgICB9XG4gIH1cblxuICBzcGxpdFdpdGhPbmVOb25OdWxsSW50ZXJzZWN0aW9uKGludGVyc2VjdGlvbnMsIHNtYWxsZXJGYWNldHMsIGZhY2V0KSB7XG4gICAgY29uc3Qgbm9uTnVsbEludGVyc2VjdGlvbkluZGV4ID0gY2FsY3VsYXRlTm9uTnVsbEludGVyc2VjdGlvbkluZGV4KGludGVyc2VjdGlvbnMpLFxuICAgICAgICAgIHBsYWNlcyA9IChWRVJUSUNFU19MRU5HVEggLSBub25OdWxsSW50ZXJzZWN0aW9uSW5kZXgpICUgVkVSVElDRVNfTEVOR1RIO1xuXG4gICAgaW50ZXJzZWN0aW9ucyA9IHBlcm11dGUoaW50ZXJzZWN0aW9ucywgcGxhY2VzKTtcblxuICAgIHRoaXMucGVybXV0ZShwbGFjZXMpO1xuXG4gICAgY29uc3QgZmlyc3RWZXJ0ZXggPSBmaXJzdCh0aGlzLnZlcnRpY2VzKSxcbiAgICAgICAgICBzZWNvbmRWZXJ0ZXggPSBzZWNvbmQodGhpcy52ZXJ0aWNlcyksXG4gICAgICAgICAgdGhpcmRWZXJ0ZXggPSB0aGlyZCh0aGlzLnZlcnRpY2VzKSxcbiAgICAgICAgICBmaXJzdEludGVyc2VjdGlvbiA9IGZpcnN0KGludGVyc2VjdGlvbnMpLFxuICAgICAgICAgIGludGVybWVkaWF0ZVZlcnRleCA9IGNhbGN1bGF0ZUludGVybWVkaWF0ZVZlcnRleChmaXJzdFZlcnRleCwgc2Vjb25kVmVydGV4LCBmaXJzdEludGVyc2VjdGlvbiksXG4gICAgICAgICAgZmlyc3RWZXJ0aWNlcyA9IFtcbiAgICAgICAgICAgIGZpcnN0VmVydGV4LFxuICAgICAgICAgICAgaW50ZXJtZWRpYXRlVmVydGV4LFxuICAgICAgICAgICAgdGhpcmRWZXJ0ZXhcbiAgICAgICAgICBdLFxuICAgICAgICAgIHNlY29uZFZlcnRpY2VzID0gW1xuICAgICAgICAgICAgaW50ZXJtZWRpYXRlVmVydGV4LFxuICAgICAgICAgICAgc2Vjb25kVmVydGV4LFxuICAgICAgICAgICAgdGhpcmRWZXJ0ZXhcbiAgICAgICAgICBdLFxuICAgICAgICAgIGZpcnN0RmFjZXQgPSBmYWNldC5mcm9tVmVydGljZXMoZmlyc3RWZXJ0aWNlcyksXG4gICAgICAgICAgc2Vjb25kRmFjZXQgPSBmYWNldC5mcm9tVmVydGljZXMoc2Vjb25kVmVydGljZXMpLFxuICAgICAgICAgIGZpcnN0RmFjZXRUb29TbWFsbCA9IGZpcnN0RmFjZXQuaXNUb29TbWFsbCgpLFxuICAgICAgICAgIHNlY29uZEZhY2V0VG9vU21hbGwgPSBzZWNvbmRGYWNldC5pc1Rvb1NtYWxsKCk7XG5cbiAgICBpZiAoIWZpcnN0RmFjZXRUb29TbWFsbCkge1xuICAgICAgc21hbGxlckZhY2V0cy5wdXNoKGZpcnN0RmFjZXQpO1xuICAgIH1cblxuICAgIGlmICghc2Vjb25kRmFjZXRUb29TbWFsbCkge1xuICAgICAgc21hbGxlckZhY2V0cy5wdXNoKHNlY29uZEZhY2V0KTtcbiAgICB9XG4gIH1cblxuICBzcGxpdFdpdGhaZXJvTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucywgc21hbGxlckZhY2V0cykge1xuICAgIGNvbnN0IHNtYWxsZXJGYWNldCA9IHRoaXM7ICAvLy9cblxuICAgIHNtYWxsZXJGYWNldHMucHVzaChzbWFsbGVyRmFjZXQpO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gRmFjZXQ7XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZUludGVybWVkaWF0ZVZlcnRleChzdGFydFZlcnRleCwgZW5kVmVydGV4LCBpbnRlcnNlY3Rpb24pIHtcbiAgY29uc3Qgc3RhcnRQb3NpdGlvbiA9IHN0YXJ0VmVydGV4LmdldFBvc2l0aW9uKCksXG4gICAgICAgIGVuZFBvc2l0aW9uID0gZW5kVmVydGV4LmdldFBvc2l0aW9uKCksXG4gICAgICAgIGV4dGVudCA9IHN1YnRyYWN0MyhlbmRQb3NpdGlvbiwgc3RhcnRQb3NpdGlvbiksXG4gICAgICAgIG9mZnNldCA9IHNjYWxlMyhleHRlbnQsIGludGVyc2VjdGlvbiksXG4gICAgICAgIHBvc2l0aW9uID0gYWRkMyhzdGFydFBvc2l0aW9uLCBvZmZzZXQpLFxuICAgICAgICB2ZXJ0ZXggPSBuZXcgVmVydGV4KHBvc2l0aW9uKSxcbiAgICAgICAgaW50ZXJtZWRpYXRlVmVydGV4ID0gdmVydGV4OyAgLy8vXG5cbiAgcmV0dXJuIGludGVybWVkaWF0ZVZlcnRleDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlTm9uTnVsbEludGVyc2VjdGlvbnMoaW50ZXJzZWN0aW9ucykge1xuICBjb25zdCBub25OdWxsSW50ZXJzZWN0aW9ucyA9IGludGVyc2VjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKG5vbk51bGxJbnRlcnNlY3Rpb25zLCBpbnRlcnNlY3Rpb24pIHtcbiAgICBpZiAoaW50ZXJzZWN0aW9uICE9PSBudWxsKSB7XG4gICAgICBjb25zdCBub25OdWxsSW50ZXJzZWN0aW9uID0gaW50ZXJzZWN0aW9uOyAvLy9cblxuICAgICAgbm9uTnVsbEludGVyc2VjdGlvbnMucHVzaChub25OdWxsSW50ZXJzZWN0aW9uKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbm9uTnVsbEludGVyc2VjdGlvbnM7XG4gIH0sIFtdKTtcblxuICByZXR1cm4gbm9uTnVsbEludGVyc2VjdGlvbnM7XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU51bGxJbnRlcnNlY3Rpb25JbmRleChpbnRlcnNlY3Rpb25zKSB7XG4gIGNvbnN0IG51bGxJbnRlcnNlY3Rpb25JbmRleCA9IGludGVyc2VjdGlvbnMucmVkdWNlKGZ1bmN0aW9uKG51bGxJbnRlcnNlY3Rpb25JbmRleCwgaW50ZXJzZWN0aW9uLCBpbmRleCkge1xuICAgIGlmIChudWxsSW50ZXJzZWN0aW9uSW5kZXggPT09IG51bGwpIHtcbiAgICAgIGlmIChpbnRlcnNlY3Rpb24gPT09IG51bGwpIHtcbiAgICAgICAgbnVsbEludGVyc2VjdGlvbkluZGV4ID0gaW5kZXg7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGxJbnRlcnNlY3Rpb25JbmRleDtcbiAgfSwgbnVsbCk7XG5cbiAgcmV0dXJuIG51bGxJbnRlcnNlY3Rpb25JbmRleDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlTm9uTnVsbEludGVyc2VjdGlvbkluZGV4KGludGVyc2VjdGlvbnMpIHtcbiAgY29uc3QgbnVsbEludGVyc2VjdGlvbkluZGV4ID0gaW50ZXJzZWN0aW9ucy5yZWR1Y2UoZnVuY3Rpb24obnVsbEludGVyc2VjdGlvbkluZGV4LCBpbnRlcnNlY3Rpb24sIGluZGV4KSB7XG4gICAgaWYgKG51bGxJbnRlcnNlY3Rpb25JbmRleCA9PT0gbnVsbCkge1xuICAgICAgaWYgKGludGVyc2VjdGlvbiAhPT0gbnVsbCkge1xuICAgICAgICBudWxsSW50ZXJzZWN0aW9uSW5kZXggPSBpbmRleDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbEludGVyc2VjdGlvbkluZGV4O1xuICB9LCBudWxsKTtcblxuICByZXR1cm4gbnVsbEludGVyc2VjdGlvbkluZGV4O1xufVxuXG5mdW5jdGlvbiBpc01pZFBvaW50UG9zaXRpb25Ub09uZVNpZGVPZk1hc2tpbmdFZGdlcyhtaWRQb2ludFBvc2l0aW9uLCBtYXNraW5nRWRnZXMpIHtcbiAgY29uc3QgbWlkUG9pbnRQb3NpdGlvblRvVGhlTGVmdE9mTWFza2luZ0VkZ2VzID0gaXNNaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0T2ZNYXNraW5nRWRnZXMobWlkUG9pbnRQb3NpdGlvbiwgbWFza2luZ0VkZ2VzKSxcbiAgICAgICAgbWlkUG9pbnRQb3NpdGlvblRvVGhlUmlnaHRPZk1hc2tpbmdFZGdlcyA9IGlzTWlkUG9pbnRQb3NpdGlvblRvVGhlUmlnaHRPZk1hc2tpbmdFZGdlcyhtaWRQb2ludFBvc2l0aW9uLCBtYXNraW5nRWRnZXMpLFxuICAgICAgICBtaWRQb2ludFBvc2l0aW9uVG9PbmVTaWRlT2ZNYXNraW5nRWRnZXMgPSBtaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0T2ZNYXNraW5nRWRnZXMgfHwgbWlkUG9pbnRQb3NpdGlvblRvVGhlUmlnaHRPZk1hc2tpbmdFZGdlczsgLy8vXG5cbiAgcmV0dXJuIG1pZFBvaW50UG9zaXRpb25Ub09uZVNpZGVPZk1hc2tpbmdFZGdlcztcbn1cblxuZnVuY3Rpb24gaXNNaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0T2ZNYXNraW5nRWRnZXMobWlkUG9pbnRQb3NpdGlvbiwgbWFza2luZ0VkZ2VzKSB7XG4gIGNvbnN0IG1pZFBvaW50UG9zaXRpb25Ub1RoZUxlZnRPZk1hc2tpbmdFZGdlcyA9IG1hc2tpbmdFZGdlcy5yZWR1Y2UoZnVuY3Rpb24obWlkUG9pbnRQb3NpdGlvblRvVGhlTGVmdE9mTWFza2luZ0VkZ2VzLCBtYXNraW5nRWRnZSkge1xuICAgIGlmIChtaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0T2ZNYXNraW5nRWRnZXMpIHtcbiAgICAgIGNvbnN0IG1pZFBvaW50UG9zaXRpb25Ub1RoZUxlZnRPZk1hc2tpbmdFZGdlID0gbWFza2luZ0VkZ2UuaXNNaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0KG1pZFBvaW50UG9zaXRpb24pO1xuXG4gICAgICBtaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0T2ZNYXNraW5nRWRnZXMgPSBtaWRQb2ludFBvc2l0aW9uVG9UaGVMZWZ0T2ZNYXNraW5nRWRnZTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWlkUG9pbnRQb3NpdGlvblRvVGhlTGVmdE9mTWFza2luZ0VkZ2VzO1xuICB9LCB0cnVlKTtcblxuICByZXR1cm4gbWlkUG9pbnRQb3NpdGlvblRvVGhlTGVmdE9mTWFza2luZ0VkZ2VzO1xufVxuXG5mdW5jdGlvbiBpc01pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXMobWlkUG9pbnRQb3NpdGlvbiwgbWFza2luZ0VkZ2VzKSB7XG4gIGNvbnN0IG1pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXMgPSBtYXNraW5nRWRnZXMucmVkdWNlKGZ1bmN0aW9uKG1pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXMsIG1hc2tpbmdFZGdlKSB7XG4gICAgaWYgKG1pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXMpIHtcbiAgICAgIGNvbnN0IG1pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZSA9IG1hc2tpbmdFZGdlLmlzTWlkUG9pbnRQb3NpdGlvblRvVGhlUmlnaHQobWlkUG9pbnRQb3NpdGlvbik7XG5cbiAgICAgIG1pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXMgPSBtaWRQb2ludFBvc2l0aW9uVG9UaGVSaWdodE9mTWFza2luZ0VkZ2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1pZFBvaW50UG9zaXRpb25Ub1RoZVJpZ2h0T2ZNYXNraW5nRWRnZXM7XG4gIH0sIHRydWUpO1xuXG4gIHJldHVybiBtaWRQb2ludFBvc2l0aW9uVG9UaGVSaWdodE9mTWFza2luZ0VkZ2VzO1xufVxuIl19