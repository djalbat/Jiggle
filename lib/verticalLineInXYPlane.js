'use strict';

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var arrayUtilities = require('./utilities/array'),
    vectorUtilities = require('./utilities/vector'),
    vertexUtilities = require('./utilities/vertex'),
    rotationUtilities = require('./utilities/rotation'),
    approximateUtilities = require('./utilities/approximate');

var normalise3 = vectorUtilities.normalise3,
    first = arrayUtilities.first,
    second = arrayUtilities.second,
    rotateAboutZAxis = vertexUtilities.rotateAboutZAxis,
    isApproximatelyEqualToZero = approximateUtilities.isApproximatelyEqualToZero,
    calculateForwardsRotationAboutZAxisMatrix = rotationUtilities.calculateForwardsRotationAboutZAxisMatrix,
    calculateBackwardsRotationAboutZAxisMatrix = rotationUtilities.calculateBackwardsRotationAboutZAxisMatrix;

var VerticalLineInXYPlane = function () {
  function VerticalLineInXYPlane(firstPositionComponent, rotationAboutZAxisMatrix) {
    _classCallCheck(this, VerticalLineInXYPlane);

    this.firstPositionComponent = firstPositionComponent;
    this.rotationAboutZAxisMatrix = rotationAboutZAxisMatrix;
  }

  _createClass(VerticalLineInXYPlane, [{
    key: 'getFirstPositionComponent',
    value: function getFirstPositionComponent() {
      return this.firstPositionComponent;
    }
  }, {
    key: 'getRotationAboutZAxisMatrix',
    value: function getRotationAboutZAxisMatrix() {
      return this.rotationAboutZAxisMatrix;
    }
  }, {
    key: 'splitFacets',
    value: function splitFacets(facets) {
      var smallerFacets = [],
          forwardsRotationAboutZAxisMatrix = calculateForwardsRotationAboutZAxisMatrix(this.rotationAboutZAxisMatrix),
          backwardsRotationAboutZAxisMatrix = calculateBackwardsRotationAboutZAxisMatrix(this.rotationAboutZAxisMatrix);

      facets.forEach(function (facet) {
        facet.rotateAboutZAxis(forwardsRotationAboutZAxisMatrix);

        this.splitFacet(facet, smallerFacets);
      }.bind(this));

      smallerFacets.forEach(function (smallerFacet) {
        smallerFacet.rotateAboutZAxis(backwardsRotationAboutZAxisMatrix);
      });

      return smallerFacets;
    }
  }, {
    key: 'splitFacet',
    value: function splitFacet(facet, smallerFacets) {
      var intersections = this.calculateIntersectionsWithFacet(facet);

      facet.split(intersections, smallerFacets);
    }
  }, {
    key: 'calculateIntersectionsWithFacet',
    value: function calculateIntersectionsWithFacet(facet) {
      var edges = facet.getEdges(),
          intersections = edges.map(function (edge) {
        var intersection = this.calculateIntersection(edge);

        return intersection;
      }.bind(this));

      return intersections;
    }
  }, {
    key: 'calculateIntersection',
    value: function calculateIntersection(edge) {
      var intersection = null;

      var edgeNonParallel = isEdgeNonParallel(edge);

      if (edgeNonParallel) {
        var edgeIntersection = this.calculateEdgeIntersection(edge),
            edgeIntersectionNonTrivial = isIntersectionNonTrivial(edgeIntersection);

        if (edgeIntersectionNonTrivial) {
          intersection = edgeIntersection; ///
        }
      }

      return intersection;
    }
  }, {
    key: 'calculateEdgeIntersection',
    value: function calculateEdgeIntersection(edge) {
      var edgePosition = edge.getPosition(),
          edgeExtent = edge.getExtent(),
          edgePositionComponents = edgePosition,
          ///
      edgeExtentComponents = edgeExtent,
          ///
      firstEdgePositionComponent = first(edgePositionComponents),
          firstEdgeExtentComponent = first(edgeExtentComponents),
          edgeIntersection = (this.firstPositionComponent - firstEdgePositionComponent) / firstEdgeExtentComponent;

      return edgeIntersection;
    }
  }], [{
    key: 'fromEdgeInXYPlane',
    value: function fromEdgeInXYPlane(edgeInXYPlane) {
      var edgeInXYPlanePosition = edgeInXYPlane.getPosition(),
          rotationAboutZAxisMatrix = calculateRotationAboutZAxisMatrix(edgeInXYPlane),
          position = rotateAboutZAxis(edgeInXYPlanePosition, rotationAboutZAxisMatrix),
          positionComponents = position,
          ///
      firstPositionComponent = first(positionComponents),
          verticalLineInXYPlane = new VerticalLineInXYPlane(firstPositionComponent, rotationAboutZAxisMatrix);

      return verticalLineInXYPlane;
    }
  }]);

  return VerticalLineInXYPlane;
}();

module.exports = VerticalLineInXYPlane;

function isEdgeNonParallel(edge) {
  var edgeExtent = edge.getExtent(),
      edgeExtentComponents = edgeExtent,
      ///
  firstEdgeExtentComponent = first(edgeExtentComponents),
      secondEdgeExtentComponent = second(edgeExtentComponents),
      edgeAngleTangent = firstEdgeExtentComponent / secondEdgeExtentComponent,
      edgeAngleTangentApproximatelyEqualToZero = isApproximatelyEqualToZero(edgeAngleTangent),
      edgeParallel = edgeAngleTangentApproximatelyEqualToZero,
      ///
  edgeNonParallel = !edgeParallel;

  return edgeNonParallel;
}

function isIntersectionNonTrivial(intersection) {
  var intersectionNonTrivial = intersection > 0 && intersection < 1;

  return intersectionNonTrivial;
}

function calculateRotationAboutZAxisMatrix(edgeInXYPlane) {
  var edgeInXYPlaneExtent = edgeInXYPlane.getExtent(),
      unitEdgeInXYPlaneExtent = normalise3(edgeInXYPlaneExtent),
      unitEdgeInXYPlaneExtentComponents = unitEdgeInXYPlaneExtent,
      ///
  firstUnitEdgeInXYPlaneExtentComponent = first(unitEdgeInXYPlaneExtentComponents),
      secondUnitEdgeInXYPlaneExtentComponent = second(unitEdgeInXYPlaneExtentComponents),
      angleOfRotationCosine = +secondUnitEdgeInXYPlaneExtentComponent,
      ///
  angleOfRotationSine = -firstUnitEdgeInXYPlaneExtentComponent,
      ///
  c = angleOfRotationCosine,
      s = angleOfRotationSine,
      rotationAboutZAxisMatrix = [c, -s, 0, +s, c, 0, 0, 0, 1]; ///

  return rotationAboutZAxisMatrix;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2VzNi92ZXJ0aWNhbExpbmVJblhZUGxhbmUuanMiXSwibmFtZXMiOlsiYXJyYXlVdGlsaXRpZXMiLCJyZXF1aXJlIiwidmVjdG9yVXRpbGl0aWVzIiwidmVydGV4VXRpbGl0aWVzIiwicm90YXRpb25VdGlsaXRpZXMiLCJhcHByb3hpbWF0ZVV0aWxpdGllcyIsIm5vcm1hbGlzZTMiLCJmaXJzdCIsInNlY29uZCIsInJvdGF0ZUFib3V0WkF4aXMiLCJpc0FwcHJveGltYXRlbHlFcXVhbFRvWmVybyIsImNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4IiwiY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4IiwiVmVydGljYWxMaW5lSW5YWVBsYW5lIiwiZmlyc3RQb3NpdGlvbkNvbXBvbmVudCIsInJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCIsImZhY2V0cyIsInNtYWxsZXJGYWNldHMiLCJmb3J3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCIsImJhY2t3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCIsImZvckVhY2giLCJmYWNldCIsInNwbGl0RmFjZXQiLCJiaW5kIiwic21hbGxlckZhY2V0IiwiaW50ZXJzZWN0aW9ucyIsImNhbGN1bGF0ZUludGVyc2VjdGlvbnNXaXRoRmFjZXQiLCJzcGxpdCIsImVkZ2VzIiwiZ2V0RWRnZXMiLCJtYXAiLCJlZGdlIiwiaW50ZXJzZWN0aW9uIiwiY2FsY3VsYXRlSW50ZXJzZWN0aW9uIiwiZWRnZU5vblBhcmFsbGVsIiwiaXNFZGdlTm9uUGFyYWxsZWwiLCJlZGdlSW50ZXJzZWN0aW9uIiwiY2FsY3VsYXRlRWRnZUludGVyc2VjdGlvbiIsImVkZ2VJbnRlcnNlY3Rpb25Ob25Ucml2aWFsIiwiaXNJbnRlcnNlY3Rpb25Ob25Ucml2aWFsIiwiZWRnZVBvc2l0aW9uIiwiZ2V0UG9zaXRpb24iLCJlZGdlRXh0ZW50IiwiZ2V0RXh0ZW50IiwiZWRnZVBvc2l0aW9uQ29tcG9uZW50cyIsImVkZ2VFeHRlbnRDb21wb25lbnRzIiwiZmlyc3RFZGdlUG9zaXRpb25Db21wb25lbnQiLCJmaXJzdEVkZ2VFeHRlbnRDb21wb25lbnQiLCJlZGdlSW5YWVBsYW5lIiwiZWRnZUluWFlQbGFuZVBvc2l0aW9uIiwiY2FsY3VsYXRlUm90YXRpb25BYm91dFpBeGlzTWF0cml4IiwicG9zaXRpb24iLCJwb3NpdGlvbkNvbXBvbmVudHMiLCJ2ZXJ0aWNhbExpbmVJblhZUGxhbmUiLCJtb2R1bGUiLCJleHBvcnRzIiwic2Vjb25kRWRnZUV4dGVudENvbXBvbmVudCIsImVkZ2VBbmdsZVRhbmdlbnQiLCJlZGdlQW5nbGVUYW5nZW50QXBwcm94aW1hdGVseUVxdWFsVG9aZXJvIiwiZWRnZVBhcmFsbGVsIiwiaW50ZXJzZWN0aW9uTm9uVHJpdmlhbCIsImVkZ2VJblhZUGxhbmVFeHRlbnQiLCJ1bml0RWRnZUluWFlQbGFuZUV4dGVudCIsInVuaXRFZGdlSW5YWVBsYW5lRXh0ZW50Q29tcG9uZW50cyIsImZpcnN0VW5pdEVkZ2VJblhZUGxhbmVFeHRlbnRDb21wb25lbnQiLCJzZWNvbmRVbml0RWRnZUluWFlQbGFuZUV4dGVudENvbXBvbmVudCIsImFuZ2xlT2ZSb3RhdGlvbkNvc2luZSIsImFuZ2xlT2ZSb3RhdGlvblNpbmUiLCJjIiwicyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBLElBQU1BLGlCQUFpQkMsUUFBUSxtQkFBUixDQUF2QjtBQUFBLElBQ01DLGtCQUFrQkQsUUFBUSxvQkFBUixDQUR4QjtBQUFBLElBRU1FLGtCQUFrQkYsUUFBUSxvQkFBUixDQUZ4QjtBQUFBLElBR01HLG9CQUFvQkgsUUFBUSxzQkFBUixDQUgxQjtBQUFBLElBSU1JLHVCQUF1QkosUUFBUSx5QkFBUixDQUo3Qjs7QUFNTSxJQUFFSyxVQUFGLEdBQWlCSixlQUFqQixDQUFFSSxVQUFGO0FBQUEsSUFDRUMsS0FERixHQUNvQlAsY0FEcEIsQ0FDRU8sS0FERjtBQUFBLElBQ1NDLE1BRFQsR0FDb0JS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QUF3Q3pELE1BQU13RCxpQ0FBTixDQUg5QztBQUFBLE1BSU1FLHlDQUF5Q3pELE9BQU91RCxpQ0FBUCxDQUovQztBQUFBLE1BS01HLHdCQUF3QixDQUFDRCxzQ0FML0I7QUFBQSxNQUt3RTtBQUNsRUUsd0JBQXNCLENBQUNILHFDQU43QjtBQUFBLE1BTW9FO0FBQzlESSxNQUFJRixxQkFQVjtBQUFBLE1BUU1HLElBQUlGLG1CQVJWO0FBQUEsTUFTTXBELDJCQUEyQixDQUFFcUQsQ0FBRixFQUFLLENBQUNDLENBQU4sRUFBUyxDQUFULEVBQVksQ0FBQ0EsQ0FBYixFQUFnQkQsQ0FBaEIsRUFBbUIsQ0FBbkIsRUFBc0IsQ0FBdEIsRUFBeUIsQ0FBekIsRUFBNEIsQ0FBNUIsQ0FUakMsQ0FEd0QsQ0FVVzs7QUFFbkUsU0FBT3JELHdCQUFQO0FBQ0QiLCJmaWxlIjoidmVydGljYWxMaW5lSW5YWVBsYW5lLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBhcnJheVV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL2FycmF5JyksXG4gICAgICB2ZWN0b3JVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy92ZWN0b3InKSxcbiAgICAgIHZlcnRleFV0aWxpdGllcyA9IHJlcXVpcmUoJy4vdXRpbGl0aWVzL3ZlcnRleCcpLFxuICAgICAgcm90YXRpb25VdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9yb3RhdGlvbicpLFxuICAgICAgYXBwcm94aW1hdGVVdGlsaXRpZXMgPSByZXF1aXJlKCcuL3V0aWxpdGllcy9hcHByb3hpbWF0ZScpO1xuXG5jb25zdCB7IG5vcm1hbGlzZTMgfSA9IHZlY3RvclV0aWxpdGllcyxcbiAgICAgIHsgZmlyc3QsIHNlY29uZCB9ID0gYXJyYXlVdGlsaXRpZXMsXG4gICAgICB7IHJvdGF0ZUFib3V0WkF4aXMgfSA9IHZlcnRleFV0aWxpdGllcyxcbiAgICAgIHsgaXNBcHByb3hpbWF0ZWx5RXF1YWxUb1plcm8gfSA9IGFwcHJveGltYXRlVXRpbGl0aWVzLFxuICAgICAgeyBjYWxjdWxhdGVGb3J3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCwgY2FsY3VsYXRlQmFja3dhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4IH0gPSByb3RhdGlvblV0aWxpdGllcztcblxuY2xhc3MgVmVydGljYWxMaW5lSW5YWVBsYW5lIHtcbiAgY29uc3RydWN0b3IoZmlyc3RQb3NpdGlvbkNvbXBvbmVudCwgcm90YXRpb25BYm91dFpBeGlzTWF0cml4KSB7XG4gICAgdGhpcy5maXJzdFBvc2l0aW9uQ29tcG9uZW50ID0gZmlyc3RQb3NpdGlvbkNvbXBvbmVudDtcbiAgICB0aGlzLnJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCA9IHJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeDtcbiAgfVxuXG4gIGdldEZpcnN0UG9zaXRpb25Db21wb25lbnQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZmlyc3RQb3NpdGlvbkNvbXBvbmVudDtcbiAgfVxuICBcbiAgZ2V0Um90YXRpb25BYm91dFpBeGlzTWF0cml4KCkge1xuICAgIHJldHVybiB0aGlzLnJvdGF0aW9uQWJvdXRaQXhpc01hdHJpeDtcbiAgfVxuXG4gIHNwbGl0RmFjZXRzKGZhY2V0cykge1xuICAgIGNvbnN0IHNtYWxsZXJGYWNldHMgPSBbXSxcbiAgICAgICAgICBmb3J3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCA9IGNhbGN1bGF0ZUZvcndhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4KHRoaXMucm90YXRpb25BYm91dFpBeGlzTWF0cml4KSxcbiAgICAgICAgICBiYWNrd2FyZHNSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXggPSBjYWxjdWxhdGVCYWNrd2FyZHNSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgodGhpcy5yb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgpO1xuICAgIFxuICAgIGZhY2V0cy5mb3JFYWNoKGZ1bmN0aW9uKGZhY2V0KSB7XG4gICAgICBmYWNldC5yb3RhdGVBYm91dFpBeGlzKGZvcndhcmRzUm90YXRpb25BYm91dFpBeGlzTWF0cml4KTtcblxuICAgICAgdGhpcy5zcGxpdEZhY2V0KGZhY2V0LCBzbWFsbGVyRmFjZXRzKTtcbiAgICB9LmJpbmQodGhpcykpO1xuICAgIFxuICAgIHNtYWxsZXJGYWNldHMuZm9yRWFjaChmdW5jdGlvbihzbWFsbGVyRmFjZXQpIHtcbiAgICAgIHNtYWxsZXJGYWNldC5yb3RhdGVBYm91dFpBeGlzKGJhY2t3YXJkc1JvdGF0aW9uQWJvdXRaQXhpc01hdHJpeCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gc21hbGxlckZhY2V0czsgICAgXG4gIH1cblxuICBzcGxpdEZhY2V0KGZhY2V0LCBzbWFsbGVyRmFjZXRzKSB7XG4gICAgY29uc3QgaW50ZXJzZWN0aW9ucyA9IHRoaXMuY2FsY3VsYXRlSW50ZXJzZWN0aW9uc1dpdGhGYWNldChmYWNldCk7XG5cbiAgICBmYWNldC5zcGxpdChpbnRlcnNlY3Rpb25zLCBzbWFsbGVyRmFjZXRzKTtcbiAgfVxuXG4gIGNhbGN1bGF0ZUludGVyc2VjdGlvbnNXaXRoRmFjZXQoZmFjZXQpIHtcbiAgICBjb25zdCBlZGdlcyA9IGZhY2V0LmdldEVkZ2VzKCksXG4gICAgICAgICAgaW50ZXJzZWN0aW9ucyA9IGVkZ2VzLm1hcChmdW5jdGlvbihlZGdlKSB7XG4gICAgICAgICAgICBjb25zdCBpbnRlcnNlY3Rpb24gPSB0aGlzLmNhbGN1bGF0ZUludGVyc2VjdGlvbihlZGdlKTtcblxuICAgICAgICAgICAgcmV0dXJuIGludGVyc2VjdGlvbjtcbiAgICAgICAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgcmV0dXJuIGludGVyc2VjdGlvbnM7XG4gIH1cbiAgXG4gIGNhbGN1bGF0ZUludGVyc2VjdGlvbihlZGdlKSB7XG4gICAgbGV0IGludGVyc2VjdGlvbiA9IG51bGw7XG5cbiAgICBjb25zdCBlZGdlTm9uUGFyYWxsZWwgPSBpc0VkZ2VOb25QYXJhbGxlbChlZGdlKTtcblxuICAgIGlmIChlZGdlTm9uUGFyYWxsZWwpIHtcbiAgICAgIGNvbnN0IGVkZ2VJbnRlcnNlY3Rpb24gPSB0aGlzLmNhbGN1bGF0ZUVkZ2VJbnRlcnNlY3Rpb24oZWRnZSksXG4gICAgICAgICAgICBlZGdlSW50ZXJzZWN0aW9uTm9uVHJpdmlhbCA9IGlzSW50ZXJzZWN0aW9uTm9uVHJpdmlhbChlZGdlSW50ZXJzZWN0aW9uKTtcblxuICAgICAgaWYgKGVkZ2VJbnRlcnNlY3Rpb25Ob25Ucml2aWFsKSB7XG4gICAgICAgIGludGVyc2VjdGlvbiA9IGVkZ2VJbnRlcnNlY3Rpb247ICAvLy9cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gaW50ZXJzZWN0aW9uO1xuICB9XG5cbiAgY2FsY3VsYXRlRWRnZUludGVyc2VjdGlvbihlZGdlKSB7XG4gICAgY29uc3QgZWRnZVBvc2l0aW9uID0gZWRnZS5nZXRQb3NpdGlvbigpLFxuICAgICAgICAgIGVkZ2VFeHRlbnQgPSBlZGdlLmdldEV4dGVudCgpLFxuICAgICAgICAgIGVkZ2VQb3NpdGlvbkNvbXBvbmVudHMgPSBlZGdlUG9zaXRpb24sIC8vL1xuICAgICAgICAgIGVkZ2VFeHRlbnRDb21wb25lbnRzID0gZWRnZUV4dGVudCwgLy8vXG4gICAgICAgICAgZmlyc3RFZGdlUG9zaXRpb25Db21wb25lbnQgPSBmaXJzdChlZGdlUG9zaXRpb25Db21wb25lbnRzKSxcbiAgICAgICAgICBmaXJzdEVkZ2VFeHRlbnRDb21wb25lbnQgPSBmaXJzdChlZGdlRXh0ZW50Q29tcG9uZW50cyksXG4gICAgICAgICAgZWRnZUludGVyc2VjdGlvbiA9ICh0aGlzLmZpcnN0UG9zaXRpb25Db21wb25lbnQgLSBmaXJzdEVkZ2VQb3NpdGlvbkNvbXBvbmVudCkgLyBmaXJzdEVkZ2VFeHRlbnRDb21wb25lbnQ7XG4gICAgXG4gICAgcmV0dXJuIGVkZ2VJbnRlcnNlY3Rpb247XG4gIH1cblxuICBzdGF0aWMgZnJvbUVkZ2VJblhZUGxhbmUoZWRnZUluWFlQbGFuZSkge1xuICAgIGNvbnN0IGVkZ2VJblhZUGxhbmVQb3NpdGlvbiA9IGVkZ2VJblhZUGxhbmUuZ2V0UG9zaXRpb24oKSxcbiAgICAgICAgICByb3RhdGlvbkFib3V0WkF4aXNNYXRyaXggPSBjYWxjdWxhdGVSb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgoZWRnZUluWFlQbGFuZSksXG4gICAgICAgICAgcG9zaXRpb24gPSByb3RhdGVBYm91dFpBeGlzKGVkZ2VJblhZUGxhbmVQb3NpdGlvbiwgcm90YXRpb25BYm91dFpBeGlzTWF0cml4KSxcbiAgICAgICAgICBwb3NpdGlvbkNvbXBvbmVudHMgPSBwb3NpdGlvbiwgLy8vXG4gICAgICAgICAgZmlyc3RQb3NpdGlvbkNvbXBvbmVudCA9IGZpcnN0KHBvc2l0aW9uQ29tcG9uZW50cyksXG4gICAgICAgICAgdmVydGljYWxMaW5lSW5YWVBsYW5lID0gbmV3IFZlcnRpY2FsTGluZUluWFlQbGFuZShmaXJzdFBvc2l0aW9uQ29tcG9uZW50LCByb3RhdGlvbkFib3V0WkF4aXNNYXRyaXgpO1xuXG4gICAgcmV0dXJuIHZlcnRpY2FsTGluZUluWFlQbGFuZTtcbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFZlcnRpY2FsTGluZUluWFlQbGFuZTtcblxuZnVuY3Rpb24gaXNFZGdlTm9uUGFyYWxsZWwoZWRnZSkge1xuICBjb25zdCBlZGdlRXh0ZW50ID0gZWRnZS5nZXRFeHRlbnQoKSxcbiAgICAgICAgZWRnZUV4dGVudENvbXBvbmVudHMgPSBlZGdlRXh0ZW50LCAvLy9cbiAgICAgICAgZmlyc3RFZGdlRXh0ZW50Q29tcG9uZW50ID0gZmlyc3QoZWRnZUV4dGVudENvbXBvbmVudHMpLFxuICAgICAgICBzZWNvbmRFZGdlRXh0ZW50Q29tcG9uZW50ID0gc2Vjb25kKGVkZ2VFeHRlbnRDb21wb25lbnRzKSxcbiAgICAgICAgZWRnZUFuZ2xlVGFuZ2VudCA9IGZpcnN0RWRnZUV4dGVudENvbXBvbmVudCAvIHNlY29uZEVkZ2VFeHRlbnRDb21wb25lbnQsXG4gICAgICAgIGVkZ2VBbmdsZVRhbmdlbnRBcHByb3hpbWF0ZWx5RXF1YWxUb1plcm8gPSBpc0FwcHJveGltYXRlbHlFcXVhbFRvWmVybyhlZGdlQW5nbGVUYW5nZW50KSxcbiAgICAgICAgZWRnZVBhcmFsbGVsID0gZWRnZUFuZ2xlVGFuZ2VudEFwcHJveGltYXRlbHlFcXVhbFRvWmVybywgLy8vXG4gICAgICAgIGVkZ2VOb25QYXJhbGxlbCA9ICFlZGdlUGFyYWxsZWw7XG5cbiAgcmV0dXJuIGVkZ2VOb25QYXJhbGxlbDtcbn1cblxuZnVuY3Rpb24gaXNJbnRlcnNlY3Rpb25Ob25Ucml2aWFsKGludGVyc2VjdGlvbikge1xuICBjb25zdCBpbnRlcnNlY3Rpb25Ob25Ucml2aWFsID0gKChpbnRlcnNlY3Rpb24gPiAwICkgJiYgKGludGVyc2VjdGlvbiA8IDEpKTtcblxuICByZXR1cm4gaW50ZXJzZWN0aW9uTm9uVHJpdmlhbDtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlUm90YXRpb25BYm91dFpBeGlzTWF0cml4KGVkZ2VJblhZUGxhbmUpIHtcbiAgY29uc3QgZWRnZUluWFlQbGFuZUV4dGVudCA9IGVkZ2VJblhZUGxhbmUuZ2V0RXh0ZW50KCksXG4gICAgICAgIHVuaXRFZGdlSW5YWVBsYW5lRXh0ZW50ID0gbm9ybWFsaXNlMyhlZGdlSW5YWVBsYW5lRXh0ZW50KSxcbiAgICAgICAgdW5pdEVkZ2VJblhZUGxhbmVFeHRlbnRDb21wb25lbnRzID0gdW5pdEVkZ2VJblhZUGxhbmVFeHRlbnQsICAvLy9cbiAgICAgICAgZmlyc3RVbml0RWRnZUluWFlQbGFuZUV4dGVudENvbXBvbmVudCA9IGZpcnN0KHVuaXRFZGdlSW5YWVBsYW5lRXh0ZW50Q29tcG9uZW50cyksXG4gICAgICAgIHNlY29uZFVuaXRFZGdlSW5YWVBsYW5lRXh0ZW50Q29tcG9uZW50ID0gc2Vjb25kKHVuaXRFZGdlSW5YWVBsYW5lRXh0ZW50Q29tcG9uZW50cyksXG4gICAgICAgIGFuZ2xlT2ZSb3RhdGlvbkNvc2luZSA9ICtzZWNvbmRVbml0RWRnZUluWFlQbGFuZUV4dGVudENvbXBvbmVudCwgIC8vL1xuICAgICAgICBhbmdsZU9mUm90YXRpb25TaW5lID0gLWZpcnN0VW5pdEVkZ2VJblhZUGxhbmVFeHRlbnRDb21wb25lbnQsIC8vL1xuICAgICAgICBjID0gYW5nbGVPZlJvdGF0aW9uQ29zaW5lLFxuICAgICAgICBzID0gYW5nbGVPZlJvdGF0aW9uU2luZSxcbiAgICAgICAgcm90YXRpb25BYm91dFpBeGlzTWF0cml4ID0gWyBjLCAtcywgMCwgK3MsIGMsIDAsIDAsIDAsIDEgXTsgIC8vL1xuXG4gIHJldHVybiByb3RhdGlvbkFib3V0WkF4aXNNYXRyaXg7XG59XG4iXX0=